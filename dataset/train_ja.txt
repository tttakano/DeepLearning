機械学習 は ソフトウエア 工学 と コンピュータサイエンス を 使っ て 伝統的 数学 と 統計学 を 組み合わせ た もの で ある 。
本書 で は 世界 を 理解 できる よう に なる ため に 、 伝統的 統計 学 から の いくつか の ツール を 紹介 する 予定 だ 。
統計学 が 、 ほとんど の 場合 データ から 解釈 できる 何 か を 学ぶ こと に 関心 が ある の に対して 、 機械学習 で は 、 データ を 実用 的 で 使い やすい もの に 変換 する こと に 重視 し て いる 。
この 違い は 機械学習 という 単語 の 意味 を 理解 し やすく し て くれる 。
機械学習 と は 、 コンピュータ に対して 世界 の 何らかの こと について 教える こと で あり 、 その 結果 コンピュータ は そこ で 得 た 知識 を 他 の こと に 利用 できる よう に なる 。
一方 で 統計学 は 人間 に対して 世界 の 何らかの こと について 教える ため の ツール を 開発 する こと に 関心 が あり 、 その 結果 人間 は より 良い 決断 を 下す ため に 、 世界 について より はっきり と 考える こと が できる よう に なる 。

信号 や 何らかの パターン が 見つかっ たら 、 アルゴリズム は それ 以外 の もの を すべて ノイズ と みなし て 捨てる 。
そのため 機械学習 の 手法 は パターン認識 アルゴリズム と 呼ば れる こと も ある 。
機械学習 で は 、 与え られ た コンテキスト の 中 で どの よう に データ が 生成 さ れ て いる か を 機械 が 学ぶ よう に 「 訓練 」 さ せる こと が できる 。
訓練 セット という 言葉 は この こと に 由来 し て おり 、 機械学習 の 処理 を 組み立てる の に 使わ れる データ の セット で ある こと を 意味 し て いる 。
データ を 観察 し 、 そこ から 学習 し 、 それ によって 何らかの 認識 処理 を 自動 化 する という 考え方 は 機械学習 の 中核 で あり 、 本書 の 中核 を なす もの で も ある 。

本書 で は 、 読者 が プログラミング の 基礎 知識 と アルゴリズム の パラダイム に関する 比較的 高い レベル の 知識 を 有し て いる こと を 仮定 し て いる 。
とはい え R は 経験 豊か な プログラマ にとって も 比較的 ニッチ な 言語 で ある 。
すべて の 読者 が 同じ スタート 地点 に 立てる よう に 、 本章 で は R という 言語 を 使い 始める に当たって の 基礎 知識 を 紹介 する こと に する 。
本章 の 後半 で は R 内 で データ を 扱う 場合 の 応用 的 な 例 も 見 て いく こと に する 。

本章 が 提供 する の は R という プログラミング言語 の 完全 な 入門 編 で は ない 。
お わかり か と は 思う が 、 そうした 導入 編 は 書籍 の たった 1 章 で カバー する に は 適さ ない 。
本章 の ねらい は R で 機械学習 に 関連 する タスク 、 特に データ の 読み込み 、 探索 、 データ クリーニング 、 分析 を 行う リーダ を 準備 する こと で ある 。
データ型 や 計算 の 概念 、 コーディング の ベストプラクティス など 、 R という 言語 の 基礎 について の 素晴らしい リソース は たくさん ある 。
そうした 概念 について は 、 ここ で 触れる ケーススタディ に 関連 の ある もの のみ 取り上げる こと に する が 、 本書 において は そうした 問題 の すべて に 触れる ものの 、 明確 な 議論 を する こと は ない 。
そうした トピック について 興味 が あれ ば 、 表 1-3 で 示し た 様々 な リソース を 参照 する こと を おすすめ する 。

これ まで R という 言語 や その 文法 に 触れ た こと が なけれ ば 、 本章 を 読み 、 まずは それ を 体験 する こと を 強く おすすめ する 。
Python や Ruby など の 他 の 高 レベル な スクリプト言語 と 異なり 、 R は 独特 で やや 厄介 な 文法 を 持っ て おり 、 その 学習曲線 は 他 の 言語 より も 急 な カーブ を 描き やすい 。
また 、 これ まで に R を 使っ た こと が あっ て も 、 機械学習 の 目的 で 使っ て い た の で なけれ ば 、 本章 は 実際 の ケーススタディ に 移る 前 に 読む 時間 を かける 価値 が ある だろ う 。

R は データ の 操作 や 分析 の ため の 非常 に パワフル な 言語 で ある 。
R は データサイエンス と 機械学習 の コミュニティ において 一気に 人気 を 集め 、 これら の コミュニティ における 事実上 の 共通 言語 と なっ た 。
データサイエンス の コミュニティ における 成功 の 理由 は 、 本節 の 冒頭 に 示し た 2つ の 引用 に よく 表れ て いる 。
R は 統計学 者 が 必要 と する 技術 の ほとんど を 標準 で 組み込ん で あり 、 そして オープンソース の 信奉 者 で も ある 統計学 者 の コミュニティ に 支え られ て いる 。

言語 が 統計 計算 用 に 設計 さ れ て いる こと は 、 多く の 技術的 利点 を もたらし て いる 。
R プロジェクト サイト の 引用 に 示さ れ て いる よう に 、 この 言語 は 多く の 高度 に 専門 的 な 統計 処理 を 基本 機能 として 提供 し 、 S 言語 へ の オープンソース の 架け橋 を 提供 し て いる 。
例えば R で 基本 的 な 線形回帰 を 行う 場合 に は 、 単に データ を lm 関数 に 渡す だけ で よく 、 そう すれ ば 回帰 の 詳細 な 情報 （ 係数 、 標準誤差 、 残差 など ） を 含む オブジェクト が 返っ て くる 。
plot 関数 という 解析 結果 を 可視 化 する ため に 設計 さ れ た 関数 も 用意 さ れ 、 結果 を plot 関数 に 渡す だけ で 、 データ を 可視 化 する こと が できる 。

Python の よう な 規模 の 大きい 科学 計算 の コミュニティ で 使わ れる 他 の 言語 において lm と 同じ 機能 を 実現 する に は 、 データ を 表現 する ため の ライブラリ （ NumPy ） 、 分析 を 行う ライブラリ （ SciPy ） 、 結果 を 可視 化 する ライブラリ （ matplotlib ） といった よう に 複数 の サードパーティ ライブラリ を 使わ なけれ ば なら ない 。
本章 で 見 て いく よう に 、 R で は こうした 高性能 な 分析 を たった 1 行 の コード で 書く こと が できる 。

さらに 、 その他 の 科学 計算 用 の 環境 と 同様 に 、 R の 基本 と なる データ型 は ベクトル で ある 。
ベクトル は 様々 に 集約 し たり 組織 化 し たり する こと が できる が 、 すべて の データ は ベクトル として 表さ れる の で ある 。
この 比較的 柔軟性 の ない データ構造 の 表現 方法 は 制限 を もたらす こと も ある が 、 言語 の 応用 範囲 を 考える と 理 に 適っ て いる と 言える 。
R において 最も 頻繁 に 用い られる データ構造 は データ フレーム と 呼ば れ 、 属性 付き の 行列 、 内部 的 に 定義 さ れ た 「 スプレッドシート 」 構造 、 あるいは 言語 の コア における リレーショナル データベース 的 な もの で ある と 考える こと が できる 。
基本的 に は 、 データ フレーム は R が 特定 の 機能性 を 付加 し た ベクトル の 列方向 集合 で あり 、 これ は 様々 な 方法 で データ を 扱う の に 適し て いる 。

その 機能 が ゆえに 、 R に は 問題 も 存在 し て いる 。
R は 大規模 な データ を 扱う こと が 難しく 、 この 問題 を 解決 する ため に 様々 な 努力 が なさ れ た の だ が 、 現在 も 深刻 な 問題 として 残っ て しまっ て いる 。
ケーススタディ の ため に その こと に 触れ て おく が 、 本書 において それ は 問題 に は なら ない 。
本書 で 利用 する データセット は 比較的 小さく 、 しかも 本書 で 構築 する システム は すべて プロトタイプ か 概念実証 の ため の モデル で ある 。
この こと を 念頭 に おく こと は とても 大事 な こと で 、 もし 、 読者 が Google や Facebook の よう な 巨大 な データ を 使っ て エンタープライズ レベル の 機械学習 システム を 構築 しよ う と し て いる の で あれ ば 、 R は 適切 な 手段 で は ない からだ 。
ただし 実際 に は Google や Facebook など の 企業 も データ を 試験 し たり 、 新しい 機械学習 の 手法 を 試し たり する 目的 で は 、 R を よく 使っ て いる 。
もし そうした 実験 の 1つ が 実 を 結べ ば 、 エンジニア は R で デザイン さ れ た 機能 を C の よう な もっと 適し た 言語 で 書き直そ う と する だろ う 。

この 実験 の 精神 は 言語 関連 の コミュニティ の 連帯感 を 高める こと に も 大いに 貢献 し て いる 。
R の 社会的 利益 は 、 この 大きく 、 そして 成長 し て いる コミュニティ の 要 で あり 、 この コミュニティ は 言語 を 使用 し たり 、 言語 に 貢献 し て いる 専門家 から 構成 さ れる 。
ボー・コーギル が 示唆 し た とおり 、 R は 統計学 者 の 専門的 ニーズ に 応え られる コンピューティング 環境 が ほしい 、 という 要望 から 生まれ た もの だ 。
そのため R の ユーザ の 多く は そうした 様々 な 分野 の 専門家 たち で ある 。
ほんの 一 例 を 挙げる だけ でも 、 数学 、 統計学 、 生物学 、 化学 、 物理学 、 心理学 、 経済学 、 政治学 など 非常 に 広い 分野 に またがる 。
こうした 専門家 の コミュニティ は R の 豊富 な 基本 機能 の 上 に 巨大 な パッケージ の 集合体 を 構築 し て き た 。
本書 執筆 時点 において 、 R の パッケージリポジトリ で ある CRAN に は 2800 以上 の パッケージ が 登録 さ れ て いる 。
本書 の ケーススタディ において は 最も 一般 的 な パッケージ を いくつ も 利用 する が 、 それでも 単に R の 可能性 の ほんの 一部分 に 触れる こと しか でき ない だろ う 。

コーギル の 発言 の 後半 部分 は 少々 不安 を 感じ させる ところ が ある が 、 これ は R の コミュニティ の 力 を 際立た せる もの な の で ある 。
これから 見 て いく とおり 、 R言語 の 文法 は 、 経験 を 積ん だ 開発者 で さえ 混乱 さ せ て しまう よう な 書き方 を 山 ほど 含ん だ とりわけ 奇妙 な もの と なっ て いる 。
しかし 粘り強い ハッカー で あれ ば 結局 の ところ そうした 言語 における 文法 上 の 困難 は すべて 克服 する こと が できる だろ う 。
統計学 者 で ない 人達 にとって 最も 困難 な 点 は 、 R の 機能 が 統計学 や 数学 的 な 手法 に 精通 し て いる こと を 前提 として 作ら れ て いる こと で ある 。
例えば lm 関数 を 利用 する 場合 に 線形回帰 について の 知識 が 全く なかっ た と し たら 、 結果 として 得 られる 係数 や 標準誤差 、 残差 を どう 探せ ば 良い か わから ない だろ う 。

しかし この 言語 は オープンソース な ので 、 この 関数 の コード を 見 て 何 が 行わ れ て いる の か を 見る こと は いつ でも できる 。
本書 の 目標 の 1つ は 機械学習 の 観点 から そうした 関数 の 多く を 探索 する こと で ある が 、 その 探索 で は R で 実現 可能 な こと の ほんの 一部 を 知る こと が できる に 過ぎ ない 。
R の コミュニティ に は 、 言語 理解 だけ で なく 、 そこ に 実装 さ れ て いる メソッド の 理解 を 助け て くれる 人たち が たくさん いる 。
表 1-1 に 、 最初 に 見 て おく の に 適し た サイト を いくつか 示す 。

本章 で は これから R の セットアップ 方法 と 使い 方 を 紹介 し て いく 。
R の ダウンロード と インストール の 方法 、 R パッケージ の インストール の 方法 を 含ん で いる 。
そして 最後 に 小さな ケーススタディ を通して 、 2 章 以降 で 用いる R の イディオム の いくつか を 紹介 し て いく 。
それ は データ の 読み込み と クリーニング 、 整理 と 分析 を 含ん で いる 。

他 の 多く の オープンソース の プロジェクト と 同様 、 R は 地域 ごと の ミラーサイト で 公開 さ れ て いる 。
まだ 自分 の マシン に R を インストール し て い ない なら 、 最初 の 一 歩 は ダウンロード する こと だ 。
http://cran.r-project.org/mirrors.html に アクセス し て 自分 に 一番 近い ミラーサイト を 選ぼ う 。
ミラーサイト を 選ん だら 、 次 は 利用 し て いる OS に 応じ て 、 適切 な ディストリビューション を 選ぶ 必要 が ある 。

R は いくつか の C と Fortran で 書か れ た 古い ライブラリ に 依存 し て いる 。
したがって 、 使用 し て いる OS の 種類 と 、 ソースコード から ソフトウエア を インストール する こと に どれ くらい 慣れ て いる か によって 、 コンパイル 済み の バイナリ を インストール する か 、 ソースコード から の インストール を 行う か を 選ぶ こと に なる 。
以下 に Windows 、 MacOSX 、 Linuxディストリビューション で の 、 ソースコード から の インストール と 、 バイナリ が 提供 さ れ て いる 場合 は その インストール 方法 を 示す 。

さらに 、 R は 32 ビット と 64 ビット の 両方 の バージョン が 提供 さ れ て いる 。
ハードウエア と OS の 組み合わせ によって 、 適切 な バージョン を 選ぶ 必要 が ある 。

Windows の 場合 は 、 R の インストーラ に は base と contrib という 2つ の 選択肢 が 存在 する 。
contrib は Windows バイナリ に CRAN に 登録 さ れ て いる すべて の R パッケージ が セット に なっ た もの で あり 、 base は 基本 的 な もの だけ を 含ん で いる 。
base インストーラ を 選択 し て 、 最新版 の コンパイル 済み バイナリ を ダウンロード しよ う 。
contrib の パッケージ を インストール する こと は R から 簡単 に でき て 、 言語 非 依存 で ある ため 、 contrib から は 何 も インストール する 必要 は ない 。
インストール は 画面 上 に 表示 さ れる 指示 に 従っ て いけ ば いい 。

通常 の Windows で あれ ば 、 この 作業 は 問題 なく 成功 する はず で ある 。
もし Windows 自体 に 何 か カスタマイズ が 加え られ て い て インストール 中 に エラー が 出 て しまっ た 場合 は 、 ダウンロード 先 の ミラーサイト に ある RforWindowsFAQ を 調べ て みよ う 。

幸運 な こと に 、 MacOSX で は R が プリインストール さ れ て いる 。
ターミナル を 起動 し て コマンドライン 上 で R と 入力 し て みよ う 。
さあ これ で 準備 完了 だ 。
しかし 中 に は 、 R コンソール を 使う のに GUI アプリケーション が あっ た ほう が いい という 人 も いる だろ う 。
その 場合 は 別途 ソフトウエア を インストール する 必要 が ある 。
MacOSX で は バイナリ の インストール と ソースコード の コンパイル という 2つ の 選択肢 が ある 。
Linux コマンドライン を 使っ た 経験 が ない ユーザ に おすすめ な の は バイナリ の インストール で 、 こちら は 単に 最新版 を http://cran.r-project.org/mirrors.html で 選ん だ ミラーサイト から ダウンロード し て 、 インストーラ の 指示 に従って インストール を する だけ だ 。
インストール が 完了 すれ ば 、 R.app （ 32 ビット ） と R 64.app （ 64 ビット ） の 両方 が アプリケーションフォルダ に 入っ て いる はず で ある 。
MacOSX の バージョン と マシン の ハードウエア 環境 によって 、 どちら を 使う か を 選ぶ 必要 が ある 。

Windows の インストール と 同様 、 バイナリ から インストール を 行う 場合 は 、 特に 何 の 問題 も 発生 は し ない はず で ある 。
R の アプリケーション を 初めて 起動 する と 、 図 1-2 で 示し た よう な コンソール が 表示 さ れる 。

もし MacOSX 環境 が カスタマイズ さ れ て い たり 、 R の インストール を 特定 の 設定 で カスタマイズ し て インストール しよう と 思う なら 、 ソースコード から の インストール を おすすめ する 。
そのため に は C と Fortran の コンパイラ が 必要 だ が 、 これら は OS に は 標準 で インストール さ れ て い ない 。
これら は MacOSX の インストーラ に 付属 し て いる MacOSXDevelopersToolsDVD から も インストール できる し 、 ミラーサイト の tools ディレクトリ から インストール する こと も できる †。

ソース から の インストール に 必要 な コンパイラ を すべて 用意 でき たら 、 多く の 他 の ソフトウエア と 同じ よう に 、 configure 、 make 、 install という 典型 的 な 手順 で インストール を 行え ば 良い 。
Terminal.app を 使い 、 ソースコード の ある フォルダ に 移動 し 、 以下 の コマンド を 実行 しよ う 。
パーミッション の 設定 によって は 、 sudo コマンド を 前 に つけ て 、 システム パスワード を 入力 し なけれ ば なら ない かも しれ ない 。
もし インストール 中 に エラー に 遭遇 し た 場合 は 、 それ が ソース から の インストール で も 、 バイナリ の インストール で あっ て も 、 ダウンロード 先 の ミラーサイト に ある RforMacOSXFAQ を 調べ て みよ う 。

MacOSX と 同様 、 Linux の 数 多く の ディストリビューション は R を インストール した 形 で 提供 し て いる 。
単純 に コマンドライン で R と 入力 すれ ば 、 R コンソール が 起動 する 。
後 は プログラミング を 始める だけ だ 。
CR AN ミラー に は いくつか の Linuxディストリビューション 用 の インストーラ が 用意 さ れ て おり 、 Debian 、 RedHat 、 SUSE 、 Ubuntu 用 の インストール 方法 も 紹介 さ れ て いる 。
これら の インストーラ を 利用 する 場合 に は 、 使っ て いる OS 用 の インストール 方法 を 注意深く 見 て おい た ほう が いい だろ う 。
なぜなら Linux で は ディストリビューション ごと に インストール 方法 に 注意 す べき 違い が 存在 し て いる からだ 。

R は スクリプト言語 で あり 、 ケーススタディ における 主 な 作業 は R コンソール 上 で 直接 何 か を 入力 する の で は なく 、 IDE か テキストエディタ 上 で 行わ れる こと に なる 。
次 の 節 で 見 て いく が 、 パッケージ の インストール など は コンソール で の 作業 が 向い て いる が 、 ほとんど の 作業 は 好み の IDE か テキストエディタ で 行い たく なる はず で ある 。

Windows と MacOSX の GUI で は アプリケーション で シンプル な テキストエディタ が 提供 さ れ て いる 。
メニュー から 「 ファイル → 新しい スクリプト 」 （ MacOSX で は 、 「 ファイル → 新規 文書 」 ） を 選ぶ か 、 ウインドウ の ヘッダ の 空 の 文書 アイコン を クリック する と 、 空 の 文書 ファイル が テキストエディタ で 開く （ 図 1-3 ） 。
読者 が ハッカー なら 、 好み の IDE や テキストエディタ が ある だろ う から 、 今後 の ケーススタディ で は その 環境 を 利用 する こと を おすすめ する 。
その 選択肢 は 多岐 に わたっ て いる し 、 ここ で 悪名 高き Emacs と Vim の 戦い に 参戦 する つもり も ない ので 、 ここ で は これ 以上 の 言及 は 避ける こと に する 。

R の 機械学習 関連 の パッケージ に は 、 きちんと デザイン さ れ 、 しっかり と 保守 、 サポート さ れ て いる もの が たくさん ある 。
本章 で 見 て いく ケーススタディ について 言え ば 、 特定 の データ を 扱っ たり 、 テキスト 分析 や 、 ネットワーク 構造 、 ウェブ ベース の API と 通信 する パッケージ など 様々 な もの を 利用 する 。
つまり 我々 が 行っ て いく 作業 は そうした パッケージ に 組み込ま れ た 機能 に 強く 依存 し て いる 。

パッケージ を R に 読み込む の は とても 簡単 だ 。
そのため に 使う 関数 は 、 library と require だ 。
この 2つ は 機能 的 に は 微妙 に 異なる が 、 本書 の 利用 目的 から する と 、 最も 大きな 違い は require が 読み込も う と し た パッケージ が マシン に インストール さ れ て いる か どう か の 真偽 値 （ TRUE か FA LSE ） を 返す こと だ 。
例えば 6 章 において は tm という テキスト の トークン 化 を 行う パッケージ を 使う こと に なる 。
この パッケージ を 読み込む ため に は 、 library と require の どちら を 使う こと も できる 。
以下 の 例 で は 、 tm の 読み込み に は library 関数 を 、 XML に は require 関数 を 使っ て いる 。
print 関数 を 使う こと で 、 パッケージ が 読み込ま れ た 後 に TRUE という 真偽 値 が 表示 さ れる こと から 、 XML が インストール さ れ て いる こと が わかる 。

XML が インストール さ れ て い なかっ たら 、 つまり require が FALSE を 返し たら 、 作業 前 に まず は その パッケージ を インストール する 必要 が ある 。

R において パッケージ を インストール する 方法 は 2つ ある 。
GUI を 使う 方法 と コンソール から install.packages 関数 を 使う 方法 で ある 。
本書 が 対象 と する 読者 層 を 考慮 し て 、 ケーススタディ 中 で は コンソール から の 操作 方法 のみ を 紹介 する が 、 GUI を 使っ て パッケージ を インストール する 方法 を 紹介 し て おく こと に も 意味 が ある 。
アプリケーション の メニュー から 、 「 パッケージ と データ 」 → 「 パッケージ インストーラ 」 と 選択 し て いく と 、 図 1-4 で 示す よう な ウインドウ が 開く 。
「 パッケージ リポジトリ 」 という ドロップダウンメニュー から 「 CRAN （ バイナリ ） 」 と 「 CRAN （ ソース ） 」 の どちら か を 選び 、 「 一覧 を 取得 」 ボタン を 押し て インストール 可能 な パッケージ の リスト を 読み込む こと が できる 。
各 パッケージ の 最新版 は 「 CRAN （ ソース ） 」 で ダウンロード が 可能 で あり 、 マシン 上 に 必要 な コンパイラ が インストール さ れ て いる 場合 は 、 この ソースリポジトリ を 利用 する こと を おすすめ する 。
表示 さ れ た 一覧 から インストール し たい パッケージ を 選ん で 「 選択 を インストール 」 を クリック すれ ば パッケージ を インストール する こと が できる 。

パッケージ を インストール する 方法 として おすすめ な の は install.packages 関数 を 使う 方法 で 、 なぜなら これ は パッケージ を どこ に 、 どの よう に インストール する か を 柔軟 に 決める こと が できる から で ある 。
install.packages を 使う こと の 大きな 利点 の 1つ は 、 CRAN から だけ で なく ローカル の ソースコード から も インストール を 行う こと が できる 点 だ 。
そうした 場合 に は 以下 の よう に し て ソースコード から インストール を 行う こと が できる 。

この 例 の 1行目 で は 、 デフォルト の 設定 を 使っ て 、 tm パッケージ を CRAN から インストール し て いる 。
tm は テキストマイニング の ため の 関数 を 提供 する パッケージ で 、 3 章 で 電子メール の テキスト を 分類 する 際 に 利用 する こと に なる 。
install.packages の 便利 な 引数 の 1つ は suggests で 、 これ は デフォルト で は FALSE に セット さ れ て いる が 、 これ を TRUE に セット する と 目的 の パッケージ の インストール に 必要 な ほか の パッケージ の ダウンロード と インストール の ため の 関数 を 教え て くれる 。
これ を 常に TRUE に セット する の が 良い だろ う 。
特に R を クリーンインストール し た 場合 に は これ が おすすめ で ある 。

パッケージ を インストール する もう 1つ の 方法 として は 、 圧縮 さ れ た ソースコード を そのまま インストール する 方法 が ある 。
前述 の 例 で は 、 RCurl パッケージ を 作者 の ウェブサイト で 公開 さ れ て いる ソースコード から 直接 インストール し た 。
setwd 関数 を 使う と R の 作業 ディレクトリ を ソース ファイル が 保存 さ れ た ディレクトリ に 設定 する こと が でき 、 その後 は すで に 示し た ソースコード から インストール を 行う コマンド を そのまま 利用 できる よう に なる 。
その 場合 に 指定 し て いる 2つ の パラメータ に 注目 し て ほしい 。
まずは repos = NULL を 指定 する こと で CRAN リポジトリ を 使わ ない こと を 関数 に 伝える 必要 が あり 、 そして ソースコード から の インストール を 示す type =" source " も 指定 する 必要 が ある 。

すで に 述べ た とおり 、 本書 の 中 で は いくつか の パッケージ を 利用 する 。
表 1-2 に 本書 で 使う すべて の パッケージ の 一覧 を 示し 、 それぞれ に 簡単 な 説明 と 詳細 情報 へ の リンク も 付記 し た 。
これら たくさん の 必要 な パッケージ の インストール を 簡単 に 行える よう に する ため に 、 簡単 な スクリプト を 作成 し た 。
この スクリプト は それぞれ の ライブラリ が インストール さ れ て いる か を チェック し 、 さ れ て い なけれ ば CRAN から インストール し て くれる 。
この スクリプト を 実行 する ため に は 、 setwd 関数 を 使っ て 作業 ディレクトリ を 本章 用 の code フォルダ に 設定 し 、 以下 の よう に source コマンド を 実行 する 。

この コマンド を 初めて 実行 する 場合 、 どの CRAN リポジトリ を 選択 する か を 尋ね られる こと に なる 。
その 選択 が 終われ ば スクリプト が 実行 さ れ 、 まだ インストール し て い なかっ た パッケージ が インストール さ れ て いく 。
そして それ が 終われ ば 、 R を 使っ て 機械学習 を 勉強 する 準備 が 整っ た こと に なる 。
しかし ケーススタディ に 進む 前 に 、 まずは 頻繁 に 使う R の 関数 と 操作 方法 を いくつか 見 て おく こと に しよ う 。

最初 に 述べ た よう に 、 新しい 技術的 スキル を 身 に つける 最善 の 方法 は 、 自分 が 解決 し たい と 思っ て いる 疑問 や 、 答え たい と 思っ て いる 質問 から 始める こと だ と 信じ て いる 。
その 作業 の 高い レベル の 目標 は 、 ケーススタディ の 学習 を より 効果的 に し て くれる こと だろ う 。
R言語 中 の 基本 概念 を 見 て いく 中 で は 、 機械学習 に 関係 し た 問題 に 対峙 する こと は ない だろ う が 、 R における データ と その 処理 方法 について の 問題 に は いくつ も 出会う こと に なる だろ う 。
ケーススタディ の 中 で 見 て いく よう に 、 しばしば データ を 分析 に 適し た 形 に 整形 、 整理 する ため に 非常 に 多く の 時間 を 割く 必要 が 出 て くる 。
分析 の 実行 に は 、 コーディング の 観点 から 言え ば 、 通常 ほとんど 時間 は かから ない 。

ここ で は 純粋 に 興味本位 の 話題 を 取り上げ て 見る こと に しよ う 。
Infochimps.com という データ サービス は 現在 、 未確認飛行物体 （ unidentifiedflyingobject ： UFO ） の 目撃 情報 に関する 文書 を 6 万 点 以上 集め た データセット を 公開 し て いる 。
この データ は 世界中 の 100年 以上 に 渡る 目撃 情報 が 収録 さ れ て いる 。
ただし 世界 的 な 目撃 情報 と 言っ て も 、 その ほとんど は アメリカ合衆国 内 の もの だ 。
その 時間的 、 空間 的 に 多様 な データ を 使っ て 、 以下 の よう な 質問 を 考える こと が できる だろ う 。
UFO の 目撃 情報 に は 季節 的 な 傾向 が ある だろ う か 。
そして そうした 傾向 が ある なら ば 、 アメリカ合衆国 の 各州 で は 違い は ある だろ う か 。
この データ は とても 内容 が 豊富 で 、 よく 整理 さ れ て おり 、 しかも 面白い ため 、 この データセット を 最初 の 一 歩 として 利用 する の は なかなか いい アイデア だ 。
しかも この データ は 練習 として も 最適 で 、 それ は こうした 大きな テキストファイル は 今後 も 本書 で 基本 的 に 利用 さ れる から で ある 。
こうした テキストファイル に は 、 ごちゃごちゃ と し た 未 整理 の 部分 が 含ま れ て いる 場合 が 多い 為 、 まずは R の 基本 的 な 関数 と 、 いくつか の 外部 ライブラリ を 使っ て 、 それら の データ を 綺麗 に 整頓 する こと に する 。
本節 で は 上 で 示し た 質問 の 答 を 得る ため の 簡単 な 分析 の 全体 の 手順 を 1つ ずつ 示し て いく 。
本章 の code フォルダ の 中 に この節 の ため の コード ufo_sightings.R が ある 。
まずは データ と 、 分析 に 必要 な ライブラリ の 読み込み から 始める こと に しよ う 。

まずは 今回 の 可視 的 分析 の 最後 の 段階 で 利用 する ggplot2 パッケージ を 読み込む 。
ggplot2 を 読み込も う と し た 場合 、 この パッケージ が plyr と reshape という 他 の 2つ の パッケージ の 読み込み を 必要 と し て いる こと が わかる はず だ 。
これら は どちら も R の 中 で データ の 操作 と 整理 を 行う ため に 利用 さ れる もの で 、 この 例 の 中 でも データ の 収集 と 整理 に plyr を 利用 する こと に なる 。

次 の ステップ として ufo_awesome.tsv という テキストファイル から データ を 読み込ん で みよ う 。
この ファイル は 本章 用 の データ の data/ufo/ディレクトリ に 格納 さ れ て いる 。
この データ は タブ を 区切り 文字 として 使っ て おり （ そのため .tsv という 拡張子 が 使わ れ て いる ） 、 その 読み込み に は read.delim 関数 を 使う 必要 が ある 。
R の 挙動 は デフォルト の 設定 を 非常 に 重要 視 する よう に なっ て いる ため 、 記述 する スクリプト 内 の それぞれ の 関数 の デフォルト の 引数 の 設定 を しっかり と 調べ て おく 必要 が ある 。
その 代わり に 、 まだ read.delim という 関数 が 存在 する こと を 知ら ず 、 タブ 区切り の データ を 読み込む ため の 関数 を 探し て いる と 仮定 し て みよ う 。
R は その 手助け を し て くれる 便利 な 関数 を いくつか 提供 し て くれる 。

最初 の 例 で は 、 関数 名 の 前 に クエスチョンマーク を つけ て いる 。
これ は 指定 さ れ た 関数 の ヘルプ ファイル を 開く もの で 、 R の ショートカット の 中 でも 大変 便利 な もの の 1つ だ 。
また ?? と :: を 組み合わせる こと によって 、 パッケージ の 中 から 特定 の 単語 を 探す こと も できる 。
クエスチョンマーク を 2つ 重ねる こと は 、 特定 の 単語 を 探す こと を 意味 する 。
この 例 で は 、 コロン を 2つ 重ねる こと で 、 「 delim 」 という 単語 が base 内 の 関数 内 に 存在 し て いる か どう か を すべて 調べ て いる 。
R で は また 、 help.search と RSiteSearch という 、 より 非 構造 的 な 検索 機能 も 提供 し て いる 。
help.search 関数 は インストール 済み の パッケージ の ヘルプ ファイル から 、 特定 の 単語 を 検索 する 関数 で あり 、 上記 の 例 で は 「 delimited 」 という 単語 を 検索 し て いる 。
また RSiteSearch 関数 を 使う と 、 R の ウェブサイト の 中 から 、 つまり ヘルプ ファイル と メーリングリスト の アーカイブ から 、 検索 を 行う こと が 可能 だ 。
ただし ここ に は R の 詳しい 説明 が 掲載 さ れ て いる わけ で も 、 本節 で 使用 する 関数 の 説明 が 載っ て いる わけ で も ない 。
単に 自分自身 で R の 基本 的 な 関数 を 調べ たい 時 に は 、 これ を 使う こと を 強く おすすめ する と いう だけ の 意味 で ある 。

この UFO に関する データ について は 、 データ を 正しく 読み込む ため に 、 read.delim に いくつか の 引数 を 指定 し なけれ ば なら ない 。
まず 最初 に 指定 する の は 、 どんな 文字 で データ が 区切ら れ て いる の か という こと だ 。
この ファイル は タブ 区切り な ので 区切り 文字 として タブ を 指定 する 。
今回 の 場合 は すべて の データ が 文字列 な の だ が 、 すべて の read.* 関数 の デフォルト の 設定 で は 文字列 を factor 型 に 変換 し て しまう 。
この クラス は カテゴリ 変数 を 意味 する もの だ が 、 今回 は 必要 ない 。
そこで stringsAsFactors = FALSE を 指定 し て この 変換 を 行わ ない よう に する 。
実際 の ところ 、 この 変換 は 基本的 に は 行わ ない よう に し た ほう が 良く 、 馴染み の ない データ を 扱う 場合 に は 特に そう で ある 。
さらに この データ は 先頭 に ヘッダ 行 を 含ん で い ない ので 、 先頭 行 を ヘッダ として 扱う という R の 標準 の 設定 を 切る 必要 が ある 。
最後 に 、 この データ 中 に は 空 の 要素 が たくさん 含ま れ て おり 、 その 場合 は NA という R の 特別 な 値 を セット する よう に する 。
空 の エントリ を NA に する ため に は 、 空白 を na.string として 明示 的 に 定義 する 必要 が ある 。

「 カテゴリ 変数 」 という 用語 は 、 観察 値 が ある カテゴリ に 属し て いる という こと を 表す データ の 種類 で ある 。
統計学 において は 、 カテゴリ 変数 は 非常 に 重要 な もの で ある の は 、 特定 の タイプ の 特定 の 観測 値 を 生み出す の は どの よう な もの か 、 という こと に 注目 する こと が 多い からだ 。
R において は 、 カテゴリ 変数 は factor 型 として 表さ れ 、 これ は 実際 に は 文字列 を 表す 数値 参照 に なっ て いる 。
この 場合 は 州 名 の 略称 の よう な 文字列 を as.factor を 使っ て カテゴリ 変数 に 変換 する 。
カテゴリ 変数 は データセット 中 の それぞれ の 州 名 の 略称 に ユニーク な 数値 の ID を 割り当てる 。
この 作業 は これから 先 何度 も 行う こと に なる 。

これ で UFO に関する データ すべて を 含む データ フレーム が 手 に 入っ た 。
これ まで データ フレーム を 扱っ た こと が ない 場合 、 特に 外部 データソース から 生成 さ れ た もの を 扱っ た こと が ない 場合 は 、 まずは その 中身 を 自分自身 の 目 で 確かめ て みる の が いい 。
head と tail という 素晴らしい 関数 が そのため に 用意 さ れ て いる 。
これら の 関数 は データ フレーム の 先頭 と 末尾 の 6 エントリ を 出力 し て くれる 。

明らか な 問題 点 として まず 挙げ られる の は 、 各 列 の 名前 が 一般名称 に なっ て しまっ て いる こと だ 。
データ の 説明 文 を 元 に 、 各 列 に もっと わかり やすい 名前 を つけ た ほう が 良い 。
データ の 各 列 に わかり やすい 名前 を つける こと は 大切 な 作業 手法 で ある 。
こう し て おく こと で 、 コード と 出力 が 、 第三者 に も 、 自分自身 にとって も 、 より わかり やすく なる からだ 。
names 関数 を 使う と データ構造 の 各 列 の 名前 の 取得 と 設定 を 行う こと が できる 。
以下 の よう に 、 データ の 説明 文 を 使っ て 各 列 の 適切 な 名前 を 表す 文字 ベクトル を 作成 し 、 データ フレーム を 唯一 の 引数 として 取る names 関数 に 渡せ ば 良い 。

head 関数 の 出力 と列 ヘッダ を 生成 する ため に 用い た ドキュメント から 、 最初 の 2 列 が 日付 で ある こと が わかっ て いる 。
他 の 言語 と 同様 に R も 日付 を 特別 な 型 として 扱う 。
そのため 日付 を 表す 文字列 を 適切 に 日付 型 に 変換 する 必要 が ある 。
そのため に は as.Date という 関数 を 使う こと が できる 。
この 関数 は 日付 を 表す 文字列 を 受け取り 、 それ を Date オブジェクト に 変換 しよ う と する 。
ここ で 扱っ て いる データ で は 日付 が YYYYMMDD という 一般 的 で は ない 形式 に なっ て いる 。
そのため as.Date に フォーマット を 表す 文字列 を 渡し 、 どう やっ て 変換 すれ ば 良い か を 教え て やる 必要 が ある 。
まずは DateOccurred という 列 から 処理 し て みよ う 。

ここ で 最初 の エラー に 遭遇 し て しまっ た 。
この メッセージ は 少々 わかり にくい の だ が 、 エラーメッセージ が 「 inputstringtoolong 」 （ 入力 さ れ た 文字列 が 長 すぎる ） という 文字列 を 含ん で いる の が わかる 。
これ は つまり DateOccurred に 含ま れる データ の 中 に 、 指定 し た 日付 フォーマット より も 長い 文字列 が 含ま れ て しまっ て いる こと を 意味 する 。
なぜ こんな こと が 起こる の だろ う か 。
今回 処理 し て いる データ は 規模 が 大きい ので 、 おそらく データ の 中 に 不正 な 形式 の もの が 含ま れ て いる の だろ う 。
不正 な データ が 含ま れ て い た 場合 に は 、 read.delim で データ を 読み込ん だ 際 に 、 こう いっ た エラー が 生じ て しまう 。
我々 は 実 世界 の データ を 扱っ て いる 。
手作業 で データ を クリーニング する 必要 も ある 。

この 問題 に 取り組む ため に は 、 まずは 正しく ない 日付 を 含む 行 を 見つけ 、 それ を どう 処理 する か を 決める 必要 が ある 。
幸運 な こと に 今回 の 場合 は 問題 と なる データ が 「 長 すぎる 」 こと が すで に わかっ て いる 。
処理 さ れる 文字列 は 常に 「 YYYYMMDDD 」 という 8 文字 で ある べき な の だ 。
したがって 問題 と なっ た 行 を 探す ため に 、 単に 8 文字 より 長い データ を 探せ ば 良い 。
最も 良い 方法 は 、 まずは データ を 眺め て 、 正しく ない データ が どんな もの な の か を 見 て から 、 何 が 間違っ て いる の か を 知る こと だ 。
今回 の 場合 は 前述 し た head 関数 を 使っ た 論理 式 の 戻り値 を 調べ て みる こと に する 。

その後 に 問題 と なる 行 を 取り除く ため に 、 ifelse 関数 を 使っ て TRUE と FALSE という 値 から なる ベクトル を 構築 し 、 与え られ た データ エントリ が 8 文字 （ TRUE ） か 、 あるいは そう で ない （ FALSE ） か を 判定 する 。
この 関数 は 一般 的 な 真偽 値 テスト に 用いる if-else の 論理 スイッチ の ベクトル 版 で ある 。
これから 先 、 R における ベクトル 化 さ れ た 様々 な 処理 を 学ん で いく こと に なる 。
これら は ベクトル の 繰り返し を 明示 的 に 行う こと と 比較 し て 、 多く の 場合 （ 常に そう と は 限ら ない が ） より 効率 的 で ある ため 、 データ を 繰り返し 処理 する 際 により 望ましい 方法 で ある 。

この 検索 を 行う ため に R の 便利 な 関数 を いくつか 利用 する 。
まずは DateOccurred と DateReported の 各 エントリ の 文字列 長 を 知る 必要 が ある 。
その 計算 に は nchar 関数 を 使う 。
その 長 さ が 8 で は なかっ た 場合 に FALSE を 返す 。
そうして 真偽 値 の ベクトル を 得る こと が でき たら 、 次 は データ フレーム の 中 の いくつ の エントリ が 正しく ない データ だっ た の か を 調べる 。
そのため に は which コマンド を 利用 し て ベクトル が FALSE で ある もの だけ を 返し 、 得 られ た ベクトル の 長 さ を 調べれ ば 良い 。
その 結果 、 正しく ない の は たった 371 個 の エントリ で ある こと が わかる 。
最も 良い 選択肢 は 、 それら の 列 を 単に 取り除き 、 無視 し て しまう こと だ 。
371 行 も の データ を 失っ て しまう こと は 危険 だ と 感じる かも しれ ない が 、 この データ は 6 万 行 以上 の データ を 含ん で いる ので 問題 が ない 為 、 単に それら の 行 を 無視 し て 、 データ の 変換 を 進める こと が できる 。

次に 行わ なけれ ば なら ない の は 場所 （ Location ） の データ の クリーニング で ある 。
head 関数 を 再度 呼び出し て みる と 、 アメリカ合衆国 内 の それぞれ の UFO 観測 地点 の 位置 は 「 都市 名 , 州 名 」 という 形式 に なっ て いる こと が わかる 。
そこで R 内蔵 の 正規表現 を 利用 し て それら の エントリ を 都市 名 と 州 名 に 分解 し 、 同時に この 形式 に 沿っ て い ない データ を 特定 する 。
今回 は アメリカ合衆国 内 の 目撃 情報 だけ に 注目 し て おり 、 その データ だけ を 取り出す 必要 が ある 為 、 後者 、 すなわち 適切 で ない データ の 特定 は 特に 重要 で ある 。

この よう な 処理 を 行う ため に 、 まずは 文字列 を 入力 として 受け取り 、 データ の クリーニング を 行う 関数 を 構築 しよ う 。
そして ベクトル 化 さ れ た apply 関数 の 1つ を 使っ て 、 位置情報 を この 関数 に かける こと に する 。

この 関数 内 で は いくつか 細かい 処理 を し て いる 。
まず strsplit コマンド を R における エラー ハンドリング を 行う 関数 で ある tryCatch で 包ん で いる 。
繰り返し に なる が 、 すべて の エントリ における 場所 の 情報 が 「 都市 名 , 州 名 」 という 形 に なっ て いる わけ で は ない 。
実際 中 に は カンマ が ない もの さえ あり 、 strsplit 関数 は 分割 に 使う 文字 が 存在 し て い なかっ た 場合 に エラー を 投げる ので 、 その エラー を キャッチ する 必要 が ある 。
今回 の 場合 は 分割 に 利用 す べき カンマ が 存在 し なかっ た 場合 は NA の ベクトル を 返し 、 この データ が 不正 で ある こと を 表し て いる 。
それから 元 の データ は 先頭 に 空白 が つい て いる ので 、 gsub 関数 （ R における 正規表現 を 利用 する 関数 群 の うち の 1つ ） を 使っ て その 空白 文字 を 取り除く 。
そして 最後 に 位置 を 示す ベクトル の 長さ が 2 で ある こと を 保証 する ため の チェック を 行う 。
アメリカ合衆国 以外 の 位置情報 の 多く は カンマ が 2 個 以上 つい て いる ので 、 strsplit の 結果 生成 さ れる ベクトル の 長さ は 2 より も 多く なる 。
その 場合 は NA ベクトル を 返し て いる 。

この 関数 を 定義 する と 同時に 、 「 list-apply 」 （ リスト に 適用 ） を 省略 し た 関数 名 で 、 これ を 使っ て Location の 列 に 入っ て いる すべて の 文字列 を 処理 する 、 lapply 関数 も 利用 する 。
すで に 述べ た よう に R における 一連 の apply 関数 群 は 非常 に 便利 だ 。
これら の 関数 は apply ( vector , function ) という 形 で 呼び出す こと が でき 、 指定 し た ベクトル を 関数 に 適用 し て その 結果 を ベクトル として 返す 。
今回 は lapply を 使っ て おり 、 これ は 結果 を 必ず リスト として 返す 。

この 例 を 見 て わかる よう に 、 R における リスト は キー 値 形式 の データ構造 に なっ て おり 、 インデックス さ れ て いる キー は 2 重 の 大括弧 で 囲ま れ 、 値 は 1 重 の 大括弧 で 囲ま れ て いる 。
今回 の ケース で は キー は 単なる 整数 値 だ が 、 リスト は 文字列 を キー として 持つ こと も できる 。
そのため に この 長い リスト を 2 列 の 行列 に 変換 し 、 その 際 都市 名 を 先頭 の 列 に する 。

リスト から 行列 に 変換 する ため に は do.call 関数 を 利用 する 。
do.call は apply 関数 と 同様 に リスト を 処理 する 関数 で ある 。
lapply と do.call は データ 操作 に は 非常 に よく 利用 する 組み合わせ だ 。
上記 で 紹介 し た 例 で は 引数 に rbind 関数 を 渡し て いる 。
この 関数 は city.state リスト の 中 の すべて の ベクトル を 「 行 ごと に 結合 」 し 、 行列 を 生成 する 。
これ を データ フレーム に 格納 する ため に 、 transform 関数 を 利用 する 。
こうして location.matrix の 1番 目 と 2番 目 の 列 から 、 USCity と USState という 2つ の 新しい 列 を 生成 する 。
そして 最後 に 、 州 の 省略 名 が エントリ によって 大文字 だっ たり 、 小文字 だっ たり と 統一 さ れ て い ない ため 、 tolower 関数 を 使っ て すべて を 小文字 に 変換 し て いる 。

データ の クリーニング に関する 最後 の 問題 は 、 「 都市 名 , 州 名 」 の 形 を し て いる に も かかわら ず アメリカ合衆国 外 の 地名 で ある エントリ で ある 。
具体的 に 言う と 、 この データ に は カナダ の UFO 目撃 情報 が いくつか 含ま れ て おり 、 これら の エントリ は 「 都市 名 , 州 名 」 の 形 を し て いる 。
幸運 な こと に カナダ の 州 の 省略 名 は 合衆国 の 州 の 省略 名 と 同じ もの は 1つ も ない 。
この こと から 、 合衆国 の 州 の 省略 名 を 集め た ベクトル を 用意 し て 、 その 中 の 項目 と 一致 する USState の エントリ だけ を 集める こと が できる 。

USState の 列 の 中 から アメリカ合衆国の州 の 省略 名 に 合致 し ない エントリ を 探す ため に は match 関数 を 利用 する 。
この 関数 は 引数 を 2つ 取る 。
1番 目 は 合致 する か どう か を 調べ たい 文字列 、 そして 2番 目 は 合致 さ せ たい 文字列 で ある 。
この 関数 は 、 第 2 引数 の いずれ か の 値 に マッチ し た エントリ の インデックス を 値 と する 、 第 1 引数 と 同じ 長さ の ベクトル を 返す 。
もし 合致 する もの が 見つから なかっ た 場合 は 、 この 関数 は 標準 で NA を 返す 。
位置情報 が アメリカ合衆国の州 名 に 合致 し ない こと を 意味 する ので 、 今回 の 場合 は どの エントリ が NA に なっ た の か という こと だけ に 注目 し て いる 。
そこで is.na 関数 を 使っ て どの エントリ が アメリカ合衆国 外 な の か を 調べ 、 その 場合 は USState を NA で リセット する 。
さらに 一貫性 を 持た せる ため に USCity に も NA を セット する 。

これ で 生成 し た データ フレーム に は 、 注目 し たい データ のみ が 残さ れ た こと に なる 。
つまり その 中 に は アメリカ合衆国 内 の UFO の 目撃 情報 しか 残っ て い ない 。
直前 の 位置情報 を チェック する 段階 で 基準 から 漏れ て しまっ た エントリ を 取り除く ため に 、 subset コマンド を 使っ て アメリカ合衆国 だけ の データ を 含む 新しい データ フレーム を 生成 する 。

これ で データ が 整理 さ れ 、 分析 を 始め られる よう に なっ た 。
前節 で は データ を きちんと 整形 し 、 これから 行う 分析 に 関係 する データ を 特定 する こと に 多く の 時間 を 割い た 。
本節 で は さらに 焦点 を 絞る ため に データ を 見 て いく こと に する 。
この データ は 2つ の 主要 な 軸 、 1つ は 場所 （ どこ で 目撃 さ れ た か ） で あり 、 もう 1つ は 時間 （ いつ 目撃 さ れ た か ） 、 を 有し て いる 。
前節 で は 場所 に 注目 し た が 、 ここ で は 時間 に 注目 し て みよ う 。
まずは summary 関数 を 使っ て DateOccurred を 処理 し 、 データ の 時間 の 幅 の 感覚 を つかん で おこ う 。

驚く べき こと に 、 この データ に は ずいぶん 古い 情報 まで 含ま れ て おり 、 最も 古い UFO 目撃 情報 は 1400年 で ある 。
この よう な 外れ値 が ある と わかっ たら 、 次に 調べ たい の は 、 目撃 情報 が どの よう な 時間 に 分布 し て いる か 、 そして すべて の 時代 を 分析 する こと に 価値 は ある の か 、 という こと で ある 。
それ を 可視 化 する 最も 手っ取り早い 方法 は ヒストグラム を 生成 する こと だ 。
ヒストグラム について は 次 章 で より 詳しく 見 て いく こと に する が 、 ここ で 知っ て おく べき こと は 、 ヒストグラム は 、 データ の 頻度 を 与え られ た 軸 で ビン † として 、 表す 方法 で ある 。
ここ で 注目 し たい 軸 は 時間 な ので 、 時間 軸 に そっ て データ を ビン に する ヒストグラム を 作る 。

ここ で 注意 し て おき たい こと が いくつか ある 。
本書 で は ここ で 初めて ggplot 2 パッケージ を 使っ て おり 、 本書 で は データ の 可視化 の ため に 今後 も ggplot 2 を 頻繁 に 利用 する 。
今回 は たった 1 行 で 記述 できる 非常 に 単純 な ヒストグラム を 生成 する だけ だ 。
まずは ggplot オブジェクト を 生成 し 、 UFO 目撃 情報 の データ フレーム を 初期化 用 の 引数 として 渡す 。
続い て 、 エステティック の x 軸 として 、 DateOccurred の 列 を 指定 する 。
これ は 頻度 情報 で あり 、 知り たい と 思っ て いる 情報 だ 。
ggplot2 を 使う 場合 は 必ず データ フレーム を 使用 する 必要 が あり 、 ggplot オブジェクト 生成 時 の 第 1 引数 は 必ず データ フレーム に なる 。
ggplot2 は レナルド・ウィルキンソン （ LelandWilkinson ） の 『 TheGrammarofGraphics 』 ［ Wil 05 ］ の R で の 実装 で ある 。
これ は つまり 、 この パッケージ が この 特定 の データ 可視化 の 哲学 を 厳守 し て いる こと を 意味 し て おり 、 すべて の 可視 化 さ れ た データ は 一連 の レイヤ として 構築 さ れる こと に なる 。
図 1-5 に 示し た この ヒストグラム で は 、 最初 の レイヤ は x 軸 の データ で あり 、 すなわち それ は UFO が 目撃 さ れ た 日付 で ある 。
続い て geom_histogram 関数 を 利用 し て ヒストグラム の レイヤ を 追加 する 。
今回 の 場合 は この 関数 の 標準 の 設定 を 利用 する が 、 今後 見 て いく 中 で 明らか に なる よう に 、 この 標準 の 設定 が 常に 最良 の 選択肢 だ と は 限ら ない 。
そして 最後 に 、 この データ は 非常 に 広い 時間 の 範囲 に 渡っ て いる ので 、 scale_x_date 関数 を 利用 し て x 軸 の ラベル の 間隔 を 調整 し 、 50年 ごと に する 。

ggplot オブジェクト を 生成 でき たら 、 ggsave 関数 を 使っ て 可視 化 し た データ を ファイル に 保存 する 。
また > print ( quick.hist ) を 実行 する こと で 画面 に それ を 表示 する こと も できる 。
可視化 の 出力 を 行っ た 時 に 警告 メッセージ が 表示 さ れ て いる こと に 注意 しよ う 。
ヒストグラム において データ を グループ 分け する 方法 は たくさん あり 、 次 章 で それ について は 詳しく 議論 する 。
しかし この 警告 文 は ggplot2 が 標準 で は どの よう に データ を グループ 分け し た の か を 知らせ て くれ て いる 。

では 可視 化 さ れ た データ を 調べ て みる こと に しよ う 。

この 結果 は あまり 意味 が ない もの に なっ て しまっ た 。
データ の 大 部分 は 1960年 から 2010年 に 集中 し て おり 、 UFO 目撃 情報 の 大 部分 は 最近 の 20年 に 集中 し て いる 。
したがって 目的 を 達成 する ため に は 1990年 から 2010年 まで の 間 の 目撃 情報 に 絞っ て み て いく の が 良い だろ う 。
外れ値 を 除外 する こと で 比較的 似 た 数値 を 比較 する こと が でき そう だ 。
先ほど 登場 し た subset 関数 を もう一度 使っ て 、 この 条件 に 合う データ フレーム を 新た に 生成 する 。
これ によって データ を クリーニング し た 際 に 取り除い た より も ずっと 多い 量 の エントリ が 捨て られ て しまう が 、 それでも なお 4 万 6 千 も の 目撃 情報 が 残っ て いる 。
違い を 確認 する ため に 、 新しい データ フレーム による ヒストグラム を 生成 し て 、 図 1-6 に 示し た 。
この サンプル の ほう が より 偏り が 生じ て いる こと が わかる 。
続い て 、 「 アメリ が 合衆国 内 の 州 によって 時期 による 目撃 情報 の 偏り は ある か どう か 」 という 一番 調べ たい 問題 に 取り組む こと が できる よう に 、 データ の 整理 を 始める こと に する 。
そのため に 「 時期 」 と は 何 か という 問題 を 考え て おか なけれ ば なら ない 。
時期 に 関係 する データ の 取得 方法 は 数多く 存在 し 、 例えば 、 週 、 月 、 四半期 、 年 など が それ に 当たる だろ う 。
その 中 で 今回 の 分析 に 最も 適し た もの は 何 だろ う か 。
DateOccurred に は UFO 目撃 情報 が 日付 として 格納 さ れ て い が 、 データ 全体 を 一貫 し て カバー し て いる わけ で は ない ため 、 これ は 考慮 し て おか なけれ ば なら ない 。
したがって 各州 の データ の 量 を 同 程度 に 集約 し て おく 必要 が ある 。
今回 の 場合 は 、 年 と 月 で それ を 行う の が 最適 で ある 。
この 集約 作業 は 、 我々 の 取り組ん で いる 問題 に も 最適 で あり 、 月 で の 集約 は 時期 による 偏り に関する 良い 情報 を 与え て くれる はず だ 。

ここ で 1990年 から 2010年 まで の 各州 で の UFO 目撃 情報 を 各 年 の 月 単位 で 数える 必要 が ある 。
まずは 新しい 列 を 追加 し 、 そこ に 年 と 月 だけ の 情報 を 格納 する 。
Date オブジェクト を strftime 関数 で 「 YYYY-MM 」 という 形式 に 変換 すれ ば いい だろ う 。
前回 と 同様 に format 引数 で 形式 を 指定 する 必要 が ある 。

今回 新しい 列 を データ フレーム に 追加 する 際 に transform 関数 を 使わ なかっ た 点 に 注意 しよ う 。
正確 に 言え ば 、 これ まで 存在 し なかっ た 列 名 を 指定 し た だけ で 、 R は 自動的 に それ を 追加 し て くれる 。
これら の データ フレーム に 新しい 列 を 追加 する 方法 は どちら も 便利 な もの で 、 状況 によって 使い分けれ ば 良い 。
続い て 各州 ごと に 各 年月 で 発生 し た 目撃 情報 の 数 を 数える 。

plyr の 一連 の 関数 群 は ここ 数年 で よく 知ら れる よう に なっ た MapReduce スタイル の データ 集約 に 似 た 動作 を する 。
これら の 関数 群 は 、 すべて の 観測 値 に対して 意味 の ある 特定 の 方法 で データ を グループ 化 し それぞれ の グループ に対して 何らかの 計算 を 行っ て から 、 その 結果 を 返す もの だ 。
今回 の タスク の 場合 は データ を 州 の 列 と 作っ た ばかり の 年月 の 列 で グループ 化 する 。
データ が グループ 化 さ れ たら 、 それぞれ の グループ の エントリ 数 を 数え て 新しい 列 に 入れる 。
そして ここ で は nrow 関数 を 使っ て グループ の 数 だけ の 行 数 に し て いる 。
これ で 各州 ごと の 年月 単位 で の UFO 目撃 件数 を 得る こと が でき た 。
しかし head を 呼び出し て みる と 、 値 が 欠け て いる ところ が たくさん ある という 問題 を 抱え て いる こと が わかる 。
例えば アラスカ州 （ AK ） において は 1990年 に 1月 、 3月 、 5月 に それぞれ 1回 ずつ UFO が 目撃 さ れ て いる こと が わかる が 、 2月 や 4月 の エントリ が 存在 し て い ない 。
それら の 月 に は 一 度 も 目撃 さ れ なかっ た こと が 推測 できる が 、 この データ に は 目撃 が なかっ た こと を 示す エントリ が 含ま れ て い ない ので 、 目撃 が なかっ た 月 に 0 を 入れる よう に し なけれ ば なら ない 。

そのため に は 注目 し て いる 全 期間 の 年月 単位 の ベクトル が 必要 に なる 。
それ を 使っ て それぞれ の 年月 が すでに データ に 存在 し て いる か を 調べ 、 もし 存在 し て い なかっ た 場合 は 0 を 追加 する 。
そのため に 、 seq.Date 関数 を 使っ て 日付 の シーケンス を 生成 する 。
そして その 形式 を 自分 の データ フレーム の 形式 に 合わせる 。
生成 し た date.strings ベクトル を 使っ て 、 すべて の 州 で の すべて の 年月 の エントリ を 含む 新しい データ フレーム を 生成 する 必要 が ある 。
この データ と UFO 目撃 情報 の データ を 照合 する わけ だ 。
これ まで と 同様 に lapply 関数 を 使っ て 列 を 生成 し 、 do.call 関数 で 行列 に 、 そして データ フレーム へ と 変換 する 。

新しく 生成 し た states.dates データ フレーム は 、 すべて の 年 の すべて の 月 と 州 の 組み合わせ を 含ん で いる 。
アラスカ州 の 1990年 の 2月 や 4月 の エントリ が 存在 し て いる 点 に 注目 しよ う 。
そして UFO 目撃 情報 に 存在 し て い なかっ た 0 を 追加 する ため に この データ と 元 の データ フレーム を 組み合わせる 必要 が ある 。
そのため に は merge 関数 と よば れる 、 2つ の 順序 付き の データ フレーム を 共通 の 列 によって 1つ に まとめ て くれる 機能 を 持つ 関数 を 用いる 。
今回 の 場合 は 州 の 省略 名 で アルファベット順 に 並べ られ 、 年月 でも 並べ られ た 2つ の データ フレーム を 1つ に まとめる こと に なる 。
この 関数 で は 、 どの 列 で データ を まとめる か を 指定 し なけれ ば なら ない 。
by.x と by.y という 引数 を 使っ て それぞれ の データ フレーム における 組み合わせ に 利用 する 列 の 名前 を 指定 する 。
そして all という 引数 に TRUE を 指定 する こと で 、 この 関数 は 片方 に 存在 し なかっ た エントリ が あっ た 場合 に 、 NA を 使っ て データ を 補完 し て くれる よう に なる 。
今回 の 場合 は UFO の 目撃 情報 の なかっ た エントリ の V1 列 が NA に セット さ れる 。

データ の 集約 の 最終 段階 は 簡単 な 後処理 で ある 。
まず 新しく 生成 さ れ た all.sightings の 列 名 を より わかり やすい もの に する 。
これ は 以前 に すで に 行っ た の と 全く 同じ 方法 で 行う こと が できる 。
次に 目撃 情報 件数 が NA に なっ て いる エントリ を is.na 関数 で 調べ て 0 に 変換 する 。
最後 に 、 YearMonth と State の 列 を 適切 な 型 に 変換 する 。
以前 作成 し た date.range ベクトル と rep 関数 を 利用 し て 、 与え られ た ベクトル を 繰り返し て いる 新しい ベクトル を 生成 し 、 年月 の 文字列 を 適切 な Date オブジェクト に 変換 する 。
繰り返す が 、 Date オブジェクト なら 2つ の 日付 を 簡単 に 比較 する こと が できる が 、 文字列 の 場合 は そう は いか ない 為 、 日付 情報 は 文字列 より も Date オブジェクト として 保持 し た ほう が 良い 。
同様 に 州 の 省略 名 は 文字列 で は なく カテゴリ 値 に し て おい た 方 が 良い ので factor 型 に 変換 する 。
この factor 型 や その他 の R の データ型 について は 次 章 で より 詳しく 見 て いく こと に する 。

さあ これ で データ を 可視 化 し て 分析 する 準備 が 整っ た 。

今回 は データ を 可視 化 し て 分析 する こと だけ で 、 調べ たい 問題 に 取り組む こと に する 。
これ 以降 は 数値 による 分析 と 可視化 による 分析 を 組み合わせる こと に なる が 、 今回 は R の コア と なる プログラミングパラダイム の 紹介 が 目的 で ある ため 、 可視化 による 分析 に 留める こと に する 。
しかし 、 すで に 行っ た ヒストグラム による 可視化 と は 異なり 、 ggplot2 を より きちんと 調整 し 、 レイヤ を より きちんと 構築 し て いく こと に する 。
それ によって 州 による 時期 的 な 偏り は ある の か という 問い を 直接 解き明かし 、 しかも より 専門 的 な 可視化 が 可能 に なる 。

可視化 の 第一歩 は 常に 、 データ フレーム を 第 1 引数 として ggplot オブジェクト を 生成 する ところ から 始まる 。
今回 は この 直前 に 生成 し た all.sightings データ フレーム を 利用 する 。
ここ でも また データ を プロット する ため に は 、 エステティック レイヤ を 生成 する 必要 が あり 、 今回 の 場合 は x 軸 は YearMonth で あり 、 y 軸 は Sightings に なる 。
続い て 州 ごと の 時期 による 偏り を 表示 する ため に 、 各州 の 線 を プロット する 。
おそらく 山あり谷あり の 起伏 が 観測 さ れ 、 各州 、 そして 観測 期間 を通して の 変化 が 見 られる はず だ 。
そのため に geom_line 関数 を 使っ て 、 色 を darkblue に 設定 する こと で 、 その 可視化 の 結果 が より 見やすい もの に なる よう に する 。

今回 の 作業 の 中 で 見 て き た よう に 、 この UFO の データ は かなり 豊富 で あり 、 アメリカ合衆国 全体 において 長い 期間 を カバー し て いる 。
この こと から 、 データ を 各州 ごと に 分け て 可視 化 する こと も 、 それら を 他 の 州 と 比較 する こと も 考える 必要 が ある 。
もし すべて の データ を 1つ の パネル の 中 に プロット し て しまう と 、 偏り を 識別 する の は 難しく なっ て しまう だろ う 。
それ を 確かめる ため に 、 直前 に 示し た コード の 最初 の 行 の color =" darkblue " を color = State に 変え て 実行 し 、 コンソール から > print ( state.plot ) と 入力 し て みよ う 。
これ より も 良い 方法 は 、 各州 の データ を 別々 に プロット し て 、 それ を 比較 し やすい よう に 格子 状 に 並べ て 表示 する こと だ 。

複数 の プロット を 生成 する ため に は facet_wrap 関数 を 使い 、 State 変数 を 使っ て パネル が 生成 さ れる よう に 指定 し て おく が 、 この 値 は 必ず カテゴリ 変数 など の factor 型 で なけれ ば なら ない 。
プロット を 格子 状 に 並べる ため に 、 格子 の 縦 と 横 の 数 も 明示 的 に 指定 し なけれ ば なら ない 。
生成 さ れる プロット の 数 が 50 で ある こと が わかっ て いる 為 、 これ は 今回 の ケース で は 簡単 だ 。

ggplot2 パッケージ に は 多く の プロット 用 テーマ が 用意 さ れ て いる 。
標準 の テーマ は 最初 の 例 で 利用 し た もの で 、 灰色 の 背景 と 濃い 灰色 の 格子 線 に なっ て いる 。
これ は 単に 好み の 問題 で は ある が 、 白 の ほう が データ の 細かい 違い が わかり やすい 為 、 ここ で は プロット の 背景 を 白 に する 。
白い 背景 と 黒い 格子 線 で プロット を 生成 し て くれる 、 theme_bw レイヤ を 追加 する 。
ggplot2 の 設定 に もっと 慣れ て き たら 、 もっと 自分 の 好み に 合う もの を 探し て みる こと を おすすめ する 。

残り の レイヤ は この 可視化 の 結果 が より 専門 的 な イメージ に なる よう に 調整 を 行う ため の もの だ 。
これら は 厳密 に は 必要 で は ない が 、 こうした 細かい 点 に 注意 を 払う か どう か で 、 素人 くさい プロット と 専門 的 な イメージ の データ 可視化 を 見分ける こと が できる 。
scale_color_manual 関数 は 「 darkblue 」 という 文字列 を 指定 する と 、 ウェブセーフカラー の darkblue に 一致 さ せる ため に 使う 。
同じ こと を 何度 も 書か なけれ ば なら ない と 感じる かも しれ ない が 、 これ が ggplot2 の 設計 の 根幹 な の で あり 、 ggplot2 では 色 など も 明示 的 に 定義 し なけれ ば なら ない 。
実際 のところ g g plo t2 は 異なる データ の 型 や カテゴリ を 見分ける ため に 色 を 使っ て いる という 思想 を 持っ て おり 、 その 結果 factor 型 が 色 の 指定 に 使わ れる こと が 多い 。
今回 は 文字列 を 使っ て 色 を 明示 的 に 指定 し て いる ので 、 scale_color_manual 関数 を 使っ て その 文字列 の 値 を 定義 し なけれ ば なら ない 。

前 に 述べ た よう に 、 scale_x_date を 使っ て グラフ の 中 の 主要 な 格子 線 を 指定 し て いる 。
この データ は 20年 の 範囲 を 持っ て いる ので 、 5年 ごと に 線 を 引く の が 良い だろ う 。
そして メモリ の ラベル を 4 桁 の 年数 に セット する 。
次に xlab と ylab という 関数 を 使っ て x 軸 の ラベル を 「 Time 」 に 、 y 軸 の ラベル を 「 NumberofSightings 」 に それぞれ セット する 。
最後 に opts 関数 を 使っ て プロット に タイトル を 付ける 。
opts 関数 に は オプション が たくさん 用意 さ れ て おり 、 その うち の いくつか は 別 の 章 で 触れ て いる が 、 用意 さ れ た オプション の 数 は それ より も ずっと 多く 、 すべて を 触れる こと は 本書 の 範囲 を 越え て いる 。

これ で すべて の レイヤ が 構築 さ れ 、 ggsave を 使っ て 画像 を 生成 し 、 データ を 分析 する 準備 が 整っ た 。

この 分析 （ 図 1-7 参照 ） から 数 多く の 面白い こと が わかっ て くる 。
カリフォルニア州 （ CA ） と ワシントン州 （ WA ） が 、 他 の 州 と 比較 し て UFO の 目撃 情報 の 数 が 大きく かけ離れ て いる こと が わかる 。
この 2つ の 州 を 比べ て みる と さらに 興味深い 違い が 見て取れる 。
カリフォルニア州 で は UFO 目撃 情報 の 報告 数 は 特に 法則 は ない よう に 見える が 、 1995年 から 着実 に 上昇傾向 に ある 一方 で 、 ワシントン州 で は 時期 による 偏り は 期間 を通して 顕著 で あり 、 その 主たる 変動 は およそ 1995年 から 始まっ て いる 。

その他 に も 、 多く の 州 で 突然 UFO 目撃 情報 の 報告 数 が 一時的 に 急激 に 上昇 し て いる の が わかる 。
例えば アリゾナ州 （ AZ ） 、 フロリダ州 （ FL ） 、 イリノイ州 （ IL ） 、 モンタナ州 （ MT ） で は 1997年 中頃 に そうした 上昇 が 見 られ 、 ミシガン州 （ MI ） 、 オハイオ州 （ OH ） 、 オレゴン州 （ OR ） で は 1999年 後半 に 同様 の こと が 起こっ て いる 。
その 中 で 、 ミシガン州 と オハイオ州 だけ が 地理的 に 近い 関係 に なっ て いる 。
もし これら を 地球 外 から の 訪問者 で ある と 信じ ない の で あれ ば 、 他 に どんな 説明 が 可能 だろ う か 。
おそらく ミレニアム が 終わろ う と する 中 で 空 を 見上げる 人 の 数 が 増加 し た こと が 、 間違っ た 目撃 情報 を 増加 さ せ た 原因 かも しれ ない 。

しかし 、 宇宙 から の 訪問者 が 定期的 に 地球 を 訪れ て いる という 考え方 を 受け入れ て いる なら 、 さらに 面白い 証拠 を 見る こと が できる 。
実際 、 アメリカ合衆国 内 の 多く の 州 の 目撃 情報 において 、 驚く べき こと に 同様 の 規則 性 が あり 、 それら は 地域 的 な 集合 を 伴っ て いる 。
それ は あたかも それら の 目撃 情報 に 本当に 意味 の ある パターン が 存在 する か の よう で ある 。

本章 で 行っ た 調査 は R という 言語 を 徹底的 に 使いこなし た もの で は 全く ない 。
今回 は 単に 、 データ の 読み込み 、 クリーニング 、 整理 、 分析 という R の いくつか の パラダイム を 紹介 し た に 過ぎ ない 。
本章 で は これから 、 新た な 事柄 を 紹介 し つつ 、 これら の 機能 や 過程 の 多く を もう一度 見 て いく こと に なる 。
ただ その 前 に 、 R について もっと 学習 し て おく こと に 興味 が 有る の で あれ ば 、 そのため の 情報 は 数多く 存在 し て いる 。

次 の 章 で は 探索 的 データ 分析 を 見 て いく こと に する 。
本章 で 行っ た ケーススタディ において も データ の 探究 が 多く 含ま れ て い た が 、 比較的 簡単 に 流し て しまっ て い た 。
次 の 章 で は データ の 探究 について より 慎重 に 考え て いく こと に する 。

データ を 扱う 場合 に 分析 を 探索 と 確証 という 2つ の 異なる 部分 に 分解 し て 考える こと は 常に 有益 で ある 。
探索 的 データ 分析 と 確証 的 データ 分析 の 違い について は 、 著名 な 人物 で ある ジョン・テューキー †（ 彼 は 実用 的 な データ 分析 の ため に シンプル な ツール を デザイン する こと の 重要性 を 主張 し た ） の 言葉 を 借りる こと に しよ う 。
彼 に よれ ば 、 データ 分析 における 探索 による 手法 と は 表 による 要約 と 可視化 表現 により データ の 中 の 隠さ れ た パターン を 探し出す こと で ある 。
本章 で は R が 提供 する 、 データ を 数 的 に 要約 する ため の 基本 的 な 手法 を 紹介 し 、 その 結果 を どう 読み解く か を 解説 する 。
その後 に R に 含ま れる データ を 可視 化 し て 表現 する 手法 の いくつか を 紹介 し 、 同時に しっかり と 覚え て おく べき 基本 的 な 可視化 手法 の パターン を 簡単 に 紹介 する 。
しかし 最初 の データセット を 見 て いく 前 に 、 データ を 探索 する 際 に は 必ず 出会っ て しまう 危険性 について 警告 し て おく 必要 が ある だろ う 。
それ は 、 実際 に は 存在 し て い ない パターン を 見つけ て しまう こと が ある という もの だ 。

人間 の 心 という もの は 世の中 に 存在 する パターン を 見つける よう に デザイン さ れ て おり 、 偶然 の 組み合わせ を パターン で ある と 認識 し て しまう こと が ある 。
人々 が 雲 を 数 秒間 見 た だけ で 、 そこ に 何らかの 形 を 簡単 に 見つけ られる こと は 、 統計学 の 学位 を 持た なく て も 理解 できる だろ う 。
シェイクスピア の 芝居 の よう な ごく ありふれ た テキスト の 中 に も 隠さ れ た メッセージ が ある と 確信 し て いる 人 も 数多く いる 。
人間 という もの は 注意深く 厳密 な パターン だけ を 発見 できる よう に は でき て い ない 為 、 データ 分析 における 探索 的 な ステップ は 独立 し て 存在 する こと が でき ない 。
探索 的 な ステップ に は 確証 的 な ステップ が 無く て は なら ない の で ある 。
確証 的 データ 分析 の 考え方 は 、 煩雑 で あり 、 とき に 無法地帯 で も ある 探索 的 データ 可視化 の 世界 を 歩き 、 その 世界 の 信念 を 浄化 する ため に 行う 、 いわば 精神衛生上 の ルーチン で ある 。

確証 的 データ 分析 で は 探索 的 データ 分析 より も 多く の 数学 を 用いる ため 、 本章 で は 探索 の ため の 手法 だけ に 注目 する 。
これ は 実際 に は データ の 数値 による 要約 と 標準 的 な 可視化 の ため の 手法 に 着目 する こと を 意味 し て いる 。
ここ で 言う 数値 による 要約 と は 統計 コース の 入門 に 出 て くる もの で 、 平均値 と 最 頻 値 、 百 分位数 （ パーセンタイル ） と 中央値 、 標準偏差 と 分散 など が それ に あたる 。
我々 が 用いる 可視化 の 手法 は 「 統計学 入門 」 といった 名前 の 授業 で 学習 する で あろ う 最も 基礎 的 な 手法 の うち に 含ま れる もの で 、 ヒストグラム 、 カーネル密度推定 、 散布図 など で ある 。
我々 は 、 こうした 基礎 的 な 可視化 の 手法 は 正しい 評価 を 受け て い ない と 考え て おり 、 こうした 基礎 的 な ツール を 使う だけ でも データ から たくさん の こと を 知り うる 場合 が 多く ある こと を 知っ て もらい たい と 考え て いる 。
より 洗練 さ れ た 手法 も 本書 の 今後 の 章 で 登場 する が 、 データ 分析 の 直観 は こうした 単純 な 手法 を 使う 中 で 培わ れる 。

データ を 探索 する ため に 利用 する 基礎 的 な 手法 を 紹介 する 前 に 、 「 データ 」 という 言葉 を どういう 意味 で 使う の か について 確認 を し て おこ う 。
データセット という 言葉 について 本当に 理解 する ため に は 、 多く の 重要 な 質問 を し なく て は なら ない 為 、 「 データ 」 という 言葉 が 意味 する 可能 性 の ある 定義 を すべて 述べる ため に は 、 本 一 冊 分 の 記述 が 必要 に なっ て しまう 。
例えば 入手 し た データ が どの よう に 生成 さ れ た もの か を 知り たい だろ う し 、 その データ が 本当に 調べ たい こと を 調べる ため の 母集団 を 代表 し て いる データ で ある と 合理 的 に 期待 できる もの な の か どう か も 知り たい だろ う 。
アマゾン 先住民 の 結婚 の 記録 から その 社会構造 について 多く を 学ぶ こと が でき た として も 、 その 過程 で 他 の 文化 民族 に 適用 できる こと を 学ん だ か どう か は わから ない 。
データ の 解釈 に は その データ の 由来 について の 何 か を 知る 必要 が ある 。
相関関係 から 因果関係 を 分離 する たった 1つ の 方法 は 多く の 場合 、 利用 し て いる データ が 実験 的 に 生成 さ れ た もの な の か 、 それとも 実験 によって 生成 さ れ た データ が なかっ た ため に 観察 と 記録 だけ によって 生成 さ れ た もの な の か を 知る こと で ある 。

この 種 の 問題 は いずれ 読者 に も 学ん で ほしい 興味深い 問題 で は ある が †、 本書 で 利用 する データセット において は この 問題 は 完全 に 回避 する 予定 で ある 。
我々 の 目的 の ため 、 データ 分析 の 微妙 な 哲学的 問題 は 、 機械学習 の 手法 を 使お う と し て いる 対象 で ある 予測 問題 から 完全 に 分離 可能 で ある と 扱う こと に する 。
実用 性 の 観点 から 、 本書 で は これから 以下 の よう な 定義 を 用いる こと に する 。
「 データセット 」 と は 数値 と 文字列 から 成る 巨大 な 表 データ で あり 、 それぞれ の 行 は 実 世界 の 1つ の 観察 結果 を 表し 、 各行 で 現れ た 観察 結果 において 測定 さ れ た 1つ 1つ の 属性 を 各 列 で 表す 。
すでに データベース の 知識 が 少し でも あれ ば 、 この データ の 定義 は データベース の テーブル の 構造 に関する 理解 と かなり 近い はず だ 。
もし データセット が 単一 の テーブル に は 実際 なら ない という こと を 心配 し て いる の で あれ ば 、 SQL の JOIN と 似 た 働き を する R の merge や 、 その他 すでに 紹介 し た 手法 を 使っ て 単一 の テーブル と なっ た データセット を 生成 し た もの と 考えれ ば 良い 。

これ を 「 矩形 データモデル 」 と 呼ぶ こと に しよ う 。
これ が 相当 な 単純 化 で ある こと は あきらか だ が 、 これ によって データ 分析 の 多く の 重要 な 点 を 視覚 的 に 明らか に し 、 それ によって 抽象 的 な 物事 が より はっきり 見える こと が 期待 できる 。
そして さらに 「 矩形 データモデル 」 に は それ 以外 の 利点 も ある 。
これ によって 純粋 な 数学 的 な 手法 だけ で なく 、 データベース 的 な 手法 を 自由 に 利用 できる よう に なる 。
行列 について あまり 詳しく ない こと を 危惧し て いる の で あれ ば 、 その 心配 は 無用 だ 。
本書 で は 行列 の こと を 単なる 2次元 配列 や 大きな 表 データ で ある と 考えれ ば いい 。
2次元 配列 を 使っ て いる と 仮定 し て いる 限り 、 処理 の 際 に は 実際 に 行わ れ て いる 数学 的 処理 を 深く 考える こと なく 、 強力 な 数学 的 手法 を 利用 する こと が できる 。
例えば 9 章 で は 行列 演算 を 簡単 に 紹介 し て おり 、 そこで 紹介 し て いる 処理 は すべて 行列 演算 の 観点 から 紹介 しよ う と し て いる が 、 それ は 近年 Netflix 賞 によって 有名 と なっ た 標準 線形回帰 モデル 、 あるいは 最新 の 行列 因子 分解 の 手法 な の で ある 。

2次元 データ 、 テーブル 、 および 行列 を 相互 変換 し て 利用 する ため 、 本書 の 中 で は それら の 用語 が 混在 する こと に なる が 、 これ について は 我慢 し て ほしい 。
どの よう な 語彙 を 使う に せよ 、 本書 において データ について 語る 際 に は 表 2-1 の よう な もの を 想定 し て いる こと を 覚え て い て くれれ ば 良い 。

データ が 矩形 として 構成 さ れ て いる ため 、 これから 行い たい 作業 について 想像 する の は かなり 簡単 だ 。
数値 データ の 要約 は テーブル 上 の すべて の 行 を 非常 に 少ない 行 数 、 その 多く は データセット 内 の 各 列 に対して 1つ の 値 に 削減 し て くれる 。
この 種 の データ の 要約 の 例 を 図 2-1 に 示す 。

数値 の 要約 と は 対照的 に 、 1つ の 列 の 内容 の 可視化 は ある 特定 の 列 の すべて の 行 の データ を 1つ の 画像 に 要約 する 。
単一 の 列 の 視覚 的 要約 の 例 を 図 2-2 に 示す 。

特定 の 単一 の 列 だけ を 分析 する の に 利用 できる 手法 だけ で なく 、 データセット 中 の 複数 の 列 間 の 関係 を 理解 する ため に 利用 できる 手法 も 数多く 存在 する 。
例えば テーブル 中 の 2つ の 列 の 間 の 相関 を 計算 する と 、 その 2つ の 列 の 関係 の 強 さ を 要約 し た 1つ の 数値 を 算出 する こと が できる 。
その 例 を 図 2-3 に 示す 。

他 に も たくさん の 手法 が 存在 する 。
列 の ペア を 関連付ける 以外 に も 、 データセット の 冗長性 が 高い 場合 、 列 の 数 を 減らし たい はず だ 。
データセット 中 の 複数 の 列 数 を 、 少ない 数 の 列 数 、 あるいは たった 1つ の 列 に 置き換える こと は 次元 削減 と 呼ば れ て おり 、 次元 削減 について は 8 章 で 解説 する 。
次元 削減 の 技術 で どんな こと が 可能 に なるか について の 例 を 図 2-4 に 示す 。

図 2-1 から 図 2-4 まで の 例 から わかる よう に 、 要約統計量 と 次元 削減 は 反対 の 方向性 を 示し て いる 。
要約統計量 は データセット 中 の すべて の 列 が 単一 の 列 に し た 時 に どの よう な 振る舞い に なる か を 示し 、 次元 削減 は データセット 中 の すべて の 列 を 少ない 数 の 、 それぞれ の 列 が 異なる 値 を 持つ 列 に 置き換える 。
山 の よう な データ を 即時 に 理解 可能 な もの に 変換 し て くれる ため 、 データ を 探索 する ため に は どちら の アプローチ も 有用 で ある 。

新しい データ を 入手 し たら 、 それ を 使っ て 何 か を 行う 前 に 、 まずは その テーブル の 各 列 が 何 を 表し て いる の か を 調べる べき だ 。
データセット 中 の すべて の 列 の 簡単 な 説明 を 渡さ れ て いる かも しれ ない という 理由 から 、 この 情報 を データ辞書 と 呼ぶ こと を 好む 人達 も いる 。
例えば 表 2-2 で 示す よう な 何 も ラベル が 付け られ て い ない データ が 与え られ た と しよ う 。

識別 を 可能 に する 何らかの 情報 なし に は 、 これら の 3 列 の 数値 が 何 を 意味 し て いる の か を 知る こと は 非常 に 難しい 。
まず 開始 点 として 考える べき なのは 各 列 の データ型 を 見極める こと だろ う 。
最初 の 列 は 実際 に は 文字列 だ が 、 0 と 1 だけ で 構成 さ れ て いる よう に 見える 。
1 章 の UFO の 例 で は 、 データ を 入手 し た 時 に すぐ に すべて の 列 に ラベル付け を 行っ た 。
入手 し た データセット に ラベル が つい て い なかっ た 場合 、 R に 組み込ま れ て いる 型 判別 の 関数 の いくつか を 使う こと が できる 。
それら の うち の 最も 重要 な 3つ の 関数 を 表 2-3 に 示す 。

先 に 進む にあたって それぞれ の 列 の 基本 的 な 型 情報 を 得る こと は 、 R の 関数 が 、 入力 さ れ た データ の 型 に 応じ て 処理 を 変える こと が しばしば ある ため 、 非常 に 重要 で ある 。
現在 注目 し て いる データセット に 文字列 として 格納 さ れ て いる 0 と 1 は 数値 に 変換 し ない と 、 R の 組み込み 関数 を 使う こと が でき ない が 、 もし それ 以外 の いくつか の R の 組み込み 関数 を 利用 する ため に は 、 factor 型 に 変換 する 必要 が ある 。
こうした データ型 を 行き来 する 傾向 は 、 機械学習 において カテゴリ の 区別 を 行う 場合 の 一般 的 な 習慣 から き て いる 部分 が 少なからず ある 。
ラベル や カテゴリ の よう に 働く 変数 として 、 変数 の 多く が 0 と 1 に 符号 化 さ れ て いる 。
これら の 数値 を 真偽 値 として 扱う こと が できる 。
例えば 0 は 電子メール が スパム で は ない こと を 、 1 は その 電子メール が スパム で ある こと を 示す といった 具合 だ 。
この 物事 の 定性的 な 性質 を 表す 特徴 的 な 0 と 1 の 使い方 は 、 機械学習 や 統計学 において ダミー コーディング と 呼ば れる 。
ダミー コーディング の システム は R の ファクター によって 扱わ れ 、 明示 的 な ラベル を 使う こと で 定性的 な 属性 を 表し て いる

R における ファクター は ラベル と 考える こと が できる が 、 この ラベル は 内部 的 に は 数値 に 符号 化 さ れ て いる 。
プログラマ が ラベル に アクセス する 場合 、 数値 は 文字列 の インデックス 付き 配列 において 特定 さ れる 文字列 の ラベル に 変換 さ れる 。
なぜなら R は 数値 符号化 を 内部 的 に 行う ため 、 R の ファクター の ため に ラベル を 数値 に 変換 する 単純 な 試み は おかしな 結果 を 生ん で しまう からだ 。
それ は ファクター の ため に ラベル に 結び付け られ た 数値 で は なく 実際 の 符号化 スキーム による 数値 を 得 て しまう から で ある 。

表 2-4 から 表 2-6 は 同じ データ 示し て いる が 、 それぞれ が 異なる 符号化 スキーム で 表現 さ れ て いる 。

表 2-4 で は 、 IsSpam は R の ファクター として 直接 扱わ れ て いる が 、 これ は 定性的 な 区別 を つける ため の 方法 の 1つ だ 。
実際 に 、 これ は ファクター 、 あるいは 文字列 として 読み込ま れる が 、 これ は 読み込み に 利用 する 関数 に 依存 する （ 詳しく は 1 章 で 紹介 し た stringsAsFactors パラメータ を 参照 の こと ） 。
新しい データセット を 取り扱う 場合 は いつも 、 それぞれ の 列 を R で どの よう に 扱う か を 決め た 後 、 値 が ファクター 、 あるいは 文字列 として 適切 に 読み込ま れ た か を 確認 し なけれ ば なら ない 。

もし 適切 な データ型 に 確信 が 持て ない 場合 、 まずは 文字列 として 読み込む ほう が 良い 結果 を 生む 場合 が 多い 。
文字列 を ファクター へ と 後で 置換 する こと は いつ でも できる 。

表 2-5 において 、 IsSpam は まだ 定性的 な 概念 で ある が 、 これ は 真偽 値 を 表す 数値 として 符号 化 する こと が できる 。
1 は IsSpam が 真 、 0 は IsSpam が 偽 で ある 。
この 形式 の 数値 コーディング は 実際 、 いくつか の 機械学習 の アルゴリズム に 必要 な もの で ある 。
例えば 次 章 で 解説 する glm という ロジスティック回帰 と 分類 に 用いる R の 標準 関数 で は 、 与え られる 変数 が ダミー コード に なっ て いる と 仮定 し て 処理 が 行わ れる 。

最後 の 表 2-6 は 同じ 定性的 な 概念 を 数値 で 符号 化 し た 別 の 例 で ある 。
この 符号化 で は 、 1 と 0 の 代わり に ＋1 と −1 を 使っ て いる 。
この スタイル の 定性的 な 符号化 手法 は 物理学者 の 中 で は 非常 に 人気 が ため 、 機械学習 を さらに 勉強 し て いく 中 で 、 いつか は この スタイル に 出会う こと だろ う 。
本書 で は 、 この スタイル の 記法 は 完全 に 排除 し て ある が 、 これ は 、 同じ 分類 を する のに 複数 の 方法 を 混ぜ て 使っ て しまう と 、 無用 の 混乱 を 招く こと に なる と 考え て いる からだ 。

各 列 の データ型 を 決定 し た として も 、 各 列 が 何 を 意味 し て いる の か について は わから ない だろ う 。
数値 で 構成 さ れ 、 ラベル の つい て い ない 表 が 何 を 表し て いる か を 決める こと は 非常 に 難しい 場合 も ある 。
以前 紹介 し た 表 を もう一度 見 て みよ う 。
同じ 表 を 表 2-7 に 示す 。

以下 の こと を 明らか に し た 場合 、 この 表 について どれ くらい の こと を 理解 できる だろ う か 。
（ a ） それぞれ の 行 は 一人 ずつ の 人 を 表し て いる 。
（ b ） 最初 の 列 は その 人 が 男性 （ 1 ） か 、 女性 （ 0 ） か を 表し て いる 。
（ c ） 2番 目 の 列 は その 人 の 身長 を インチ で 表し て いる 。
（ d ） 3番 目 の 列 は その 人 の 体重 を ポンド で 表し て いる 。
正しい 文脈 を 与え た 途端 、 これら の 数値 は 突然 と し て 意味 を 持つ よう に なり 、 それら を どの よう に 考えれ ば 良い か が わかっ て くる はず だ 。

しかし 悲しい か な 、 この よう な 説明 は 、 とき に 与え られ ない こと が ある 。
そうした 場合 に は 、 Google の 検索 を 強力 な 後ろ盾 と し た 人間 の 直観 が 、 提案 できる 唯一 の 手法 で ある 場合 が 多い 。
ありがたい こと に 、 意味 が わから ない 列 に 出会っ て も 、 数値 要約 や 視覚 的 な 要約 を いくらか 行う こと で 、 直観 による 判別 を 行い やすく なる 場合 も ある 。

新しい データセット を 理解 する ため の 最初 の 一 歩 として 適切 な もの の 1つ に 、 各 列 の 単純 な 数値 要約 を 計算 し て みる という 方法 が ある 。
R は それ に 非常 に 適し て いる 。
ベクトル として データセット から 1つ の 列 だけ を 得 た とき は 、 summary が 最初 に 見 て おく べき 明らか な 値 を 出力 し て くれる 。

R で 数値 ベクトル を summary に 渡す と 、 例 に 示し た よう に 以下 の よう な 値 が 出力 さ れる 。

これ は データセット の 簡単 な 要約 を 必要 と する 際 に ほしい と 思う 値 の ほぼ すべて と いっ て も いい だろ う 。
実際 、 抜け て いる の は 標準偏差 だけ で ある （ 標準偏差 について は 本章 の 後半 で 触れる ） 。
それでは ここ から は 、 これら の 要約 の 値 が どの よう に 計算 さ れる か 、 そして それ を どう 解釈 すれ ば 良い の か について 解説 し て いこ う 。

平均値 と 中央値 の 違い について 学ぶ こと は 「 統計学 入門 」 という 授業 において 最も 退屈 な こと の 1つ だ 。
これら の 概念 を きちんと 理解 する に は 少し 時間 が かかる が 、 データ の 処理 を 真面目 に し たい の で あれ ば 、 この 違い を 理解 し て おく こと は 間違い なく 必要 だ と 言える 。
より 良い 説明 を 追求 する ため に 、 これら の 意味 について 2つ の 全く 違う 方法 を 使っ て 説明 を し て みる こと に する 。
まず 最初 に 、 平均値 と 中央値 が アルゴリズム 的 に どう やっ て 計算 さ れる の か を 説明 する 。
ほとんど の ハッカー にとって は 、 数学 的 な 記号 より も コード を 使っ て 解説 を 行っ た ほう が 馴染み やすい と 思わ れる ので 、 平均値 と 中央値 を 計算 する 関数 を 自作 し た ほう が 、 それら の 2つ の 統計量 の 定義 を 示す 数式 を 示す より も ずっと 理解 し やすい はず だ 。
また 本章 の 後半 で は データ の ヒストグラム や 密度 プロット の 形 を 見 た 際 に 、 平均値 と 中央値 が どの よう な とき に 異なっ て くる の か を 解説 する 。

平均値 の 計算 は 非常 に 簡単 で ある 。
R において は 、 通常 mean 関数 を 用いる 。
もちろん ブラックボックス の 関数 を 使う の で は 、 平均値 が 何 か を 実感 でき ない ので 、 独自 の mean 関数 を 作り 、 これ を my.mean と しよ う 。
sum と length という 他 の 2つ の 関数 として R で は すでに 用意 さ れ て いる ため 、 この 関数 は R の コード たった 1 行 で 記述 が できる 。

この 1 行 の コード が 平均 の ため の すべて の 処理 を し て いる 。
行っ て いる の は 単に 、 ベクトル 中 の すべて の 数値 を 足し 合わせ 、 その 合計 値 を ベクトル の 長さ で 割っ て いる だけ だ 。
想像 通り この 関数 は x という ベクトル の 数値 の 平均値 を 算出 する 。
平均値 の 計算 は 比較的 簡単 な もの で 、 リスト 中 の 数値 を 並べ 替え た 際 に 、 それぞれ が どこ に 存在 する の か という 情報 を 一切 使わ ない から で ある 。

中央値 は 全く 逆 で ある 。
この 値 は それぞれ の 数値 が 相対的 に リスト 中 の どの 位置 に 存在 する の か という こと に 完全 に 依存 し て いる 。
R において は 通常 、 median という 関数 を 使っ て 中央値 を 計算 する こと に なる が 、 ここ で は 平均値 と 同様 に my.median という 関数 を 自分 で 実装 し て みよ う

コード の 行 数 だけ を 見る と 中央値 の 計算 は 平均値 より も 多く の 計算 を 必要 と し て いる よう に 見える 。
まず 最初 に ベクトル を ソート し て いる の は 、 中央値 の 本質 は 、 ソート し た ベクトル の 中央 に ある 数値 の こと で ある からだ 。
それ ゆえ に 中央値 は 50パーセント 点 、 あるいは 第 2 四 分位数 と も 呼ば れる 。
ベクトル を ソート し たら 、 あと は その 長 さ に 応じ て リスト を 2つ に 分ける だけ で 、 任意 の パーセント 点 や 四分 位 数 を 取得 する こと が できる 。
25パーセント 点 （ 第 1 四 分位数 と も 呼ば れる ） を 取得 し たい の で あれ ば 、 その 長さ の 4分 の 1 の 部分 で 分けれ ば いい わけ だ 。

この 非公式 な 定義 の 長さ に関する 唯一 の 問題点 は 、 リスト の エントリ 数 が 偶数 だっ た 場合 に どう すれ ば いい の か が わから ない 点 で ある 。
データセット 中 に 中央 の 値 として 単一 の 数値 が 存在 し て い なかっ た 場合 、 中央値 の 計算 に 多少 策 を 講じる 必要 が ある 。
上記 の 作成 し た コード で は 、 偶数 の 長 さ を 保つ ベクトル の 場合 に は 、 もし リスト が 奇 数 個 の エントリ を 有し て い た 場合 に は 中央値 に なっ て い た で あろ う 2つ の 値 の 平均 を 求め て いる 。

ここ で 問題 を わかり やすく する ため に 、 簡単 な 例 を 用意 し た 。
この 例 で は ベクトル の 要素 数 が 偶数 で 中央値 の 算出 に 平均 を 取ら なけれ ば なら ない 場合 と 、 そう では なく 中央 に ある エントリ が そのまま 中央値 に なる 場合 の 両方 を 見る こと が できる 。
ここ で 元々 使っ て い た 身長 と 体重 の データセット に 戻り 、 身長 の 平均 値 と 中央値 を 計算 し て みよ う 。
これ によって 我々 の 書い た コード も テスト する こと が できる はず だ 。
この 例 で は 平均 値 と 中央値 は 非常 に 近い 値 に なっ て いる 。
もう少し 後で 、 我々 が 用い て いる データ の 形 から 、 なぜ この よう に なる の か を 説明 しよ う 。

統計学 入門 コース で 最も 目 を 引く 3つ の 数値 の うち の 2つ を 説明 し た わけ だ が 、 なぜ 最 頻 値 について 述べ ない の か を 疑問 に 思っ て いる かも しれ ない 。
ここ で 少し だけ 最 頻 値 について 述 る が 、 これ まで 触れ て 来 なかっ た こと に は 意味 が ある 。
最 頻 値 は 平均 値 と 中央値 と 異なり 、 今 作業 し て いる よう な ベクトル に対して 、 簡単 な 定義 で 説明 でき ない 場合 が ある の で ある 。
この 計算 は 簡単 に は 自動 化 でき ず 、 R に は ベクトル の 最 頻 値 を 計算 する 組み込み 関数 は 用意 さ れ て い ない 。

任意 の ベクトル の 最 頻 値 を 定義 する の は 複雑 な こと で ある が 、 これ は 最 頻 値 を 数 的 に 定義 する の で あれ ば 、 ベクトル 中 で 繰り返し 現れる 数 が 必要 だ から だ 。
もし ベクトル 中 の 数値 が 任意 の 浮動小数 で あっ た 場合 、 いずれ の 数値 も 2回 以上 登場 する こと は な さ そう で ある 。
この 理由 から 、 最 頻 値 は 多く の データセット において 、 視覚 的 に のみ 定義 さ れ て いる 。

ここ まで で 、 最 頻 値 について 数学 的 に 明確 で は なく 、 理論 的 に どう ある べき か 疑問 を 持っ て いる なら ば 、 データセット の 中 で 最も 頻繁 に 出現 する 数値 で ある と 考えれ ば よい 。

少し 前 に 述べ た よう に 、 中央値 は データ 中 の 50% の 位置 に 出現 する 数値 の こと だ 。
データ の 範囲 について より 理解 を 深める ため 、 データ 中 の 最も 小さい 値 は 何 か という こと も 知り たく なる はず で ある 。
つまり それ は データセット の 最小 値 で あり 、 R で は 以下 の よう に 計算 さ れる 。

そして データセット の 最大 値 について は 、 R で は max を 使っ て 計算 する こと が できる 。

min と max を 使う こと で データ の 範囲 を 知る こと が できる 。

これら の 値 は 別 の 考え方 を すれ ば 、 min は データ の 0% が その 下 に ある よう な 数値 で あり 、 max は データ の 100% が その 下 に ある よう な 数値 で ある 。
こう 考える と 自然 と 次 の よう に 考え が 広がっ て いく はず だ 。
データ の N % が その 下 に ある よう な 数値 は 何 だろ う か 。
その 答え は R で は quantile 関数 を 使う こと で 得る こと が できる 。
第 N 百 分位数 （ quantile ） と は データ の N % が その 下 に ある 数値 の こと を 意味 する 。

標準 で は quantile 関数 は データ 中 の 0% 、 25% 、 50% 、 75% 、 100% の 値 を 出力 する 。

他 の 位置 の 数値 を 得る ため に は 、 probs という 引数 で どういう 単位 で 分割 を する の か を 渡し て やれ ば 良い 。

上記 の 場合 は seq 関数 を 使っ て 0 から 1 の 間 で 0.20 ずつ 増え て いく シーケンス を 生成 し て いる 。

分位数 は 昔ながらの 統計 の 教科書 において は 、 平均値 や 中央値 ほど に は 重要 視 さ れ て い ない が 、 これ は 非常 に 便利 な 値 で ある 。
読者 が 顧客 サービス 部門 の 作業 を し て おり 、 顧客 対応 に どれ くらい の 時間 が かかっ て いる の か を 記録 し て いる の で あれ ば 、 中央値 に 位置 する 顧客 に 何 が 起こっ て いる か に 注意 を 払う こと で 主たる 99% の 顧客 について 注意 を 払う こと が できる よう に なり 、 より 良い サービス を 提供 できる かも しれ ない 。
また 、 その データ が 特殊 な 形状 を 示し て いる の で あれ ば 、 平均 的 顧客 という 考え方 は あまり 役に立た ない かも しれ ない 。

数値 リスト の 平均値 や 中央値 は 重要 で ある 。
中央値 は 文字通り リスト の 中心 で あり 、 平均値 は 、 リスト 中 の すべて の 要素 を その 値 で 重み付け た 後 の 中心 で ある 。

しかし 中心 傾向 は それぞれ の データ について 知り たい もの の 1つ に すぎ ない 。
同様 に 重要 な の は 、 典型 的 な 値 が どの ぐらい 離れ た ところ に ある か という こと で あり 、 これ を データ の 広がり と 呼ぶ 。
データ の 範囲 を 定義 する 方法 は いくつ も 思いつく だろ う 。
そして すで に 述べ た よう に 、 range 関数 の 実装 の 定義 を 利用 する こと が できる 。
すなわち 範囲 と は min と max の 値 の 間 に ある もの で ある という こと だ 。
しかし この 定義 は 広がり における 合理 的 な 定義 に は 2つ ほど 足り ない もの が ある 。

min と max は 外れ値 を 取得 し て しまい がち で 、 この 値 を 使う と 広がり の 定義 は 非常 に 怪しい もの に なっ て しまう 。
min と max を 使う こと が 間違い で ある こと を 理解 する ため の 別 の 方法 は 、 最大 値 と 最小 値 を 変化 さ せ ず に それ 以外 の 値 を すべて 変化 さ せ て しまっ た 場合 の こと を 考え て みれ ば 良い 。
実際 、 最大 値 と 最小 値 以外 の 値 を どれ だけ 変更 しよ う と 、 min と max は 同じ 値 を 示す こと に なる 。
言い換える と min と max を 利用 し た 範囲 の 定義 は 、 その データセット が たった 2つ の データ しか 含ん で いよ う が 、 200万 の データ を 含ん で いよ う が 、 その 中 の たった 2つ の 値 に 完全 に 依存 し て いる という こと な の だ 。
データ 中 の ほとんど の 値 を 利用 し て い ない 要約 データ を 信頼 す べき で は ない ので 、 データセット の 広がり に は もっと 良い 定義 を 考える こと に しよ う 。

さて すで に 述べ た データ の 良い 数値 要約 の 要件 を 満たす に は 、 様々 な 方法 が 考え られる 。
例えば データ の 50% を 含む 範囲 、 つまり 中央値 の 周り だけ を 調べる こと が できる 。
R で は これ は 非常 に 簡単 に 実現 できる 。

あるいは より 包括的 に 調べる ため に 、 95% の データ を 使い たい かも しれ ない 。

これら は 実際 データ の 広がり を 調べる 良い 測定 方法 で ある と 言える 。
より 高度 な 統計 的 手法 を 利用 し て 作業 を 行う 際 に 、 これら の 範囲 の 考え方 を 再び 利用 する こと に なる だろ う 。
しかし 歴史的 に 、 統計学 者 は 広がり を 測る の に 異なる 測定 方法 を 利用 し て き た 。
具体的 に は それら は 分散 と 呼ば れる 定義 だ 。
簡単 に 言え ば 、 これ は 与え られ た値 が 平均値 から どれ だけ 離れ て いる の か を 算術平均 的 に 測定 する 考え方 で ある 。
数学 の 公式 を 使っ た 定義 で は なく 、 自分たち で 分散 を 計算 する variance 関数 を 書い て みよ う 。

いつも と 同様 、 我々 の 実装 を R の var と 比較 し て 動作 を 確かめる こと に する 。

我々 の 作っ た 関数 は R の 組み込み 版 の var と 比べる と おおよそ 等しい 程度 の 仕事 しか し て くれ て い ない 。
これ に は いくつか の 論理 的 な 理由 が あり 、 こうした 違い を 引き起こす 例 の ほとんど は 、 浮動小数 演算 が 完全 に 正しく ない こと による もの だ 。
しかし 我々 の コード が R の 組み込み 関数 と 同じ よう に 動作 し ない の に は もう ひとつ 理由 が ある 。
正式 な 分散 の 定義 において は ベクトル の 長さ で 割り算 を し て おら ず 、 ベクトル の 長さ マイナス 1 の 値 で 割り算 を し て いる 。
これ は 実験 に 基づい た データ が 、 ごく 僅か な 理由 により 、 その 真 の 値 より も 下方 に バイアス が かかる こと による もの だ 。
n 個 の 要素 を 持つ データ において これ を 修正 する ため に は 、 分散 として 算出 さ れ た値 に n / ( n - 1 ) という 係数 を 掛ける の が 一般 的 で ある 。
my.var を この こと を 考慮 し て 改良 し て みよ う 。

my.var の 改良版 の 結果 は R の 組み込み 関数 の 結果 と 完全に一致 する 。
先 に 述べ た 浮動小数 演算 の 懸念 は 大きな ベクトル を 使う 場合 に は 起こり やすい が 、 現在 対象 と し て いる よう な サイズ で は 問題 と は なら ない 。

分散 は データ の 広がり を 見る ため の 非常 に 自然 な 尺度 だ が 、 残念 な こと に その 値 は データセット 中 の すべて の 値 より も はるか に 大きな 値 と なる 場合 が 多い 。
この 大き さ の ミスマッチ を はっきり と 確認 する 方法 の 1つ は 、 平均値 と 分散 の 値 が どれ くらい 離れ て いる か を 見る こと で ある 。

この 範囲 は 元々 の データセット の 範囲 より も 大きく なる 。

この よう に 範囲 が 元々 の データ を 超え て しまう 理由 は 、 分散 が リスト 中 の 各 数値 と 平均値 の 距離 の 二乗 を 測定 する もの と 定義 し て おり 、 しかも その 二乗 の ステップ を 打ち消し て い ない から だ 。
数値 を 元 の 尺度 に 戻す ため に は 、 分散 を 標準偏差 と 置き換え て やる 必要 が ある 。
標準偏差 は 分散 の 単なる 平方根 で ある 。

他 の 処理 を する 前 に 、 R の 組み込み の 標準偏差 を 求める 関数 で ある sd と 、 我々 の 実装 に 違い が ある か を チェック し て おい た ほう が 良い だろ う 。

これ で 正しい 尺度 で 値 を 計算 できる よう に なっ た ので 、 平均値 から 標準偏差 の 差 を 1つ の 単位 として データ の 範囲 を 調べる こと は より 意味 の ある こと に なっ た 。

分散 の 単位 で は なく 標準偏差 の 単位 を 使う よう に なっ た ので 、 データ の 範囲 内 に 収まる よう に なっ た 。
しかし 内側 と いっ て も どれ くらい の 範囲 な の か を 、 きちんと 確かめ て おい た ほう が いい だろ う 。
その 方法 の 1つ は 標準偏差 を 使っ た 範囲 と 分位数 を 使っ た 範囲 を 比較 し て みる こと だ 。

quantile 関数 を 使う こと で 、 平均値 と 標準偏差 を 使っ た 範囲 より も 、 データ の 50% の 範囲 の ほう が やや 小さい こと が わかる 。
これ は 特に この 身長 の データ の よう な 形状 の 場合 に は 非常 に 典型 的 な もの だ 。
しかし データ の 形式 に関して きちんと 考え られる よう に する ため に は 、 データ の 可視化 を 行い 、 データ の 形状 に関する いくつか の 正式 な 用語 を 知る 必要 が ある 。

データ の 数 的 な 要約 を 行う こと は 明らか に 意味 の 有る こと で ある が 、 これ は 結局 の ところ 伝統 的 な 統計処理 の 作業 で ある 。
しかし 多く の 人達 にとって 、 数値 は 彼ら が 見 たい だけ の 情報 を 効果的 に もたらす こと が でき ない 。
データ の 可視化 は データ の パターン を より 効果的 に 見せ て くれる 場合 が 多い 。
本章 で は 探索 的 データ における 2つ の 最も 単純 な 可視化 の 形 を 取り扱う 。
1つ 目 は 1 列 可視化 で あり 、 これ は データ の 形状 に 着目 し た もの で ある 。
もう 1つ が 2 列 可視化 で 、 こちら は 2つ の 列 の 関係 に 着目 し た もの だ 。
データ の 可視化 を 行う 手法 を 紹介 する こと を通じて 、 データ を 見る にあたって 予期 す べき いくつか の 基準 と なる 形状 の 解説 も 行う 。
それら の 理想 的 な 形状 （ 分布 と も 呼ば れる ） は 、 統計学 者 が 長い 年月 を かけて 研究 し て き た 標準 と なる パターン で ある 。
データ が この 形状 の いずれ か に 該当 し た 場合 は 、 その データ に関して 多く の 推論 を 行う こと が できる 場合 が 多い 。
例えば それ が 何 に 由来 する もの か 、 どんな 抽象 的 な 特性 が その データ に 含ま れ て いる か 、 と いっ た もの だ 。
そうした 理想 的 な 形状 が 手元 の データ の 形状 と 多少 似 て いる 程度 だ と 感じ られ た 時 でも 、 そうした 標準 の 分散 の 形状 は 、 より 手元 の データ の 形状 に 近い 複雑 な 形状 を 構築 する ため の 構成要素 として 利用 する こと が できる 。

とりあえず 、 今 取り組ん で いる 身長 と 体重 の データ の 可視化 を 行う こと から 始め て みよ う 。
この データセット は 本書 の 中 で 繰り返し 登場 する 多く の 考え方 を 含ん だ か なり 複雑 な データセット で ある 。
広く 使わ れ て いる 最も 典型 的 な 1 列 可視化 の テクニック は ヒストグラム で ある 。
ヒストグラム で は 、 データセット を ビン に 分割 し 、 それぞれ の ビン に 含ま れる データ の エントリ 数 を 数える という もの だ 。
例えば 図 2-5 は 身長 の データ を 1インチ ごと の ビン に 分割 し て 可視 化 し た もの だ 。
R を 使っ て これ を 行う に は 以下 の よう に する 。

この データ の 中 に ベル 型 曲線 が 存在 し て いる こと に 、 すぐ に 気付く だろ う 。
ほとんど の データ は 平均 値 と 中央値 の ある 中央 付近 に 位置 し て いる 。
しかし この 形状 は 我々 が 用い た ヒストグラム の タイプ による まやかし で ある かも しれ ない という 危険 を はらん で いる 。
それ を 確かめる 方法 の 1つ は ビン の 幅 を いろいろ 変え て ヒストグラム を 生成 し て みる こと だ 。
ヒストグラム を 使っ て 作業 を する 際 に は 気 を つけ て おか なけれ ば なら ない こと が いくつか ある 。
ビン の 幅 は データ の 内部 構造 を 明らか に する と 同時に 、 データ の 外部 構造 を 強制 する 。
パターン を 発見 し て 、 それ が たとえ 実際 に 存在 し た もの で あっ た として も 、 ヒストグラム の ビン の 設定 を 間違えれ ば 容易 に 見え なく なっ て しまう の で ある 。
図 2-6 に 5インチ の ビン の 幅 で 再 作成 し た ヒストグラム を 示す 。

ビン の 幅 が 広 すぎる と 、 データ 中 の 構造 の 多く が 消え去っ て しまう 。
ピーク は まだ 存在 し て いる が 、 図 2-5 に 存在 し た 対称 な 形状 は 消え去っ て しまう 。
これ は 過剰 な 平滑 化 （ oversmoothing ） と 呼ば れる 。
そして その 逆 の 問題 で ある 平滑 化 の 不足 （ undersmoothing ） も 同じ よう に 危険 で ある 。
図 2-7 は ビン を 0.001 インチ という 非常 に 小さい 幅 に 設定 し 直し た ヒストグラム で ある 。

ビン を 非常 に 小さく し て しまっ た ため に 、 明らか に 平滑 化 の 不足 が 起こっ て いる 。
データ が 多く 存在 する 場合 、 これ でも まだ ヒストグラム から 何 か を 得る こと は 可能 だ が 、 100 個 の 要素 が 入っ て いる データセット が 、 この よう な ビン の 幅 で は 意味 が なくなっ て しまう 。

ビン の 幅 の 設定 は 面倒 な 作業 で あり 、 最も 適切 な ヒストグラム は 我々 の 目 に は ギザギザ に 見え すぎる ので 、 カーネル密度推定 （ kerneldensityestimates ： KDE ） 、 あるいは 密度 プロット と 呼ば れる ヒストグラム の ほう が より 便利 で ある 。
密度 プロット は ヒストグラム で 問題 と なっ た 過剰 な 平滑 化 や 平滑 化 の 不足 の 問題 が 同様 に 存在 する が 、 こちら の ほう が 一般的 に 見た目 が 良い 。
特に 大量 の データ を 含む データセット の 密度 プロット は 、 我々 が データ から 見つけ出す こと を 期待 する 論理 的 な 形状 に ずっと 近い 形 を し て いる 。
それ に 加え 、 密度 プロット に は ヒストグラム に 比べ て 理論 的 な 優位 点 が もう 1つ ある 。
理論 上 、 密度 プロット を 使う こと は ヒストグラム と 比べ て 少ない データ 量 で その データセット の 形 を 明らか に し て くれる の だ 。
そして ありがたい こと に R を 使え ば 密度 プロット は ヒストグラム と 同じ くらい 簡単 に 扱う こと が できる 。
図 2-8 は 身長 の データ を 使っ た 初 の 密度 プロット で ある 。

密度 プロット の なめらか な 線 により 、 ヒストグラム で は 見つける の が 難しかっ た よう な パターン を 見つけ出す こと を 助け て くれる 。
この 例 の 場合 で は 、 ピーク と なる 値 において データ が 平ら に なっ て いる こと が 、 密度 プロット から わかる 。
通常 の ベル 型 曲線 で は ピーク 部分 は 平ら に は なら ない ため 、 密度 プロット を 使う こと で 、 この データセット に は さらに 隠さ れ た 構造 が ある の で は ない か と 考える こと が できる よう に なる わけ だ 。
まだ 見つけ て ない 構造 が 何 か 存在 する と 感じ た 時 に できる こと の 1つ は 、 使う こと が 可能 な 質 的 変数 を すべて 使っ て プロット を 分割 し て みる こと だ 。
ここ で は 性別 の 情報 を 使っ て プロット を 2つ に 分け て 見る こと に する 。
図 2-9 に 示す の は 、 2つ の 密度 プロット を 重ね合わ せ て 性別 ごと に 別 の 色 で 塗り 分け た もの だ 。

この プロット で は 、 これ まで 明らか に なっ て い なかっ た 隠さ れ た パターン が 明らか に なる 。
我々 は 1つ の ベル 型 曲線 を 見 て い た の で は なく 、 一部 が 重なっ た 2つ の 異なる ベル 型 曲線 を 見 て い た の で ある 。
男性 と 女性 が 異なる 平均 身長 と なっ て いる の は 驚く べき こと で は ない 。
この こと から 、 おそらく 体重 も 男性 と 女性 で 異なる ベル 型 曲線 を 描い て いる こと が 予想 さ れる 。
図 2-10 は 体重 の 列 を 使っ て 生成 し た 密度 プロット で ある 。

ここ でも 同じ よう に 2つ の ベル 型 曲線 が 重なっ て いる こと が わかる 。
後 の 章 で この よう な 重なり あっ た ベル 型 曲線 について より 詳しく 見 て いく こと に する が 、 この よう な 構造 に ここ で 名前 を つけ て おい た ほう が のちのち 便利 で あろ う 。
これ は 2つ の 標準 分布 が 混ざっ て 非 標準 分布 を 生成 し て いる 混合モデル で ある 。

もちろん 、 この 一文 を より わかり やすく する ため に 、 我々 の 標準 分布 について より はっきり 定義 し て おく 必要 が ある ため 、 最初 の 理想 的 な 標準 分布 を 考え て いく こと に しよ う 。
それ は 正規分布 、 ガウス分布 、 そして ベル 型 曲線 と も 呼ば れる もの だ 。
プロット を 相 と 呼ば れる 2つ の 部分 に 分割 する こと で 、 簡単 に 正規分布 の 例 を 見る こと が できる 。
図 2-11 は すで に 見 た 密度 プロット を 2つ の ベル 型 曲線 に 分け た もの だ 。
R で は 以下 の よう に すれ ば こうした プロット を 生成 できる 。

一度 これ を し て しまえ ば 、 女性 の ベル 型 曲線 が 130 ポンド あたり を 中心 と し て おり 、 男性 は 185 ポンド あたり が 中心 で ある こと が わかる 。
この ベル 型 曲線 は 正規分布 で あり 、 この 形状 は 非常 に 多く の データ に 共通 する ため に 「 正規 」 で ある と 思わ れ がち だ 。
しかし これ は 完全 に 正しい わけ で は ない 。
人々 の 年収 や 株価 の 日々 の 変動 まで 、 多く の もの は 正規分布 を 使っ て 表す こと が でき ない 。
ただし 正規分布 は 統計 における 数学 理論 の 中 で は 非常 に 重要 で あり 、 その他 ほとんど の 分布 より も よく 理解 し て おく ほう が 良い 。

もう 1つ 抽象 的 な レベル で は 、 正規分布 は 単なる ベル 型 曲線 の 一 種 で ある 。
正規分布 は 図 2-12 から 図 2-14 に 示す ベル 型 曲線 の いずれ でも あり うる 。

これら の グラフ で は 、 2つ の パラメータ によって 違い が 現れ て いる 。
1つ は 分布 の 平均値 で あり 、 これ が ベル 型 曲線 の 中央 を 決め て いる 。
そして もう 1つ が 分散 で あり 、 こちら が ベル 型 曲線 の 幅 を 決め て いる 。
以下 に 示す コード を 使っ て 様々 に これら の 値 を 変化 さ せる こと で 、 どの よう に ベル 型 曲線 が 変化 する の か を しっかり 理解 できる まで 繰り返し て みよ う 。
以下 の よう に m （ 平均 ） と s （ 分散 ） の 値 を セット すれ ば 良い 。

この コード で 生成 できる 曲線 は すべて 基本 的 な 形 は 同じ で ある 。
m と s を 変える こと で 、 中心 の 位置 が 変化 する か 、 幅 が 変化 する だけ で ある 。
その うち の 1つ は すぐ 後ほど 紹介 する こと に なる が 、 正規分布 は データ の 形 に関する いくつか の 定性的 な 考え方 を 定義 さ せる ため 、 ここ で は 簡単 に 専門用語 の 勉強 だけ を し て おこ う 。

まずは これ まで 先延ばし に し て き た 最 頻 値 の トピック に 戻る こと に しよ う 。
すで に 述べ た よう に 、 連続 する 数値 の リスト における 最 頻 値 は きちんと 定義 さ れ て い ない の は 、 数値 の 繰り返し が ない 場合 が ある からだ 。
しかし 最 頻 値 は 明らか な 視覚 的 な 説明 が できる 。
密度 プロット を 生成 し た 場合 、 最 頻 値 は ベル の ピーク に なる 。
例えば 図 2-15 を 見 て みよ う 。

最 頻 値 を 視覚 的 に 見積もる に は 、 ヒストグラム より 密度 プロット の ほう が 容易 で あり 、 ヒストグラム より も 密度 プロット の ほう が 便利 な 理由 の 1つ で ある 。
そして 最 頻 値 は 直接 数値 で 作業 し て いる とき に は わかり づらい が 、 密度 プロット を 見れ ば ほぼ すぐ に 理解 できる 。

さあ これ で 最 頻 値 が 定義 でき た ので 、 ここ で 正規分布 の 性質 の 1つ が 最 頻 値 を 1つ 持ち 、 それ が 平均値 と 中央値 と 同じ で ある と 言える 。
それ と は 対照 的 に 図 2-16 に 示す よう な 2つ の 最 頻 値 を 持つ グラフ や 、 図 2-17 に 示す よう な 3つ の 最 頻 値 を 持つ グラフ も ある 。

データ 中 の 最 頻 値 の 数 について 述べる 場合 、 以下 の 用語 を 使う 。
1つ の 最 頻 値 を 持つ 分布 は 単 峰 型 、 2つ の 場合 は 双峰 型 、 また 2つ 以上 の 最 頻 値 を 保つ 場合 は 多 峰 型 で ある 。

もう 1つ の 重要 な 性質 は データ が 対称 か 歪ん で いる （ 非対称 ） か によって 異なっ て くる 。
図 2-18 と 図 2-19 は 対称 か 歪ん で いる か の 違い を 明確 に する ため に 図示 し た もの で ある 。

対称 分布 は 最 頻 値 の 左右 で 同じ 形 を し て いる もの の こと で ある 。
正規分布 は この 形状 を し て おり 、 これ は 最 頻 値 以下 の データ と 同じ だけ の データ が 最 頻 値 以上 に も 存在 し て いる こと を 意味 する 。
それ と は 対照 的 に 2つ 目 の グラフ は ガンマ分布 と 呼ば れ 、 右 方向 に 歪ん で いる が 、 これ は 極端 な 値 は 最 頻 値 の 左側 より も 右側 に はるか に 多く 現れ やすい こと を 意味 し て いる 。

特性 の 違い として 最後 に 挙げる の は 、 薄い 裾 と 厚い 裾 で ある 。
この あと この 違い を 示す 一般 的 な グラフ を 示す が 、 この 違い は おそらく 言葉 で 説明 し た ほう が 簡単 で ある 。
薄い 裾 の 分布 を 見 て みる と 、 例えば 99% の 値 が 平均値 から あまり 遠く ない ところ に 位置 し て いる 。
例えば 正規分布 において 99% の 値 が 標準偏差 の 3倍 まで の 距離 以内 に 含ま れる よう な ケース で ある 。
対照的 に 、 コーシー分布 と 呼ば れる ベル 型 の 分布 で は 標準偏差 の 3倍 まで の 距離 以内 に 値 の 90% しか 含ま れ ない 。
さらに 平均値 から 離れる につれ 、 2つ の タイプ の 分布 の 違い は より 大きく なる 。
正規分布 の 場合 は 標準偏差 の 6倍 以上 の 部分 に は ほぼ 値 が 存在 し ない が 、 コーシー分布 の 場合 は 5% ほど の 値 が それ 以上 遠く に 存在 し て いる 。

薄い 裾 の 正規分布 と 厚い 裾 の コーシー分布 の 違い を 説明 する ため に 一般 的 に 利用 さ れる 画像 を 図 2-20 と 図 2-21 に 示し た 。
しかし これら の 分布 で の 値 を たくさん 生成 し て み て 、 その 結果 を 自分 の 目 で 確かめる ほう が 、 より 直観 的 に 理解 できる よう に なる はず だ 。
R で は これ は 簡単 に 実現 できる 。
以下 の よう に すれ ば 良い 。

これら の 値 を プロット する こと で 、 論点 を より 明確 に し て くれる だろ う 。

本節 の 正規分布 と その いとこ に当たる コーシー分布 の 解説 を 終える にあたって 、 正規分布 の 特性 を もう一度 整理 し て おこ う 。
正規分布 は 単 鋒 分布 で あり 、 対称 分布 で あり 、 薄い 裾 の ベル 型 を し て いる 。
コーシー分布 は 単 鋒 型 で あり 、 対称 で あり 、 厚い 裾 の ベル 型 を し て いる 。

正規分布 に 続き 、 本節 の 密度 プロット の 説明 を 終える 前 に 示し て おき たい 画像 が もう 2つ ある 。
軽く 歪ん だ ガンマ分布 と 呼ば れる 分布 と 、 強く 歪ん だ 指数 分布 と 呼ば れる 分布 で ある 。
これら の 分布 は 実際 の データ に 出現 する ため 、 後ほど 利用 し て いく こと に なる が 、 傾斜 を 視覚 的 に 表す こと で それら を ここ で 解説 し て おく こと は 重要 で ある 。

まずは ガンマ分布 から 始めよ う 。
これ は 非常 に 柔軟 な ので 、 まずは いろいろ 自分 で 操作 し て みる こと を おすすめ する 。
以下 に その 出発 点 を 示す 。
図 2-22 に 結果 として 得 られる ガンマ分布 の プロット を 示す 。

ご覧 の とおり 、 ガンマ分布 は 右 に 向かっ て 歪ん で おり 、 その 結果 平均 値 と 中央値 は 大きく 異なる 場合 が ある 。
図 2-23 に Canabalt という iPhone の ゲーム を プレイ し た 人たち の スコア を 集め て プロット し た もの を 示す 。
この 実際 の データセット は ガンマ分布 に したがっ て 理論 的 に 生成 さ れ た データ と 非常 に よく 似 て いる 。
他 の 多く の ゲーム の スコア を 使っ た 密度 プロット も 、 これ と 同様 の 形 を 取る で あろ う こと は 間違い が ない 。
つまり これ は ゲーム データ を 分析 し たい 場合 に は 、 非常 に 便利 な 論理的 手段 で ある と 言える 。

1つ 心 に 留め て おく べき なのは 、 ガンマ分布 が 正 の 値 のみ を 生成 する という こと だ 。
本書 の 終わり 近く で 確率変数 最適化 の ツール の 使い方 を 紹介 する 際 、 すべて が 正 の 値 と なっ て いる 分布 は 非常 に 使い勝手 が 良い 。

ここ で 紹介 する 最後 の 分布 は 指数 分布 で あり 、 これ は 強く 歪ん だ 分布 の 例 として 適し て いる 。
図 2-24 に 指数 分布 の サンプル データセット の プロット を 示す 。

指数 分布 の 最 頻 値 は ゼロ に なる ため 、 指数 曲線 を 描く ため に 釣鐘 の 正 の 部分 だけ を 切り取っ た よう な 形 に なっ て いる 。
この 分布 は ゼロ の 頻度 が 非常 に 高く 、 正 の 値 だけ が 存在 する よう な データセット で 現れる 。
例えば 企業 の コールセンター で オペレータ が 受ける 電話 同士 の 時間 間隔 は 指数 分布 に なる こと が 多い 。
読者 が データ に 非常 に 精通 し 、 統計学 者 が 研究 し た 理論 分布 を より 多く 学べ ば 、 こうした 分布 は より 馴染み深い もの に なる だろ う 。
これ は 特に 、 同じ 数少ない 分布 が 繰り返し 登場 する から で ある 。
今 現在 この 節 において 覚え て おく べき こと は 、 単 峰 型 と 多 峰 型 、 対称 と 歪み 、 薄い 裾 と 厚い 裾 という 、 データ を 他 の 人 に 説明 する ため に 必要 と なる 性質 を 示す 簡単 な いくつか の 単語 で ある 。

ここ まで は データセット 中 の 独立 し た 列 について 深く 考える ため の 戦略 だけ を 考え て き た 。
これ は 明らか に 価値 の ある こと だ 。
単に データ が どんな 形 を し て いる か を 見る だけ でも 、 非常 に 多く の こと が わかる から で ある 。
正規分布 が 見つかれ ば 中央値 と 平均値 が 交換 可能 で ある こと が わかる し 、 平均値 から 標準偏差 の 3倍 以上 の 距離 に ある データ が 存在 し ない 場合 が ほとんど で あろ う こと も 期待 する こと が できる 。
可視化 を 1回 試し て みる だけ で も 多く の こと が わかる 。

しかし これ まで 見 て き た すべて の 素材 は 、 昔ながらの 統計 の 授業 で 習う よう な もの ばかり だ 。
この 中 に 、 早く 取りかかり たく で ウズウズ し て いる で あろ う 機械学習 へ の 応用 を 感じ させる よう な もの は 全く なかっ た 。
実際 に 機械学習 を 行う ため に は 、 データ 中 の 複数 の 列 の 関係 を 見つけ 、 それら の 関係 を データ の 理解 と 今後 の 予測 の ため に 使う 必要 が ある 。
以下 に 本書 で 触れる 予測 問題 の 一部 を 紹介 しよ う 。

すで に 述べ た よう に 、 こうした 問題 は 2つ の 種類 に 分類 できる 。
1つ 目 は 回帰 問題 で 、 ある ひとかたまり の 数値 、 例えば 身長 など を 与え られ 、 別 の 数値 、 例えば 体重 、 を 予測 する もの で ある 。
そして もう 1つ は 分類 問題 で 、 こちら は 「 バイアグラ 」 や 「 シアリス 」 といった スパム で 使わ れ やすい 言葉 の 数 など の ある ひとかたまり の 数値 から 、 スパム か どう か といった ラベル付け を 行う もの で ある 。
回帰 と 分類 に 利用 可能 な 手法 は 、 本章 の 残り を 使っ て 紹介 し て いく が 、 念頭 に 置い て おい て おく と 良い データ の 可視化 の 種類 を 2つ 紹介 する 。

1つ 目 は 典型 的 な 回帰 の 図 で ある 。
この 回帰 の 図 で は 、 データ の 散布図 を 作り 、 データセット 中 の 2つ の 列 の 隠さ れ た 関連性 を 調べる 。
我々 の 大好き な 身長 と 体重 の データ を 使っ て 、 身長 と 体重 の 散布図 を 作っ て みよ う 。

もし 散布図 に 詳しく なけれ ば 、 散布図 と は 2次元 の 図 の こと で 、 その うち の 1 軸 を 変数 X 、 もう 1つ の 軸 を 変数 Y に 関連付け た もの で ある 。
散布図 も ggplot を 使っ て 描く こと が できる 。

この 図 を 見る と 、 身長 と 体重 を 関連付ける パターン が ある こと が はっきり と わかる 。
身長 が 高 い人 ほど 、 体重 も 重い という こと だ 。
この 関連性 は 直観 的 に わかる こと で は ある が 、 こうした パターン の 発見 は 、 本書 全体 を通して の 一般 的 な 戦略 と なっ て いる 。
この パターン について より 詳しく 見 て いく 前 に 、 ggplot2 の 平滑 化 ツール を 使っ て 、 発見 し た 線形 の パターン を 視覚 的 に 明らか に し て みよ う 。

散布図 に 平滑 化 し た パターン を 重ね た もの を 図 2-26 に 示す 。

geom_smooth によって 身長 を 与え られ た 時 に 体重 を 予想 する こと が できる よう に なる 。
この 場合 、 その 予想 は 青い 線 で 示さ れる 単純 な 線 に なる 。
線 の 周り に は 網掛け に なっ た 領域 が あり 、 これ は データ 中 の 誰か の 体重 に 基づく 、 その他 の 妥当 な 予想 の 領域 を 表し て いる 。
データ を より たくさん 入手 できれ ば 、 この 予想 は より 正確 に なり 、 網掛け の 領域 を より 小さく する こと が できる 。
すでに 手持ち の データ を すべて 使っ て しまっ て いる ので 、 この 効果 を 調べる 最適 な 方法 は それ を 逆手 に 取る こと だ 。
つまり データ の 一部 を 取り除き 、 この パターン の 正確 性 が 低下 する の を 見る わけ で ある 。
その 結果 を 図 2-27 から 図 2-29 に 示す 。

予測 しよ う と し て いる 値 が 数値 の 場合 、 ある 列 を 利用 し て 別 の 列 の 値 を 予測 する こと を 回帰 と 呼ぶ こと を 思い出そ う 。
それ に対して ラベル を 予測 する 場合 、 それ は 分類 と 呼ば れる 。
分類 の ため に は 、 まず 図 2-30 に ある 図 を 心 に 留め て おこ う 。

この 図 において も データセット 中 に 含ま れる 人々 の 身長 と 体重 が 示さ れ て いる が 、 その 点 は 性別 ごと に 色分け さ れ て いる 。
これ によって 2つ の 異なる グループ が データ 中 に 存在 し て いる こと が はっきり と 見て取れる 。
この 図 を ggplot2 で 作成 する ため に は 以下 の コード を 用いる 。

この 図 は 標準 的 な 分類 図 で ある 。
分類 図 において は 、 第 3 の 列 を 使っ て ラベル ごと に 色付け を 行っ た 散布図 を 作成 する 。
今回 の 身長 と 体重 の データ の 場合 、 第 3 の 列 として は 性別 情報 を 使っ て いる 。
この 図 を 見れ ば 、 与え られ た 身長 と 体重 から その 人 の 性別 を 判別 でき そう に 見える 。
他 の 情報 から 性別 を 推定 する 、 といった よう に 、 カテゴリ 変数 を 推定 する という こと は 、 分類 が やろう と し て いる こと そのもの で ある 。
そして 次 章 において そのため の アルゴリズム について 詳しく 見 て いく こと に する 。
ここ で は 標準 的 な 分類 アルゴリズム を 使っ た 結果 を 図 2-31 に 示す に 留める 。

この 図 において 引い た 線 に は 「 分離 超 平面 」 という とても 洒落 た 名前 が つい て いる 。
これ は データ を 2つ に 分け て いる ため 「 分離 」 超 平面 と 呼ば れる 。
平面 の 片側 で は 与え られ た 身長 と 体重 から その 人 が 女性 で ある と 推定 でき 、 逆 側 で は 男性 で ある と 推定 できる 。
これ は 推定 の ため の とても 良い 手法 で ある 。
この データセット において は 、 92% の 正答 率 と なる 。
これ は 身長 と 体重 だけ を 予想 アルゴリズム の 入力 として 用い た 単純 な 分類 モデル を 使っ た 結果 として は 悪く ない 印象 を 受ける 。
実際 の 分類 タスク において は 、 予想 の ため に 数 十 、 数 百 、 時には 数 千 も の 入力 を 使う 場合 も あり うる 。
この データ は たまたま 分類 が うまく いく もの だっ た の で あり 、 そして それ が この データ を 最初 に 選ん だ 理由 で ある 。

これ で 本章 も 終了 で ある 。
次 章 を 読み たく なる よう に 、 R の コード を 使っ て これ まで 見 た よう な 予想 を 行う R の コード を 見せよ う 。
ご覧 の とおり 、 ほとんど コード を 書か なく て も 、 かなり 素晴らしい 結果 を 得る こと が できる 。

次 章 で は 、 既存 の 機械学習 ツール を 使っ て 独自 の 分類 器 を 生成 する 方法 について 、 より 詳しく 見 て いく こと に する 。

2 章 の 最後 において 分類 の 例 を 簡単 に 紹介 し た 。
そこ で は 身長 と 体重 を 使っ て ある 人 が 男性 か 女性 か を 予測 し て おり 、 グラフ を 使っ て 片方 の グループ は 「 男性 」 、 もう 片方 の グループ は 「 女性 」 という よう に 、 データ を 2つ の グループ に 分割 する 線 を 引く こと が でき た 。
この 線 は 分離 超 平面 と 呼ば れる が 、 これ 以降 で は 直線 だけ で は きちんと 分類 でき ない データ も 扱う ため 「 決定 境界 」 という 用語 を 使う こと に する 。
例えば 例 3-1 の よう な データセット が あっ た と しよ う 。

この 散布図 は ある 病気 の リスク の ある 人 と そう で ない 人 と を プロット し た もの だ 。
この 分散 図 において は 、 黒い 横線 の 上下 の 領域 に プロット さ れ た 人 は リスク が あり 、 その 内側 の 領域 に プロット さ れ た 人 は 健康 で ある と 予測 できる 。
したがって これら の 黒い 線 が 決定 境界 で ある 。
さらに ここ で 青い 点 が 健康 な 人 、 赤い 点 が ある 病気 に 罹っ て いる 人 を 表す と しよ う 。
この 場合 でも 、 2本 の 黒い 線 は 人 が 健康 か 病気 か を 分類 する 決定 境界 として 役立つ 。

決定 境界 が 単一 の 直線 で は ない よう な 問題 を 扱える 一般 目的 の 手法 が 開発 さ れ た こと は 、 機械学習 の 大きな 成果 の 1つ で ある と 言える だろ う 。
特に これから 注目 する アプローチ の 1つ として 、 カーネルトリック と 呼ば れる もの が ある 。
カーネルトリック は 、 計算 コスト を ほとんど 増加 さ せ ず により 高度 な 決定 境界 を 扱う こと が できる という 優れ た 性質 を 持つ 。

しかし 実際 に 決定 境界 を どの よう に 決定 する か について 学ぶ 前 に 、 分類 における 一般 的 な 考え方 について 復習 し て おこ う 。

ここ で は カテゴリ の ラベル 付き の 事例 が あり 、 そこ から 、 どの よう に 識別 する か を 学習 し たい と しよ う 。
これら の 事例 は ラベル （ クラス 、 タイプ と も 呼ば れる ） と 、 それぞれ の 事例 を 記述 する 一連 の 測定 変数 で 構成 さ れ て いる 。
これら の 測定 変数 を 素性 や 予測 因子 と 呼ぶ 。
例えば 前章 の 身長 と 体重 の 列 は 、 「 男性 」 「 女性 」 の ラベル を 推定 する ため に 使う こと の できる 素性 で ある 。

分類 の 例 は 様々 な ところ で 見る こと が できる 。

本章 で は テキスト 分類 に 注目 する 。
これ は 、 上記 の リスト の 中 でも 最後 の 問題 に 答える ため に 使う 手法 に 特に 関連 する もの だ 。
ただし 演習 において は 、 ある 電子メール が スパム か 非 スパム か を 判断 する システム を 構築 する こと に する 。

ここ で 使う 生データ は 、 SpamAssassin 公開 コーパス から 取得 し た もの で あり 、 http://spamassassin.apache.org/publiccorpus/ から 無料 で ダウンロード する こと が できる 。
そして 本章 の 演習 ため に 、 この コーパス の 一部分 が code/data/フォルダ に 格納 さ れ て おり 、 それ を 本章 を通じて 使う こと に なる 。
未処理 の 段階 で は 、 この 素性 は 単に プレーンテキスト で 書か れ た 生 の 電子メール の 内容 で ある 。

この 生 テキスト が 最初 に 突き当たる 問題 と なる 。
なぜなら 生 テキスト の データ を 、 メール の 質的 な 概念 を 量的 に 記述 する 一連 の 素性 に 変換 し なけれ ば なら ない から だ 。
今回 の 場合 それ は 「 スパム 」 か 「 非 スパム 」 か の 0/1 符号化 方略 で ある 。
例えば 「 HTML タグ を 含ん で いる 場合 、 その メール は より スパム で ある 確率 が 高い か 」 という こと を 明確 に し たい という こと な の だ 。
これ に 答える ため に は 、 電子メール の テキスト を 数字 に 変換 する 方略 が 必要 と なる 。
素晴らしい こと に R言語 に は 汎用 の テキストマイニング 用 パッケージ が 用意 さ れ て いる ので 、 これ を 今回 の 作業 に 使う こと が できる 。
この ため 、 本章 で は テキスト データ を 扱う 際 に これ まで 人々 が 使っ て き た よう な 素性 に対する 読者 の 直観 を 養う こと に もっぱら 注目 する こと に する 。
素性 生成 は 、 最新 の 機械学習 研究 において も 主要 な トピック で あり 、 一般 的 な 形 で 自動 化 さ れる まで に は 全く 至っ て い ない 。
したがって 今 の ところ は 、 素性 という もの は 機械学習 における 用語 の 1つ で あり 、 これから 先 より 多く の 機械学習 タスク に 取り組む につれて より 詳しく なっ て いく もの と 考え て おく と 良い だろ う 。

新しい 言語 の 単語 を 学ぶ こと によって 、 実際 に どの よう な もの が 単語 に なり 得る か という 直観 が 養わ れる の と 同様 に 、 過去 に どの よう な 素性 が 使わ れ て き た か を 学ぶ こと によって 、 未来 において どの よう な 素性 が 適切 に 役に立つ か という 直観 を 養う こと が できる 。

テキスト を 扱う 際 に 、 過去 に 使わ れ て き た 最も 重要 な 素性 は 単語 カウント で ある 。
もし HTML タグ を 含ん だ テキスト が 電子メール が スパム か どう か の 強い 指標 に なる と 考える なら 、 「 html 」 や 「 table 」 の よう な 単語 を 選び 、 ある 種類 の 文書 に どの ぐらい 現れる か を 他 の 種類 の 文書 と 比較 すれ ば 良い 。
この アプローチ が SpamAssassin 公開 コーパス に対して どの ぐらい 有効 か を 示す ため に 、 「 html 」 「 table 」 という 単語 が 現れ た 数 を 数え て み た 。
その 結果 を 表 3-1 に 示す 。

さらに データセット の すべて の 電子メール に対して 、 クラス 所属 を 図 3-1 に プロット し た 。
しかし この 分散 図 で は 多く の データ ポイント が 重なっ て しまっ て おり 、 あまり 役に立ち そう も ない 。
この 手 の 問題 は 、 設定 し た 変数 の 取る 値 が 少し しか ない 場合 に よく 発生 する 。
この 問題 は よく 発生 する もの な ので 、 グラフ 上 で 解決 する 標準 的 な 方法 が ある 。
プロット する 前 に 、 ランダム ノイズ を 単に 値 に 載せれ ば 良い 。
この ノイズ によって 点 が 分離 さ れ 、 プロット の 重 なり を 減少 さ せる こと が できる 。
この ノイズ は ジッタ と も 呼ば れ 、 ggplot2 を 使っ て 簡単 に 生成 する こと が できる （ 図 3-2 を 参照 ） 。

この 分散 図 から 「 html 」 「 table 」 という 単語 が 出現 する か どう か を 数える だけ でも 電子メール か スパム か どう か を そこそこ 判定 できる こと が わかる 。

さて 実際 に は 、 これら の 2つ の わかり やすい 単語 を 数える 以外 に も さらに 判定 を 改善 できる 方法 が ある 。
事実 、 最終 的 な 分析 に は 数 千 の 単語 を 使う こと に なる 。
それだけ の 単語 を 使う と 、 単語 カウント の データ しか 使っ て いない に も 関わら ず 比較的 正確 な 分類 を する こと が できる 。
さらに 実際 に は 偽装 し た ヘッダ や IP 、 電子メール アドレス の ブラックリスト など 、 単語 カウント 以外 の 素性 も 使う こと が できる の だ が 、 ここ で は テキスト 分類 の 基礎 を 紹介 する に 留める 。

さて 先 に 進む 前 に 、 条件付き確率 の 基礎 的 な 概念 を 復習 し 、 これ が テキスト に 基づく メッセージ の 分類 と どの よう に 関連 する か について 議論 し て おこ う 。

本質的 に は 、 テキスト 分類 と は 18世紀 の 条件付き確率 の 概念 を 応用 し た 20世紀 の 仕事 で ある 。
そして 条件付き確率 と は 、 すで に 知っ て いる 事実 を 仮定 し た 時 に 、 ある もの を 観測 する 尤もらし さ の こと を 意味 する 。
例えば 、 ある 大学生 の 専攻 が コンピュータサイエンス で ある 場合 に 、 その 大学生 が 女性 で ある 確率 を 知り たい と する 。
アメリカ国立科学財団 （ NationalScienceFoundation ） の 2005年 の 調査 に よれ ば 、 コンピュータサイエンス学部 生 の 中 の 女性 の 比率 は 22% で ある ［ SR 08 ］ 。
その 一方 で 学部 生 全体 の 51% が 女性 で ある ため 、 コンピュータサイエンス 専攻 で 条件 付け を する と 、 女性 で ある 確率 は 51% から 22% まで 下がる こと に なる 。

本章 で 使う 分類 アルゴリズム は 、 ナイーブベイズ 分類 器 と 呼ば れ て おり 、 テキスト 中 から 、 (a) 明らか に スパムメッセージ に 出現 し やすい 、 もしくは ( b ) 明らか に 非 スパムメッセージ に 出現 し やすい 、 という 類 の 差異 を 見つける 。
ある 単語 が 明らか に 特定 の 場合 に のみ 出現 し やすい 時 、 その 出現 を 使っ て 新しい 別 の メッセージ が スパム か 非 スパム か を 診断 できる という わけ で ある 。
この ロジック は 単純 だ 。
例えば テキスト 中 に 非 スパム より スパム に 出現 し そう な 単語 が 「 1つ 」 観察 さ れ た 場合 、 これ は 電子メール が 全体 として スパム で ある こと の 1つ の 証拠 と なる 。
そして さらに 、 この よう な 非 スパム より スパム に 出現 し そう な 単語 が 数多く 観測 さ れ 、 逆 に スパム より 非 スパム により 出現 し そう な 単語 について は あまり 観察 さ れ なかっ た 場合 、 これ は 電子メール が 全体 として スパム で ある こと の 強い 証拠 と なる 。

最終的 に は 、 ここ で の テキスト 分類 器 は 、 （ a ） 電子メール が スパム で ある と 仮定 し た 時 に 観察 さ れる メール の 内容 の 確率 と 、 （ b ） その 同じ 電子メール が 非 スパム で ある と 仮定 し た 時 に 観察 さ れる メール の 内容 の 確率 を 使っ て 計算 を 行う こと で 、 この 直観 を 定式 化 する 。
その こと から もし 対象 の 電子メール が スパム として 仮定 し た 場合 に 、 その メール を 観察 する 可能性 が 高けれ ば 、 その メール は スパム と 判定 さ れる 。

どの ぐらい この 確率 が 高けれ ば スパム と 判定 さ れる か は 、 電子メール 中 に どれ くらい スパム が 混じっ て いる の か という 標準 の 割合 に 依存 し て くる 。
この 標準 の 割合 は 一般的 に 事前 分布 と 呼ば れる 。
事前 分布 は 以下 の よう に 考える こと が できる 。
ある 公園 で 見かける 鳥 の ほとんど が アヒル で ある なら 、 ある 朝 、 鳥 が 「 ガーガー 」 と 鳴い て いる の が 聞こえ た 時 に 、 その 鳥 が アヒル で ある と 考える の は 極めて 安全 な こと で ある 。
しかし 、 その 公園 で アヒル を これ まで 一 度 も 見かけ た こと が ない 場合 、 「 ガーガー 」 と 鳴く もの すべて が アヒル だ と 判断 する こと は かなり 危険 で ある 。
これ と 同じ よう に 、 電子メール を 扱う 時 に も この 事前 分布 が 関与 し て くる の は 、 送信 さ れ て くる 電子メール が スパム ばかり だっ た と し たら 、 ある 新しい 電子メール において スパム だ という 証拠 が たとえ 弱く て も 、 その メール が スパム で ある と ラベル付け する 十分 な 理由 と なり うる から で ある 。

以下 の 節 で は 、 スパム 分類 器 を 書い て いく 過程 を通じて この 論理 を 詳しく 説明 する 。
電子メール における 確率 を 計算 する にあたって 、 各 単語 の 出現 頻度 は 他 の すべて の 単語 と は 独立 に 推定 できる と 仮定 する 。
形式的 に は 、 これ は 統計的 独立 性 と 呼ば れる 仮定 に 相当 する 。
それ が 正しい という 確信 が ない 時 に この 仮定 を おい た 場合 、 その モデル は ナイーブ で ある と 呼ば れる 。
この モデル は 、 電子メール 中 に どれ くらい スパム が 混じっ て いる の か という 標準 の 割合 を 利用 する ため 、 初めて 条件付き確率 の 概念 を 著し た 18世紀 の 数学者 に 敬意 を 払い 、 ベイズ モデル と も 呼ば れる 。
これら 2つ の 特徴 を まとめ 、 ここ で の モデル は ナイーブ ベイズ 分類 器 と 呼ば れる 。

本章 冒頭 で 述べ た よう に 、 ここ で は 分類 器 の 訓練 と テスト の 両方 の ため に SpamAssassin 公開 コーパス を 使う 。
ある メール が スパム で ある と 簡単 に 特定 する 方法 の 1つ として 、 それら タグ の 存在 を 確かめる 方法 が 考え られる こと を 思い出そ う 。
「 非 スパム （ 難 ） 」 を より 正確 に 分類 する に は 、 より 多く の テキスト 素性 から 得 られる 情報 を 利用 し なけれ ば なら ない 。
これら の 素性 を 抽出 する に は 、 電子メール ファイル の テキストマイニング が 必要 で あり 、 これ が 分類 器 を 作る ため の 第一歩 と なる 。

ここ で 扱う 生 の 電子メール ファイル に は 、 ヘッダ と メッセージ テキスト が 含ま れ て いる 。
典型 的 な 「 非 スパム （ 易 ） 」 の 電子メール は 例 3-1 の よう な もの だ 。
この メール を 見 て いくつか 興味深い 特徴 に 気付く はず だ 。
まず 、 ヘッダ に この 電子メール が どこ から 来 た の か を 示す 多く の 情報 が 含ま れ て いる の が わかる 。
サイズ の 制約 の ため 、 実は 例 3-1 に は ヘッダ の 全体 の うち 一部 しか 示し て い ない 。
ヘッダ に は 他 に も 多く の 有用 な 情報 が 含ま れ て いる が 、 ここ で 構築 する 分類 器 は それら 情報 を 使用 し ない 。
メッセージ の 伝達 に 含ま れ て いる 特徴 に 注目 する より も 、 メッセージ の 内容 そのもの が どの よう に 電子メール の 種類 の 予測 を 予測 する 上 で 意味 を 持つ か という こと の ほう に 方 に 興味 が ある からだ 。
これ は もちろん 、 ヘッダ など の 他 の 情報 を いつも 無視 し て いい という わけ で は ない 。
実際 、 最近 の 高度 な スパムフィルタ は 、 電子メール メッセージ ヘッダ の 情報 、 例えば 、 その 一部 が 偽装 さ れ て いる か どう か 、 既知 の スパム 業者 から 送ら れ て いる か どう か 、 欠け て いる 部分 が ある か どう か など の 情報 を 必ず 利用 し て いる 。

電子メール の メッセージ 本文 のみ に 注目 し て いる ので 、 まずは メッセージ ファイル から 本文 のみ を 抽出 する 必要 が ある 。
この 演習 に 含ま れ て いる メッセージ ファイル を いくつか 見 て みる と 、 電子メール の メッセージ が いつも 電子メール ファイル 内 の 最初 の 空 行 の 後 から 始まっ て いる という こと が わかる だろ う 。
例えば 例 3-1 において は 、 「 Hello , have you seen and discussed thisarticleandhisapproach ?」 という 文 が 、 最初 の 空 行 の 後 に 来 て いる の が わかる 。
分類 器 の 構築 を 始める ため に 、 まず この 電子メール テキスト の ルール を 利用 し て メッセージ 本文 を 抽出 する R の 関数 を 作ろ う 。

まず はじめ に 、 いつも と 同様 この 演習 に 使う ライブラリ を 読み込む 。
テキスト 分類 に は 、 tm パッケージ を 使う （ tm は テキストマイニング 、 textmining を 意味 する ） 。
分類 器 の 構築 と テスト を 行っ た 後 は 、 ggplot 2 パッケージ を 使い 、 結果 を 可視 化 し 分析 する 。
その他 に その 前 段階 として 、 すべて の 電子メール ファイル が 格納 さ れ た パス 変数 を セット する こと も 重要 だ 。
さて 前述 の 通り 、 メッセージ に は 「 スパム 」 「 非 スパム （ 易 ） 」 「 非 スパム （ 難 ） 」 の 3種類 が ある 。
本 演習 の データファイル ディレクトリ に は 、 それぞれ を 含む 2つ の 別々 の フォルダ が 用意 さ れ て いる 。
最初 の ファイル 群 は 分類 器 を 訓練 する ため に 、 そして 2つ 目 の ファイル 群 は 訓練 し た 分類 器 を テスト する ため に 使う 。

必要 な パッケージ を 読み込ん で パス 変数 が セット し て ある 状態 で あれ ば 、 両方 の ファイル 群 から テキスト コーパス を 作成 する こと により 、 スパム と 非 スパム に 含ま れる 単語 の 種類 について の 知識 を 構築 できる 。
そのため に は 各 ファイル を 開い て 最初 の 空 行 を 見つけ 、 その 下 の テキスト を 単一 の テキスト 要素 を 含む 文字 ベクトル として 返す 関数 を 書け ば 良い 。

R言語 における ファイル の 入出力 は 、 他 の 多く の 言語 と 同様 の 方法 で 行う こと が できる 。
この 関数 は ファイル パス を 文字列 として 受け取り 、 その ファイル を rt （ テキスト として 読み込む ） モード で 開く 。
エンコーディング が latin1 で ある こと に 注意 しよ う 。
これ は 、 多く の 電子メール の メッセージ に ASCII 外 の 文字 が 含ま れ て いる ため で あり 、 この 符号化 を 使う こと により これら の ファイル を 扱う こと が できる †。
readLine 関数 は 、 ファイル 中 の テキスト の 各行 を それぞれ 別 の 要素 と し た 文字 ベクトル を 返す 。
したがって すべて の 行 を 読み込ん だ 後 、 テキスト の 最初 の 空 要素 を 発見 し 、 その後 の すべて の 要素 を 抽出 する 必要 が ある 。
それ を 行う に は 、 電子メール の メッセージ を 文字 ベクトル に 格納 し て ファイル 接続 を 閉じ た 後 、 paste 関数 を 使い ベクトル を 単一 の 文字 要素 に し 、 cllapse 引数 に \ n ( 改行 ) を 指定 する 。

分類 器 を 訓練 する に は 、 すべて の スパム 、 非 スパム 電子メール から メッセージ を 取り出す 必要 が ある 。
それ を 行う 方法 の 1つ として 、 すべて の メッセージ を 含み 、 ベクトル の 各 要素 が 単一 の 電子メール と なっ て いる よう な ベクトル を 作る こと が 考え られる 。
R で それ を 行う 一番 素直 な 方法 は 、 新しく 作っ た get.msg 関数 を 、 apply 関数 と 一緒 に 使う こと だ 。

まずは スパム 電子メール に対して 、 dir 関数 を 使い 、 data/spam ディレクトリ 内 の すべて の ファイル名 の 一覧 を 取得 する こと から 始めよ う 。
この ディレクトリ を はじめ として 電子メール を 格納 し て いる すべて の ディレクトリ に は 、 cmds という ファイル が 含ま れ て おり 、 これ は それぞれ の ディレクトリ に ファイル を 移動 する ため の Unix ベース の コマンド が 書か れ た 長い リスト だ 。
今回 の 訓練 データ に は これら は 不要 な ので 、 ファイル名 に cmds を 含む ファイル を 無視 する 。
この 作業 によって spam.docs は 、 分類 器 を 訓練 する の に 使う スパムメッセージ の ファイル名 だけ を すべて 含ん だ 文字 ベクトル と なる 。

スパムメッセージ の ベクトル を 作る ため に 、 sapply 関数 を 使っ て get.msg を すべて の スパム ファイル名 に対して 適用 する と 、 ファイル の 内容 が 戻り値 として 返っ て くる ので 、 それ を 用い て メッセージ の ベクトル を 構築 する 。

この 処理 の 中 で は paste 関数 を 使っ て ファイル名 を 適切 な ディレクトリ ・ パス と 結合 する ため に 匿名 関数 を sapply に 渡し て いる こと に 注目 しよ う 。
これ は R の 処理 において よく 見 られる 構成 で ある 。
これら 一連 の コマンド を 実行 し た 後 、 head ( all.spam ) を 実行 する こと で その 結果 を 調べる こと が できる 。
すると 各 ベクトル 要素 の 名前 が ファイル名 に 対応 し て いる こと が わかる だろ う 。
これ は sapply を 使う 利点 の 1つ で ある 。

次 の ステップ で は 、 tm パッケージ の 提供 する 関数 を 使い 、 電子メール の ベクトル から テキスト コーパス を 作る 。
コーパス として 表現 さ れ た テキスト を 作る こと が できれ ば 、 メッセージ 中 の 単語 を 操作 し て 、 スパム 分類 器 の 素性 セット を 作り 始める こと が できる 。
tm パッケージ の 非常 に 大きな 利点 は 、 テキスト を 綺麗 に し たり 、 正規 化 し たり する ため に 必要 な 煩雑 な 作業 の 多く を 自動 化 し て くれる こと だ 。
数行 の R の コード で 完了 する こと が 、 低 レベル 言語 を 使っ て 自分 で 操作 の コード を 書く 場合 だ と 、 文字列 操作 を 何 行 も 書か なけれ ば なら ない こと も ある 。

スパムメール に ある 単語 の 頻度 を 数量 化 する 方法 の 1つ として 、 単語 文書 行列 （ termdocumentmatrix ： TDM ） を 構築 する 方法 が ある 。
TDM は その 名前 の 示す 通り 、 全 文書 に 現れ た 単語 1つ 1つ が 行 に 、 各 文書 が 列 に 対応 する よう な N×M 行列 で ある 。
この 行列 の [ i , j ] 番 目 の 要素 は 、 単語 i が 文書 j に 現れる 回数 に 対応 する 。

以前 と 同様 に 、 電子メール の メッセージ の ベクトル を 受け取っ て TDM を 返す 簡単 な 関数 get.tdm を 定義 する 。

tm パッケージ を 使う と 、 様々 な 方法 で コーパス を 作る こと が できる 。
今回 は 電子メール の ベクトル から コーパス を 作る ため 、 Vector Source 関数 を 使う 。
他 に どんな もの を 入力 として 使える の か を 調べる に は 、 R の コンソール で ? getSources と 入力 すれ ば 良い 。
tm パッケージ を 使う 場合 に は よく ある 処理 方法 で 、 一旦 ソース テキスト を 読み込ん だ 後 に 、 Corpus 関数 を VectorSpace と 一緒 に 使い 、 コーパス オブジェクト を 作る 。
ただし TDM の 作成 に 移る 前 に 、 テキスト を 綺麗 に し て 正規 化 する よう に tm に 指定 し なけれ ば なら ない 。
そのため に は 、 どの よう に し て テキスト を 「 精製 する 」 か を 指定 する オプション の リスト で ある control を 用いる 。

この 演習 で は 4つ の オプション を 指定 する こと に する 。
まずは stopwords = TRUE を セット し 、 英語 の 一般 的 な ストップワード を 文書 から 除去 する よう 、 tm に 伝える 。
stopwords () と R の コンソール で 打つ と 、 この ストップワード の リスト を 見る こと が できる 。
次に 、 removePunctuation と removeNumbers を TRUE に セット する 。
これら は 文字通り そういった たぐい の 文字 （ Punctuation ＝ 句読点 、 Numbers ＝ 数字 ） に関する ノイズ を 減らし て くれる が 、 この 指定 を 行っ て いる の は 、 今回 扱う 文書 の 多く が HTML タグ を 含ん で いる ため だ 。
最後 に 、 minDocFreq = 2 を セット し 、 コーパス に 2回 以上 出現 する 単語 のみ が 、 TDM の 行 に 現れる よう に する 。

これ で やっと スパム 電子メール の 生 テキスト を 、 分類 器 を 作り 始め られる 段階 まで 処理 する こと が でき た 。
つまり ここ まで で 構築 し た TDM を 利用 し て 、 スパム の 訓練 データ を 構築 する こと が できる よう に なっ た 。
R 上 で これ を する に は 、 電子メール が スパム で ある という 条件 の 下 、 各 単語 の 観察 さ れ た 確率 を 含む データ フレーム を 作る の が 良い 。
つまり 女性 の コンピュータサイエンス 専攻 に関する 例 と 同様 に 、 ある 単語 が 観察 さ れ た 時 に その 電子メール が スパム で ある 確率 が わかる よう に 分類 器 を 訓練 すれ ば 良い 。

この データ フレーム を 作る ため に は まず 、 as.matrix コマンド を 使っ て TDM オブジェクト を 通常 の R 行列 に 変換 し なけれ ば なら ない 。
その後 rowSums コマンド を 使い 、 各 単語 の 全 文書 中 の 合計 頻度 を 含む ベクトル を 作る 。
ここ で data.frame 関数 を 使い 文字 ベクトル と 数値 ベクトル を 結合 し て いる が 、 その 際 に R は デフォルト で これら の ベクトル を 共通 の 表現 に 変換 する 。
頻度 カウント は 文字列 として も 表現 でき 、 何 も 指定 し なけれ ば 文字列 に 変換 さ れ て しまう ため 、 stringAsFactors = FALSE を セット する よう に 注意 し なけれ ば なら ない 。
次に 少し データ を 整理 する ため に 、 行 の 名前 を セット し て から 頻度 カウント を 数値 ベクトル に 戻す 。

続く 2つ の ステップ で は 、 大切 な 訓練 データ を 生成 する こと に なる 。
まずは ある 単語 が 出現 し た 文書 の 割合 を 計算 する 。
そのため に は sapply を 使っ て すべて の 行 を 匿名 関数 に 渡し て 正の数 を 持つ 要素 の 数 を 数え 、 次に その 合計 を TDM の 列 の 数 、 すなわち スパムコーパス の 文書 数 で 割る こと により 実現 できる 。
次に 各 単語 の コーパス 全体 で の 頻度 を 計算 する （ 今回 は 頻度 情報 を 分類 に 使う わけ で は ない が 、 ある 単語 が 結果 に どの よう に 影響 し て いる か を 考える 時 に 、 これら の 数字 を 比較 する の は 役に立つ ） 。
最後 に 、 spam.occurrence と spam.density ベクトル を transform 関数 を 使い データ フレーム に 追加 する 。
これ で スパム 分類 の 教師 データ を 生成 は 完了 だ 。

データ を チェック し て 、 今回 の 訓練 データ の 中 で は どの 単語 が スパム の 最も 強い 兆候 と みなさ れ て いる か を 調べ て みよ う 。
spam.df を occurrence 列 で ソート し 、 head を 調べれ ば 良い 。

すでに 繰り返し 述べ て いる よう に 、 HTML タグ は 最も 強い スパム の 素性 で ある 。
スパム の 訓練 データ 中 の 30% 以上 の メッセージ が 、 html という 単語 や 、 body 、 table 、 font 、 head など の 他 の HTML 関係 の 単語 を 含ん で いる 。
しかし 出現 頻度 で 考える と 、 これら は 最も 頻出 する 単語 で は ない 。
前述 の 文 の -occurrence を -frequency で 置き換える こと で 、 頻度 を チェック する こと も できる 。
これ は 、 分類 器 を 定義 する 上 で 非常 に 重要 で ある 。
もし 生 の 頻度 データ と その 密度 を 訓練 データ として 使っ て しまう と 、 ある 種 の スパム 、 特に HTML の 表 を 含む もの を 重視 し すぎ て しまう こと に なる 。
しかし すべて の スパムメッセージ が HTML で ある わけ で は ない こと は もちろん 知っ て の とおり だ 。
よって 、 いくつ の メッセージ が その 単語 を 含む か に 基づい て 、 条件付き確率 を 定義 する ほう が 良い アプローチ だろ う 。

さて 、 スパム 訓練 データ の 準備 が でき た ので 、 非 スパム の 訓練 データ も 作っ て バランス を 取る 必要 が ある 。
同様 に 訓練 データ を 非 スパム （ 易 ） メッセージ だけ を 使っ て 作っ て みよ う 。
もちろん 、 非 スパム （ 難 ） を 訓練 データ として 利用 する こと も 可能 だ 。
実際 、 もし 実際 に 利用 する ため の システム を 構築 し て いる の なら ば その 方 が 望ましい 。
しかし ここ で は 簡単 に 分類 できる 小さい 文書 コーパス のみ を 使っ て 訓練 し た 場合 に 、 テキスト 分類 器 が どの ぐらい うまく 動く か を まずは 見 て みる の が 良い だろ う 。

非 スパム の 訓練 データ は スパム に対して 行っ た の と 全く 同じ 方法 で 構築 する ので 、 その 方法 について は 省略 する 。
この ステップ において 、 スパム の 訓練 データ を 作る の と 唯一 異なる 点 は 、 date/easy_ham フォルダ の 最初 の 500 個 の 電子メール メッセージ のみ を 使う という 点 で ある 。

この ディレクトリ に は 実際 に は 2 , 500 個 の 非 スパム 電子メール が 含ま れ て いる 。
なぜ ここ で データ の 5分 の 4 を 無視 し て しまう の だろ う か 。
それ は 最初 の 分類 器 を 作る 際 に 、 各 メッセージ が スパム で ある 確率 と そう で は ない 確率 が 等しい と 仮定 する から で ある 。
そのため 、 訓練 データ が この 仮定 を 反映 する よう に し た ほう が 良い 。
つまり スパムメッセージ が 500 個 しか ない ため に 、 非 スパム の 訓練 セット も 500 個 に 制限 する の で ある 。

どの よう に し て 非 スパム の 訓練 データ を 制限 し た の か を 見る に は 、 この 章 の email_classify.R ファイル の 102 行 目 を 見れ ば 良い 。

非 スパム の 訓練 データ が 構築 でき たら 、 スパム の 場合 と 比較 する ため に 、 その 中身 を 覗い て みよ う 。

違い を 比較 し て 最初 に 気付く こと は 、 非 スパム の 訓練 データ で は 電子メール 間 で 単語 の 単語 の 出現 が より バラバラ で ある という 点 だ 。
最も 多く の 文書 に 出現 する 単語 「 yahoo 」 で も 、 出現 する 文書 の 割合 は たった 18% だ 。
他 の 単語 に いたっ て は 、 それぞれ 出現 し て いる 文書 の 割合 は 10% より も 少ない 。
これ を 、 24% 以上 の 文書 に 出現 する 上位 の スパム 単語 と 比較 し て みよ う 。
この 違い を 使い どう やっ て スパム を 非 スパム から 分離 する か 、 もう すで に わかっ て きた だろ う か 。
もし ある メッセージ に スパム に 強く 関連 の ある 単語 を 1 〜 2 個 含ん で い た と し たら 、 その メッセージ が 非 スパム と 分類 さ れる に は 、 多く の 非 スパム 単語 が 必要 に なる 。
さて 両方 の 訓練 セット が 定義 でき た ので 、 ここ で 分類 器 を 完成 し 、 テスト する 準備 が 整っ た と いえる 。

ここ で 定義 し たい の は 、 電子メール の メッセージ ファイル を 受け取り 、 それ が スパム 、 あるいは 非 スパム で ある 確率 を 計算 し て くれる 分類 器 で ある 。
幸い な こと に 、 この 計算 を 行う ため に 必要 な 関数 と データ は も うすで に ほとんど 作っ て ある 。
しかし 先 に 進む 前 に 、 考え て おか なけれ ば いけ ない 問題 が 1つ ある 。

新しい 電子メール に 出現 し た 単語 の うち 、 訓練 セット の 単語 に マッチ する もの と 、 マッチ し ない もの を どの よう に し て 扱う か を 決める 必要 が ある （ 図 3-3 参照 ） 。
ある 電子メール メッセージ が スパム で ある 確率 、 あるいは 非 スパム で ある 確率 を 計算 する ため に は 、 訓練 データ と 対象 の メッセージ で 、 共通 する 単語 を 見つける 必要 が ある 。
その後 に これら の 単語 に 結び付い た 確率 を 使い 、 メッセージ が 訓練 データ の どちら の タイプ か の 条件付き確率 を 計算 する 。
ここ まで は 非常 に わかり やすい が 、 もし 分類 しよ う と し て いる 電子メール の 単語 で 、 訓練 データ に 現れ ない もの が あっ た 場合 どう すれ ば 良い だろ う か 。

ある メッセージ の 条件付き確率 を 計算 する に は 、 訓練 データ の 各 単語 の 確率 を 積 を 取る こと によって 結合 する 。
例えば スパムメッセージ において 「 html 」 という 単語 が 現れる 確率 が 0.30 、 「 table 」 が 現れる 確率 が 0.10 なら 、 スパムメッセージ において 両方 が 現れる 確率 は 0.30 × 0.10 ＝ 0.03 で ある と 言える 。
しかし 、 電子メール 中 に 現れ た 単語 が 訓練 データ に ない もの だっ た 場合 、 スパムメッセージ に も 非 スパムメッセージ に も 、 その 頻度 に関する 情報 が ない 。
そうした 状況 を 解決 する 方法 の 1つ として 、 ある グループ において 観察 さ れ て い ない 単語 の 出現 確率 を ゼロ である と する 方法 が 考え られる 。
しかし これ は 間違っ た 考え方 だ 。
ある 単語 が まだ 観察 さ れ て い ない から と いっ て 、 世に ある すべて の スパム や 非 スパムメッセージ において その 単語 を 未来永劫 絶対 に 観察 し ない と 仮定 する の は あまり 薦め られ た こと で は ない 。
これ は 、 多く の 、 あるいは すべて の メッセージ に対して 、 スパム もしくは 非 スパム で ある 確率 が 0 に なっ て しまう という 壊滅 的 な 結果 を 引き起こす こと に なる 。
この 問題 を 回避 する 方法 として 、 ある 分布 から ランダム で 確率 を 選ん だり 、 自然言語処理 （ naturallanguageprocessing ： NLP ） の 技術 を 使う こと で 文脈 から 単語 の 「 スパム らし さ 」 を 推定 し たり といった 賢い 方法 が 研究者 によって 考案 さ れ て き た 。
しかし ここ で は 訓練 セット に 含ま れ ない 単語 に は 、 非常 に 小さな 確率 を 割り当てる 、 という 非常 に 単純 な 規則 を 使う こと に する 。
実は これ は 単純 な テキスト 分類 器 で 未知語 を 扱う 一般 的 な 方法 で あり 、 今回 の 場合 も 問題 なく 機能 し て くれる 。
本 演習 において は この 確率 を 0.0001 % 、 すなわち 1 万 分の 1パーセント に セット する 。
これ は この データセット に対して は 十分 に 小さな 値 で ある 。

また 最後 に 、 すべて の 電子メール は スパム 、 非 スパム で ある 確率 が 同等 だ と 仮定 し て いる ため 、 電子メール が それぞれ の タイプ で ある という 事前確率 は 50% と し て おく 。
ただし 、 後 から この 問題 を もう一度 検討 できる よう 、 この 事前確率 を 変更 できる よう に classify.email 関数 を 設計 し て いる 。

classify.email 関数 の 最初 の 3つ の ステップ は 、 訓練 の 際 と 同じ 処理 で ある こと が わかる だろ う 。
メッセージ テキスト を get.msg を 使っ て 抽出 し 、 get.tdm を 使っ て TDM に 変換 し 、 rowSums を 使っ て 単語 の 頻度 を 計算 し て いる わけ だ 。
続い て 図 3-3 に 示す よう に 、 電子メール メッセージ の 単語 と 訓練 データ の 単語 と どの ぐらい 重複 し て いる の か を 調べる 。
それ を 行う に は intersect コマンド を 使い 、 電子メール メッセージ と 訓練 データ に それぞれ 含ま れる 単語 を 渡せ ば 良い 。
返っ て くる の は 図 3-3 の 灰色 に 塗ら れ た 部分 で ある 。

分類 の 最後 の ステップ は 、 電子メール の メッセージ 中 の 単語 が 訓練 データ に 含ま れ て いる か どう か を 調べる こと だ 。
もし 含ま れ て いる の で あれ ば 、 それら を 使っ て この メッセージ が それぞれ の 分類 で ある 確率 を 計算 する 。

まずは 、 この 電子メール が スパム で ある か どう か を 判定 する ところ を 見 て みよ う 。
msg.match に は 、 スパム の 訓練 データ で ある spam.df に ある 電子メール メッセージ に 含ま れる すべて の 単語 が 入っ て いる 。
もし これ と 調べ て いる メール の 本文 の 積 集合 が 空 で あれ ば 、 msg.match の 長さ は ゼロ 未満 に なり 、 事前 分布 に 電子メール の 単語 の 数 と 小さい 確率 値 c と の 積 を 掛け合わ せ て 更新 する こと しか でき ない 。
結果 として 、 スパムラベル が 電子メール に 割り当て られる 確率 は 非常 に 小さく なる 。

逆 に もし 積 集合 が 空 で なけれ ば 、 その 電子メール に 含ま れる 単語 を 訓練 データ から 見つけ 、 その 出現 確率 を 調べる 必要 が ある 。
match 関数 を 使う こと で 出現 確率 を 調べる こと が でき 、 これ は 、 訓練 データ の term 列 における その 単語 の 要素 位置 を 返す 。
次に 、 この 要素 位置 を 使っ て 対応 する 確率 を occurrence 列 から 取得 し 、 これら の 値 を match.probs に 返す 。
続い て これら の 個々 の 確率 の 積 を 計算 し 、 電子メール が スパム で ある 事前確率 と 、 単語 の 確率 、 そして 、 未知語 の 確率 を 組み合わせる 。
その 結果 が 、 訓練 データ に マッチ し た 単語 を 条件 と し た 、 ある メッセージ が スパム で ある 確率 の ベイズ推定 値 で ある 。

まず 最初 に 、 スパム と 非 スパム （ 易 ） から 作っ た 訓練 データ を 使い 、 非 スパム （ 難 ） を 分類 する テスト を 行っ て みよ う 。
非 スパム （ 難 ） の すべて の 電子メール が スパム で は ない という こと が わかっ て いる ため 、 ここ で 構築 し た 分類 器 が これら の メッセージ が 非 スパム で ある という 方 に 高い 確率 を 付与 する という の が 理想 的 な 状態 だ 。
しかし 同時に 、 非 スパム （ 難 ） は 、 スパム に 関連 する 単語 も 含ん で おり 、 正しく 分類 する の は 「 難しい 」 こと も わかっ て いる 。
さて 今回 の 分類 器 が どの ぐらい うまく いく か 見 て みよ う 。

これ まで と 同様 に すべて の ファイル パス を 順番 に 取得 し 、 sapply 関数 の 呼び出し で スパム 判定 と 非 スパム 判定 の 両方 を ラップ する こと によって 、 すべて の 非 スパム （ 難 ） メッセージ に対して 、 分類 器 を テスト する こと が できる 。
hardham.spamtest と hardham.hamtest の ベクトル に は 、 それぞれ 適切 な 訓練 データ に 基づい て 計算 し た 、 各 非 スパム （ 難 ） 電子メール が スパム もしくは 非 スパム で ある 条件付き確率 が 含ま れ て いる 。
次に ifelse コマンド を 使い 、 各 ベクトル の 確率 値 を 比較 する 。
もし hardham.spamtest の 値 が hardham.hamtest の 値 より 大きけれ ば 、 その メッセージ は スパム 、 そう で なけれ ば 非 スパム と 分類 さ れ た こと に なる 。
最後 に 、 summary コマンド を 用い て 結果 を 調べる こと が できる （ 表 3-2 ） 。

お疲れ様 。
これ で 最初 の 分類 器 が 完成 し 、 非 スパム （ 難 ） を スパム で は ない と そこそこ 良く 判定 でき て いる こと が わかっ た 。
今回 作っ た 分類 器 の 偽陽性 率 は おおよそ 26% で ある 。
この 意味 する ところ は 、 おおよそ 4分 の 1 の 非 スパム （ 難 ） 電子メール が 、 誤っ て スパム で ある と 判断 さ れ て しまっ て いる という こと だ 。
この 分類 器 の 性能 は 非常 に 低く 、 実用 システム において この よう な 結果 の 電子メール プラットフォーム を 提供 し たく は ない と 考える かも しれ ない が 、 今回 構築 し た 分類 器 が いかに 単純 か を 考える と 、 なかなか 良い 結果 で ある と も いえる 。
もちろん さらに 、 分類 器 が 非 スパム （ 難 ） だけ で は なく 非 スパム （ 易 ） や スパム に対して も どの よう に 振る舞う か を 見 た ほう が より 良い テスト と なる 。

すべて の タイプ に対して テスト を 行う ため の 最初 の ステップ は 、 前節 で 見 た よう な 確率 の 比較 を 、 すべて の 電子メール に対して 一 度 に 実行 し て くれる よう な 簡単 な 関数 を 作る こと で ある 。

簡単 化 の ため に 、 spam.classifier 関数 は 、 ある 電子メール が スパム か どう か を spam.df と 訓練 データ easyham.df に 基づき 判定 する と する 。
もし ある メッセージ が スパム で ある 確率 が 非 スパム で ある 確率 より 大きけれ ば 、 この 関数 は 1 を 返し 、 そう で なけれ ば 0 を 返す 。

本 演習 の 最後 の ステップ として 、 スパム 、 非 スパム （ 易 ） 、 非 スパム （ 難 ） の 残り の セット を 、 分類 器 を 使っ て テスト し て みよ う 。
これら の ステップ は 、 前節 で 見 た の と 全く 同じ よう に 進む 。
spam.classifier 関数 を lapply 関数 で ラップ し 、 電子メール ファイル パス を 渡し 、 データ フレーム を 作る 。
そのため 、 これら の 関数 呼び出し を 再掲 する こと は し ない が 、 email_classifier.R ファイル の 158 行 目 以降 を 参照 し 、 どの よう に これ を 実行 する か を 確認 する こと を 推奨 する 。

新しい データ フレーム に は 、 スパム もしくは 非 スパム で ある 尤もらし さ 、 分類 結果 、 3つ の データセット における 各 メッセージ の 電子メール の 種類 が 含ま れ て いる 。
新しい データセット は class.df と 呼ば れ 、 head コマンド を 使っ て その 内容 を 調べる こと が できる 。

最初 の 6つ の エントリ を 見る と 、 分類 器 が うまく 動い て いる よう に 見える 。
しかし すべて の データセット に対する 分類 器 の 偽 陽性 と 偽陰性 の 割合 を きちんと 計算 し て みよ う 。
そのため に 、 行 が 実際 の 分類 タイプ 、 列 が 予測 さ れ た タイプ に 対応 する N×M の 行列 を 構築 する 。
ここ で は 、 3つ の タイプ を 持つ 電子メール を 2つ の タイプ に 分類 し て いる ため 、 混同 行列 は 3 行 2 列 から なる （ 表 3-3 に 示し た とおり ） 列 は 非 スパム もしくは スパム と 分類 さ れ た 割合 で あり 、 もし 分類 器 が 完璧 に 動作 し た 場合 に は 列 は それぞれ [ 1 , 1 , 0 ]、[ 0 , 0 , 1 ] と なる 。

残念 ながら 今回 作っ た 分類 器 は 完璧 で は ない が 、 結果 は 悪く ない 。
最初 の テスト と 同様 、 偽陽性 率 約 25% を 達成 し て おり 、 非 スパム （ 易 ） の 方 が 、 非 スパム （ 難 ） に 比べ て 分類 器 が 良い 結果 を 上げ て いる 。
一方 で 偽陰性 率 は かなり 低く 、 たった 15% ほど しか ない 。
分類 が どの ぐらい うまく 行っ て いる か という 感覚 を つかむ ため に 、 x 軸 と y 軸 に それぞれ 非 スパム・スパム で ある 予測 確率 を 取っ て 、 散布図 を 用い て 結果 を プロット し て みよ う 。

図 3-5 に 、 この 散布 図 を 両 対数 グラフ で 示し た 。
対数 変形 し た の は 、 多く の 予測 確率 が 非常 に 小さい が 、 同時に 大きい 値 も 含ま れ て いる から で ある 。
これ ほど 分散 の 度合い が 大きい と 、 結果 を 直接 比べる の が 難しく なる 。
対数 を 取る の は 、 より 簡単 に 値 を 比べる ため に 見た目 の スケール を 変える 簡単 な 方法 で ある 。

さらに この 図 に は 単純 な 決定 境界 、 すなわち y ＝ x の 完全 な 線形 関係 を 図 に 追加 し て ある 。
なぜ か と いう と 、 今回 の 分類 器 は 、 2つ の 予測 確率 を 比較 し て 電子メール の 種類 を スパム の 確率 が 大きい か 、 非 スパム の 確率 が 大きい か に 基づき 決定 する もの だ から だ 。
したがって 黒い 対角線 の 上側 に ある すべて の 点 は スパム 、 下側 の 点 は 非 スパム と なる べき で ある 。
もちろん 、 見 て わかる とおり 、 その よう な 状態 に は なっ て い ない が 、 メッセージ の 種類 によって かなり の まとまり が でき て いる こと が わかる 。

図 3-5 を 見る と 、 偽陽性 に関して 分類 器 が どの よう に 失敗 し て いる の か を 、 直観 的 に 理解 する こと が できる 。
失敗 に は 、 2つ の 一般 的 な タイプ が ある よう だ 。
1つ 目 は 、 スパム で ある 確率 が 正 である が 、 非 スパム で ある 確率 が ほぼ ゼロ の 非 スパム （ 難 ） で あり 、 かなり の 数 が 存在 する 。
これら は y 軸 に くっつい て いる 点 によって 表さ れ て いる 。
2つ 目 は 、 非 スパム で ある 相対 確率 が より 高い もの で 、 これ は 非 スパム （ 難 ） と 非 スパム （ 易 ） の 両方 に 存在 する 。

本章 で は 、 テキスト 分類 の 概念 を 紹介 し た 。
そのため に 、 最低限 の 数 の 仮定 と 素性 を 使い 、 非常 に 単純 な ベイズ 分類 器 を 構築 し た 。
この タイプ の 分類 は 、 本質的 に は 古典 的 な 条件付き確率 の 理論 を 現代 的 な 状況 に 応用 し た もの で ある 。
今回 、 全体 として 使える データ の 一部 のみ を 使っ て 分類 器 を 訓練 し た に も 関わら ず 、 この 単純 な 方法 は 満足 の いく 程度 に うまく 行っ た 。

と は 言う ものの 、 今回 作成 し た 分類 器 における テストデータ の 偽 陽性 と 偽陰性 の 割合 は 、 実用 スパムフィルタ として は 高 すぎる 。
本章 で 説明 し た よう に 、 現在 の モデル の 結果 たくさん の 簡単 な 微 調整 を 行う こと で 改善 できる 。
例えば 今回 の アプローチ で は 、 各 電子メール が スパム もしくは 非 スパム で ある 確率 は 等しい と 事前 に 仮定 し て いる 。
しかし 現実 に は 、 この 比率 は 非 スパム 80% − スパム 20% に 近い こと が わかっ て いる 。
よって 結果 を 改善 する 1つ の 方法 は 、 単純 に この 事実 を 反映 する よう に 事前 分布 を 変え 、 予測 確率 を 再 計算 する こと で ある 。

classify.email 関数 において 、 事前 分布 の パラメータ を 変更 できる よう に し て おい た の を 覚え て いる だろ う か 。
この 準備 の おかげ で 、 事前 分布 を 変更 する 場合 も 、 前 の 例 に 示し た spam.classify を 少し 変える だけ で 良い 。
この 変更 後 、 分類 器 を もう一度 走ら せ て 結果 を 比較 できる ため 、 ぜひ 自身 で 試し て ほしい 。
しかし 、 この 新しい 仮定 は 、 訓練 データ における 非 スパム と スパムメッセージ の 分布 と 食い違っ て いる 。
より 正確 に 結果 を 得る に は 、 非 スパム （ 易 ） の データセット を すべて 用い て 分類 器 の 再 学習 を 行う べき で ある 。
訓練 データ が ベイズ 仮定 を 反映 する よう 、 オリジナル の 非 スパム 訓練 データ を 、 最初 の 500 メッセージ に 限定 し た こと を 思い出そ う 。
つまり 新しい 事前 分布 の 仮定 を 反映 さ せる ため に は 、 データセット 全体 を 使わ なけれ ば なら ない 。

新しい easyham.df と classify.email の パラメータ 分類 器 を もう一度 走ら せ て みる と 、 偽陽性 の 性能 について 目立っ た 改善 が 見 られ た （ 表 3-4 ） 。

この 簡単 な 変更 により 、 偽陽性 の 割合 を 50% も 減ら せ た こと に なる 。
しかし 興味深い の は 、 この よう に 性能 を 改善 する こと により 、 偽陰性 の 結果 が 悪く なっ て いる という こと で ある 。
突き詰め て 考える と 、 ここ で 行っ て いる こと は つまり 、 決定 境界 を 動かし て いる という こと な の だ （ 例 3-1 を 思い出そ う ） 。
その 操作 によって 偽陰性 を 犠牲 に し て 、 偽陽性 の 性能 を 改善 し て いる の で ある 。
これ は なぜ モデル の 仕様 が 非常 に 大切 か 、 そして それぞれ の 仮定 と 素性 の 選択 が 結果 の どの よう に 影響 する か を 示す 素晴らし い例 で ある 。

以降 の 章 で は 、 この 演習 で 扱っ た 単純 な 二 値 の 「 白 か黒か 」 の 例 より も 分類 の 視野 を 広げる こと に する 。
最初 に 述べ た よう に 、 観察 データ を 単一 の 決定 境界 により 分類 する の は 時に 難しく 、 不可能 で すら ある 。
次 章 で は 、 高い 優先 度 に 関連 する 素性 に 基づい て 電子メール を いかに 順位 付け する か について 詳しく 見 て いく 。
分類 タスク の 幅 を 増やし て いく につれて さらに 重要 に なる の は 、 モデル に どんな 素性 を 利用 する か という こと だ 。
これから 見 て いく よう に 、 データ が 素性 の 幅 を 制限 し 、 モデル デザイン に 重大 な 影響 を 及ぼす 場合 も ある の で ある 。

3 章 で は 、 与え られ た 項目 が 2つ の クラス の どちら に 属する か を 判別 する 二 値 分類 問題 について 考え た 。
実際 に 解決 す べき 問題 の 中 に は 単に 2種類 の 区別 を つける だけ の 簡単 な 手法 で 十分 な もの が たくさん ある 。
しかし 、 ある クラス に 属する 項目 が 同等 の もの で は なく 、 その 中 で 順位 付け 行う 必要 が あっ た と し たら どう だろ う 。
例えば 電子メール を 分類 し て い て 、 どの メール が 最も スパム で ある 可能性 が 高く 、 2番 目 に 可能性 が 高い の は どれ か 、 あるいは その他 の 意味 の ある 方法 で 区別 し たい 場合 も ある 。
例えば 単に 電子メール から スパム を 除去 する だけ で なく 、 「 より 重要 な 」 メッセージ を 受信箱 の 上位 に 表示 し たい と する 。
これ は 機械学習 で は よく ある 問題 で あり 、 本章 で 取り扱う 問題 で も ある 。

これら の 問題 を 考え た こと が ない かも しれ ない が 、 項目 の 一覧 を 順位 付け する ため の 規則 性 は 、 機械学習 において 一般 的 な タスク に なり つつ ある 。
もしか し たら 推薦 システム という 言葉 を 聞い た こと が ある かも しれ ない が 、 これ は 暗黙 的 に 商品 の 順位 を 生成 する もの で ある 。
もし 推薦 システム という 言葉自体 を 聞い た こと が なかっ た として も 、 今 まで に ある 種 の 推薦 システム を 使っ たり 見 たり し た こと は ある に 違い ない 。
大きな 成功 を 収め て いる 電子商取引 ウェブサイト の うち いくつか は 、 ユーザ の データ を 活用 し て ユーザ が 興味 を 持つ かも しれ ない 他 の 商品 を 推薦 する こと で 利益 を 得 て いる の だ 。

例えば 、 書籍 など を 販売 する ウェブサイト の Amazon で 買い物 を し た こと が あれ ば 、 推薦 システム を 目 に し て いる はず で ある 。
Amazon が 直面 する 課題 は シンプル で 、 在庫 の ある 商品 の うち 、 顧客 が どれ を 買う か を 予想 する という もの だ 。
これ は 暗黙 的 に 、 Amazon が それぞれ の ユーザ に対して 在庫 の ある 商品 を 順序付け て いる こと を 示し て いる 。
同様 に Netflix.com という 英語圏 の ウェブサイト は 、 顧客 に 貸し出す こと の できる 大量 の DVD を 保有 し て いる 。
これら の 顧客 が ウェブサイト を 最大限 活用 できる よう に 、 Netflix は 顧客 に レンタル する 商品 を 提案 する 洗練 さ れ た 推薦 システム を 採用 し て いる 。

これら の 推薦 システム は どちら も 2種類 の データ に 基づい て 構築 さ れ て いる 。
1つ 目 は 在庫 の ある 商品 そのもの に 関連 する データ で ある 。
Amazon で は 、 例えば テレビ について の データ なら 、 種類 （ プラズマテレビ 、 液晶 、 LED など ） 、 メーカー 、 価格 など が それ に 当たる 。
Netflix で は 、 この データ は 映画 の ジャンル 、 出演者 、 監督 、 上映 時間 など で ある 。
2つ 目 の データ は 顧客 による 閲覧 や 購買 行動 に 関連 する データ で ある 。
この 種 の データ は 、 Amazon で は プラズマ TV を 買っ た 顧客 が 次に 買い そう な アクセサリ を 予想 し たり 、 Netflix で は ジョージ・A・ロメロ （ GeorgeA.Romero ） の ファン が どの ラブコメディ の DVD を 借り そう か 推定 し たり する の に 使わ れる 。
どちら の 種類 の データ も 、 その 素性 は きちんと 定義 さ れ て いる 。
つまり 商品 の 種類 や 映画 の ジャンル など 、 カテゴリ データ の ラベル が わかっ て いる という こと だ 。
同様 に 、 ユーザ が 生成 し た データ は 購入 、 レンタル の 記録 や 明示 的 な 評価 の 形 で 構成 さ れ て いる 。

順位 付け を 行う とき 、 通常 は あらかじめ 明示 的 な 出力 例 が 与え られ て いる ため 、 この よう な 機械学習 の 手法 を 教師 あり 学習 と 呼ぶ 。
これ は データ を 扱う 前 に 存在 する 出力 例 が 与え られ ない 教師 なし 学習 と 対照 的 で ある 。
この 違い を より 理解 する ため に 、 指示 を 介し て の 学習 過程 として 、 教師 あり 学習 を 考え て みる 。
例えば 、 誰か に おいしい チェリーパイ の 焼き 方 を 教える こと を 考え 、 あなた は その 生徒 に レシピ を 渡し て 、 その 結果 でき た パイ の 味見 を さ せる 。
味見 を し た 結果 を 見 て 、 素材 を 調整 する こと に する かも しれ ない 。
使っ た 素材 （ 入力 ） と 味見 の 結果 （ 出力 ） の 記録 によって 、 各 素材 が どの よう に 影響 し た の か を 分析 し 、 完璧 な チェリーパイ の レシピ を 見つけよ う と する の で ある 。

それ と は 異なり 、 もし あなた が 、 フライドビーンズ の 料理 が トルティーヤ とともに 出 て くる 傾向 が ある 一方 で 、 焼い た チェーリー が パン生地 と 一緒 に 出 て くる 傾向 が ある こと を 知っ て い たら 、 メキシコ料理 を 作る 素材 と アメリカ の デザート を 素材 という よう に 素材 を グループ 化 できる かも しれ ない 。
この よう な 教師 なし 学習 は クラスタリング と 呼ば れ 、 項目 を 共通点 や 相違 点 を もと に 決まっ た 数 の グループ に 分ける こと が できる 。

3 章 の 演習 を 実際 に 試し て み た の で あれ ば 、 読者 は すでに 教師 あり 学習 の 問題 を 解い た こと が ある こと に なる 。
スパム 分類 の 問題 で は 、 スパム と 非 スパム の メッセージ に 関連 する 単語 を 活用 し て 、 その レシピ に 基づい て 分類 器 を 訓練 し た 。
これ は 非常 に 単純 な 問題 だっ た ので 、 メッセージ に 含ま れる 単語 という 単純 な 素性 を 使う だけ で 、 比較的 良好 な 結果 を 得る こと が でき た 。
しかし 、 順位 付け において 項目 を うまく 並べる ため に は 、 それぞれ の 項目 に 固有 の 重み を 割り当てる 必要 が ある 。

それでは 次 の 節 から 、 本章 の タイトル に ある 問題 に 取り組む こと に しよ う 。
どう すれ ば まだ 並び 順 を 知ら ない データ を 並び 替え られる だろ う か 。

どう すれ ば 電子メール の 重要 度 を 決め られる だろ う か 。
この 疑問 に 答える ため に 、 まずは 電子メール と は 何 か という 点 に 立ち戻っ て 考え て みよ う 。
第一 に 、 電子メール は やり取り に 基づく メディア だ 。
人々 は 時間 軸 に 沿っ て メッセージ を 送っ たり 受け取っ たり し て いる 。
よって 、 電子メール の 重要 度 を 決める ため に は 、 まず その やり取り そのもの に 焦点 を 当てる 必要 が ある 。
スパム 分類 タスク で は 、 すべて の 電子メール から スパム か どう か を 決める ため の 統計 情報 を 使う こと が でき た が 、 電子メール を 重要 度 順 に 順位 付け する ため に は 、 入っ て き たり 出 て いっ たり する やり取り の 動き に 注意 を 払う 必要 が ある 。
特に 求め たい の は 、 ある 人 が 新しい 電子メール を 受け取っ た 時 に 返信 など の 反応 を 示す か どう か どう か の 確率 で ある 。
言い換えれ ば 、 注目 する と 選ん だ 素性 の セット が 与え られ た とき 、 読み手 は どれ くらい の 確率 で その 電子メール に対して 近い 将来 に 行動 を 起こす だろ う か 、 という 問題 で ある 。

この 問題 において 重要 な の は 、 時間 という 新しい 軸 で ある 。
電子メール の やり取り の 中 で 物事 を 重要 度 で 順位 付け する ため に は 、 何らかの 形 で 時間 の 概念 を 扱う 必要 が ある 。
時間 を 使っ て 電子メール の 重要 度 を 決める 自然 な 方法 は 、 受け手 が その 電子メール に対して 何らかの 行動 を 起こす まで の 時間 を 測る という もの だ 。
受け手 が 何らかの 行動 を する まで の 平均 時間 が 短けれ ば 短い ほど 、 その 電子メール は 重要 で ある と 言う こと が できる の で ある 。

ここ で 、 重要 な 電子メール に は そう で ない 電子メール より も すぐ に 反応 する という 暗黙 的 な 仮定 を 置い て いる 。
これ は 直観 的 に わかり やすい 。
多く の ユーザ は 、 受信 トレイ に 溜まっ た 電子メール を 見 て 、 すぐ に 返信 が 必要 な メール と 待た せ て も いい メール と を 振り分けよ う と する から だ 。
ユーザ が 当たり前 に 行っ て いる この 振り分け 作業 は 、 次 の 節 で コンピュータ に 教えよ う と し て いる こと そのもの だ 。
だが これ を 始める 前 に 、 まずは 電子メール の メッセージ の どんな 素性 が 優先 度 の ため の 良い 基準 と なる か を 決める 必要 が ある 。

もし Google の 電子メール サービス で ある Gmail を 使っ た こと が あれ ば 、 「 優先 トレイ 」 と 呼ば れる アイデア が Google によって 、 2010年 に 初めて 広まっ た こと を 知っ て いる かも しれ ない 。
本章 で 取り扱う 順位 付け の 事例 は もちろん この 優先 付け の 問題 から 着想 を 得 た もの で ある ので 、 順位 付け アルゴリズム を 実装 する ため に Google 自身 が 取っ た アプローチ を 知る こと は 、 今 から 独自 の アルゴリズム を 設計 する 上 でも 重要 な こと で ある 。
幸運 な こと に 、 Google が 優先 トレイ の 機能 を リリース し た 数 ヶ月 後 に 、 彼ら 自身 によって その 戦略 を 記述 し た 論文 が 発表 さ れ て おり 、 その 論文 に は 教師 あり 学習 アプローチ の デザイン 戦略 と 、 大規模 に スケール する 実装 方針 が 記述 さ れ て い て 、 「 Gmail の 優先 トレイ における 学習 （ The L ea rn ing BehindGmailPriorityInbox ） 」 という タイトル で 公開 さ れ て いる ［ DA 10 ］ †。
本章 の 目的 に 照らし 合わせる と 、 興味 が ある の は スケーラビリティ で は なく アルゴリズム の 設計 だ が 、 ここ で の 議論 の 補足 資料 として この 論文 を 読む こと を 強く 推奨 する 。
4 ページ の 長さ に は 、 それだけ の 時間 を 費やす 価値 が ある 。

すで に 述べ た よう に 、 この 課題 において は 時間 の 測定 が 重要 で あり 、 しかも Google の 場合 は 電子メール の 詳細 で 長大 な 送受信 の 履歴 を 活用 する こと が できる 。
具体的 に は 、 Gmail の 優先 トレイ で は 、 ユーザ が 新しい 電子メール を 受け取っ て から ある 決まっ た 秒 数 以内 に 何らかの 行動 を 起こす か どう か の 確率 を 予測 し て いる 。
Gmail が 扱う ユーザ の 行動 の 種類 に は 、 開く 、 返信 する 、 ラベル付け する 、 など の 多様 な 行動 が 含ま れる 。
また 、 受信 という の は サーバ が その 電子メール を 受け取っ た 時刻 を 表す の で は なく 、 最終的 に ユーザ に 届け られ た 時刻 、 つまり ユーザ が 新しい 電子メール を チェック し た 時刻 を 意味 し て いる 。

スパム 分類 と 同様 に 、 これ は 次 の よう に 処理 し やすい 単純 な 問題 で ある 。
取り 得る 一連 の 行動 、 最小 と 最大 秒 数 の 区間 、 電子メール の 一連 の 素性 、 最新 の メール を チェック し た こと に関する 知見 、 これら 状況 の 中 で 、 いくつか の 行動 を 起こす 確率 を 求める の で ある 。

電子メール の 素性 として は 様々 な もの が 考え られる と 思う が 、 Google が 使っ た の は どの 素性 だろ う か 。
想像 の 通り 、 彼ら は 非常 に たくさん の 種類 の 素性 を 使っ て いる 。
この 論文 の 著者 ら に よれ ば 、 誰 が コーディング し て も 同じ よう に なる スパム 分類 と 違っ て 、 電子メール を 優先 付ける に は 様々 な 方法 が ある 。
ユーザ が 素性 を 評価 する 方法 に は 多様性 が ある ので 、 Google の アプローチ で は 複数 の 素性 を 統合 する 必要 が あっ た 。
アルゴリズム の 設計 を 始める にあ たり 、 Google の エンジニア は 以下 の よう に 様々 な 異なる 電子メール の 素性 を 考案 し て いる 。

素性 の 数 は 数 百 に も のぼる が 、 いくつか の カテゴリ に 分け られる 。
ソーシャル 素性 と は 送信 者 と 受信 者 の 関係 の 強 さ に 基づく もの で 、 例えば 受信 者 が 読ん だ メール の 中 で その 送信 者 の メール の 割合 など が ある 。
コンテンツ 素性 に は ヘッダ の 情報 や 受信 者 が メール 上 で 行う （ また は 行わ ない ） こと と 高い 相関 を 持つ 最近 の 単語 、 例えば 件名 に 含ま れる 単語 など が ある 。
この よう な 単語 は ユーザ に 固有 で あり 、 学習 の 前 段階 の 処理 で 発見 する 。
スレッド 素性 は その スレッド と の ユーザ の 関係 を 表し 、 例えば ユーザ が スレッド を 始め た か どう か など が それ に 該当 する 。
ラベル 素性 は 、 ユーザ が フィルタ を 用い て メール に 適用 し た ラベル を 調べる 。
素性 の 値 は 順位 付け する 際 に 計算 さ れ 、 のち の 学習 の ため に 一時 的 に 保存 さ れる 。
連続 値 の 素性 は 素性 値 の ヒストグラム に対する 単純 な ID 3 の よう な アルゴリズム によって 自動的 に 二 値 素性 に 変換 さ れる 。

すで に 見 て き た よう に 、 Google は Gmail に対する ユーザ の 操作 の 長い 履歴 を 保持 し て おり 、 その 履歴 は ユーザ が 電子メール に対して いつ どの よう な 行動 を 起こす の か を 予測 する のに 大いに 役立つ 。
残念 ながら そのよう な 詳細 な 電子メール の 履歴 を この 演習 で 使う こと は でき ない 。
その 代わり http://spamassassin.apache.org/publiccorpus/ から 無料 で ダウンロード 可能 な SpamAssassin 公開 コーパス に 頼る こと に しよ う 。

この データセット は スパム 分類 アルゴリズム の ため の もの だ が 、 単一 ユーザ の 時系列 の 電子メール も 含ま れ て いる 。
この 単一 の スレッド を 用いる こと で 、 この データセット を 電子メール の 順位 付け を 行う システム の 設計 と テスト に 使う こと が できる 。
なお 本章 で は 非 スパム の 電子メール に 着目 する ため 、 利用 する メッセージ は すべて 受信 箱 に 入れ て も 良い もの を 使う 。

まずは Google が 提案 する 4種類 の カテゴリ について 考え 、 次に 今回 使う データ に どう 当てはまる の か を 考え て みよ う 。

完全 な 電子メール の 履歴 と 今回 の データ の 間 の 最も 重要 な 違い は 、 受信 し た メッセージ しか 見る こと が でき ない という 点 で ある 。
これ は つまり ユーザ が い つ どんな 電子メール に 返信 し た か 、 自ら スレッド を 開始 し た か どう か といった こと に関する データ が 手 に 入ら ない という こと を 意味 し て おり 、 片目 を 閉じ た 状態 で 空 を 飛ぶ よう な もの だ と いえる だろ う 。
これ は 重要 な 制約 な ので 、 本章 で 扱う 方法 や アルゴリズム は 単なる 演習 で あり 、 商用 の 優先 トレイ システム の 実装 例 に は なっ て い ない こと に 注意 しよ う 。
ここ で 示し たい の は 、 たとえ そのよう な 制約 が あっ た として も 、 電子メール の 重要 度 を 表す 近似 的 な 指標 を 作る こと で 、 比較的 良い 順位 付け システム を 設計 できる という こと で ある 。

電子メール は やり取り を する ため の メディア な ので 、 ソーシャル 素性 は 電子メール の 重要性 を 測る 上 で 最高 位 に 位置 する 。
しかし 今回 の 場合 、 使える の は やり取り の うち 半分 だけ で ある 。
完全 な 履歴 の 場合 なら 、 ユーザ と 電子メール 送信 者 の やり取り の 量 を 測定 する こと で 、 どの 送信 者 が より 素早い 返信 を ユーザ から 得 て いる か 推察 できる 。
今回 の データ で は 、 送受信 の うち 受信 し た量 だけ しか 使う こと が でき ない 。
そこで 今回 は この 一方向 の 量 を ソーシャル 素性 の 近似 として 使う こと に する 。

もちろん 、 これ が 理想 的 な 素性 で は ない こと は 明らか だ 。
しかし 、 この 演習 で は SpamAssasin 公開 データ の うち 非 スパム の メッセージ だけ を 使う という こと を 思い出そ う 。
もし 非 スパム の 電子メール メッセージ を ある アドレス から 多く 受け取っ て い たら 、 その ユーザ は 送信 者 と 強い 社会 的 な 関係 が ある 可能性 が ある 。
もう 1つ の 可能性 として 、 その ユーザ が 流量 の 多い メーリングリスト に 登録 し て いる だけ で 、 その アドレス の 優先 度 を 高く する こと は 望ま ない 可能性 も あり うる 。
そして これ こそ が 、 今回 の 順位 付け システム を 開発 する ため に は 他 の 素性 も 使っ て 情報 の バランス を 取ら なけれ ば なら ない 理由 な の だ 。

与え られ た アドレス から 来る メッセージ の 量 だけ を 考慮 する 方法 の 欠点 の 1つ に 、 一時 的 な やり取り の 量 が 長く 影響 を 及ぼす という 点 が 挙げ られる 。
今回 の データセット は 完全 な 電子メール の 履歴 と 比べ て 静的 で ある ため 、 動的 な 振る舞い を より 良く 理解 する に は 、 時間 的 な セグメント に 分割 し て その 範囲 で 流量 を 測る 必要 が ある 。

あと で 見 て いく こと に なる が 、 この 演習 で は 単純 に すべて の メッセージ を 時系列 順 に 並べ 、 その データ を 半分 に 分割 する 。
そして その 最初 の 半分 を 順位 付け アルゴリズム の 訓練 に 使い 、 後ろ の 半分 を テスト に 使う 。
つまり それぞれ の 電子メール アドレス に対して 、 訓練 データ の 時系列 の 範囲 全体 に またがる メッセージ の 分 が 、 ソーシャル 素性 を 訓練 する ため に 使わ れる 。

今回 の データ の 性質 を 考慮 する と 、 これ は 良い スタート に なる かも しれ ない が 、 もし メッセージ を もっと 正確 に 順位 付け し たい 場合 は 、 より 深い 理解 を 必要 と する だろ う 。
これら の 振る舞い を より きめ 細やか な 視点 で 見る 方法 の 1つ として 、 会話 の スレッド を 認識 し 、 スレッド 内部 の 活動 を 測定 する 方法 が ある 。
（ スレッド を 認識 する に は 、 他 の 電子メールクライアント の よう に 、 キー と なる スレッド 用語 、 例えば 「 RE :」 を メッセージ の 件名 から 探し出し て 利用 する こと が できる ） ユーザ が ある スレッド 内 で とっ て いる 行動 まで は わから ない として も 、 活発 な スレッド ほど 重要 で ある という 仮定 を 置く こと は できる 。
一時 的 な やり取り の 範囲 を これら の 小さな 単位 に まとめる こと で 、 より 正確 な スレッド 素性 を 用い て 電子メール の 優先 度 を モデル 化 する こと が できる だろ う 。

次 の 段階 として 、 電子メール から 抽出 し て 素性 セット に 追加 する こと が できる コンテンツ 素性 は いろいろ と 考え られる 。
今回 は 、 3 章 で 使っ た テキストマイニング の 技術 を この 場合 に 拡張 する こと で 、 比較的 シンプル に コンテンツ 素性 を 実現 する 。
具体的 に は 、 それ まで ユーザ が 受け取っ た 電子メール の 本文 や 件名 に 共通 の 用語 が 多く 含ま れ て い た 場合 、 新しく 受け取っ た 電子メール の うち 、 同じ 用語 が 含ま れ て いる もの は より 重要 で ある と 考える 。
これ は よく ある テクニック で あり 、 Google の 優先 トレイ の 論文 でも 簡単 に 言及 さ れ て いる 。
電子メール の 件名 と 本文 の 両方 の 単語 に 基づく コンテンツ 素性 を 追加 し て いく と 、 興味深い 重み付け の 問題 に 遭遇 する こと に なる 。
一般 的 に 電子メール の 件名 は 本文 より も 単語 数 が かなり 少ない 。
そのため 、 これら 2つ の 素性 における 単語 の 重要 度 は 同じ よう に 重み付け す べき で は ない 。

結局 の ところ Gmail の よう な 商用 の 分散 優先 トレイ の 実装 で は 、 この 演習 で は 使う こと の でき ない 多く の 素性 が 使わ れ て いる 。
すで に 触れ た よう に 、 ソーシャル 素性 について は 片方 の やり取り しか 手 に 入ら ない ため 、 近似 的 な 手法 を 使い これら の やり取り を 測定 し なけれ ば なら ない 。
さらに 他 の 様々 な ユーザ 行動 に関して は 近似 する こと さえ も でき ない 。
例えば 、 ラベル付け や メッセージ の 移動 の よう な ユーザ 行動 は 、 我々 に は 全く 見る こと が でき ない 。
Google の 優先 トレイ の 実装 で は 、 これら の 行動 は 素性 と なる ユーザ 行動 の 多く の 割合 を 占め て いる が 、 ここ で は 完全 に 欠落 し て いる 。
繰り返し に なる が 、 これら の 素性 は 今回 の 場合 は 手 に 入ら ない ため 、 完全 な 電子メール の 履歴 と 比べる と 今回 説明 する アプローチ の 弱点 と なっ て しまう 。
しかしながら 、 手 に 入ら ない 素性 が ある から と いっ て 今回 の 結果 に 影響 が ある わけ で は ない 。

これ で 今回 の 電子メール 順位 付け システム で 使う 素性 の 基本 的 な 青写真 は 完成 で ある 。
予測 において 興味 の ある 部分 は 多く が 時間 軸 に 含ま れ て いる ため 、 まずは メッセージ を 時系列 順 に 並べる こと から 始めよ う 。
今回 の システム を 訓練 する ため に 、 これら の メッセージ の 最初 の 半分 を 使う 。
そして 今回 は 以下 の 4つ の 素性 を 訓練 の ため に 用いる 。
最初 は ソーシャル 素性 の 代わり として 用いる ユーザ から 受け取っ た メッセージ の 量 で あり 、 これ を 訓練 データ 中 から 数え上げ て 用いる 。
次 が スレッド を 探し て 一時 的 な やり取り の 範囲 を まとめる とともに 、 活発 な スレッド が そう で ない スレッド より も 高く 順位 付け さ れる よう に する 。
最後 は 、 電子メール の 件名 と メッセージ 本文 に 含ま れる 頻出 単語 を 2種類 の コンテンツ 素性 として 加える 。
図 4-1 は これら の 素性 が 電子メール から どの よう に 抽出 さ れる か を 表し て いる 。

次 の 節 で は 、 ここ で 説明 し た 優先 トレイ の アプローチ を 実装 する 。
今 まで 説明 し た 素性 を 用いる こと で 、 より 重要 な メッセージ を 素早く 受信箱 の 上位 に 持っ て 来る ため の 重み付け 方式 を 決定 する 。
これ まで と 同様 に 、 最初 の ステップ として 、 生 の 電子メール データ から 素性 に 関係 する 部分 を 抽出 する こと に しよ う 。

これ まで は 、 この 過程 で 面倒 な 思い を する よう な こと は ほとんど なかっ た 。
スパム 分類 で は 、 電子メール の メッセージ 本文 を 抜き出し さえ すれ ば 、 その後 は tm パッケージ が 力仕事 を すべて 引き受け て くれ た 。
しかし この 演習 で は 、 データセット に いくつか 他 の 素性 を 追加 し たり 、 一時 的 な やり取り の 範囲 を 追加 し たり し なけれ ば なら ない 。
そのため 、 今回 は データ を 操作 する 必要性 が より 多く なっ て いる 。
だが 我々 は ハッカー で あり 、 データ で 手 を 汚す の は 望む ところ で ある ！

この 演習 で は 、 SpamAssassin 公開 コーパス の うち 非 スパム の メッセージ のみ に 注目 する 。
スパム 分類 の 演習 と 違い 、 この 演習 で 関心 が ある の は 電子メール の 種類 で は なく 優先 度 によって それら が どう 順位 付け さ れる か なのだ 。
そのため 、 今回 は 一番 大きい 非 スパム （ 易 ） の データセット だけ を 使い 、 他 の 種類 の 電子メール データ は 使わ ない 。

3 章 と 同様 に 、 この 演習 で 使う R パッケージ は 電子メール の 件名 と 本文 から 特徴 語 を 取り出す ため の tm と 、 結果 を 可視 化 する ため の ggplot 2 だけ で ある 。
また SpamAssassin 公開 コーパス は 比較的 大きな テキスト データセット な ので 、 本章 で は data/フォルダ を コピー し たり は し ない 。
代わり に 3 章 で 設置 し た データ に対する 相対パス を 設定 する 。

次に 電子メール を 解析 し 、 図 4-1 に 示さ れ て いる よう な 素性 を 取り出す ため の 関数 群 を 作成 する 。
この 図 から 電子メール の メッセージ から 4種類 の 要素 を 取り出す 必要 が ある こと が わかる 。
つまり 送信 者 の アドレス 、 受信 日 時 、 件名 、 そして メッセージ の 本体 で ある 。

2 章 で 紹介 し た 矩形 データモデル という 考え方 を 思い出し て みよ う 。
つまり この 演習 における 訓練 データ の 構築 タスク は 、 ある 種 の 「 矩形 化 」 、 つまり データ を 矩形 に 変換 する こと な の で ある 。
ここ で は 電子メール の データセット を 使い やすい 素性 の 形 に 落とし込む 必要 が ある 。
電子メール から 抽出 する 素性 は 訓練 データ の 列 と なり 、 それぞれ の 行 は 単一 の 電子メール から の ユニーク な 値 として 、 データ の 矩形 を 埋める こと と なる 。
この よう に データ を 抽象 化 する こと は 非常 に 有用 で 、 半 構造 化 さ れ た テキスト データ を きちんと 構造 化 さ れ た 訓練 データ として 解釈 し 、 新しく 受信 し た 電子メール を 順位 付け する ため に 使う こと が できる 。

この プロセス を 理解 する ため に 、 parse.email 関数 の 内部 を 調べ て みよ う 。
この 関数 は それぞれ の メッセージ から 適切 な データ を 取り出す ため の ヘルパ 関数 群 を 呼び出し 、 それら の 要素 を 並べ て 1つ の ベクトル に し て 返す 。
c ( date , from , subj , msg , path ) コマンド によって 作ら れ た ベクトル は 、 後 に 訓練 データ を 構成 する こと に なる 1 行 の ベクトル で ある 。
しかしながら 、 それぞれ の 電子メール を これら の ベクトル に 落とし込む 過程 は 、 やや 古めかしい テキスト データ の 処理 を 必要 と する 。

もし 3 章 の 演習 を 終え て いる なら 、 この msg.full 関数 は とても 馴染み深い もの の はず だ 。
この 関数 は ファイル パス を 開き 、 ファイル の 内容 を 読み込ん で 文字 の ベクトル に 変換 し て いる だけ の もの だ 。
readLines 関数 は 要素 が ファイル 中 の それぞれ の 行 に なっ て いる よう な ベクトル を 生成 する 。
3 章 と は 異なり 、 メッセージ から 様々 な 要素 を 抽出 する 必要 が ある ため 、 この 段階 で は データ の 前 処理 は 行わ ない 。
代わり に 電子メール 全体 を 文字 の ベクトル として 返し 、 この ベクトル から 必要 な 要素 を 抽出 する 関数 は 別途 コーディング する よう に する 。

メッセージ ベクトル を 手 に 入れ たら 、 次 は 電子メール の メッセージ から 可能 な 限り 有用 な 情報 を 引き出し 、 それ が でき たら 、 その 情報 を 統一 さ れ た 方法 で 整理 し 、 訓練 データ を 作り上げる 。
まずは 比較的 簡単 な ところ で 、 送信 者 の アドレス を 取り出す こと から 始めよ う 。
そのため に は 探し て いる テキスト の パターン を 電子メール の メッセージ の 中 から 認識 する 必要 が あり 、 これ は この 節 の 素性 抽出 で 行う こと の すべて で も ある 。
まずは いくつか の 電子メール の メッセージ を 見 て みよ う 。

いくつか の 電子メール の メッセージ を 見 て みる と 、 送信 者 の 電子メール アドレス を 認識 する ため の 手がかり と なる パターン が 見つかる 。
例 4-1 は 、 2つ の 電子メール の 抜粋 で あり 、 これら の パターン を 強調 し て 示し て いる 。
まずは 、 それぞれ の メッセージ 内 で 電子メール アドレス を 含む 行 を 認識 する 必要 が ある 。
この 例 で は 、 その 行 は 常に 「 From :」 という 単語 で 始まっ て おり 、 2 章 で 触れ た 電子メール の プロトコル に 沿っ て 記述 さ れ て いる 。
そのため 、 この 情報 を 使っ て それぞれ の 電子メール について 正しい 要素 を 認識 する ため に 文字 ベクトル を 検索 する こと が できる 。
しかしながら 、 例 4-1 でも 見 られる よう に 、 電子メール アドレス の 記述 方法 に は 若干 の バリエーション が ある 。
この 行 は 常に 送信 者 の 名前 と 電子メール アドレス を 含ん で いる が 、 アドレス は あるとき は 山 括弧 で 囲わ れ て おり （ 電子メール # 1 ） 、 他 の 場合 に は 括弧 で 囲わ れ て い ない （ 電子メール # 2 ） 。
この よう な 理由 から 、 この 素性 の ため に 正規表現 を 用い て 情報 を 抽出 する get.from 関数 を 書く 必要 が ある 。

すで に 見 た よう に 、 R に は 正規表現 の ため の 強力 な 関数 が 数多く 用意 さ れ て いる 。
grepl 関数 は 正規表現 パターン を マッチング さ せる ため の 通常 の grep 関数 と 同様 の 動作 を する が 、 末尾 の 「 l 」 は 「 ロジカル （ Logical ） 」 を 表し て いる 。
そして マッチ し た ベクトル の 添字 を そのまま 返す の で は なく 、 msg.vec と 同じ 長 さ で その 要素 が マッチ し た か どう か を 表す 真偽 値 （ Boolean 値 ） で ある ベクトル を 返す よう に なっ て いる 。
この 関数 の 最初 の 行 の すぐ 下 で は 、 from 変数 は 要素 数 が 1 で ある よう な 文字 ベクトル で 、 その 要素 は 例 4-1 で 強調 し た 「 From :」 を 含む 行 と なる 。

正しい 行 を 得 たら 、 次に アドレス 自体 を 取り出す こと に しよ う 。
これ を 行う ため に は strsplit 関数 を 使っ て 、 文字列 を 正規表現 の パターン によって リスト に 分割 すれ ば 良い 。
アドレス を 適切 に 取り出す に は 、 例 4-1 で 見 た よう な パターン の バリエーション を 考慮 し なけれ ば なら ない 。
そのため に 正規表現 パターン の 中 で 角括弧 （[ と ]） を 使っ て 区切り 文字 に 使用 できる 文字 の 種類 を 列挙 し て いる 。
ここ で 挙げ られ て いる 区切り 文字 は 、 引用符 （"）、 コロン （:）、 山 括弧 （< と >）、 そして 空白 で ある 。
この パターン は 常に リスト 中 の 最初 の 要素 に アドレス を 格納 する ため 、 「[[ 1 ]]」 を 使っ て リスト から その 要素 を 引き出す こと が できる 。
しかし それでも なお 、 パターン の バリエーション によって は この ベクトル に 空 の 要素 が 追加 さ れる 場合 が ある 。
そのため 電子メール アドレス そのもの を 返す ため に は 、 空 の 要素 を 無視 し て 、 なおかつ 残り の 要素 から 「 @」 記号 を 含む もの を 探し て 返す 必要 が ある 。
これ で 訓練 データ に 必要 な データ の 4分 の 1 は 解析 が 完成 し た 。

次 の 2つ の 素性 、 メッセージ の 件名 と 本文 は 比較的 簡単 で ある 。
3 章 で は スパム と 非 スパム の 電子メール メッセージ に 含ま れる 単語 の 頻度 を 集計 する ため に 、 メッセージ 本文 を 取り出す 必要 が あっ た 。
今回 の get.msg 関数 は 同じ 方法 を 真似 て いる 。
メッセージ 本文 は 常に 電子メール 中 の 最初 の 空 行 から 始まる こと を 思い出そ う 。
そのため 、 この 関数 は 単純 に msg.vec の 最初 の 空 の 要素 を 探し出し 、 その 後ろ の すべて の 要素 を 返す 。
テキストマイニング の 手順 を 簡単 に する ため に 、 この 2次元 ベクトル を paste 関数 を 使っ て 単一 の 文字 ベクトル に 展開 し て から 返し て いる 。

電子メール の 件名 を 取り出す の は 送信 者 の アドレス を 取り出す の と 似 て いる が 、 実際 に は もう少し 簡単 で ある 。
get.subject 関数 で は 、 また し て も grepl 関数 を 使っ て 各 電子メール 中 の 「 Subject :」 パターン を 探し出す こと で 、 メッセージ 中 の 件名 を 含む 行 を 見つけ出す 。
しかし ここ に は 落とし穴 が ある 。
必ずしも すべて の メッセージ が 実際 に 件名 を 含ん で いる と は 限ら ない 。
この パターン マッチ で は 、 これら の 例外 的 な 場合 に 破綻 し て しまう 。
この 問題点 を 解決 する ため に 、 ここ で は 単純 に grepl 関数 の 呼び出し が 実際 に 要素 を 返し て いる か どう か を 確認 し て いる 。
具体的 に は 、 subj 変数 の 長さ が ゼロ より 大きい か どう か を チェック し て いる 。
もし これ が ゼロ より 大きけれ ば 、 行 を パターン によって 分割 し 、 その 2番 目 の 要素 を 返せ ば よい 。
そう で なけれ ば 空 の 文字 を 返す 。
R で は 、 grepl の よう な 関数 が マッチ し なかっ た とき 、 integer ( 0 ) や character ( 0 ) の よう な 特殊 な 値 を 返す の が 標準 だ 。
これら の 値 は 長さ が ゼロ で ある ため 、 この 種 の 確認 は 汚い データ に対して 関数 を 適用 する とき に 特に 有効 で ある 。

3 章 の code/data/hard_ham/ フォルダ から 00175.* という ファイル名 を 検索 する と 、 問題 の ある 電子メール メッセージ を 見つける こと が できる 。
新しい 課題 の ため に 既存 の データセット を 転用 しよ う と する とき は 、 しばしば この 手 の 例外 的 な 場合 に 遭遇 する 。
これら を 乗り越える ため に は 、 今回 の よう に いくつか の 試行錯誤 が 必要 で ある こと が 多い 。
重要 な の は 落ち着い て データ を よく 観察 し 、 問題 を 見つける こと で ある 。
もし データセット を 解析 し て 使える 形 に する まで 一 度 も 問題 に 遭遇 し なかっ た と し たら 、 何 か が おかしい に 違い ない ！

これ で 全体 の 4分 の 3 の 素性 抽出 が 完了 し た が 、 最後 に 最も 大変 な 要素 で ある メッセージ を 受信 し た 日付 と 時刻 が 残っ て いる 。
この フィールド を 処理 する の は 2つ の 理由 により 難しく なっ て しまっ て いる 。
最初 に 、 プログラミング言語 によって 採用 する 方式 が 少し ずつ 違っ て おり 、 R も 例外 で は ない ため 、 日付 表現 を 扱う の は いつも 大変 な もの で ある という こと だ 。
最終的 に データ を 時系列 順 に ソート する ため に は 、 日付 の 文字列 を POSIX 日付 オブジェクト に 変換 する 必要 が ある 。
例 4-2 は この バリエーション の うち いくつか を 示し て いる 。

これ を 見 て も わかる よう に 、 それぞれ の 電子メール から 日付 と 時刻 の 情報 を 取り出す に は 、 いろいろ な こと を 認識 し て い なけれ ば なら ない 。
例 4-2 を 見 て 最初 に 気付く こと は 、 今 から 取り出そ う と し て いる 行 は すべて 「 Date :」 という 表現 によって 認識 できる という こと だ 。
ところが この パターン を 使う とき は 気 に 留め て おか なけれ ば なら ない 様々 な 罠 が 潜ん で いる 。
例 4-2 中 の 電子メール # 1 から は 、 この パターン に マッチ する 行 が 複数 ある 場合 が ある こと が わかる 。
同様 に 電子メール # 2 に よる と 複数 の 行 が 部分的 に マッチ する 場合 が あり 、 しかも これら の 行 の 内容 が 矛盾 し て いる 可能性 が あり 、 この 矛盾 は 電子メール # 1 でも 起こり うる 。
次に 、 これら の たった 4つ の 例 だけ を 見 て も わかる よう に 、 すべて の 電子メールの日 付 や 時刻 が 決まっ た 方法 で 整え られ て いる わけ で は ない 。
これら すべて の 電子メール で は 、 時差 を 表す ため に GMT （ グリニッジ標準時 ） から の オフセット や 他 の ラベル 情報 が 追記 さ れ て いる 。
そして 電子メール # 4 における 日付 と 時刻 の 形式 は 他 の 2つ と は 全く 異なっ て いる 。

この よう な 違い は データ を 整え て 利用 できる 形 に 処理 する ため に すべて 非常 に 重要 で ある 。
しかし まず は 、 この 問題 を 解決 する ため に 、 ここ から は get.date 関数 を 定義 する こと によって 、 日付 と 時刻 の 情報 を 抽出 する こと に 専念 し て いく 。
必要 な 日付 と 時刻 を 文字列 に し た 後 は 、 矛盾 する フォーマット を 統一 さ れ た POSIX オブジェクト に 変換 する 必要 が ある が 、 get.date 関数 で は そこ まで は 取り扱わ ない こと に する 。

これ まで に も 述べ た よう に 「 Date :」 パターン に 完全 に あるいは 一部 だけ マッチ する 行 は 複数 ある 可能性 が ある 。
しかし 注意 し て ほしい の は 、 例 4-2 の 電子メール # 1 と # 2 では 「 Date :」 パターン が 文字列 の 先頭 に 来 て いる 行 は 1つ しか ない 点 だ 。
電子メール # 1 で は 、 この パターン の 前 に 空白 が 含ま れ て おり 、 電子メール # 2 で は この パターン は 部分的 に 「 X - Original - Date :」 と マッチ し て いる 。
正規表現 によって 「 Date :」 を 先頭 に 含む 文字列 だけ を 取り出す に は 、 先頭 を 表す 「^」 記号 を 使っ て 「^ Date :」 という パターン を 検索 すれ ば 良い 。
これ で grepl 関数 を 使っ て 、 目的 と する 行 に マッチ する 要素 だけ が TRUE に なる よう な ベクトル を 作る こと が できる 。

次に 、 msg.vec 変数 の うち 最初 に この パターン に マッチ する 要素 を 取り出す こと を 考える 。
これ に は 単に grepl 関数 で マッチ し た 要素 を 返せ ば 良い よう に 思える が 、 もし 電子メール メッセージ 本文 の 中 に 「 Date :」 で 始まる 行 が あっ た と し たら どう だろ う ？

次 は R の POSIX オブジェクト に 変換 する ため の 文字列 を 返す ため に 、 この 行 の テキスト を 処理 する 必要 が ある 。
すで に 見 て き た よう に 、 この 行 に は 付加 情報 が ある 上 に 、 日付 と 時刻 は 統一 さ れ た 形式 で 表現 さ れ て いる わけ で は ない 。
日付 と 時刻 の 情報 を 取り出す ため に 、 付加 情報 を 加える ため の 文字 によって この 文字列 を 分割 する 。
この 場合 は コロン （:）、 プラス （+）、 マイナス （-） 記号 が それ に 該当 する 。
多く の 場合 、 これ によって 日付 と 時刻 の 情報 だけ を 取り出す こと が できる が 、 場合 によって は 前後 に 空白 文字 が 挿入 さ れる 場合 が ある 。
次 の 行 の gsub 関数 を 使う こと で 、 これら の 連続 する 前後 の 空白 文字 を 取り除い て いる 。
最後 に 例 4-2 の 電子メール # 3 で 見 られる よう な 付加 情報 に 対処 する ため に は 、 25 文字 目 以降 の すべて の 文字 を 切り捨て て しまえ ば 良い 。
標準 的 な 日付 と 時刻 の 文字列 は 25 文字 で ある ので 、 これ 以降 の 文字 は 付加 情報 で ある と 判断 する こと が 可能 な の だ 。

おめでとう 。
これ で ようやく つかみ どころ の ない 電子メール データ を 順位 付け アルゴリズム を 訓練 する ため に 都合 の 良く 構造 化 さ れ た 矩形 に 変換 する 苦しみ から 解放 さ れ た わけ だ 。
これ で あと は 本題 に 入れ ば いい だけ だ 。
3 章 で やっ た よう に 、 ここ で は 非 スパム （ 易 ） の すべて の ファイル を 含む ベクトル を 作り 、 余分 な 「 cmds 」 ファイル を ベクトル から 除き 、 lapply 関数 によって parse.email 関数 を それぞれ の 電子メール ファイル に対し 適用 し て いる 。

次に 、 lapply によって 返さ れる ベクトル の リスト を 行列 形式 、 つまり データ を 表す 矩形 に 変換 する 必要 が ある 。
これ まで と 同様 に do.call 関数 と rbind 関数 を 使っ て 、 ehparse.matrix オブジェクト を 作る 。
さらに 文字 ベクトル の データ フレーム に 変換 し て 、 5つ の 列 の 名前 を それぞれ 「 Date 」 、 「 From.EMail 」 、 「 Subject 」 、 「 Message 」 、 「 Path 」 に 設定 し て いる 。
結果 を 確認 する に は head ( allparse.df ) と 入力 し 、 データ フレーム 中 の 最初 の 何 行 か を 調べれ ば 良い 。
ここ で は 紙面 を 節約 する ため に その 結果 を 掲載 し ない ので 、 自分自身 で 試し て み て ほしい 。

さて この データ から 重み付け の 方式 を 作成 する 前 に 、 いくつか 雑用 的 な 作業 が 残っ て いる 。

すで に 述べ た よう に 、 これ まで は テキスト 中 の 日付 と 時刻 を 取り出し て 独立 さ せる 作業 だけ に 取り組ん で き た 。
ここ で は 、 テキスト を 受け取っ て それ を POSIX オブジェクト に 変換 し 、 それら を 論理的 に 比較 できる よう に する 必要 が ある 。
これ は 、 電子メール を 時系列 順 に ソート する ため に 必要 な 作業 だ 。
この 演習 で は 全体 を通して 時間 の 概念 を 扱っ て おり 、 素性 の 時間 的 な 変化 が 電子メール の 重要性 を 推論 する ため に 大きな 役割 を 果たし て いる こと を 思い出そ う 。
日付 と 時刻 を 文字 で 表現 し た だけ で は 不十分 な の だ 。

例 4-2 に 示す よう に 、 日付 に は 2つ の バリエーション が 存在 する 。
この 例 から 、 電子メール # 3 は 「 Wed , 04 Dec 200211 : 36 : 32 」 という 形式 の 日付 と 時刻 を 採用 し て いる が 、 電子メール # 4 の 日付 と 時刻 の 形式 は 「 04 Dec 200211 : 49 : 23 」 で ある 。
これら 2種類 の 文字列 を POSIX 形式 に 変換 する ため に は strptime 関数 を 使う が 、 変換 に 用いる 日付 と 時刻 の 形式 は この 2つ で 異なっ て いる 。
それぞれ の 種類 の 文字列 は 特定 の POSIX 形式 に 対応 し て いる ので 、 これら の 形式 に 合致 する 変換 用 文字列 を 指定 する 必要 が ある 。

まず allparse.df 変数 の Date 列 に 入っ て いる 文字列 を 2つ の 異なる POSIX 形式 に 別々 に 変換 し 、 次に 変換 後 の POSIX オブジェクト を 再結合 し て データ フレーム に 格納 し 直す こと で 、 変換 を 完了 する 。
これ を 実現 する ため に 、 2つ の POSIX パターン と 文字 ベクトル を 引数 として 受け取っ て 変換 を 行う date.converter 関数 を 定義 する 。
strptime に 渡さ れ た パターン が 文字列 に マッチ し なかっ た とき 、 デフォルト の 挙動 で は NA を 返す 。
これ を 使っ て 、 1番 目 の 変換 で NA を 返し た 要素 を 2番 目 の 要素 で 置き換える こと で 、 変換 後 の 文字 ベクトル を 結合 する こと が できる 。
今回 の 場合 は 2つ しか パターン が 存在 し ない こと が わかっ て いる ので 、 結果 は すべて の 日付 文字列 が POSIX オブジェクト に 変換 さ れ た 単一 の ベクトル と なる 。

データ を クリーニング する 最後 の 作業 は 、 件名 を 格納 し た Subject と 送信 元 メールアドレス を 格納 し た From の 列 の 文字 ベクトル を すべて 小文字 に 変換 する こと だ 。
これ も また 訓練 段階 に 進む 前 に すべて の データ を 可能 な 限り 均一 化 する ため に 行う 作業 で ある 。
次に 、 R に 組み込み の with 関数 と order 関数 を 組み合わせ て データ を 時系列 順 に ソート する （ ソート の 記述 方法 は R の 中 で も 特に わかり づらい もの だ が 、 この 省略 し た 方法 は 今後 よく 使う こと に なる ので 、 慣れ て おく と 良い だろ う ） この よう に 組み合わせる と 、 時系列 順 で 昇順 と なる よう に 元 の データ フレーム の 添字 番号 が 並べ られ た ベクトル が 生成 さ れる 。
そして これら の 添字 によって データ フレーム を 並べ 替える ため に 、 allparse.df 変数 の 要素 を その 順番 で 参照 する 。
その 際 に すべて の 列 が その 順番 で ソート さ れる よう に 角括弧 を 閉じる 前 に カンマ を 加える 必要 が ある 。

そして 最後 に 時系列 順 に ソート さ れ た データ フレーム の 最初 の 半分 を priority.train 変数 として 保存 し て いる 。
この データ フレーム は 順位 付け システム を 訓練 する ため に 使わ れる 。
priority.df 変数 の 後ろ の 半分 は 、 後々 順位 付け システム を テスト する ため に 使う こと に なる 。
データ を すべて 整形 し 終わっ たら 、 順位 付け 方式 の 設計 を 始める 準備 が 整っ た こと に なる 。
素性 を 抽出 し た 次 に やる べき 作業 は 、 訓練 データ 中 で 観測 さ れ た それぞれ の 素性 に対して 重み を 定義 する こと で ある 。

重み付け の 方式 を 実装 し 始める 前 に 、 本題 から 外れる が 尺度 について 簡単 に 議論 する 必要 が ある 。
自分自身 の 電子メール の 使い方 について 少し 思い返し て み て ほしい 。
電子メール で の やり取り を 定期的 に 行っ て いる の は 同じ 人達 ばかり だろ う か 。
自分 が 1日 に 何 通 の 電子メール を 受け取っ て いる か 把握 し て いる だろ う か 。
1週間 に 何 通 、 見知らぬ人 から の 電子メール を 受け取っ て いる だろ う か 。
筆者 と 同じ 状況 な の で あれ ば 、 そして おそらく 他 の 多く の 人たち も そう だ と 考え られる が 、 これら の 質問 の 答え と なる よう な 電子メール の 利用 傾向 について は 、 大雑把 に 言っ て 「 80 : 20 の 法則 」 に 忠実 で ある 。
つまり 80% の 電子メール は アドレス帳 の うち 20% の 人々 と の やり取り な の で ある 。
この 事実 は なぜ 重要 な の だろ う か 。

正確 に 言う と 、 これら の 絶対 的 な 値 同士 を 直接 比較 する こと は でき ない の で ある 。
いま 解析 を 終え た ばかり の 訓練 データ を 例 にとって 考えよ う 。
今回 の 順位 付け システム で 使う 素性 の うち 1つ は 、 訓練 データ 中 の それぞれ の アドレス から 受け取っ た 電子メール の 量 に 基づい て 人間関係 の 深 さ を 近似 し た もの で ある 。

最初 の 素性 に 尺度 が どの よう に 影響 を 及ぼす か を 説明 する ため に 、 まずは それぞれ の 電子メール アドレス が データ 中 に 現れる 回数 を 数える こと から 始めよ う 。
1 章 の 例 を 実際 に 試し て み た の で あれ ば 、 すでに plyr パッケージ を 動かし て み た こと が ある はず だ 。
簡単 に 言う と 、 plyr パッケージ の 関数 群 は データ を 小さな 正方形 や 立方体 に 分割 し 、 小さな データ の 断片 を 一 度 に 処理 する こと が できる よう に し て くれる 。
（ これ は 多く の 大規模 な データ 解析 環境 で 一般 的 に 用い られる MapReduce の パラダイム と 非常 に よく 似 て いる ）
ここ で は 非常 に 単純 な タスク を 行う こと に する 。
From.Email 列 の アドレス に マッチ する すべて の 行 を 検索 し 、 それら を 数え上げる という もの だ 。

この ため に データ フレーム を 操作 する ddply 関数 を 使っ て 、 訓練 データ を 処理 する 。
ddply 関数 の 構文 で は 、 まず グループ 化 し たい データ （ ここ で は From.Email 属性 ） と 、 グループ 化 し た データ に対して 実行 する 操作 を 定義 する 。
さらに グループ 化 さ れ た データ を 集計 する ため に summarise オプション を 使い 、 Freq という 名前 の 新しい 列 を 作っ て 頻度 情報 を 保存 し て いる 。
この 結果 は head ( from.weight ) という コマンド を 使っ て 確認 する こと が できる 。

この 場合 、 この 操作 は 分割 さ れ た データ フレーム における Subject 列 の ベクトル の 長 さ を 問い合わせ て いる が 、 実際 に は 、 訓練 データ 中 の どの 列 の 名前 を 使っ て も その ベクトル は 同じ 長さと なる ため 、 同じ 結果 が 得 られる 。
plyr パッケージ に もっと 慣れ親しめ ば 、 次に 進む 上 で 非常 に 有用 と なり 、 この 目的 に は 、 plyr パッケージ の 作者 による 文書 を 強く おすすめ する ［ HW 11 ］ 。

この データ の 規模 を より 良く 理解 する ため に 、 結果 を グラフ に 表示 し て みよ う 。
図 4-2 の 棒グラフ は 7 通 以上 の 電子メール を 送っ た ユーザ から の 電子メール の 量 を 表し て いる 。
今回 は 見やすく ため に この よう な 集計 を 行っ た が 、 この データ を 削除 し た として も データ が いかに 素早く 増加 する か を 確認 する こと は いつ でも できる 。
最も 送信 頻度 が 高かっ た アドレス （ tim.one@comcast.ent ） は 45 通 の メッセージ を 送信 し て い た 。
これ は 実に 訓練 データ 中 の 平均 的 な 人 の 15倍 も 多く 送信 し て い た こと に なる が 、 これ は 非常 に 特殊 な 場合 で ある 。
図 4-2 を 見れ ば わかる よう に 、 これ ほど 多く の 電子メール を 送信 し て いる ケース は ごく 少数 で あり 、 電子メール の 頻度 は その後 に すぐ 落ち込ん で いる 。
では どう すれ ば この よう な 最多 送信 者 の よう な 外れ値 の アカウント の 値 による 歪み を 取り除い て 、 訓練 データ の 中 の 平均 的 な 人 の 観測 値 に 重み付け できる の だろ う か 。

その 答え は 尺度 を 変換 する こと で ある 。
今回 の 素性 の 単位 に は 偏り が ある ため 、 数値 的 な 関係 を ならし て あまり 極端 に なら ない よう に する 必要 が ある 。
単純 に 観測 さ れ た 絶対 頻度 を 比較 し て しまう と 、 tim.one@comcast.ent から の 電子メール は 平均 的 な 送信 者 より も 15倍 も 重要 で ある と 重み付け さ れる こと に なる 。
後ほど 説明 する が 、 訓練 段階 で は 生成 さ れ た 重み の 値 の 範囲 に 基づい て 重要 な メッセージ か どう か を 判断 する ため の しきい値 を 決める ため 、 この よう な 偏り は 大きな 問題 と なる 。
その よう な 極端 な 偏り が ある と しきい値 が 低 すぎ た り高 すぎ たり し て しまう ため 、 データ の 特性 を 考慮 し て 素性 の 尺度 を 変える 必要 が ある 。

こう 考え て いく と 対数 関数 による 対数 変換 が 頭 に 浮かぶ はず だ 。
対数 について は すでに 高校 数学 で 馴染み が ある かも しれ ない が 、 馴染み が なかっ た として も 、 その 概念 は とても 単純 で ある 。
対数 関数 は 指数関数 の 逆関数 で 、 正式 な 定義 に よる と 対数 と は 、 与え られ た 引数 と 底 の 指数 が 等しい という 等式 を 考え 、 その 等式 を 満たす よう な 指数 部 を 返す 関数 で ある †。

対数 変換 における 底 の 値 は 非常 に 重要 で ある 。
ハッカー として は 、 底 が 2 として 考える 、 すなわち 2 進数 で 考え た ほう が 馴染み深い だろ う 。
底 が 2 で ある よう な 対数 変換 を 構築 する の は 簡単 で ある 。
この 場合 、 入力 値 が 2 の 指数 と 等しい という 等式 を 解く 必要 が ある 。
例えば 底 が 2 として 16 を 変換 し た と する と 、 2 の 4 乗 は 16 で ある ため 、 その 答え は 4 と なる 。
重要 な こと は 、 データ が そのよう な 関数 に 適合 する よう な とき は 、 指数関数 を 「 反転 」 さ せ て 効果 を 打ち消す ため に この よう な 変換 を 使う こと が できる という こと だ 。

いわゆる 自然 対数 と 常用対数 は 、 対数 変換 の うち 最も 有名 な もの で ある 。
前者 で は 、 底 は ネイピア数 e と 呼ば れる 特別 な 値 で あり 、 円周率 π と 同じ よう に 無理数 の 定数 で あり 、 ネイピア数 は おおよそ 2.718 で ある 。
自然対数 は しばしば ln （ log natural ） と 省略 さ れる 。
この 定数 による 変化率 は 、 幾何学 的 な 螺旋 模様 として 自然 界 で 非常 に よく 観測 さ れ て おり 、 事実 これ は 円 の 内部 の 角 の 関数 として 幾何学 的 に 導き出せる 。
この よう な 観点 で 考え た こと は ない かも しれ ない が 、 自然対数 が 作る 模様 や 関係性 に は すでに 馴染み が ある はず だ 。
図 4-3 は 自然対数 の 螺旋 を 表し て おり 、 自然 界 の 様々 な 現象 において 観測 さ れ て いる 。
オウムガイ の 内部 の 構造 や 台風 または ハリケーン の 風 の 渦 など は 、 この 好例 で ある 。
私達 の 銀河系 における 星間物質 の 散らばり も 、 自然対数 の 螺旋 に 従う の で ある 。
また 、 多く の プロ 用 の カメラ の 設定 で は 、 絞り 値 は 自然対数 に 従う よう 設定 さ れ て いる 。

多く の 自然現象 から の 類推 により 、 対数 は 指数 的 に 増加 する 頻度 の 尺度 を 調整 する に は 都合 の 良い 関数 で あり 、 これ に は 電子メール の 活動量 の よう な ソーシャルデータ が 含ま れる 。
ただし 自然対数 e の 代わり に 常用対数 を 用いる こと が 可能 で あり 、 常用対数 は しばしば log 10 と 表記 さ れ 、 底 が 10 で ある よう な 対数 を 意味 し て いる 。
対数 変換 の 定義 から 、 常用対数 は 大きな 値 を 自然対数 より も 小さな 値 に 減少 さ せる こと が わかる 。
例えば 10 の 3 乗 は 1 , 000 な ので 、 1 , 000 の 常用対数 は 3 と なる が 、 自然対数 で は 約 6.9 で ある 。
そのため データ が 非常 に 大きな 指数 で 増加 する 場合 、 常用対数 を 使う の は 理 に かなっ て いる 。

電子メール の 量 を 変換 する ため に これら 両方 の 方法 を 用い た 様子 を 、 図 4-4 に 示し て いる 。
この 図 において 訓練 データ 中 で ユーザ が 送信 し た 電子メール の 数 は 急激 に 指数 的 に 増加 し て いる こと が わかる 。
これら の 値 を 自然対数 と 常用対数 によって 変換 する こと で 、 この 曲線 を かなり 平坦 化 する こと が できる 。
すで に 述べ た よう に 、 常用対数 は 値 を 大幅 に 変換 する の に対し 、 自然対数 で は まだ 少し 変化 が 残っ て おり 、 この 訓練 データ から 意味 の ある 重み を 引き出す こと が できる 。
この ため 、 今回 の 電子メール の 量 の 素性 を 定義 する ため に は 自然対数 を 用いる こと に する 。

本章 、 および 2 章 で 詳しく 説明 し た よう に 、 機械学習 の 課題 に 取り組む とき に データ を 可視 化 し て 調べる の は 非常 に 役に立つ 。
ここ で 知り たい の は 、 最適 な 予測 を 行う ため に 、 観測 さ れ た 素性 が どの よう に 互いに 関連 し て いる か という こと で ある 。
そのため の 最良 の 方法 は データ の 可視化 で ある こと が 多い 。

最後 に 、 学校 で 数学 の 時間 に 習っ た 指数 法則 を 思い出そ う 。
どんな 数 を ゼロ 乗 し て も 1 と なる 。
この こと は 素性 の 重み付け において 対数 変換 を 使う とき は 常に 心 に 留め て おい た ほう が 良い だろ う 。
なぜなら 対数 変換 によって 観測 し た 1 が ゼロ に なっ て しまい 、 他 の 重み を ゼロ と 掛け合わ せ て も すべて ゼロ に なっ て しまう 危険性 が ある から で ある 。
今回 は これ を 避ける ため に 、 すべて の 観測 について 対数 を 取る 前 に 1 を 足す よう に し て いる 。

実は R に は log ( 1 + p ) を 計算 する ため の 専用 の log (1 + p) 関数 が ある が 、 今回 は 学習 が 目的 で ある ため 、 内部 の 処理 が 明確 に わかる よう 手動 で 実装 し た 。

この 尺度 の もとで は 、 この 処理 は 結果 に 影響 は なく 、 しかも すべて の 重み は ゼロ より 大きい 値 に 保た れる 。
今回 の 場合 、 底 について は log 関数 の デフォルト を 使っ て いる ので 、 自然対数 と なっ て いる 。

今回 の 目的 で は データ 中 に 出現 し た ものの 頻度 を 数え て いる ので 、 素性 の 値 が ゼロ に なる こと は ない 。
もし 一 度 も 観測 さ れ ない もの が あっ て も 、 それ が 訓練 データ に 含ま れる こと は ない からだ 。
いつも その よう に なる と は 限ら ず 、 データ 中 に ゼロ を 観測 する こと も あり うる 。
ゼロ の 対数 は 未定義 で あり 、 R で 計算 しよ う と する と 「- Inf 」 という 特別 な 値 を 返す よう に なっ て いる 。
データ 中 に 「 - Inf 」 が 現れる と しばしば 問題 を 引き起こし 、 プログラム を 台無し に し て しまう 。

次に データ から 抽出 し たい 素性 は 電子メール の スレッド 活動 量 で ある 。
すで に 書い た よう に 、 今 順位 付け を 構築 しよ う と し て いる 対象 の ユーザ が 電子メール の 返信 を 行っ た か どう か は わから ない が 、 メッセージ を スレッド に まとめ て 、 その スレッド が 開始 し て から の 活動量 を 測定 する こと は できる 。
繰り返し に なる が 、 この 素性 において は 時間 が 重要 で ある と 仮定 し て おり 、 そのため より 多く の メッセージ を より 短い 期間 で やり取り し て いる スレッド が 、 より 活動 的 で あり 結果的 に 重要 で ある という こと に なる 。

今回 の データ 中 の 電子メール は 特定 の スレッド ID を 含ま ない が 、 件名 を 一部 共有 する 電子メール を 探す こと で 、 論理的 に 訓練 データ から スレッド を 認識 する こと が できる 。
つまり 、 件名 が 「 re: 」 で 始まっ て い たら 、 その 電子メール は どれ か の スレッド の 一部 で ある という こと に なる 。
この よう な メッセージ が あっ たら 、 その スレッド の 他 の メッセージ を 探し出す こと で 、 活動量 を 測定 する こと が 可能 と なる 。

これ が すなわち find.threads 関数 が 今回 の データ に対して 行っ て いる こと で ある 。
訓練 データ 中 の すべて の 件名 を 「 re: 」 で 分割 し た と する と 、 最初 の 要素 が 空 で ある よう な 文字 ベクトル を 探す こと で 、 スレッド の 開始 点 を 見つける こと が できる 。
訓練 データ 中 の どの 観測 が スレッド の 先頭 で ある か を 認識 し たら 、 これら の スレッド と 件名 から 送信 者 を 抽出 する こと が できる 。
その 結果 の 行列 は 訓練 データ 中 の すべて の 送信 者 と スレッド 中 の 最初 の メッセージ の 件名 を 含む もの と なる 。

次に スレッド 中 で 最も 活動 的 な 送信 者 に 基づい て 重み付け を 行う 。
これ は データセット 全体 の 電子メール の 量 を 用い た 重み付け の 補完 と なっ て いる が 、 今度 は threads.matrix 変数 に 現れる 送信 者 だけ に 注目 する こと に しよ う 。
email.thread 関数 は 、 入力 として threads.matrix 変数 を 受け取り 、 この 第 2 の 重み付け を 計算 し て 返り 値 として 返す 。
これ は 前節 で やっ た こと と よく 似 て いる が 、 今度 は table 関数 を 使っ て スレッド 中 の 送信 者 の 頻度 を 数える 点 が 異なる 。
これ は 、 plyr パッケージ を 使っ て データ フレーム を 処理 する の で は なく 、 R において 同じ 行列 の 計算 を する ため に 別 な 方法 を 示す ため で ある 。
残り の 部分 は 単純 に senders.df データ フレーム を 整形 し たり し て いる が 、 今度 も また 自然対数 による 重み付け を 採用 し て いる こと に 注目 しよ う 。

電子メール の スレッド 素性 の 締めくくり として 、 活動的 と 認識 さ れ た スレッド に 基づく 重み付け を 行う 。
これ まで に 訓練 データ 中 の すべて の スレッド を 認識 し 、 これら の スレッド に 基づく 重み付け を 作成 し て き た 。
今度 は 、 この 知識 を 利用 し て 活動的 と 認識 さ れ た スレッド の 重み を 増やし たい 。
ここ で は 、 その スレッド を すでに 認識 し て いる なら ば 、 ユーザ は より 活動 的 な スレッド ほど 重要 視 する と 仮定 し て いる 。

作成 し た threads.matrix を 使っ て 、 訓練 データ に 立ち戻っ て それぞれ の スレッド に 含ま れる すべて の 電子メール を 見つける こと に しよ う 。
そのため に threads.matrix と 訓練 データ を 引数 として 受け取る get.threads 関数 を 作成 する 。
unique 関数 を 使う こと で 、 今回 の データ 中 の すべて の スレッド の 件名 を ベクトル として 作成 する 。
次に この 情報 を 使っ て それぞれ の スレッド の 活動量 を 測定 する 必要 が ある 。

それ を 行う の は thread.counts 関数 だ 。
ここ で は 、 スレッド の 件名 と 訓練 データ を 引数 として 用い 、 thread.times ベクトル 中 の スレッド に 合致 する すべて の 電子メール に 含ま れる 日付 と タイムスタンプ を 取り出し て いる 。
thread.times 変数 の 長 さ を 測る こと で 、 この スレッド に対する 電子メール を 訓練 データ 中 で 何 通 受信 し た か を 知る こと が できる 。

最後 に 、 活動量 を 測定 する ため に は 訓練 データ 中 で その スレッド が どれ だけ の 期間 続い た か を 知る 必要 が ある 。
なお 、 訓練 データ に 含ま れる 電子メール が スレッド の 途中 から 、 あるいは 途中 まで しか 含ん で い ない 可能性 が ある こと に 注意 しよ う 。
すなわち 、 訓練 データ が 始まる 前 や 終わっ た より も 後 に も 電子メール の やり取り が ある かも しれ ない 。
と は いえ 、 これ に関して 今回 は 何 も 対策 の 打ち よう が ない 。
そこで それぞれ の スレッド について 単純 に 最小 と 最大 の 日付 と 時刻 を 取っ て 、 時間 の 幅 を 測る こと に する 。
difftime 関数 は 2つ の POSIX オブジェクト の 間 に 経過 し た 時間 を ある 単位 で 計算 する 。
この 場合 は 、 最小 の 単位 で ある 「 秒 」 を 指定 し て いる 。

先 ほど 述べ た スレッド が 途切れ て いる こと の 影響 で 、 スレッド 中 に 電子メール が 1つ だけ の 場合 を 観測 する 場合 が あり うる 。
その メッセージ は 訓練 データ の 収集 が 始まっ て すぐ に 終了 し た スレッド か 、 収集 が 終わる 直前 に 始まっ た スレッド の 可能性 が ある 。
そのため 、 スレッド が 続い た 時間 に またがる 活動 量 から 重み を 作る 前 に 、 1つ の メッセージ だけ から なる スレッド に フラグ を つけ なけれ ば なら ない 。
thread.counts の 最後 に ある if 文 は これ を 確認 し 、 スレッド に 1つ しか メッセージ を 含ま なけれ ば その 要素 として NA を 返す 。
これ は あと で 、 活動量 に 基づい て 重み付け さ れ た データ から これら を 取り除く ため に 使う こと に なる 。

そのため に まず 、 ある スレッド 中 の 1秒 あたり の メッセージ の 数 を 計算 する 。
例えば 、 ある スレッド 中 で 毎秒 1 通 ずつ の メッセージ が 送信 さ れ て い たら 、 結果 は 1 と なる 。
もちろん 、 実際 に は この 値 は もっと 小さく なる 。
平均 的 な スレッド 中 の メッセージ の 数 は 約 4.5 通 と なっ て おり 、 平均 経過 時間 は 約 31 , 000 秒 （ 8.5時間 ） で ある 。
この よう な 数値 の もとで は 、 多く の スレッド の 1秒 あたり メッセージ 数 は 1 より かなり 小さな 数 と なる 。
これ まで と 同じ よう に 、 これら の 値 を 対数 を 使っ て 変換 する が 、 小さな 値 を 入力 し て いる ので その 結果 は 負 の 値 と なる 。
今回 の 仕組み の 上 で は 負 の 値 を 取り扱う こと は でき ない ため 、 正式 に は アフィン 変換 と 呼ば れる 変換 を 追加 で 行う 必要 が ある 。

アフィン 変換 と は 、 空間 の 中 の 点 を 単純 に 線型 に 移動 する 変換 で ある 。
グラフ 用紙 に 描か れ た 正方形 を 想像 し て みよ う 。
もし その 正方形 を 他 の 場所 に 移し たい と し たら 、 同じ 方向 に すべて の 点 を 移動 する よう な 関数 を 定義 する こと で 実現 できる 。
これ が アフィン 変換 で ある 。
log.trans.weight で 非負 の 重み を 得る ため に は 、 単純 に 対数 変換 さ れ た値 に 10 を 足す こと に する 。
これ によって すべて 正 の 値 を 持っ た 適切 な 重み と なる こと が 保証 さ れる 。

以前 と 同じ よう に 、 get.threads と thread.counts で 重み の データ を 生成 し たら 、 thread.weights データ フレーム と 他 の 重み付け の データ フレーム が 一貫 し た 名前 を 持つ よう に 、 thread.weights データ フレーム に対して いくつか の 基本 的 な 整形 を 行う 。
最後 の 行 で は 、 subset 関数 を 使っ て 1つ の メッセージ しか ない スレッド （ つまり 一部 が 切り取ら れ た スレッド ） を 示す 行 を 削除 し て いる 。
これ で head ( thread.weights ) コマンド を 使っ て 結果 を 確認 する こと が できる 。

最初 の 2 行 は この 重み付け 方式 が どの よう に スレッド の 活動量 を 評価 する か を 示す 良い 例 と なっ て いる 。
どちら の スレッド も メッセージ は 4つ だ 。
しかし 件名 が 「 prob.w/install/uninstall 」 の スレッド で は 、 もう 一方 に対して 約 半分 の 秒 数 に 同じ 数 の メッセージ が 詰め込ま れ て いる 。
我々 の 仮定 に よれ ば 、 この スレッド は より 重要 で あり 、 より 高い 重み を 与え られる 。
この 場合 、 この スレッド から の メッセージ に は 件名 が 「 please helpanewbiecompilemplayer :-) 」 の スレッド より も 1.04 倍 の 重み を 与える こと に なる 。
この こと は 一見 し た だけ で は 理 に かなっ て いる か わから ない かも しれ ない ため 、 この よう な 仕組み を 設計 し 、 一般 的 な 問題 に 適用 する にあたって 一 種 の 職人 芸 が 必要 と なる 。
この 場合 、 ある ユーザ は この よう な 方法 で 物事 を 評価 し 、 他 の ユーザ は この 方法 で は 評価 し ない かも しれ ない が 、 今 は 一般 的 な 解決 を 必要 と し て いる ので 、 先 ほど 置い た 仮定 が 間違っ て いる 場合 が ある として も 受け入れ なけれ ば なら ない 。

これら の スレッド から 生成 する 最後 の 重み付け データ は 、 スレッド 中 に 頻出 する 単語 で ある 。
3 章 と 同様 に 、 単語 の ベクトル と TermDocumentMatrix の control リスト を 受け取っ て TDM を 生成 し 、 すべて の スレッド 中 の 単語 の 頻度 を 抽出 する term.counts と 呼ば れる 一般 的 な 関数 を 作成 する 。
この よう な 重み付け データ を 作成 する という こと は 、 活動 的 な スレッド の 件名 中 で 頻出 する 単語 が 、 そう で ない 単語 や 一 度 も 現れ ない 単語 より も 重要 で ある と 仮定 し て いる こと に なる 。
電子メール の きめ細かい 区分 を 行う ため に 、 順位 付け において 可能 な 限り 多く の 情報 を 考慮 しよ う と し て いる の で ある 。
そのため に は すでに 活動 的 な スレッド を 探す だけ で なく 、 活動的 だっ た よう に 「 思わ れる 」 スレッド について も 重み付け を 行っ て おり 、 単語 の 重み付け は そのため の 方法 の 1つ で ある 。

最後 の 重み付け データ は 訓練 データ 中 の すべて の 電子メール メッセージ の 単語 の 頻度 に 基づい て 構築 さ れる 。
この 目的 に は スパム 分類 の 演習 で 単語 を 数え上げ た の と ほとんど 同じ 方法 を 使う こと が できる 。
ただし 、 今回 は これら の 頻度 を 対数 変換 し た 重み を 割り当てる こと に する 。

これ で 順位 付け の ため の 5つ の 重み データ フレーム は 完成 で ある 。
これ に は from.weight （ ソーシャル 素性 ） 、 sender.df （ スレッド 中 の 送信 者 の 活動量 ） 、 thread.weights （ スレッド メッセージ の 活動量 ） 、 term.weights （ 活動 的 な スレッド における 単語 ） 、 そして msg.weights （ すべて の 電子メール における 頻出 の 単語 ） が 含ま れる 。
これ にて 順位 付け を 利用 し て 訓練 データ を 処理 し 、 メッセージ が 重要 で ある か どう か の しきい値 を 見つける 準備 は 完了 で ある 。

訓練 データ 中 の それぞれ の メッセージ から 優先順位 を 生成 する ため に は 、 前 の 節 で 生成 し た すべて の 重み を 掛け合わ せ なけれ ば なら ない 。
これ は つまり 、 データ 中 の それぞれ の メッセージ に対し 、 電子メール を 解析 し 、 素性 を 抽出 し 、 対応 する 重み データ フレーム と 付き合わ せ て 適切 な 重み の 値 を 取得 する 必要 が あり 、 これら の 値 の 積 を 取る こと で それぞれ の メッセージ に対して 特有 の 順位 付け を する ため の 値 を 得る こと が できる の で ある 。
次 の ran k.message 関数 は メッセージ の ファイル パス を 受け取っ て これ まで に 定義 し た 素性 と それ に 連なる 重み に 基づい て その メッセージ の 優先順位 を 生成 する まで を 1つ の 関数 に まとめ た もの だ 。
ran k.message 関数 は すでに 定義 し た 多く の 関数 を 利用 し て いる だけ で なく 、 get.weights 関数 という 新しく 作成 し た 関数 も 利用 し て いる 。
これ は 素性 が 単一 の 重み に 対応 し ない 場合 、 つまり 件名 と メッセージ 中 の 単語 の 場合 に 、 重み を 検索 する 関数 で ある 。

まずは 検索 単語 （ 文字列 ） 、 検索 する 重み データ フレーム 、 そして term の ため の 真偽 値 という 3つ の 引数 を 取る 、 get.weights 関数 を 定義 する 。
最後 の 引数 は この 関数 に 単語 の データ フレーム を 検索 し て いる の か 、 スレッド の データ フレーム を 検索 し て いる の か を 教える ため の もの だ 。
term.weight と thread.weights データ フレーム は 列 の 名前 が 異なっ て いる ため 、 その 区別 を つけ て 、 これら に対する 検索 も 少し 違っ た 方法 で 扱う 。
ここ で の 処理 は かなり 素直 な もの で 、 match 関数 を 使っ て 重み データ フレーム の 中 から search.term に 一致 する 要素 を 見つけ 、 その 重み の 値 を 返す 。
重要 な こと は 、 一致 する 要素 が なかっ た とき に この 関数 が どの よう に 振る舞う か で ある 。

最初 に 、 get.weights に 渡さ れる 検索 単語 が 正 の 長 さ を 持っ て いる こと を 確認 し 、 それ が 有効 で ある か どう か の 安全性 チェック を 行っ て いる 。
この 確認 方法 は 、 電子メール データ を 解析 し て いる とき に 電子メール が 件名 の 行 を 含ん で いる か どう か を チェック し た の と 似 て いる 。
もし 検索 単語 が 無効 で あっ たら 、 単純 に 1 を 返す （ 初等 数学 に よれ ば 、 何 か に 1 を かけ て も 次 の ステップ で 計算 さ れる 積 は 変化 し ない ） 。
どこ に も 一致 し なけれ ば 、 term.match ベクトル は すべて NA と なり 、 match.weights は 長さ ゼロ と なる だろ う 。
この 場合 に 備え て 追加 の 確認 を 行っ て おり 、 外れ値 を 見つけ たら 先ほど と 同じ よう に 1 を 返す よう に し て ある 。
もし 複数 の 重み の 値 と 一致 し たら 、 すべて の 重み の 平均 を 結果 として 返す 。

ran k.message 関数 は get.weights 関数 と 似 た ルール を 使っ て 、 データセット 中 の それぞれ の 電子メール から 抽出 さ れ た 素性 に 重み の 値 を 割り当てる 。
まず 、 parse.email 関数 を 呼ん で 興味 の ある 4つ の 素性 を 抽出 する 。
次に 、 いくつか の if - then 節 を 使っ て 現在 の 電子メール から 抽出 さ れ た 素性 が 順位 付け の ため の 重み データ フレーム の いずれ か に 含ま れる か どう か を 調べ 上げ 、 適切 に 重み付け する 。
from と thread.from は ソーシャル 素性 を 使っ て 送信 者 の 電子メール アドレス に 基づく 重み を 発見 する 。
どちら の 場合 も 、 ifelse 関数 が 重み データ フレーム に 1つ も 一致 し なかっ たら 、 1 を 返す こと に 注目 しよ う 。
これ は get.weights 関数 の 実装 と 同じ 理由 による もの だ 。

スレッド と 単語 による 重み付け で は 、 いくつか の 内部 的 な テキスト 解析 を 行う 。
スレッド に関して は 、 まず 順位 付け さ れる 電子メール が スレッド の 一部 か どう か を 訓練 段階 と 全く 同じ やり方 で 確認 し て いる 。
もし そう なら 重み を 検索 し 、 そう で なけれ ば 1 を 割り当てる 。
単語 に 基づく 重み付け で は 、 term.counts 関数 を 使っ て 電子メール の 素性 から 興味 の ある 単語 を 取得 し 、 適切 に 重み付け を する 。
最後 の ステップ として 、 今 検索 し て き た すべて の 重み の 値 を prod 関数 に 渡す こと で 優先 度 を 生成 する 。
ran k.message 関数 は 返り 値 として 電子メールの日 付 と 時刻 、 送信 者 の アドレス 、 件名 、 そして 優先 度 を 返す よう に なっ て いる 。

これ で いよいよ 順位 付け を 行う 準備 が 整っ た 。
先 に 進む 前 に 、 データ を 時系列 順 に 2つ に 分割 する 。
最初 は train.paths と 名付ける 訓練 データ で ある 。
ここ で 生成 さ れ た 順位 付け の データ を 「 優先 する 」 メッセージ に対する しきい値 を 決める ため に 使う 。
一度 しきい値 を 決めれ ば 、 あと は test.paths 中 の 電子メール について 内部 的 な 優先 順位 を 求め 、 優先 度 が 高い か どう か によって 順位 付け を 行う こと が できる 。
次に 、 train.paths ベクトル に rank.message 関数 を 使っ て 、 それぞれ の 電子メール に対する 素性 と 優先 度 を 含む ベクトル の リスト を 生成 する 。
そして 、 いくつか の 基本 的 な 整形 によって この リスト を 行列 に 変換 する 。
最後 に 、 この 行列 を データ フレーム に 変換 し 、 列 名 の 付与 と 整形 さ れ た ベクトル 形式 へ の 変換 を 行う 。

コマンド 「 train.ranks <- lapply ( train.paths , ran k.message )」 を 実行 する と R が 警告 を 発生 する こと に 気付く だろ う 。
しかし これ は 大した 問題 で は なく 、 順位 付け の 実装 方法 による 仕様 通り の 結果 で ある 。
もし この 警告 を 見 たく なけれ ば 、 lapply の 呼び出し を suppressWarnings 関数 を 使っ て ラップ する こと で 回避 する こと が できる 。

次に 、 優先 電子メール の しきい値 を 計算 する 重要 な ステップ を 実行 する 。
見 て の 通り 、 ここ で は しきい値 として 訓練 データ 中 の 優先 度 の 中央値 を 用いる こと に し た 。
もちろん 中央値 の 他 に も 2 章 で 見 て き た よう な 様々 な 要約統計量 を しきい値 として 使う こと が できる 。
この しきい値 を 決める ため に 電子メール が どの よう に 順位 付け さ れる か どう か の 既存 の 事例 を 使っ て い ない ため 、 今回 の やり方 は 実際 に は 一般 的 な 教師 あり 学習 と は 異なっ て いる 。
しかし 、 中央値 を 選ん だ の に は 2つ の 大きな 理由 が ある 。
第一 に 、 もし 良い 順位 付け 関数 を 設定 し た の なら 、 ほとんど の 電子メール の 優先 度 は 低く 、 わずか な 電子メール の 優先 度 だけ が 高い よう な 、 なだらか な 分布 に なる はず で ある 。
今 探し て いる の は 「 重要 な 電子メール 」 で あり 、 通常 の 電子メール の やり取り と は 異なる 独特 な メッセージ で ある 。
これら の 電子メール は 優先 度 の 分布 の 右側 の 部分 に 当たる はず だ 。
もし そう なら 、 中央値 より も 大きい 優先 度 は 典型 的 な 優先 度 より も 大きい と 言う こと が できる 。
直観 的 に は 、 この よう に 典型 的 な 電子メール より も 優先 度 の 高い メール を 選ぶ という 方法 は 、 人間 が 考える 優先 メール を 推薦 する 方法 と 似 て いる と いえる だろ う 。

第 二 に 、 テストデータ は 訓練 データ の うち どれ と も 一致 し ない 電子メール を 含ん で いる 可能性 が ある 。
新しい 電子メール は 常に 増え て いく が 、 今回 の 設定 で は 順位 付け 関数 を 更新 する 方法 は 与え られ て い ない 。
そのため 、 排他的 と いう より は 包括 的 な 基準 によって 優先 度 の ルール を 決める べき で ある 。
そう で なけれ ば 、 用意 し た 素性 と 一致 し ない メッセージ を 見逃す 可能性 が ある 。
最後 に train.ranks.df に Priority という 2 値 の 列 を 加え て 、 その 電子メール が 優先 メール として 推薦 さ れる か どう か の 情報 を 示し て いる 。

図 4-5 は 訓練 データ に対して 推定 し た 優先 度 の 分布 を 表し て いる 。
垂直 の 破線 は 中央値 の しきい値 を 表し て おり 、 おおよそ 24 で ある 。
見 て の 通り 、 優先 度 の 分布 は 非常 に 厚い 裾 を 持っ て おり 、 訓練 データ について うまく 動く 順位 付け 関数 を 作成 でき た こと が わかる 。
中央値 の しきい値 は 非常 に 包括 的 で あり 、 密度 の 高い 部分 の 電子メール も 多く 優先 メール に 含ま れ て いる という こと も わかる 。
上記 の 通り 、 これ は 意図的 に 成し遂げ た もの で ある 。
それ より も 包括 的 で は ない しきい値 の 基準 として 、 sd ( train.ranks.df$Rank ) で 計算 できる 標準偏差 が 挙げ られる 。
標準偏差 は 約 90 で あり 、 密度 の 高い 部分 の ほとんど すべて を 切り捨て て しまう 。

次に テストデータ 中 の すべて の 電子メール について 優先 度 を 計算 する 。
この 処理 は 訓練 データ に 行っ た の と 完全 に 同じ もの な ので 、 ここ で コード を 再 掲載 する の は やめ て 紙面 を 節約 する こと に する 。
もし この コード を 読み たけれ ば 、 この 章 の code/priority_inbox.R ファイル の 308 行 目 から 先 を 参照 し て ほしい 。
テストデータ の 優先 度 を 計算 し たら 、 訓練 データ と 結果 を 比較 し 、 新しい 電子メール に対し どの ぐらい 順位 付け が うまく 行っ た か を 知る こと が できる 。

図 4-6 は 図 4-5 に テストデータ の 優先 度 の 分布 を 重ね合わ せ た もの で ある 。
この 図 は 順位 付け の 質 に関して 実に 様々 な こと を 教え て くれる 。
第一 に 、 テストデータ に は より 値 の 小さい 部分 により 高い 密度 の 山 が ある という こと が 挙げ られる 。
つまり 低い 優先 度 の 電子メール が より 多く 存在 し て いる という こと だ 。
さらに は 、 テスト 段階 で の 密度 推定 は 訓練 データ ほど なだらか で ない という こと が 言える 。
この こと は 、 テストデータ が 訓練 データ に 含ま れ ない よう な 事象 を 多く 含ん で いる という こと を 示し て いる 。
これら の 事例 は 訓練 データ の どれ と も 一致 し ない ため 、 順位 付け の 際 に は この 情報 は 無視 さ れ て いる 。

この こと は 問題 を 引き起こす 可能性 が ある が 、 優先 メール の しきい値 として 包括 的 な 指標 を 使っ た ため に 厄介 な こと に なる の を 回避 でき て いる 。
テストデータ 中 に は しきい値 の 線 より も 右側 に ある 密度 も かなり 残っ て いる こと に 注目 しよ う 。
これ により 、 テストデータ の 順位 付け において も 重要 な 電子メール を 推薦 する こと が でき て いる こと が わかる 。
最後 の 確認 として 、 実際 に どの 電子メール が 上位 に 順位 付け られ た か を 見 て みよ う （ 表 4-1 ） 。

この 種 の 順位 付け を 行う 際 に は 本質的 に 未知 の 量 という もの が 存在 する 。
この 演習 の 全体 を通して 、 設計 に 取り入れる それぞれ の 素性 について 仮説 を 置き 、 それら を 直観 的 に 説明 する こと で 正当化 しよう として きた 。
しかしながら 、 今回 の 場合 は 順位 付け アルゴリズム の 性能 が どれ だけ 良い か について の 評価基準 を 知る こと は でき ない 。
なぜなら 、 これら の 電子メール を 受け取っ た ユーザ にとって その 順序 が 良い か どう かや 意味 が 通る か どう か を 確認 する 方法 が ない からだ 。
分類 問題 の 演習 で は 、 訓練 データ と テストデータ の それぞれ の 電子メール に 付与 さ れ た ラベル を 知っ て い た ため 、 混同 行列 を 使っ て 分類 器 が どれ だけ うまく 動作 し た か を 明示 的 に 評価 する こと が でき た 。
今回 の 場合 は 同じ 方法 を 使う こと は でき ない が 、 結果 を 見 て 順位 付け が どれ だけ うまく いっ た か を 推察 する こと は できる 。
これ は この 演習 において 通常 の 教師 あり 学習 と は 異なる 部分 で ある こと に 注意 しよ う 。

表 4-1 は 、 テストデータ 中 で 優先 メール として ラベル付け さ れ た もの の うち 、 最も 新しい 40 通 の 電子メール を 示し て いる 。
この 表 は 実際 に この システム を 使っ て 優先 トレイ を 実装 し た とき 、 受信 トレイ が どの よう に 見える か を 模擬 し て 、 優先 度 の 情報 とともに 表示 し た もの で ある 。
この 結果 を 確認 し て 電子メール の グループ 化 が どの よう に 行わ れ て いる か を 調査 する こと が できる 。

この 結果 の 有望 な 点 は 、 今回 の 順位 付け が スレッド を うまく まとめ て いる ところ だ 。
この 表 を 見る と 、 同じ スレッド から の 電子メール が 優先 メール として 一緒 に まとめ られ て いる 例 を いくつか 見つける こと が できる 。
また 、 順位 付け によって 高 頻度 の 送信 者 、 例えば tomwhore@slack.net や yyyy@spamassassin.taint.org など から の 電子メール は 高い 優先 度 を 持っ て いる という こと が わかる 。
最後 に 最も 重要 な 点 は 、 訓練 データ 中 に 現れ なかっ た メッセージ を 優先 付け する こと が でき た という こと で ある 。
実際 、 テストデータ に 含ま れる 85 の スレッド の うち たった 12 の スレッド （ 約 14% ） だけ が 、 訓練 データ から 引き続き 優先 メール として 扱わ れ て いる 。
つまり この 順位 付け を 更新 なし で テストデータ 中 に 現れ た 新しい スレッド に 適用 する こと が でき 、 推薦 を 行う こと が できる という こと だ 。
これ は 非常 に 素晴らしい 結果 だ 。

本章 で は 1つ の 要素 から なる 素性 だけ で なく 、 複数 の 素性 を 組み合わせ た 複雑 な モデル を 扱う 方法 を 紹介 し た 。
実際 に は もう少し 難しい 、 やり取り の うち 半分 しか 手 に 入ら ない 状況 で の 電子メール の 順位 付け モデル を 設計 し た 。
やり取り の 量 と スレッド 活動 量 と 高 頻度 の 単語 に 基づい て 、 順位 付け を 行う ため に 4つ の 素性 と 5つ の 重み データ フレーム を 生成 し た 。
正解 データ が 手 に 入ら ない ため に 定量 的 に 評価 する こと は 難しい が 、 今 調べ た よう に 結果 は 良好 そう で ある 。

ここ まで の 2つ の 章 で 、 スパム 分類 を 達成 する ため の 比較的 単純 な 教師 あり 学習 と 、 ヒューリスティック に 基づく 非常 に 基本 的 な 順位 付け の 方法 を 扱っ た 。
次 の 章 で は 統計的 学習 における 主戦 力 、 回帰 問題 に 取り組む こと に しよう †。

一言 で 言え ば 、 回帰 と は 与え られ た ある 数値 群 から 別 の 数値 群 を 予測 する という 非常 に 単純 な 概念 だ 。
例えば 、 保険数理 士 （ アクチュアリ ） は ある 人 の 喫煙 歴 から その 人 の 寿命 を 予測 し たい と 思う だろ う し 、 気象予報士 は 前日 の 気温 を 与え られ て 翌日 の 気温 を 予測 し たい と 思う だろ う 。
一般 に 、 与え られる 数値 群 の こと を 入力 変数 、 予測 し たい 数値 群 の こと を 出力 変数 と 呼ぶ 。
入力 変数 の こと を 予測 変数 や 特徴 量 と 呼ぶ こと も ある 。

回帰 が 分類 と 違う の は 、 出力 変数 が 実 数値 という 点 で ある 。
3 章 で 扱っ た よう な 分類 問題 で は 、 カテゴリ の 区別 を する ため だけ に ダミー の 数値 を 使い 、 0 が 非 スパム で 1 が スパム を 表し て い た 。
しかし これら の 数値 は 単なる 記号 で あり 、 ダミー 変数 を 使う とき は 0 や 1 を 数値 として 扱っ て い た わけ で は ない 。
回帰 で は 、 出力 変数 は 実際 に 数値 で ある という 点 が 重要 で ある 。
例えば 気温 を 予測 し たい と し たら 、 摂氏 10度 や 21度 といった 数値 を 扱う こと に なる 。
数値 を 予測 し て いる と 、 入力 変数 と 出力 変数 の 関係 について 強く 主張 し たく なる かも しれ ない 。
例えば 、 1日 に 吸う タバコ の 数 が 2倍 に なる と 寿命 は 半分 に なる といった 具合 だ 。

しかし 、 数値 的 に 正確 な 予測 を し たい こと と 実際 に うまく 予測 できる か どう か に は 大きな 隔たり が ある という 問題 が ある 。
定量 的 な 予測 の ため に は 、 入手 可能 な 情報 に 基づい て 何らかの 規則 を 考え付く 必要 が ある 。
統計学 者 が この 200年間 に 渡っ て 考え て き た 種々 の 回帰 アルゴリズム は 、 入力 変数 から 出力 変数 の 予測 を 行う 様々 な 方法 を 提供 し て き た 。
本章 で は 、 回帰 モデル の 中 で も とりわけ 主戦 力 と なる 線形回帰 について 扱う こと に しよ う 。

馬鹿らしく 聞こえる かも しれ ない が 、 回帰 の ため の 最も 単純 な 方法 は 、 入力 を 無視 し て 過去 の 出力 の 平均 に 基づき 未来 の 予測 値 を 出力 する という モデル で ある 。
保険数理 士 の 例 で 言え ば 、 健康診断 の 記録 を 無視 し て 常に 平均寿命 と 同じ だけ 生きる と 仮定 する よう な もの だ 。
しかし 、 この あらゆる 場合 に 平均 的 な 出力 を 予測 する という 方法 は 見かけ ほど 馬鹿らしく は ない 。
他 の 情報 なし に 真実 に 最も 近い 予測 を 行う と し たら 、 平均 を 出力 する という の は 考え られる 限り 最善 の 推測 に なり うる 。

この 主張 を 明確 に する ため に は 、 「 最善 の 」 推測 という 言葉 の 定義 について 少し ばかり 頭 を 使う 必要 が ある 。
もし ここ で 「 最善 」 という 言葉 を 、 それ が 意味 する ところ を 説明 せ ず に 使っ て いる こと が 気 に なる なら 、 後ほど 正式 な 定義 を 与える ので 少し だけ 待っ て ほしい 。

最善 の 推測 を 行う 方法 について 議論 する 前 に 、 表 5-1 に 部分 的 に 示し た 想像 上 の 保険数理 データ を 使える と しよ う 。

これ は 完全 に 新しい データセット な ので 、 2 章 で 提案 し た よう に 正式 な 解析 を 行う 前 に ちょっと だけ データ の 中身 を 見 て みよ う 。
数値 の 列 と ダミー 符号 に なっ て いる 因子 を 与え られ て いる ので 、 喫煙者 と 非喫煙者 を 比較 する ため に 密度 プロット を 行う という 考え は 自然 で ある （ 図 5-1 の グラフ を 見 て ほしい ） 。

結果 の プロット から は 喫煙 が 寿命 に 悪い 効果 を 与える という 推測 は 、 非喫煙者 の 寿命 の 分布 は 喫煙者 の 分布 より も 中心 が 右 に ずれ て いる ため 、 合理的 に 思える 。
別 の 言い方 を すれ ば 、 非喫煙者 の 平均寿命 は 喫煙者 の 平均寿命 より も 長い 。
しかし 喫煙 の 習慣 から 寿命 を 予測 しよ う と する 前 に 、 この よう な 情報 を 与え られ て い ない と 仮定 し て みよ う 。
そうすると すべて の 新しい 人 に対して 、 その 人 の 喫煙 習慣 に 関わら ず 常に 単一 の 値 を 予測 する 必要 が ある 。
その 場合 に は どの よう な 値 を 選ぶ べき だろ う か 。

この 問い の 回答 は 、 良い 予測 と は 何 か を どう 定義 する か による ため 、 そう 簡単 で は ない 。
予測 の 精度 を 定義 する 合理 的 な 方法 は いろいろ と 考え られる が 、 統計学 の 歴史 において よく 使わ れ て き た 指標 が 1つ だけ ある 。
その 指標 は 二 乗 誤差 と 呼ば れ て いる 。
予測 し たい 変数 を y （ 真 の 出力 ） と し 、 予測 した値 を h （ y について の 仮説 、 hypothesis ） と する と 、 その 予測 値 の 二 乗 誤差 は ( y - h )^ 2 で 表さ れる 。

予測 値 の 質 を 測る ため に 二 乗 誤差 を 使う こと に は 、 単なる 慣習 として 受け入れ られ て いる だけ で なく 、 もっとも な 理由 が 数多く ある 。
ここ で は 詳しく 説明 し ない が 、 機械学習 における 最適化問題 について 取り扱う 7 章 で は 、 誤差 を 測る ため の 方法 について より 詳しく 見 て いく 。
ここ で は 、 二乗 誤差 に関する 簡単 な 事実 を 示す に とどめる こと に しよ う 。
二 乗 誤差 を 予測 の 質 を 測る ため に 使う と 、 人々 の 習慣 について 追加 の 情報 が ない 場合 に 取り うる 最も 良い 予測 値 は 、 寿命 の 平均 と なる 。

この 主張 を 納得 できる よう に する ため 、 平均 以外 の 推測 値 を 使っ た 場合 に どう なる か 考え て みよ う 。
寿命 の データセット において 寿命 を 表す AgeAtDeath の 平均 は 72.723年 で あり 、 さしあたり 四捨五入 し て 73 として 扱お う 。
それでは もし すべて の 人々 が 73歳 まで 生きる と 推測 する と 、 その 推測 は どれ だけ 外れる だろ う か ？

この コード を 実行 し た 結果 、 今回 の データセット の すべて の 人々 に 73 という 推測 を する と 、 その 平均 二 乗 誤差 は 32.991 と なる こと が わかる 。
しかし この 結果 だけ で は 73 以外 の 推測 が 平均 二 乗 誤差 の 意味 で もっと 悪く なる という 証明 に は なら ない 。
73 が 最も 良い 推測 で ある と 納得 できる よう に する ため に は 、 他 の 推測 を 行っ た 場合 の 二 乗 誤差 について 考える 必要 が ある 。
その 計算 を R で 行う ため に 、 63 から 83 まで の 可能 な 推測 値 の 系列 に対して 繰り返し ながら 二 乗 誤差 を 見 て みる 。

図 5-2 を 見る と わかる よう に 、 73 以外 の 推測 で は すべて 今回 の データセット に対して より 悪い 予測 と なっ て いる 。
実は この 結果 は 数学 的 に 証明 でき 、 一般 化 できる 理論 で ある 。
つまり 二 乗 誤差 を 最小 化 する ため に は 、 データセット 中 の 平均 の 値 を 予測 すれ ば 良い 。
ここ で 重要 な こと は 、 喫煙 に関する 情報 を 取り入れる こと によって 得 られる 新た な 予測 力 は 、 すべて の 人 に対して 平均値 だけ を 用い た 推測 と 比べ た とき の 改善 の 大き さ によって 、 その 効果 を 測定 する 必要 が ある という 点 で ある 。

それでは 、 どの よう に 追加 の 情報 を 取り入れ て 予測 する こと が できる だろ う か 。
より 広範囲 な 問題 に 取り組む 前 に 、 単純 な 場合 を 考え て みよ う 。
寿命 について 予測 を 行う 上 で 、 喫煙 習慣 の 情報 を どの よう に 使う こと が できる だろ う か 。

単純 に 考えれ ば 、 喫煙者 と 非喫煙者 について 平均寿命 を 個別 に 計算 し 、 その 値 を 推測 値 として 新しい 人 の 寿命 を 予測 すれ ば 良い 。
今回 は MSE の 代わり に 、 機械学習 の 文献 で は より 多く 使わ れ て いる 指標 で ある 、 その 平方根 で ある RMSE （ RootMeanSquaredError ） を 使う 。

R で データ を 喫煙 者 と 非喫煙者 の グループ に 分割 し 、 別々 に 推測 値 を 求めて RMSE を 計算 する に は 以下 の よう に する （ 結果 は 表 5-2 に まとめ て ある ） 。

計算 し た RMSE を 見る と 、 追加 の 情報 を 使う こと で 実際 に 予測 精度 が 改善 さ れ て いる こと が わかる 。
人々 の 寿命 を 推定 する 上 で の 予測 誤差 は 、 喫煙 の 習慣 を 取り入れる こと で 約 10% ほど 削減 さ れ て いる 。
一般 に データ ポイント が 出力 変数 と 関連 し て 2種類 に 分け られる とき 、 データ ポイント を その グループ に 分け て 個別 に 平均 を 取る こと で 、 より 良い 予測 結果 を 得る こと が できる 。
2種類 の 区別 が 役に立つ の は 、 例えば 男性 と 女性 を 比べ たり 、 米国 の 政治 の 文脈 で 民主 党員 と 共和党 員 を 比べ たり する という よう な こと を 指す 。

これ により 、 ダミー 変数 の 情報 を 予測 に 取り入れる 方法 を 手 に 入れ た 。
しかし 、 より 豊富 な 情報 を 取り入れる ため に は どう すれ ば 良い だろ う か 。
ここ で いう 豊富 という 言葉 に は 2種類 の 意味 が ある 。
1つ 目 は 2 値 で なく 連続 値 で ある よう な 入力 変数 を どう 取り扱う か という こと で 、 例えば 身長 や 体重 の 情報 が これ に 当たる 。
もう 1つ は 、 どう すれ ば 複数 の 情報源 を 組み合わせ て 推測 を 改善 する こと が できる か という 点 で ある 。
実際 の 例 で 言え ば 、 喫煙 習慣 の 情報 や 両親 の 寿命 を 考え て み て ほしい 。
直観 的 に 考え て 、 これら の 2つ の 情報源 を 組み合わせれ ば 、 それぞれ 単独 の 情報 より も 多く の こと を 教え て くれる はず で ある 。

しかし 手 に 入り うる 限り の すべて の 情報 を 取り入れる こと は 簡単 で は ない 。
実際 に は 、 物事 を 単純 化 する 仮定 を 置い て うまく 組み合わせる の が 普通 で ある 。
本章 で は 回帰 の 種類 として 線形回帰 のみ を 扱う が 、 まずは この 線形回帰 で 置か れ て いる 仮定 について 説明 しよ う 。
線形回帰 のみ を 使っ た として も 、 制限 は 想像 より も 少なく 、 現実 の 90% の 回帰 問題 を 解く こと が でき 、 しかも 少し 改良 する だけ で より 高度 な 回帰 を 行う こと も できる の で ある 。

線形回帰 で 出力 変数 を 予測 する 際 に は 次 の 2つ の 大きな 仮定 を 置い て いる 。

線形回帰 で は 、 推測 に 影響 する 複数 の 情報源 が あっ た と し たら 、 これら の 情報 から の 影響 を まるで それら が 別々 に 使わ れ て いる か の よう に 足し 合わせる こと により 推測 を 行う 。
例えば 、 アルコール中毒 者 が 非 アルコール中毒 者 より も 寿命 が 1年 短く 、 喫煙者 は 非喫煙者 より も 5年 短い と 仮定 しよ う 。
この とき 、 アルコール中毒 で かつ 喫煙 も する 人 の 寿命 は 両方 と も 当てはまら ない 人 より も 1 ＋ 5 ＝ 6年 短い に ちがい ない 、 という の が この 加法 性 の 性質 で ある 。
独立 し た 特徴 量 の 効果 が 同時に 起こっ た とき に 足し 合わさ れる という の は 非常 に 強い 仮定 だ が 、 回帰 問題 の 多く の 応用 における 初め の 一 歩 と なる 。
後ほど 、 線形回帰 における 可分 性 の 仮定 にまつわる 相互作用 という 考え方 について 触れる こと に する 。
これ は 先 ほど の 例 で 言え ば 、 喫煙 も する 人 が 飲み 過ぎる と さらに 悪い 効果 が ある といった 性質 の こと で ある 。

ある 入力 変数 を 変え た とき 、 予測 し た 出力 変数 が 常に 上昇 または 減少 する とき 、 その モデル は 単調 で ある と いう 。
例えば 、 身長 を 入力 として 体重 を 予測 する とき に 、 モデル が 単調 なら 身長 が 大きけれ ば 大きい ほど 体重 も 大きい という 予測 と なる 。
単調 性 は 非常 に 強い 仮定 で あり 、 例えば 、 ある 入力 変数 に対して 出力 変数 が 一時的 に 増加 し た 後 に 減少 する よう な 例 は いくら で も 考え付く 。
しかし 、 単調 性 は 実際 に は 線形 性 と 呼ば れる 線形回帰 における 完全 な 仮定 より も かなり 弱い 仮定 と なっ て いる 。
線形 性 と は 意味 的 に は 非常 に 単純 な 技術 用語 な の だ 。
数学 的 に 説明 する と 、 線形 性 と は 入力 を 1 だけ 変更 する と 常に 出力 に N を 足す 、 または N を 引く という 性質 の こと で ある 。
すべて の 線形 な モデル は 単調 で ある が 、 単調 だ が 線形 で は ない 曲線 も 存在 する 。
そのため 、 線形 性 は 単調 性 より も 強い 仮定 と なっ て いる 。

図 5-3 の 例 を 見 て 直線 、 曲線 、 波 と は 何 か を しっかり と 理解 し て おこ う 。
これら の 曲線 と 直線 は 両方 とも 単調 で ある が 、 波 は あるとき は 増加 し別 の とき は 減少 する ため 、 単調 で は ない 。
標準 的 な 線形回帰 は データ を 可視 化 し た とき に 直線 の よう に 見える とき に うまく 動作 する 。
曲線 や 波 に対して 線形回帰 を 用いる こと も 不可能 で は ない が 、 この 話題 について は 6 章 で 議論 する まで おい て おこ う 。

加法 性 と 線形 性 の 仮定 を 念頭 に 置い たら 、 線形回帰 の 簡単 な 例 に 取り掛かろ う 。
それでは もういちど 身長 と 体重 の データセット に 立ち戻っ て 、 線形回帰 が この 場合 に どの よう に 動作 する か を 示す こと に する 。
図 5-4 で は 、 これ まで に 何回 も 行っ て き た の と 同じ 方法 で 散布 図 を 描画 し た 様子 を 示す 。
図 5-5 で は 、 この コード に 若干 の 変更 を 加える こと で 、 線形回帰 モデル が 身長 から 体重 を 予測 する 様子 を 直線 として 重ね て 描画 し て いる 。
ここ で 線形 モデル を 実装 する ため に 必要 と し た の は 、 method に lm を 指定 し て geom_smooth 関数 を 呼び出す こと だけ で ある 。

この グラフ から わかる こと は 、 直線 を 用い て 身長 から 体重 を 予測 する という 方法 は かなり うまく いく という こと だ 。
例えば 、 この 直線 によって 線形回帰 は 60インチ （ 152センチ メートル ） の 身長 の 人 に は 105 ポンド （ 47 キログラム ） の 体重 を 予測 し 、 75 インチ （ 190センチ メートル ） なら 225 ポンド （ 101 キログラム ） と 予測 する という こと が わかる 。
これ により 、 直線 を 用い て 予測 を 行う こと は 合理 的 で ある と 考え られる 。
この 結果 から 次に 考える べき 疑問 は 、 この グラフ に 表示 さ れ た 直線 の 式 を 見つける に は どう すれ ば いい だろ う か 、 という もの で ある 。

R が 機械学習 の ため の 言語 として 実際 に 活躍 する の は この よう な 場面 で ある 。
R で は lm という 単純 な 関数 が すべて 必要 な こと は 行っ て くれる 。
lm を 使う ため に は 、 回帰 式 を 「 ~」 演算子 によって 指定 する 必要 が ある 。
今回 の 例 で は 、 身長 から 体重 を 予測 しよ う と し て いる ため 、 ここ に は 「 Weight ~ Height 」 と 書い た 。
もし 逆 方向 の 予測 を 行い たかっ たら 、 「 Height ~ Weight 」 と 書く 必要 が ある 。
この よう な 数式 を 声 に 出して 読む なら 、 Height ~ Weight という 式 は 「 身長 を 、 体重 の 関数 として 」 と でも 読む こと に しよ う 。

この よう な 回帰 の 設定 に 加え て 、 データ が 格納 さ れ て いる 場所 を R に 教える 必要 が ある 。
回帰 の ため の 変数 を グローバル変数 に し て おけ ば この 手順 を 省略 する こと が できる が 、 この よう に グローバル変数 を 使う こと は R ユーザ の コミュニティ から は 嫌わ れ て いる ので 注意 しよ う 。

R で グローバル変数 を 使い すぎる と 、 どの データ が メモリ 中 に 読み込ま れ て いる か が わから なく なっ て しまう ため 、 悪い 習慣 と さ れ て いる 。
何 が メモリ に あっ て 何 が ないか を 管理 でき なく なる こと で 、 コーディング 中 に 意図 し ない 結果 を 引き起こす 。
しかも コードの再利用 性 も 下げる こと に も なる 。
グローバル変数 が コード 中 で 暗黙 的 に 使わ れ て いる と 、 他 の 誰か が それ を 見落とし て 、 結果 として コード が 正常 に 動作 し ない こと に も なり うる 。

この 場合 、 data パラメータ によって 明示 的 に データ の 場所 を 指定 する ほう が 好ましい 。
これら を まとめる と 、 R で 線形回帰 を 実行 する に は 以下 の よう に すれ ば 良い こと に なる 。

lm を 呼び出し たら 、 次 は 線形 モデル の 入力 と 出力 の 間 の 係数 を 返す coef 関数 を 呼び出し て 回帰 直線 の 切片 と 傾き を 求める こと が できる 。
回帰 は 3次元 以上 に対して も 動作 する ため 、 ここ で は 直線 で は なく 線形 モデル と 呼ぶ こと に する 。
入力 と 出力 の 2次元 だけ なら グラフ は 直線 で 済む が （ それ ゆえ 「 線形 」 で ある ） 、 3次元 で は 平面 を 、 それ 以上 で は 超 平面 を 学習 する こと に なる 。

もし これら の 用語 の 意味 が わから なく て も 、 直観 的 に 理解 する の は 簡単 で ある 。
平ら な 面 は 、 2次元 上 で は 直線 で あり 、 3次元 空間 で は 平面 と なる という こと で あり 、 さらに これら を 4次元 以上 に 拡張 し た もの は 図示 でき ない が 超 平面 と 呼ば れる 。
もし よく わから なけれ ば 、 参考文献 として Flatland ［ Abb 92 ］ † を 読む こと を おすすめ する 。

この 出力 の 意味 を 理解 する ため に は 、 線形回帰 の 意味 する ところ を 理解 する 必要 が ある 。
coef から の 出力 を 理解 する ため の 最も 単純 な 方法 は 、 出力 が 意味 する 関係性 を 明示 的 に 書き出す こと で ある 。

傾き の 意味 する ところ は 、 誰か の 身長 が 1インチ （ 25.4 ミリメートル ） 増加 する ごと に 、 体重 が 7.7 ポンド （ 3.5 キログラム ） 増加 する という こと で ある 。
これ は かなり 合理的 に 思える 。
対照的 に 、 切片 は 身長 0インチ の 人間 の 体重 を 表す ため 、 若干 奇妙 で ある 。
R に よれ ば 、 人間 は − 350 ポンド （ − 158.6 キログラム ） の 体重 に なる はず で ある 。
少し 計算 すれ ば 、 その 人間 は 身長 が 45インチ （ 114.3センチ メートル ） の とき に 体重 が 0 と なる こと が わかる 。
つまり 率直 に 言っ て 、 今回 の 回帰 モデル は 子供 や 極端 に 身長 の 低い 大人 に は あまり 有効 で は ない の で ある 。

これ は 実 のところ 線形回帰 について 一般的 に 言える 問題 で ある 。
過去 に 観測 し た 入力 と は かけ離れ た 新しい 入力 を 受け取っ た とき 、 予測 モデル は 通常 、 あまり 良い 出力 を 予測 する こと が でき ない ††。
この よう な 訓練 データ の 範囲 の 外側 の 入力 について 、 推測 の 質 を 改善 する 何らかの 方法 が ない わけ で は ない が 、 今回 の 場合 は 一般 的 な 身長 （ 4 フィート 以上 8 フィート 以下 ： 122センチ 以上 244 センチ 以下 ） の 人々 を 対象 と し て いる ため 、 その 必要 は ない 。

回帰 を 実行 し て 結果 の 係数 を 確認 する 以外 に も 、 R を 使っ て 線形回帰 の 結果 を 理解 する ため に いろいろ と できる こと が ある 。
R が 生成 する 出力 の すべて の 部分 を 解説 する と 本 1 冊 分 に なっ て しまう ので 、 ここ で は 係数 を 抽出 し た 後 に 最も 重要 な いくつか の 部分 だけ に 注目 しよ う 。
実際 に 予測 を 行う とき に 必要 と なる の は 、 線形回帰 の 係数 だけ で ある 。

まず 、 どういう 場所 で この モデル が 間違い やすい の か を 理解 しよ う 。
これ は 、 モデル の 予測 を 計算 し て 入力 と 比較 する こと によって 行う 。
モデル の 予測 を 計算 する ため に は 、 R で は predict 関数 を 用いれ ば 良い 。

予測 結果 を 手 に し たら 、 簡単 な 引き算 によって 真 の 出力 と モデル による 予測 の 違い を 求める こと が できる 。

この 方法 で 計算 できる 誤差 は 残差 と 呼ば れ 、 回帰 直線 によって 説明 できる 部分 を 除い た 残り の 部分 を 表し て いる 。
R で は これら の 残差 を predict 関数 の 代わり に residuals 関数 を 用い て 直接 求める こと が できる 。

線形回帰 を 使う とき に 犯し やすい 明らか な 誤り を 診断 する 基本 的 な 方法 として 、 真 の 値 に対する 残差 を プロット し て みる 方法 が ある 。

ここ で は which = 1 を 指定 する こと で 、 最初 の 回帰 診断 グラフ だけ を 表示 する こと を R に 伝え て いる 。
他 にも 表示 方式 は いろいろ ある ので 、 他 の どれ か が 役に立つ か どう か 試し て みる こと を おすすめ する 。

この 例 で は 、 残差 に 規則 的 な 構造 は 見 られ ない ので 線形 モデル が うまく いっ て いる と 考え られる 。
しかし 、 うまく いっ て い ない 例 も ある 。

この 問題 について は 残差 に 明確 な 構造 を 見る こと が できる 。
これ は 一般 に データ を モデル 化 する とき に は 悪い 兆候 で ある 。
データ は モデル によって 、 予測 が 表す パターン と 、 残差 が 表す ノイズ に 分け られる 。
直接 目 で 見 た 時 に 、 残差 の 中 に はっきり と し た 傾向 を 見て取る こと が でき た の なら 、 モデル が すべて の 傾向 を 抽出 でき て おら ず 、 表現力 が 十分 で ない ため に 本当 の ノイズ だけ を 残差 として 取り出せ て い ない こと を 表し て いる 。
では ここ で 取り組む 簡単 な 線形回帰 より も 強力 な 回帰 モデル について 議論 する 。
と は いえ 大きな 力 は 大きな 責任 を 伴う もの な ので 、 6 章 で は 強力 すぎる モデル を 扱う とき に 注意 を 必要 と する 独特 の 問題 に 焦点 を 当てる こと に なる 。

ここ で は 、 どう すれ ば 線形回帰 を うまく 扱える か より 深く 考え て みよ う 。
残差 は 多く の 情報 を 与え て くれる が 、 たくさん の 残差 を 取り扱う の は とき に 難しい こと が ある 。
この 問題 に 対処 する ため に 、 結果 の 質 について 要約 し て くれる たった 1つ の 数字 が 必要 で ある 。

最も 単純 に 誤差 を 測る 方法 は 、 （ 1 ） すべて の 残差 について 、 （ 2 ） それ を 2 乗 する こと で モデル に対する 誤差 を 求め 、 （ 3 ） それら を 合計 する 、 という 手順 を 踏む 。

この 単純 な 二乗 誤差 の 和 は 異なる モデル を 比較 する ため に 便利 で ある が 、 多く の 人 が 嫌う よう な いくつか の 問題点 が ある 。

第一 に 、 二乗 誤差 の 和 は データ 数 の 小さい とき より も 大きい とき に 値 が 大きく なる 。
この こと を 納得 する ため に は 、 ある 決まっ た データセット と 、 その データセット に対する 二 乗 誤差 の 和 を 想像 し て みれ ば いい 。
次に 予測 が 完璧 で は ない もう 1つ の データ ポイント を 追加 し て みる 。
この 新しい データ ポイント を 加える と 、 その 前 の 二 乗 誤差 の 和 に 正 の 値 を 足す こと に なる ので 、 二乗 誤差 の 和 は 常に 大きく なっ て しまう 。

しかし この 問題 に は 簡単 な 解決 方法 が ある 。
二 乗 誤差 の 和 で は なく 、 二乗 誤差 の 平均 を 取れ ば 良い 。
これ により 、 本章 の もっと 前 で 用い た MSE による 評価 値 を 得 られる 。
MSE は ただ の 二 乗 誤差 の 和 と 違っ て データ ポイント の 増加 が 常に 評価 値 の 増加 を もたらす こと は ない が 、 もう 1つ だけ 問題 が ある 。
もし 平均 的 な 予測 値 が 5 だけ 真 の 値 から 離れ て い た と する と 、 平均 二 乗 誤差 は 25 と なっ て しまう という 点 だ 。
これ は 、 平均 を 取る 前 に 二乗 し て いる ため に 引き起こさ れる 問題 で ある 。

この よう な 尺度 の 問題 を 解決 する の は 難しく ない 。
平均 二 乗 誤差 の 平方根 を 取っ て RMSE （ RootMeanSquaredError ） と 呼ば れる 評価 値 を 求めれ ば 良い 。
RMSE は 、 線形回帰 より も はるか に 高度 な アルゴリズム も 含め て 、 機械学習 の アルゴリズム を 評価 する ため の 評価基準 として よく 使わ れ て いる 。
Netflix コンテスト で は RMSE を 最終 的 な 基準 として コンテスト 参加 者 の 機械学習 アルゴリズム の 性能 を 評価 し て い た こと など が 例 として 挙げ られる だろ う 。

RMSE について 不満 に 思わ れ て いる の は 、 「 普通 の 」 性能 と は どれ くらい なのか が すぐ に わから ない という こと だ 。
完璧 な 性能 と は 明らか に RMSE が 0 で ある こと を 意味 する が 、 この 課題 で は 完璧 を 目指す の は 現実 的 な 目標 で は ない 。
同様 に 、 モデル が うまく 動作 し て い ない こと を 認識 する の も 簡単 で は ない 。
例えば 、 全員 の 身長 が 170センチ メートル で モデル による 予測 が 1 , 700メートル だっ たら 、 RMSE は 非常 に 大きな 値 と なる 。
しかし 17 , 000 メートル と 予測 すれ ば もっと 悪く なる し 、 もっと 悪い 予測 は いくら でも 考え られる 。
RMSE が 際限 なく 大きな 値 を 取り うる こと は 、 モデル の 性能 が 合理的 か どう か を 判断 する の を 難しく し て いる 。

線形回帰 を 使う とき における 、 この 問題 に対する 解決 方法 は R2 を 使う こと だ 。
R2 の 考え方 は 、 単なる 平均 を 予測 値 として 使っ た 場合 と 比較 し て モデル の 性能 が どれ くらい 良い か を 測る もの だ 。
解釈 し やすい よう に 、 R2 は 常に 0 から 1 の 値 を 取る 。
単なる 平均 より も 改善 さ れ て い なけれ ば 、 その 値 は 0 と なる 。
すべて の データ ポイント を 完璧 に 予測 でき て い た と し たら 、 R2 の 値 は 1 と なる 。

R2 は 常に 0 から 1 の 値 を 取る ので 、 これ を 100倍 する こと で パーセント 表示 と し 、 データ と モデル による 予測 の 不一致 の 割合 で ある という 説明 が よく 行わ れ て いる 。
これ は 、 たとえ 全く 経験 が ない よう な 分野 に 取り組ん で い て 、 RMSE が 通常 は どれ くらい な の か わから ない よう な 場合 でも 、 モデル が どれ くらい 正確 で ある か の 直観 を 得る こと が できる ため 、 便利 な 方法 だ と いえる 。

R2 を 計算 する ため に は 、 すべて の データ ポイント に対して 常に 平均 を 出力 する よう な 単純 な モデル の RMSE を 計算 する 必要 が ある 。
その 次に 独自 の モデル による RMSE を 計算 する 。
最後 に 、 R2 を 生成 する ため に 必要 な の は 、 以下 に 示す よう な 簡単 な 計算 だけ で ある 。

線形回帰 を 使う 準備 が 整っ た ので 、 2011年 の インターネット で 上位 1 , 000 件 の ウェブサイト の ページビュー の 量 を 回帰 モデル によって 予測 し て みよ う 。
NeilKodne によって 提供 さ れ た この データ の 上位 5件 を 表 5-3 に 示し た 。

今回 の 目的 で は 、 この データセット の 列 の うち 一部 しか 使わ ない 。
今回 は 特に 5つ の 列 、 すなわち Rank 、 PageViews 、 UniqueVisitors 、 HasAdvertising 、 IsEnglish に 着目 する 。

Rank 列 は その ウェブサイト が 上位 1 , 000 件 中 の どこ に 位置 し て いる か を 意味 し て いる 。
Facebook が この データセット の 第 1位 の サイト で あり 、 YouTube が 第 2位 で ある 。
Rank は 実際 の 値 で は なく 順位 を 表す という 意味 で 、 興味深い 基準 で ある 。
値 の 大き さ 自体 が 意味 を 成さ ない こと は 、 例えば 、 「 この リスト の 1.5位 の ウェブサイト は どれ か 」 といった 質問 に は 真 の 答え が ない という こと から も 理解 できる だろ う 。
この よう な 質問 に は 、 その 数値 が 通常 の 値 （ 基数 ） で あれ ば 答える こと が できる はず だ から だ 。
その他 に も 、 順位 の 1 , 2 , 3 , 4 を A , B , C , D に 置き換え て も 情報 が 失わ れ ない という こと から も この 値 の 異質 さ が わかる 。

次 の PageViews 列 は この 課題 における 予測 し たい 出力 変数 で あり 、 その 年 に その ウェブサイト が 何回 閲覧 さ れ た か を 表し て いる 。
これ は Facebook の よう な 何度 も 訪れる 常連 ユーザ が いる サイト における 人気 度 を 測る 良い 方法 で ある 。

本章 を 読み 終え たら 、 ページビュー と ユニークユーザ 数 を 比較 し て どんな サイト が 常連 ユーザ が 多く 、 どんな サイト に 初めて 訪れる 人 が 多い の か を 調べ て みる の も 面白い だろ う 。

UniqueVisitors 列 は 測定 期間 の 1 ヶ月 間 、 その ウェブサイト に どれ だけ の 異なる ユーザ が 訪れ た か を 表し て いる 。
ページビュー は 人々 が ページ を 無意味 に 再 読み込み する こと でも 簡単 に 水増し できる と 考え られる ため 、 ユニークユーザ 数 の ほう が ウェブサイト の 影響力 を 測る 重要 な 指標 と なっ て いる 。

HasAdvertising 列 は その ウェブサイト が オンライン 広告 を 掲載 し て いる か どう か を 表し て いる 。
広告 は 煩わしい ので 、 他 の 条件 が 同じ なら 人々 は 広告 を 載せ て いる サイト を 避けよ う と する と 考え られる 。
この こと を 明示 的 に 確認 する ため に 、 線形回帰 を 用いる こと が できる 。
そもそも 線形回帰 の 良い ところ の 1つ は 、 他 の 条件 が 同じ 場合 に ある 特徴 量 が 予測 に どう 影響 する か を 調べ られる こと だ 。
ここ で 線形回帰 の 質 は 入力 変数 の 質 に 大きく 依存 する こと に 注意 しよ う 。
もし 重要 な 変数 が 入力 から 抜け落ち て い たら 、 線形回帰 の 結果 は 実際 と かけ離れ た 値 に なり うる 。
そのため 、 回帰 の 結果 は 常に 不確か で ある と 仮定 す べき で ある 。
もし 仮に 問題 に対して 適切 な 入力 を 与え られ たら 、 回答 は どの よう に なる か を いつも 念頭 に 置い て おこ う 。

IsEnglish 列 は ウェブサイト が 主 に 英語 で 書か れ て いる か どう か を 表し て いる 。
リスト を 眺め て みる と 、 ほとんど の 上位 の ウェブサイト は 主 に 英語 か 中国語 の サイト で ある という こと が わかる 。
この 列 を 選ん だ の は 、 英語 で 書か れ て いる こと が 肯定的 に 働く か 否定的 に 働く か を 調べる ため だ 。
また 回帰 において 因果関係 の 方向性 は 明確 で は ない という こと の 例 として も 興味深い ため で も ある 。
例えば 英語 で サイト を 作る こと で 人気 が 上がる の か 、 人気 の サイト ほど 結果 として インターネット上 の 共通語 として の 英語 に 対応 し て いる 傾向 が ある の か 、 それ は わから ない という こと だ 。
回帰 モデル によって わかる の は 2つ の 事柄 が 関連 し て いる という こと だけ で 、 ある 一方 が もう 片方 を 引き起こし て いる の か 、 もしくは その 逆 なのか は わから ない の で ある 。

これ まで に ウェブサイト の アクセス について の データ の うち 5つ の 列 について 説明 し 、 そのうち ページビュー を 出力 変数 として 使う こと を 決定 し た 。
続い て は 入力 変数 が どの よう に 出力 変数 に 関連 し て いる か を 調べる こと に しよ う 。
まずは ページビュー と ユニークユーザ 数 の 関連性 を 可視 化 する ため 、 散布図 を 描く こと から はじめよ う 。
定量 的 な 値 を 扱う とき は いつも 、 線形回帰 を 使っ て 関連付けよ う と する 前 に 、 散布図 によって 線形 性 の 仮定 を 満たす か どう か 確認 する こと を おすすめ する 。

図 5-6 に 示し た この ggplot 呼び出し による 散布図 は ひどい もの に なっ て しまっ た 。
ほとんど すべて の 値 が x 軸 上 で 固まっ て おり 、 わずか な 点 だけ が その 固まり から 離れ て いる 。
これは普通 の 分布 と は 異なる データ を 扱う とき に よく ある 問題 で 、 値 の 範囲 全体 を 表示 しよう として 十 分 大きな 縮尺 を 使っ て しまっ た ため に 、 ほとんど の データ ポイント を 互いに 近く に 配置 し て しまい 見た目 に 区別 でき なく し て しまう の で ある 。
この グラフ における データ の 問題 を 確認 する ため に 、 ページビュー 自体 の 分布 を 表示 する こと が できる 。

図 5-7 で 示し た この 密度 分布 は 、 先 ほど の 散布図 と 同じ よう に 全く 理解 不能 で ある 。
4 章 で 説明 し た よう に 、 この よう な 無意味 な 密度 分布 に 出会っ た とき は 、 解析 し たい 値 の 対数 を 取っ て その 密度 分布 を 確認 する の が 1つ の 方法 で ある 。
R の log 関数 を 単純 に 呼び出す こと で 、 これ を 行う こと が できる 。

図 5-8 に 示し た 対数 変換 し た 密度 プロット は 、 これ まで の もの と 比べ て 理 に 適っ て いる よう に 見える 。
そのため 、 これ 以降 に ページビュー と ユニークユーザ 数 を 扱う とき は 、 対数 変換 した値 を 使う こと に する 。
対数 変換 し た 尺度 で さき ほど の 散布図 を 再 生成 する こと は 簡単 に できる 。

ggplot 2 パッケージ に は 軸 を 対数 尺度 に 変換 する 便利 な 関数 が ある 。
この 場合 は scale_x_log または scale_y_log を 使う こと が できる 。
4 章 で 議論 し た よう に 、 場合 によって は 0 の 対数 を 取っ て しまう こと による エラー を 避ける ため に logp 関数 を 使う 必要 が ある こと を 思い出そ う 。
しかし 、 この 場合 は この 問題 が 起きる こと は ない 。

図 5-9 で 示し た 散布図 に は 回帰 によって 直線 による 近似 を 行える 可能 性 を 見て取る こと が できる 。
回帰 直線 を 生成 する ため に lm を 使う 前 に 、 ggplot2 の 引数 で geom_smooth と method =' lm ' を 使う こと によって この 回帰 直線 が どの よう に 見える か を 確認 し て おこ う 。

図 5-10 に 示し た 結果 の 直線 は うまく 行っ て いる よう に 見える 。
それでは 次に 進ん で lm によって 傾き と 切片 の 値 を 求めよ う 。

これ で 直線 を 求める こと が でき た ので 、 簡単 に 要約 し て みよ う 。
coef を 使っ て 係数 を 確認 し たり 、 residuals を 使っ て RMSE を 調べ たり する こと も できる が 、 ここ で は もっと 複雑 な 要約 を 生成 し て くれる 別 の 関数 を 紹介 し たい 。
これ を ステップ に 分けて 見 て いこ う 。
その 関数 は 、 都合 の いい こと に summary と 呼ば れ て いる 。

summary が 最初 に 示す の は 、 lm の 呼び出し を 行っ た とき の 設定 で ある 。
これ は コンソール で 作業 し て いる とき に は あまり 役に立た ない が 、 もっと 大きな スクリプト で lm を 複数回 呼び出し て いる よう な 場合 に 有用 で ある 。
その よう な 場合 は この 情報 によって 、 モデル について の 情報 を 保持 し 、 どの モデル が どの データ や 変数 から 作ら れ た の か を 追跡 する こと が できる 。

次に summary が 教え て くれる の は quantile ( residuals ( lm.fit )) という 呼び出し で 計算 する の と 同じ 残差 の 最小 値 、 第 1分 位 、 中央値 、 第 3分 位 、 最大 値 の 5つ の 値 で ある 。
筆者 個人 は 、 この よう な 数値 的 な 要約 より も 散布図 による 視覚 的 な 表示 を 好ん で 使っ て いる 。
人 によって は 残差 の 最小 や 最大 といった 対称性 を 好 む人 も いる が 、 散布図 による 可視化 は 数値 的 な 要約 より も 情報量 が 多い と 考え て いる 。

さらに summary は coef より も 詳細 な 回帰 直線 の 係数 について 教え て くれる 。
coef の 出力 は この 表 で は 「 Estimate 」 の 列 に 格納 さ れ て いる 。
その 後ろ に は 、 それぞれ の 係数 に対して 標準誤差 （ Std.Error ） 、 t 値 （ tvalue ） 、 そして p 値 （ p - value ） を 表す 列 が 表示 さ れ て いる 。
これら の 値 は 推定 値 の 不確かさ を 評価 する ため に 使わ れる 。
言い換える と 、 特定 の データセット から 計算 した値 が データ を 生成 し た 実 世界 の 正確 な 記述 で ある か どう か の 確信 の 度合い を 意味 し て いる 。
例えば 標準誤差 は 係数 の 95% 信頼区間 を 生成 する ため に 使わ れる 。
信頼区間 の 解釈 は やや 紛らわしく 、 しばしば 間違っ た 説明 が なさ れ て いる 。
信頼区間 は 、 「 95% の 確率 で 、 真 の 係数 が アルゴリズム によって 作ら れ た 区間 の 内側 に 収まる 」 と 言う こと の できる 境界 を 表し て いる 。
もし これ を 難しく 感じ た として も 、 それ は 当たり前 の こと だ 。
不確かさ の 解析 は 重要 で は ある が 、 この 本 で 取り扱う 題材 の うち 最も 難しい 問題 で も ある 。
もし この 題材 を 本当に 理解 し たい と 思う なら 、 「 AllofStatistics 」 ［ Wa 03 ］ や 「 DataAnalysis Using RegressionandMultilevel/HierarchicalModels 」 ［ GH 06 ］ など の 適切 な 統計 学 の 教科書 を 買っ て 実践 する こと を おすすめ する 。
ありがたい こと に 、 何 か を 予測 する モデル を 使っ て ハック する だけ なら 、 標準誤差 に 関連 する この 種 の 量的 な 差 を 必要 と する こと は 少ない 。

t 値 や p 値 （ summary の 出力 で は 「 Pr (>| t |)」 と 書か れる ） は 両方 とも 、 真 の 相関 が ゼロではない という 確信 の 度合い を 表し て いる 。
これら の 値 は 、 今 調べ て いる 入力 変数 と 出力 変数 の 間 に 実際 に 確信 を 持っ て 関係 が ある と 主張 する ため に 使わ れる 。
例えば 、 ここ で の t 値 は PageViews と UniqueVisitors が 実際 に 関係 し て いる という 確信 の 度合い を 評価 する ため に 使う こと が できる 。
心 に 留め て おき たい の は 、 これら の 2つ の 値 は 扱い を 心得 て いれ ば 有用 だ が 、 その 使い方 は 統計学 を よく 理解 し て い ない 人々 にとって は 難し すぎる という こと だ 。
2つ の 変数 が 関連 し て いる と 確信 できる か どう か を 知り たけれ ば 、 予測 値 が 少なくとも 標準誤差 2つ 分 、 ゼロ から 離れ て いる か どう か を 確認 する 必要 が ある 。
例えば 、 log ( UniqueVisitors ) の 係数 は 1.33628 で 標準誤差 は 0.04568 で ある 。
つまり この 係数 は 、 標準誤差 の 1.33628 / 0.04568 == 29.25306 倍 だけ ゼロ から 離れ て いる こと に なる 。
もし 標準誤差 が ゼロ から 3 以上 離れ て いれ ば 、 2つ の 変数 が 関連 し て いる と 確信 する の は 理 に かなっ て いる 。

t 値 や p 値 を 使う と 、 データ 中 の 2つ の 列 の 関係性 が 実際 に ある の か 、 それとも ただ の 偶然 による もの か を 判断 する 助け に なる 。
関係性 が ある か どう か を 知る の は 重要 だ が 、 関係性 を 理解 する こと と は 全く 異なる 問題 で ある 。
人々 が 無理 に そう しよう と する の と は 対照的 に 、 線形回帰 や 一般 の 回帰 で は 関係性 の 理解 の 助け に は なら ない 。
結局 の ところ 、 2つ の 事柄 が 関係 し て いる か を 理解 し たけれ ば 、 ただ の 線形回帰 が 提供 できる 以上 の 情報 を 必要 と する 。

ある 入力 変数 が 出力 変数 に 関係 し て いる か どう か を 決める ため の 昔 から 使わ れ て いる しきい値 として 標準誤差 の 2倍 以上 も ゼロ から 離れ て いる 係数 を 探す という もの が ある 。

次に summary が 吐き出す 情報 は 、 係数 の ため の 統計的 有意 性 で ある 。
ここ に は t 値 が どれ だけ 大きい の か 、 または p 値 が どれ だけ 小さい の か を 意味 する アスタリスク が 表示 さ れ て いる 。
特に アスタリスク は p 値 が 定数 より も 小さく なる よう な しきい値 の 系列 を 表し て おり 、 それぞれ p 値 が 0.1 、 0.05 、 0.01 、 0.001 以下 の 場合 に 対応 し て いる 。
これら の 値 は 学術的 に は よく 使わ れ て いる が 、 実際 に は 統計 解析 が コンピュータ で は なく 人手 で 行わ れ て い た 時代 の 名残 という 側面 が 強く 、 利用者 の 立場 で 深く 気 に する 必要 は ない 。
これら の 数字 に は 、 推定 が 0 から 標準誤差 の 何 倍 離れ て いる か という こと から わかる 以上 の こと は 何 の 意味 も 含ま れ て い ない 。
これ まで の 計算 において 、 log ( UniqueVisitors ) の t 値 は 、 log ( UniqueVisitors ) の 係数 が 0 から 標準誤差 の 何 倍 離れ て いる か という 数 と 同じ で あっ た こと に 気付い た かも しれ ない 。
一般的 に t 値 と 標準誤差 の 何 倍 0 から 離れ て いる か は 関係 し て いる ため 、 p 値 について は 気 に し ない こと を 推奨 し て いる 。

最後 に 得 られる 情報 は 、 データ に 当てはめ た 線形 モデル の 予測 力 に 関係 し て いる 。
まず 、 「 Residual standard error 」 は 単に RMSE を 表し て おり 、 「 sqrt ( mean ( residuals ( lm.fit )^ 2 ))」 と 入力 する こと で 計算 できる 。
「 degrees of freedom 」 （ 自由度 ） は 係数 を 求める ため に 余分 に 使用 し た データ 数 を 表し て おり 、 データ 数 − 係数 の 数 で 求め られる 。
少ない データ に対して 多く の 係数 を 用い て しまう と 、 6 章 で 議論 する 過学習 の 問題 を 引き起こす 。

次に 「 MultipleR - squared 」 の 項目 が ある 。
これ は 先ほど 説明 し た R2 と 同じ もの で 、 モデル によって データ の 分散 が どの 程度 説明 できる か という 割合 を 表し て いる 。
ここ で は 46% の 分散 を モデル によって 説明 でき て おり 、 かなり 良い 値 と みなす こと が できる 。
「 AdjustedR - squared 」 と は 「 Multiple R-squared 」 に 係数 の 数 による ペナルティ を 加え た 第 2 の 基準 で ある 。
筆者 ら の 現場 で は 、 この 値 は やや その 場 しのぎ の 基準 で ある ため に 無視 する 傾向 が ある が 、 これ を 好ん で 使う 人々 も 少なく ない 。

最後 に 「 F-statistic 」 （ F 統計量 ） という 情報 を 見る こと が できる 。
これ は 予測 に 平均 を 使っ た 場合 と 比べ た モデル による 改良 の 度合い を 測る 基準 で あり 、 p 値 を 取り入れ た R2 の 代替 として 使う こと が できる 。
筆者 ら は p 値 を あまり 信憑 性 の ない もの として 扱っ て いる ため 、 F 統計量 について も あまり 依存 し ない よう すすめ て いる 。
p 値 は 計算 方法 を 完全 に 理解 し て 使う の なら 有用 だ が 、 そう で なけれ ば 、 モデル の 評価基準 として 正統 な の は 未知 の データ に対する 予測 力 で あり 、 訓練 データ に対する 性能 で は ない という こと を 忘れ させる 可能性 が 高い 。
6 章 で は 、 モデル によって 新しい データ を 予測 する 能力 の 評価 方法 について 議論 する 。

summary から の 出力 により いろいろ な こと が わかる が 、 ここ で ページビュー を 予測 する ため に ユニークユーザ 数 以外 の 情報 も 使える よう に しよう 。
さらに HasAdvertising と IsEnglish を 加える こと によって モデル に 多く の 入力 を 与え た 時 に 何 が 起こる か を 調べ て みよ う 。

先 ほど と 同様 に 、 summary は lm の 呼び出し 方 を 表示 し て 残差 を 出力 する 。
異なる の は 複雑 に なっ た 回帰 モデル の すべて の 変数 に対する 係数 が 含ま れ て いる こと だ 。
切片 は 同じ よう に 「 （ Intercept ） 」 として 出力 さ れ て いる 。
次 の 行 は 今回 の モデル に 含め た 新しい ファクター を 示し て いる ため 、 これ まで の もの と は 意味合い が 全く 異なる 。
回帰 分析 で ファクター を 使う とき 、 モデル は 切片 の 一部 として 取り扱う か モデル に 明示 的 に 取り込む か 決定 し なけれ ば なら ない 。
ここ で は HasAdvertising が 「 Yes 」 の サイト は 切片 と は 切り離さ れ て おり 、 「 No 」 の サイト は 切片 に 織り込ま れ て いる こと が わかる 。
言い換える と 、 この 切片 は 広告 なし で 、 かつ log ( UniqueVisitors ) が ゼロ （ つまり ユニークユーザ 数 が 1 ） の ウェブサイト の 予測 を 表し て いる 。

InEnglish に対して も 同じ こと が 言える が 、 この ファクター は NA 値 を 数多く 持つ ため 、 実際 に は NA 、 No 、 Yes の 3種類 の 値 を 取る こと に なる 。
この 場合 に R は NA を デフォルト の 切片 として 回帰 モデル を 構築 し 、 No と Yes に対して は 別々 の 係数 を 当てはめる よう に なっ て いる 。

これ で 回帰 モデル の 入力 として ファクター を 使う 方法 を 考える こと が でき た ので 、 別々 に 扱っ た 3つ の 入力 を 比較 し て 、 どの 変数 が 最も 予測 力 が 高い か 調べ て みよ う 。
これ を 行う に は それぞれ の 要約 から 別々 に R2 の 値 を 取り出す こと が できる 。

これ を 見 て わかる よう に 、 HasAdvertising は 分散 の 1% だけ を 、 UniqueVisitors は 46% を 、 InEnglish は 3% を 説明 できる 。
実際 に は 、 簡単 に 集め られる 情報 なら すべて 入力 として 予測 モデル に 含める 価値 は ある が 、 もし HasAdvertising の よう に その 情報 を 自動的 に 集める こと が 難しけれ ば 、 モデル から 外し て 他 の 予測 力 の 大きい 入力 に 注力 する の も 1つ の 手段 で ある 。

ここ まで に 線形回帰 の 紹介 を 行っ て き た が 、 やや 横道 に それ 、 「 相関 」 という 言葉 について もっと 詳しく 議論 し て みよ う 。
厳密 な 意味 で は 、 2つ の 変数 は それら の 関係性 を 直線 で 記述 できる とき に 相関 を 持つ と 呼ぶ 。
言い換える と 、 相関 と は 線形回帰 を 使っ て どれ だけ うまく それら 2つ の 変数 の 関係性 を モデル 化 できる か という 指標 で ある 。
相関係数 が 0 で ある という こと は 、 2つ の 変数 について 意味 の ある 直線 を 引く こと が 完全 に 不可能 で ある という 意味 で ある 。
相関係数 が 1 で ある という こと は 、 2つ の 変数 の 間 に 右 上がり の 直線 で 完全 に 表せる 関係 が ある という 意味 で ある 。
逆 に 相関係数 が −1 で ある という こと は 、 右 下がり の 直線 で 2つ の 変数 の 関係 を 表せる こと を 示し て いる 。

これら を 正確 に 理解 する ため に 、 簡単 な 例 を 取り上げる 。
まずは 完全 に 線形 で は ない データ を 生成 し 、 グラフ 上 に 表示 し て みよ う 。

図 5-11 に サンプル データ を 示す 。
見 て の 通り 、 geom_smooth 関数 による 直線 は すべて の データ ポイント を 正確 に 通る わけ で は ない ため 、 x と y の 関係性 は 完全 な 線形 に は なら ない 。
しかし それ なら ば どれ だけ 線形 に 近い と 言える だろ う か 。
それ に 答える に は 、 R で cor 関数 を 用い て 相関係数 を 計算 すれ ば いい 。

これ により 、 x と y が 直線 に かなり 近い 関係性 を 持っ て いる という こと が わかる 。
cor 関数 は その 関係 性 が どれ だけ 強い か という 推測 を 与え て くれる 。
この 場合 、 相関係数 は 0.97 で あり ほとんど 1 に 近い 。

cor を 使う の で は なく 、 自分 で 相関係数 を 計算 し たかっ たら どう すれ ば できる だろ う か 、 lm を 使っ て 同じ こと を できる が 、 その 場合 は 先 に x と y の 両方 の 縮尺 を 揃える ため 、 正規化 を 行っ て おく 必要 が ある 。
正規化 は 両方 の 変数 から 平均 を 差し引い て 、 標準偏差 で 割る こと によって 得 られる 。
R で は scale 関数 を 使っ て 簡単 に 正規化 を 行う こと が できる 。

見 て の 通り 、 この 場合 は x と y の 間 の 相関係数 は 両方 を 標準化 後 に 線形回帰 を 使っ た 場合 の 係数 と 正確 に 一致 する 。
これ は 相関係数 について 一般的 に 言える 性質 な ので 、 線形回帰 を 使う とき は いつも 2つ の 変数 に 相関 が ある という こと の 意味 を 念頭 に 置い て おく と 良い 。

相関係数 は 単に 2つ の 変数 の 関係性 が どれ だけ 線形 に 近い か を 測る 基準 で ある ので 、 因果関係 に関して は 何 も 教え て くれ ない 。
これ は 「 相関関係 は 因果関係 で は ない 」 という 原則 に 言い表さ れ て いる 。
もちろん 2つ の 変数 の 片方 を 用い て もう 片方 を 予測 し たい とき に は 、 それら が 相関 を 持つ か どう か を 知る こと は 非常 に 重要 で ある 。

これ で 線形回帰 と 相関 の 概念 について の 入門編 を 終える こと に する 。
次 の 章 で は 、 どう やっ て より 洗練 さ れ た 回帰 モデル を 使っ て データ 中 の 非線形 の パターン を 認識 し たり 、 同時に 過学習 を 防い だり する か について も 見 て いく こと に しよ う 。

5 章 において 線形回帰 における 2つ の 変数 間 の 関係 は 直線 で ある という こと を 述べ た 一方 で 、 これ は 真実 で ある が 、 実際 に は 線形回帰 を 使っ て 直線 で は うまく 表さ れ ない よう な 関係 を 捉える こと も 可能 で ある 。
この 意味 する ところ を 示す ため 、 図 6-1 （ A ） に 示し た データ について 考え て みよ う 。

この 分散 図 を 見る と 、 X と Y と の 間 の 関係 を 直線 で は うまく 表す こと が でき ない の は 明らか だ 。
実際 、 回帰 直線 を プロット し て みる と 、 直線 を この データ において 使う こと の 何 が 問題 な の か が わかる 。
図 6-1 （ B ） が 結果 を 示し て いる 。

直線 を 使っ て しまう と 一定 の エラー が 発生 する こと が 見て取れる 。
x の 値 が 小さい 場合 と 大きい 場合 に は y の 予測 値 が 大きく なり すぎ 、 x の 値 が 中 程度 の 場合 に は y の 予測 値 が 小さく なっ て しまう 。
これ は 残差 プロット （ 図 6-1 （ C ） ） を 見る の が 一番 簡単 で あろ う 。
デフォルト の 線形回帰 モデル で は 、 構造 を 全く 捉える こと が でき て い ない ため 、 この プロット で は元 の データ の 構造 全体 が 観察 でき て しまう の で ある 。

ggplot 2 の geom_smooth 関数 を 引数 なし で 使う と 、 一般 化 加法 モデル （ GeneralizedAdditiveModel ： GAM ） と 呼ば れる より 複雑 な 統計 モデル を 当てはめ 、 データ における 構造 の 非線形 かつ なめらか な 表現 を 得る こと が できる 。

この 結果 を 図 6-1 （ D ） に 示し た 。
これ を 見る と 、 この データセット に関して は 直線 より も 曲線 を 当てはめ たく なる こと が わかる 。

それでは この データ に 当てはめる 曲線 を どう やっ て 決定 すれ ば 良い だろ う か 。
ここ が 線形回帰 の 絶妙 な 点 な の だ 。
線形回帰 は 直線 を 入力 に 当てはめる こと しか でき ない が 、 元 の 入力 に対する 非線形 関数 で 表さ れる 新た な 入力 を 作り出す こと も 可能 な の で ある 。
例えば 、 R の 以下 の コード を 使い 、 生 の 入力 x の 2 乗 で ある 新しい 入力 を 作り出す こと が できる 。

その後 y を 新しい 入力 x.squared に対して プロット する と 、 同じ データ から 全く 異なっ た 形 が 浮かび上がる 。

図 6-2 に 示し た よう に 、 y を この 新しい 入力 として x.squared に対して プロット する と 、 まさに 直線 が 当てはまる こと が わかる 。
これ は つまり 、 2つ の 入力 が 適切 に 線形回帰 の 線形 仮説 を 満たす よう に 、 元 の 非線形 問題 を 新しい 問題 に 変形 し た の で ある 。
入力 の 変換 を 用い て 、 複雑 な 非線形 問題 を より 単純 な 線形 問題 に 置き換える という この 考え方 は 、 機械学習 において 繰り返し 登場 する 。
ちなみに この 考え方 は 12 章 において 議論 する カーネルトリック の 根幹 を 成し て いる 。
この 単純 な 2 乗 変換 が どの ぐらい 予測 の 質 を 向上 さ せ て いる か を 見る ため に 、 x を 使っ た 場合 と x.squared を 使っ た 場合 の 線形回帰 の R2 値 を 比較 し て みよ う 。

変動 の 0% しか 説明 でき て い なかっ た 状態 から 、 97% を 説明 できる よう に なっ た 。
これ は 、 モデル に 単純 な 変更 しか 加え て いない に し て は 、 非常 に 大きな 進歩 だ と いえる 。
しかし 直線 より も 複雑 な 形 を 持つ より 表現力 の 高い モデル を 使っ た から と いっ て 、 どの ぐらい の 予測 力 を 実現 する こと が できる か 疑問 に 思う の が 普通 だろ う 。
数学 的 な 理由 について は この 本 の 対象外 で ある が 、 これ によって 本質的 に は 2つ の 変数 間 に 存在 する どの よう な 種類 の 関係 で あっ て も 捉え られる という こと が わかっ て いる 。
より 複雑 な 形 を 構築 する アプローチ は 多項式 回帰 と 呼ば れ 、 本章 の 次 の 部分 で 取り扱う 。
当てはめ た モデル が 、 発見 しよ う と し て いる 内在 的 な 真 の パターン だけ で なく 、 データ の ノイズ まで も そのまま 模倣 し て しまう 可能性 が ある ため 、 多項式 回帰 の 柔軟性 は ただ 単に 良い もの で ある という こと が でき ない 。
本章 で は これから 、 線形回帰 など の シンプル な 手法 の 代わり に 多項式 回帰 など の より 複雑 な 手法 を 使う 時 に 、 併せ て 注意 し なけれ ば なら ない 作法 に 焦点 を 当て て いく 。

では その 注意 点 を 心 に 留め つつ 、 R で poly 関数 として 実装 さ れ て いる 多項式 回帰 を 扱っ て みる こと に しよ う 。
poly が どの よう に 動作 する か を 知る 最も 簡単 な 方法 は 、 簡単 な 例 から 始め 、 データ の 構造 を 模倣 できる よう に モデル により 多く の 表現力 を 与え た 時 に 何 が 起こる か を 見る こと で ある 。

ここ で は 、 x と y と の 関係 として 、 単純 な 直線 で は 絶対 に 記述 でき ない 正弦波 を 用いる 。

図 6-3 に 示し た この データ を 見る だけ で 、 単純 な 線形回帰 モデル を 使っ た の で は うまく いか ない こと は すぐ に わかる はず だ 。
しかし まず は 、 単純 な 線形 モデル を 走ら せ て 、 どの ぐらい うまく 行く か を 見 て おこ う 。

単純 な 線形回帰 モデル が 波形 データ に対して 不適切 な モデル で ある こと が はっきり し て いる に も かかわら ず 、 驚く べき こと に 線形 モデル を 用いる と この データセット の 60% の 変動 を 説明 できる 。
良い モデル を 使え ば この データセット の 変動 の 90% 以上 を 説明 できる こと も わかっ て いる 。
しかし それでも 、 線形 モデル が この よう に データ に うまく 当てはまっ た の は なぜ か という こと は 理解 し て おい た ほう が いい だろ う 。
この 疑問 を 解決 する に は method =' lm ' オプション を 設定 し 、 線形 モデル を 使う よう に 強制 し た geom_smooth の 変種 を 使い 、 線形回帰 を 当てはめ た 結果 を プロット し て みる と 良い 。

図 6-4 を 見る と 、 線形 モデル が 正弦波 の 構造 の 半分 を 捉える 右 下がり の 直線 を 見つけ た こと が わかる 。
しかし これ で は 、 データ の うち の 右 下がり 直線 に 当てはまら ない 部分 は 捨て て しまっ て いる わけ な ので 、 あまり 良い 方法 だ と は 言え ない 。
さらに 正弦波 を もう 1周 期 分 伸ばし た 場合 、 この モデル の R2 値 は いきなり 0% 近く へ 落ち込ん で しまう こと は 目 に 見え て いる 。

この こと から 、 デフォルト の 線形回帰 モデル は この データセット 特有 の 「 クセ 」 に 過 学習 し て しまい 、 本来 内在 し て いる 波形 構造 を 見つけ出す こと が でき ない と 結論づける こと が できる 。

まず 最初 に 試す 方法 は 、 本章 の 冒頭 で 用い た 理論 に 基づい て 、 データセット に 新た な 素性 を 追加 する こと で ある 。
今回 は x の 2 乗 と 3 乗 の 両方 を 追加 し 、 さらに 少し 遊び の 部分 を 加え て いる 。
以下 に 示す よう に 、 この 変更 によって 予測 能力 は 大幅 に 改善 する 。

2つ の 入力 を 追加 する こと により 、 R2 値 が 60% の から 97% へ 達し た 。
これ は 劇的 な 向上 と いえる だろ う 。
そして 原理 的 に は 、 この 考え方 に 基づい て X の べき乗 の 入力 を データセット に どんどん 追加 し て いけ ば さらなる 向上 が 見込める はず だ 。
しかし べき乗 の 入力 を 追加 する に したがっ て 、 結果的 に は データ ポイント より も 入力 の 方 が 多く なっ て しまう 。
これ で は 、 理論 的 に は データ と 入力 が 完全 に 同じ もの に なっ て しまう ため 、 厄介 な 問題 と なり うる 。
しかし 、 それ より 前 に この 戦略 の 微妙 な 問題 が 出現 し て しまう 。
データ に 追加 する 新しい 列 と すでに ある 列 の 値 が 非常 に 似 て くる ため 、 lm が 全く 動か なく なっ て しまう の だ 。
以下 に 示し た summary の 出力 の 中 で この 問題 は 「 特異性 （ singularity ） 」 として 表示 さ れ て いる 。

ここ で の 問題 は 、 追加 し て いっ た より 大きな X の べき乗 入力 と 、 すでに ある 行 と の 相関 が 高 すぎる ため 、 線形回帰 の アルゴリズム が 正常 に 動か なく なり 、 すべて の 列 に対して 別々 に 係数 を 見つける こと が でき なく なる という もの で ある 。
ありがたい こと に 、 これ まで の 数学 の 研究 から この 問題 に対する 解法 を 見つける こと が できる 。
それ は 、 単純 な x の べき乗 を 盲目的 に 追加 する の で は なく 、 x の 連続 し た べき乗 の よう に 振る舞う が 、 x と x ^ 2 の 間 の よう に ぞ れ ぞ れ の 間 に 相関 が ない よう に し た 、 より 複雑 な x の 変種 を 追加 し て いく という 方法 で ある 。
これら x の べき乗 の 変種 は 直交 多項式 † と 呼ば れ 、 R の poly 関数 を 用い て 簡単 に 生成 できる 。
x の べき乗 を 14 個 データ フレーム に 追加 する 代わり に 、 単に poly ( X , degree = 14 ) と 入力 すれ ば 、 x を X+ X ^ 2 + X ^ 3 +...+ X ^ 14 に 似 て はいる が 、 lm を 実行 する 際 に 特異性 が 出 ない よう な 直交 し た 列 に 変換 できる 。

poly の 内部 処理 は ここ で は 見え ない が 、 それ が きちんと 動作 し て いる の か を 確認 する に は 、 poly の 出力 を 使っ て lm を 動かせ ば 良い 。
実際 、 14 個 の X の べき乗 すべて に対して きちんと し た 係数 を 返す こと が 見て取れる 。

通常 は poly によって 多く の 表現力 を 得る こと が できる 。
数学 者 によって 、 多項式 回帰 が 非常 に 様々 な 複雑 な 形 を 捉える こと が できる こと が 示さ れ て いる からだ 。

ただし これ も 必ずしも 良い こと と は 限ら ない 。
以下 の 例 で は 、 1 , 3 , 5 , 25 の 次数 を 与え た poly を 使っ て モデル を 生成 し た 。
図 6-5 は その 結果 で ある 。

この 過程 は 際限 なく 続ける こと が できる が 、 予測 値 を 見る と 当てはめ て いる 形 は 明らか に もはや 波形 に は 似 て おら ず 、 でこぼこ に 歪み 始め て しまう 。
問題 は 、 使っ て いる モデル が 、 データ によって 裏付け られる より も 強力 な こと で ある 。
1 や 3 や 5 といった 小さい 次数 で は 問題 ない が 、 次数 25 あたり で うまく いか なく なる 。
ここ で 起き て いる の は 過学習 と 呼ば れる 問題 で ある 。
データ の 観察 数 が 増える に従い 、 より 強力 な モデル を 使い たい と 思う の は 当然 だ 。
しかし どの よう な データセット で も 、 それ に対して 強力 すぎる モデル という の が 常に 存在 する 。
これ を 防止 する に は どう すれ ば 良い だろ う か 。
そして どう すれ ば 、 自分自身 の 首 を 絞め そう な 時 に 、 どの よう な 問題 が 起こり そう か を 察知 する こと が できる だろ う か 。
ここ で 我々 が 提案 する の は 、 機械学習 ツール キット 全体 において 最も 重要 な 2つ の 概念 で ある 交差 検定 と 正則化 を 一緒 に 使う こと で ある 。

過学習 の 防ぎ 方 を 見 て いく 前 に 、 この 用語 を 厳密 に 定義 し て おこ う 。
モデル が 、 内在 する 真 の パターン で は なく 、 データセット の ノイズ の 一部 に 当てはまっ て しまう とき 、 モデル が 過 学習 し て いる という 話 を し た 。
しかし 真実 が わから ない とき に 、 どう やっ て 本当 の 解 に 近づい て いる か 、 それとも 遠ざかっ て いる の か を 見分けれ ば 良い だろ う か 。

コツ は この 「 真実 」 が 何 を 指す か を 明確 に する こと で ある 。
ここ で の 目的 に対して は 、 ある 予測 モデル の 将来 に関する 予測 が 正確 で ある とき に 、 その モデル は 「 真実 」 に 近い 、 と しよ う 。
しかし もちろん 、 未来 の データ を 入手 する こと は でき ない 。
過去 の データ が ある のみ で ある 。
ところが 幸い な こと に 、 未来 の データ を 入手 でき た と し たら どう なる か という こと は 、 過去 の データ を 2つ に 分割 する こと で シミュレート できる 。

簡単 な 例 を 使っ て 、 この 手法 を わかり やすく 説明 し て みよ う 。
例えば 未来 の 気温 を 予測 する モデル を 構築 し て いる と しよ う 。
1月 から 6月 の データ は すでに 用意 さ れ て い て 、 そこ から 7月 の 気温 を 予測 し たい と する 。
この 場合 に は 、 1月 から 5月 まで の データ に よく 当てはまる の は どの よう な モデル か を 調べ 、 それ を 6月 の データ に対して テスト する こと が できる 。
この 「 モデル に 当てはめる 」 という 段階 を もし 5月 に 行っ て い た と すれ ば 、 モデル を 本当に 未来 の データ に対して テスト し て いる という こと に なる 。
よって この データ の 分割 方法 は 、 未知 の データ に対して 、 モデル の 現実 的 な シミュレーション 実験 を 行う の に 使う こと が できる 。

つまり この 交差 検定 は モデル 当てはめ を 過去 の データ の 一部 を 使わ ず に 行う こと で 、 モデル を 未来 の データ に対して シミュレーション する こと が できる 、 という こと を 指し て いる 。

3 章 および 4 章 の 演習 を すでに 読ん で いれ ば 、 その 時 に これ と 全く 同じ こと を し た の を 覚え て いる はず だ 。
どちら の 場合 も データ を 分割 し て 、 分類 と 順位 付け の モデル を 訓練 と テスト の ため に 用い て い た 。

これ は 子供 の 時 に 教わっ た 科学的方法 の 実践 で ある 。
つまり （ 1 ） 仮説 を 立て 、 （ 2 ） データ を 集め 、 （ 3 ） それ を 検証 し て いる 。
実際 に は 、 既存 の データ に 基づい て 仮説 を 立て 、 それから より たくさん の データ を 集め に 行く わけ で は ない ため 、 少し だけ ごまかし が 必要 と なっ て しまう 。
仮説 を 立て て いる 時 に データ の 一部 を 使わ ず に とっ て おい て 、 予測 を テスト する 時 に なっ て その データ を 魔法 で 取り出し た か の ごとく 利用 する の で ある 。

交差 検定 を 複雑 な 応用 問題 で 使う 前 に 、 以前 用い た 正弦波 データ に対して 、 交差 検定 を 使っ て 多項式 回帰 の 次数 を どの よう に 選択 する か 、 という 簡単 な 例 を 考え て みよ う 。

まずは 正弦波 データ を 再 作成 する 。

その後 データ を 、 モデル を 当てはめる の に 使う 訓練 セット と 、 モデル の 性能 を テスト する の に 使う テスト セット の 2つ の 部分 に 分割 する 。
訓練 セット は 過去 の データ 、 テスト セット は 未来 の データ と 考える 。
今回 は データ を ぴったり 半分 に 分ける 。
より 複雑 な 問題 の 場合 は 、 モデル の 当てはめ に たくさん データ が あれ ば ある ほど 、 その モデル は 良く なる 傾向 が ある ため 、 訓練 セット に 例えば 80% といった 多く の データ を 使い 、 テスト セット 使う データ を 20% など に 少なく し た 方 が 良い 場合 も ある 。
やり方 という の は 1つ で は ない の が 常 で あり 、 実 世界 の 問題 に 立ち向かう 場合 は 、 とにかく 実験 する こと が 大切 で ある 。
まずは データ を 分割 し 、 詳細 について は 後ほど 述べる こと に しよ う 。

ここ で は ランダム な 添字 を 含ん だ ベクトル を 作り 、 その 値 から 訓練 セット を 生成 する 。
訓練 データ と テスト セット に データ を 分割 する 際 に は 、 ランダム に 分割 する の が 常に 良い と さ れる が 、 これ は 訓練 セット と テスト セット の 差異 が 規則 的 に なっ て しまう こと を 避ける ため だ 。
ランダム な 分割 を 行わ なかっ た 場合 、 x の 小さい ほう の 値 だけ を 訓練 セット に 、 大きい ほう の 値 だけ を テスト セット に 入れ て しまう といった こと が 起こり うる の で ある 。
この ランダム 性 は 、 与え られ た ベクトル から ランダム な サンプル を 生成 する R の sample 関数 を 使う こと によって 実現 できる 。
今回 の 場合 、 1 から n まで の 整数 の ベクトル を 作り 、 その 半分 を サンプル する 。
添字 の 値 を 決定 し た 後 は 、 R の ベクトル の 添字 ルール を 使い 、 訓練 セット と テスト セット を 分離 する 。
最後 に 、 データ フレーム を 使う と lm を 扱い やすい ため 、 データ フレーム を 構築 し て データ を 保存 する 。

データ を 訓練 セット と テスト セット に 分離 し た 後 は 、 多項式 回帰 で 様々 な 次数 を 試し 、 どの 次数 が 最も うまく 行く か を 見る こと に なる 。
ここ で は RMSE を 使っ て 性能 を 測定 する 。
コード を 少し 見やすく する ため に rmse という 関数 を 作っ て みよ う 。

次に 、 1 から 12 まで の 整数 から なる 多項 次数 の 集合 に対して これ を 繰り返し 処理 する 。

繰り返し の 各 ステップ において 、 次数 d の 多項式 回帰 を train ing.df に ある データ に 当てはめ 、 続い て 、 train ing.df と test.df に対して その 性能 を 測定 する 。
繰り返し が 終わっ た 後 に すぐ に 結果 を 解析 できる よう に 、 結果 は データ フレーム に 格納 する 。

ここ で は 、 前 に 行っ た の と は 少し 異なっ た 方法 で データ フレーム を 作成 する 。
空 の データ フレーム を 変数 performance に 格納 する こと から 始め 、 これ に rbind 関数 を 用い て 繰り返し 行 を 追加 し て いく 。
すで に 述べ た よう に 、 R で は データ を 操作 する 同じ よう な タスク に対して 、 複数 の 操作 方法 が 存在 する こと が 多い が 、 この 種 の ループ が 最も 効率 的 な 方法 で ある こと は あまり ない 。
に も かかわら ず ここ で この 方法 を 用い た 理由 は 、 データ が 小さく 、 アルゴリズム の 過程 の 理解 が より 明確 に なる から で ある 。
実際 に 自身 の 交差 検定 テスト を 書く 際 に は 、 この 方法 が 効率 的 で ない こと を 心 に 留め て おく こと 。

繰り返し の 実行 が 終わっ たら 、 多項式 回帰 モデル の 結果 を すべて の 次数 に対して プロット し て みよ う 。

図 6-6 に 示し た 結果 から 、 実験 に 使っ た 次数 の うち で は 、 中 程度 の もの が テストデータ において 最も 良い 性能 を 達成 し て いる こと が はっきり と わかる 。
次数 が 1 や 2 と 低い 場合 、 モデル は データ における 真 の パターン を 捉える こと が でき ず 、 訓練 ・ テストデータ の 両方 において 予測 性能 が 非常 に 低く なっ て しまっ て いる こと も わかる 。
この よう に モデル の 複雑 さ が 足ら ず 、 訓練 データ に 当てはめる こと すら でき ない こと を 未 学習 と 呼ぶ 。

グラフ の 反対 側 、 次数 が 11 や 12 の 場合 、 モデル に対する 予測 が テストデータ において 悪化 し 始め て いる こと が わかる 。
これ は 、 モデル が あまりに 複雑 かつ ノイズ が 多い ため 、 テストデータ に 存在 しない 訓練 データ の クセ を 拾っ て しまっ て いる 。
モデル が データ 内 の 偶然 による クセ に 当てはまり 始め て しまう こと を 過学習 と 呼ぶ 。
過学習 の 他 の 考え方 として 、 訓練 セット と テスト セット における 性能 が 、 図 6-6 の 右側 に 行く に したがっ て 離れ 始め て いる の に 気付く だろ う 。
訓練 セット の 誤り 率 が 下がり 続け て いる の に対して 、 テスト セット の 性能 は 上がり 始める 。
この モデル は それ が 訓練 さ れ た 特定 の 点 を 超え て データ に 一般 化 する こと は でき ず 、 この こと が 過学習 を 引き起こし て いる 。

幸い に も ここ で は この プロット によって 、 モデル から 最良 の 性能 を 引き出す に は どの よう な 次数 を セット し たら 良い か という こと が わかる 。
未 学習 で も 過学習 で も ない 中間 の 点 は 、 交差 検定 を 使わ なけれ ば 発見 する の は 非常 に 難しい 。

ここ まで 交差 検定 を 使っ て 過学習 に どの よう に 対処 する か について 簡単 に 説明 し て き た ため 、 ここ から は 正則化 と 呼ば れる 、 過学習 を 防ぐ もう 1つ の アプローチ に 議論 を 移す こと に する 。
正則化 は その 考え方 において は 交差 検定 と は 異なっ て いる が 、 結局 の ところ 正則化 が 過学習 を 防ぐ こと が できる という こと は 、 交差 検定 を 使っ て 示す こと に なる 。
さらに 正則化 アルゴリズム の 調整 は 交差 検定 を 使っ て 行う ため 、 つまるところ この 2つ の 考え方 は 、 深く 結び付く こと に なる 。

本章 で は これ まで 、 複雑 すぎる モデル について 述べ て き た が 、 「 複雑 さ 」 という もの に対して 正式 な 定義 を し て い なかっ た 。
多項式 回帰 を 扱う とき の アプローチ で は 、 次数 が 大きい とき モデル は より 複雑 で ある と いえる 。
例えば 次数 2 の 多項式 は 次数 1 の 多項式 より も 複雑 で ある 。

しかし これ は 、 線形回帰 一般 に対して 当てはめる こと が でき ない 。
そこで 、 複雑 さ という もの に対する 他 の 指標 を 使う こと に しよ う 。
それ は 係数 が 大きい とき 、 その モデル は 複雑 で ある という もの で ある 。
例えば 、 y ~ 5 * x+ 2 という モデル は 、 y ~ 3 * x+ 2 という モデル より も 複雑 で ある 、 という わけ だ 。
同じ 定義 で 言う なら 、 y ~ 1 * x ^ 2+1 * x+ 1 という モデル は y ~ 1 * x+ 1 という モデル より も 複雑 で ある 。
この 定義 を 実践 において 使う ため に は 、 lm を 使っ て モデル を 当てはめ 、 coef によって 返さ れ た値 を 合計 する こと により その 複雑 さ を 測定 すれ ば 良い 。

ここ で は 合計 する 前 に 係数 を 2 乗 し 、 合計 し た 際 に 係数 が 相殺 さ れ ない よう に し た 。
この 2 乗 の ステップ は 、 L 2 ノルム と 呼ば れる 。
係数 を 2 乗 する の で は なく 、 代わり に 係数 の 絶対値 を 取る 方法 も 存在 する 。
こちら の 方法 は L1 ノルム と 呼ば れる 。
R において は 以下 の よう に この 2つ を 計算 する こと が できる 。

最初 、 この モデル の 複雑 さ の 指標 は 奇妙 に 見える かも しれ ない 。
しかし これ が 過学習 を 防ぐ ため に 有効 で ある こと は すぐ に わかる で あろ う 。
その 理由 は 、 モデル の 当てはめ の 際 に モデル が 単純 に なる よう に 強制 する よう 、 この 複雑 さ の 指標 を 使う から だ 。
これ が どの よう に し て 起こる か の 詳細 について は 7 章 で 述べる が 、 とりあえず の 大まか な 考え方 として は 、 モデル が 訓練 データ に なるべく 当てはまる よう に する こと と 、 モデル の 複雑 さ と の 間 の 折り合い を つける 、 という こと で ある 。
これ によって 、 データ を モデル 化 する 際 の 最も 重要 な 決定 基準 データ の 当てはめ と モデル の 複雑 さ と の 間 の 妥協 点 を 探し て いる ため 、 当てはまり が 良い が 複雑 で ある モデル より も 、 より 単純 で は ある が 当てはまり が 悪い モデル の 方 を 最終的 に 選択 する こと に なる 。
この 正則 化 による 妥協 点 によって 、 最終的 に モデル が 当てはめ に 使う 訓練 データ の ノイズ に 当てはまっ て しまわ ない よう に する こと が できる 。

ここ で は 、 R で 正則化 を 扱う こと の できる 機能 について 述べる こと に しよ う 。
本章 で は 、 正則化 を 使っ て 線形 モデル を 当てはめる こと の できる glmnet という 関数 が 用意 さ れ て いる 、 glmnet パッケージ を 引き続き 用いる 。
glmnet が どの よう に 動作 する の か を 見る ため に 、 再び 正弦波 の データ を 用いる こと に する 。

glmnet を 使う に は 、 x の ベクトル 版 を 、 matrix 関数 を 使っ て 行列 に 変更 する 必要 が ある 。
その後 、 lm と ~ 演算子 の 文法 を 使う の と は 逆 の 順番 で glmnet を 呼ぶ 。

この よう に し て glmnet を 呼ぶ と 、 指定 し た 回帰 に対して 可能 な すべて の 正則化 の セット 全体 を 返し て くれる 。
リスト の 最 上部 は glmnet が 適用 し た 最も 強い 正則化 で あり 、 最 下部 は 計算 さ れ た 最も 弱い 正則化 で ある 。
上記 で は その 中 の 最初 と 最後 の 5 行 ずつ のみ を 掲載 し て いる 。

ここ に 示し た 10 行 の 出力 の 各 列 の 解釈 について 考え て みよ う 。
出力 の 各行 に は 、 Df 、 % Dev 、 Lambda の 3つ の 列 が ある 。
最初 の 列 Df は 、 モデル 中 の いくつ の 係数 が 非 ゼロ と なっ た か を 表し て いる 。
入力 の うち 実際 に 重要 な の は 少数 で ある と 断定 できる 方 が 望ましい と 考える 人 が 多く 、 多く の 入力 に ゼロ の 重み を 割り当て た 時 で さえ モデル の 性能 が 良い なら 、 そう 自信 を 持っ て 断定 できる ため 、 非 ゼロ 係数 の 数 が わかる の は 便利 で ある 。
統計的 モデル の 入力 の 大 部分 に対して 係数 ゼロ が 割り当て られ て いる 時 、 その モデル は 疎 （ スパース ） で ある と いう 。
モデル が 疎 に なる の を 促進 する よう な 手法 は 、 現代 の 機械学習 研究 における 大きな トピック の 1つ と なっ て いる 。

2つ め の 列 % Dev は 、 基本的 に は この モデル の R2 値 で ある 。
一番 上 の 列 について は 、 たった 1つ しか ない 入力 変数 に対して 係数 ゼロ が 割り当て られ て おり 、 定数 の 切片 を 使う だけ で は 良い 性能 を 得 られ ない ため 、 0% と なっ て いる 。
一番 下 の 列 で は 、 Dev は 59% と なっ て おり 、 これ は lm を 直接 使っ た 場合 と 同じ 値 で ある （ lm は 正則化 を 全く 行わ ない ） 。
モデル を 切片 まで 正則 化 し て しまっ た 場合 および 全く 正則化 を し ない という これら 2つ の 極端 な 場合 の 中間 で は 、 Dev が 9% から 58% まで の 値 を 取る 。

最後 の 列 Lambda は 、 正則化 の 学習者 にとって 最も 重要 な 情報 で ある 。
Lambda は 、 当てはめ て いる モデル が どの ぐらい 複雑 に なっ て も 良い か を コントロール する 正則化 アルゴリズム の パラメータ で ある 。
この Lambda は 最終的 に モデル の 主要 な パラメータ と なる 値 を コントロール する ので 、 ハイパー パラメータ と 呼ば れる 。

Lambda の 詳細 な 意味 について は 7 章 で 説明 する が 、 基本 的 な 考え方 は 簡単 に 理解 できる 。
Lambda が 非常 に 大きい とき は 、 複雑 な モデル が 不利 に なる よう に 大きな ペナルティ を 与え 、 これ が すべて の 係数 が ゼロ に なる 方向 へ と 向かわ せる 。
Lambda が 非常 に 小さい 時 に は 、 この よう な ペナルティ を あまり 与え ない 。
極端 に 弱い 正則化 の 方 に 進ん で いく と 、 最終的 に は Lambda が 0 に セット さ れ て 、 lm を 使っ て 当てはめる とき の よう な 正則 化 なし の 線形回帰 の 結果 が 得 られる 。

しかし 一般的 に は 、 これら の 2つ の 極端 な 場合 の 間 の どこか に 、 選び うる 中 で 最良 の モデル を 得 られる Lambda の 値 が ある 。
この Lambda の 値 を どう やっ たら 見つけ られる だろ う か 。
ここ が 、 正則化 を 扱う 過程 の 一部分 として 、 交差 検定 を 使う 場面 で ある 。
多項式 回帰 の 次数 を 変更 する 代わり に 、 はじめ から 次数 を 10 など の 高い 値 に セット し て しまう 。
そして 、 訓練 セット を 用い て モデル を Lambda の いろいろ な 値 に対して 当てはめ 、 ヘルドアウト・テストセット に対して どの よう な 性能 を 出す か を 見る †。
これ を Lambda の いろいろ な 値 に対して 行っ た 後 、 どの Lambda の 値 が テストデータ に対して 最も 良い 性能 を 上げ た か が わかる 。

正則化 の 結果 は 、 必ず ヘルドアウト の テストデータ に対して 行わ なけれ ば なら ない 。
正則化 の 強 さ を 上げる と 、 訓練 データ における 性能 は 悪化 する だけ で あり 、 訓練 データ に対する 性能 を 見る こと によって わかる 情報 は 実質 ゼロ で ある 。

この こと を 心 に とどめ ながら 、 例 を 見 て いく こと に しよ う 。
前 と 同様 に データ を 準備 し て 、 それ を 訓練 セット と テスト セット に 分割 する 。

しかし 今回 は 、 次数 で は なく Lambda の 値 に対して 繰り返し を 行う 。
幸いに 、 glmnet は 当てはめ の ステップ を 一 回 実行 する だけ で 、 Lambda の 様々 な 値 に対して 当てはめ た モデル を 保持 し て くれる ため 、 毎回 モデル を 再度 当てはめる 必要 は ない 。

モデル の 性能 を Lambda の いろいろ な 値 に対して 計算 し た 後 、 プロット を 作る と 、 試し て いる Lambda の 値 の 範囲 の どこ で 、 新しい データ に対して 最も 良い 性能 を 上げ られる か が わかる 。

図 6-7 を 見る と 、 できる 限り 最も 良い 性能 は Lambda の 値 が 0.05 付近 で 得 られ て いる よう だ 。
よって 、 全体 の データ に対して モデル を フィット さ せる ため に は 、 この 値 を 選択 し 、 全体 の データセット に対して モデル を 訓練 さ せる 。
ここ で は まさに これ を 行っ て いる 。

全体 の データセット に 最終 的 な モデル を 当てはめ た あと は 、 coef を 使っ て 正則 化 し た モデル の 構造 を 調べる こと が できる 。

この 表 を 見 て わかる よう に 、 モデル 自体 は 10 個 の 係数 を 使う 能力 が ある ものの 、 結果的 に は 3つ の 非 ゼロ 係数 しか 使う こと は なかっ た 。
この よう に 、 より 複雑 な モデル が 可能 で ある 時 に も 単純 な モデル を 選択 する という こと は 、 正則化 の 裏 に ある 根本 的 な 戦略 で ある 。
ツール キット の 正則化 を 使え ば 、 大きな 次数 を 持つ 多項式 回帰 を 使い ながら 、 データ に対する 過学習 を 回避 する こと が できる 。

正則化 について の 基本 的 な 考え を きちんと 押さえ ながら 、 本章 の ケーススタディ として 実際 の 応用 例 を 見 て みよ う 。

交差 検定 と 正則化 は どちら も 、 過学習 を 避け ながら 、 データ 中 の 入り組ん だ パターン を 模倣 できる 複雑 な モデル を 扱える よう に する 強力 な 道具 で ある 。
正則化 が 使える 非常 に 興味深い ケース として は 、 ある 連続 値 の 出力 を 予測 する ため に テキスト を 使う 場合 が ある 。
例えば ある 会社 の 株価 が どの ぐらい 変動 し やすい か を 、 その 上場 申請書類 から 予測 できる かも しれ ない 。
テキスト を 回帰 問題 の 入力 として 使う 場合 、 ほとんど の 場合 観察 （ 文書 ） の 数 より も 入力 （ 単語 ） の 方 が はるか に 多い 。
もし 1 グラム （ 個々 の 単語 ） より も 観察 の 数 が 多けれ ば 、 2 グラム （ 単語 の ペア ） や 3 グラム （ 単語 の 3つ 組 ） を 考慮 し 、 N グラム の 数 が 文書 より 多く なる よう に できる 。
ここ で は データ の 行 より も 列 の 方 が 多く 、 正則化 無し の 線形回帰 で は いつも 過 学習 し た モデル が 生成 さ れ て しまう 。
この 理由 から 、 少し でも 意味 の ある 結果 を 得る ため に は 、 何らかの 形 の 正則化 を 使う 必要 が ある 。

この 問題 の 感覚 を つかむ ため に 、 米 オライリー 社 が これ まで に 出版 し た 書籍 の 売上 トップ 100 冊 の 相対 的 な 人気 度 を 、 裏表紙 の 紹介 文 だけ を 使っ て 推定 する 、 という 単純 な ケーススタディ に 取り組ん で みよ う 。
この テキスト で 書か れ た 記述 を 意味 の ある 入力 に 変換 する ため に 、 各 書籍 の 紹介 文 を 単語 頻度 の ベクトル に 変換 し 、 「 the 」 や 「 Perl 」 など の 単語 が どの ぐらい 頻繁 に 各 紹介 文 に 現れる か が わかる よう に する 。
理論 上 、 分析 し た 結果 として 本 の 紹介 文 の 単語 の うち 、 売上 が 高く なる こと を 予測 できる よう な 単語 の リスト が 得 られる はず だ 。

予測 タスク が 達成 でき ない 、 という 結果 に 終わる 可能性 は もちろん 常に ある 。
これ は 、 本質的 に 任意 の 単語 に対して 大きい 係数 を 割り当てる モデル によって 引き起こさ れ た 結果 で ある 場合 も ある 。
つまり 米 オライリー 社 の 人気 書籍 の 紹介 文 に 共通 に 現れる 単語 が 非常 に 少ない に も 関わら ず 、 モデル が この こと を 知ら ず に データ を 当てはめ 、 一部 の 単語 に 値 を 割り当てよ う と する 、 という こと が 起こり うる から で ある 。
しかし 、 この 場合 の 結果 から は 、 これら の 単語 が どうして 有用 で ある の か について ほとんど もしくは 全く 情報 は 得 られ ない 。
この 問題 は 、 今回 ここ で 説明 する 演習 で 顕著 に なる こと は ない が 、 テキスト 回帰 を 行う とき に この こと を 頭 に 入れ て おく こと は 非常 に 重要 で ある 。

まず はじめ に 、 生データ セット を 読み込み 、 3 章 で 紹介 し た tm パッケージ を 使っ て 文書 単語 行列 に 変換 しよ う 。

ここ で は ranks データセット を CSV ファイル から 読み込み 、 tm が 理解 できる 形式 の 本 の 紹介 文 を 含む データ フレーム を 作成 し て いる 。
この データ フレーム から コーパス を 作成 し 、 テキスト の 大文字 小文字 の 統一 、 空白 の 削除 、 英語 に 頻出 する 一般 的 な 単語 の 削除 を 行っ た 後 、 文書 単語 行列 を 構築 し た 。
この 作業 が 終わっ た 時点 で 、 データ を 作る ため の 本質 的 な 変換 作業 は すべて 完了 し て いる 。
これら が 終われ ば 、 変数 を 少し 操作 し て 、 回帰 問題 を glmnet に対して 少し わかり やすく 与える こと が できる よう に なる 。

ここ で は 文書 単語 行列 を 扱い やすい 単純 な 数値 行列 へ と 変換 し た 。
さらに 順位 を 逆 に 数値 化 し 、 最も 順位 の 高い 書籍 の y の 値 が 100 、 最も 低い もの が 1 と なる よう に し た 。
これ は 、 書籍 の 人気 度 を 予測 する 係数 が 、 人気 を 高める 手がかり で ある とき に 正 の 値 と なる よう に する ため で ある 。
もし 順位 の 値 を そのまま 使っ た 場合 、 この よう な 同じ 単語 の 係数 は 負 の 値 に なっ て しまう 。
この 2つ の 符号化 方法 に は 実質 的 な 違い は ない の だ が 、 負 の 値 に なる こと が あまり 直観 的 で は ない と 感じ られる 。

回帰 分析 を 実行 する 前 の 最後 の 作業 は 、 乱数 の シード を 初期 化 し て 、 glmnet パッケージ を 読み込む こと だ 。

この 準備 作業 が 終われ ば 、 いくつか 取り 得る Lambda の 値 を 使っ て ヘルドアウト・データ に対して 最も 良い 結果 を 出す 値 を 繰り返し 調べる こと が できる 。
我々 が 持っ て いる データ は あまり 多く は ない ため 、 この 分割 を Lambda の 各 値 に対して 50回 繰り返し 、 正則化 の レベル を 変える と 精度 が どう 変わる か を より 正確 に 把握 する 。
以下 の コード で は Lambda の 値 を セット し 、 データ を 訓練 セット と テスト セット に 50回 分割 し た 後 、 モデル の 性能 を 各 分割 について 調べ て いる 。

モデル の 性能 を 3つ の 異なる Lambda の 値 に対して 計算 し た あと に 、 それら を 比較 する こと により モデル の 性能 が 最も 良かっ た ところ が わかる 。

残念 ながら 図 6-8 を 見 て わかる よう に 、 これ は 統計 的 な 手法 を データ に 当てはめよ う として 失敗 し た 最初 の 例 で ある 。
Lambda の 値 が 大きく なれ ば なる ほど モデル が 良く なっ て いる の は 明らか な の だ が 、 これ は ちょうど モデル が 単なる 切片 に 縮退 し て しまっ た とき に 起こっ て いる 。
その 時点 で は 、 テキスト データ は 全く 使っ て い ない こと に なる 。
端的 に 言え ば 、 今回 の テキスト 回帰 で 発見 でき た 手がかり は ない という こと で ある 。
ここ で 観察 できる すべて の もの は 、 ヘルドアウト・データ に対して モデル を 適用 し た 時 に は 単なる ノイズ で あっ た という こと に なる 。

これ は 書籍 の 紹介 文 を 書く とき に 、 その 書籍 が 必ず 良く 売れる よう に する ため の 方法 は わから ない という こと を 示唆 し て いる ものの 、 機械学習 に 携わる 人 が 心 に 留め て おく べき 貴重 な 教訓 が 含ま れ て いる 。
つまり 扱っ て いる データ から 手がかり が 見つから ない こと も あり うる 、 という こと で ある 。
以下 の 引用 は この 問題 を 簡潔 に 言い表し て いる 。

データ に は 答え が 含ま れ て いる と は 限ら ない 。
いくら か の データ が あり 、 答え を 知り たい と 強く 切望 し て い た として も 、 その データ 本体 から 妥当 な 答え が 引き出せる と は 限ら ない 。

しかし この データセット に 完全 に 見切り を つけ て しまう 必要 は ない 。
順位 を テキスト から 予測 する 道具 を 作る の は 上手く いか なかっ た が 、 もう少し 単純 化 し て 、 書籍 が 上位 50位 以内 に 入る か どう か を 予測 する こと は できる かも しれ ない 。

これ を する ため に 、 回帰 問題 から 分類 問題 へ と 問題 を 切り替えよ う 。
無数 に ある 順位 の うち の 1つ を 予測 する 代わり に 、 「 この 本 は 50位 以内 に 入る か 否 か 」 という 単純 な 分類 の 判断 へ と 切り替える の で ある 。

この 区別 は より 広く 単純 で ある ので 、 ここ で 取り扱っ て き た 小さな データセット から でも 手がかり を 抽出 する の は もっと 簡単 で ある と 期待 できる 。
はじめ に 、 クラス ラベル を データセット に 追加 し て みよ う 。

ここ で は 、 2 章 で 議論 し た 0/1 擬似 符号化 を 使い 、 書籍 が 上位 50位 以内 で ある 場合 を 1 で 、 そう で は ない 場合 を 0 によって 表現 する 。
この 符号化 を 使う と 、 トップ 50 書籍 リスト に 存在 する か どう か を 予測 する ため に 、 2 章 の 終わり に 紹介 し た ロジスティック回帰 の 分類 アルゴリズム を 使う こと が できる 。

ロジスティック回帰 は 、 本質的 に は ある 要素 が 2つ の カテゴリ の 1つ に 属する 確率 を 予測 する 回帰 の 一 種 で ある 。
確率 は 必ず 0 から 1 の 間 で ある ので 、 0.5 で しきい値 を 定める と 分類 アルゴリズム を 作る こと が できる 。
出力 が 0 と 1 の 間 で ある こと 以外 は 、 ロジスティック回帰 は 基本 的 に 線形回帰 と 同じ 振る舞い を する 。
唯一 の 違い は 、 クラス の 予測 を 得る ため に は 出力 に しきい値 を 設け なけれ ば なら ない 点 で ある 。
ロジスティック回帰 を R で 使う の が いかに 簡単 か を 示し た あと 、 この しきい値 を 設ける プロセス に 進む 。

まず 最初 に ロジスティック回帰 を データセット 全体 に 適用 し 、 どの よう に なる か を 見 て みよ う 。

この glmnet の 呼び出し と 、 以前 の 線形回帰 の 呼び出し と の 唯一 の 違い は 、 予測 を する 際 に 期待 さ れる 誤差 の 種類 を 制御 する family という パラメータ を 1つ 追加 で 指定 する こと で ある 。
これ は 5 章 で は 議論 し なかっ た こと だ が 、 線形回帰 で は 誤差 は ガウス分布 に 従う と 仮定 し て おり 、 一方 ロジスティック回帰 で は 誤差 は 二項分布 に従って 分布 する と 仮定 し て いる 。
ここ で 二項分布 の 詳細 について は 議論 し ない が 、 二項分布 と は 、 コイン を 投げ て 得 られる データ の 統計的 分布 で ある こと を 知っ て おこ う 。
そのため 二項分布 は すべて 0 か 1 か の 誤差 を 生成 する が 、 もちろん これ は まさに 分類 の ため に 必要 な もの で ある 。

これ を 詳しく 見る ため に 、 glmnet を 呼び出し た 例 を 3つ 紹介 しよ う 。

1つ 目 の 呼び出し は 本章 で 以前 説明 し た もの で 、 線形回帰 を 実行 する もの で ある 。
2つ 目 の 呼び出し は 実際 は 最初 の 呼び出し と 同等 で ある が 、 family 引数 の デフォルト 値 を 明示 的 に 指定 し た もの で 、 指定 し ない 場合 これ は 自動的 に ' gaussian ' に 設定 さ れる 。
3つ 目 の 呼び出し は 、 ロジスティック回帰 を 実行 する もの で ある 。
見 て わかる よう に 、 線形回帰 から ロジスティック回帰 へ と 分析 を 切り替える の は 、 単に 誤差 の 分布 族 を 切り替える だけ という こと で ある †。

ロジスティック回帰 を データセット 全体 に 当てはめ たら 、 predict 関数 を 使っ て 、 モデル の 予測 が どの よう に なる か を 見 て みよ う 。

ご覧 の 通り 0 か 1 か の 予測 を 期待 し て いる の に も かかわら ず 、 出力 に は 正 の 値 も 負 の 値 も 含ま れ て いる 。
この 生 の 予測 結果 に対して できる こと は 2つ ある 。

1つ 目 は ifelse 関数 を 使っ て 0 で 足切り を 行い 、 0/1 の 予測 を 作り出す こと で ある 。

2つ 目 は 、 これら の 生 の 予測 を もっと 解釈 が 簡単 な 確率 値 に 変換 する こと で ある が 、 1つ 目 と 同様 に 0/1 の 予測 を 得る ため に は 、 もう一度 0.5 で 足切り を し なけれ ば なら ない 。
生 の ロジスティック回帰 の 予測 を 確率 に 変換 する ため に は 、 boot パッケージ の inv.logit 関数 を 使う 。

inv.logit 関数 が どの よう に 動く か の 詳細 を 知り たけれ ば 、 その ソースコード を 見 て 、 計算 さ れ て いる 数学 的 変換 を 理解 する こと を おすすめ する 。
今回 の 目的 の ため に は 、 ロジスティック回帰 で は 、 出力 が 逆 ロジット 関数 によって 変換 さ れ 、 その後 に 確率 値 を 出力 として 生成 する という こと だけ 理解 し て おけ ば 良い 。
この ため 、 ロジスティック回帰 は ロジットモデル と 呼ば れる こと も 多い 。

ロジスティック回帰 の 生 の 出力 を 変換 する のに 上記 2つ の どちら の 方法 を 使う に しろ 、 重要 な の は ロジスティック回帰 が 5 章 で 実行 し た 線形回帰 と 同じ ぐらい 簡単 に 分類 を し て くれる 道具 を 提供 し て くれる と いう こと で ある 。
では 、 ロジスティック回帰 を 使っ て 書籍 が 上位 50位 以内 で ある か どう か を どの ぐらい うまく 分類 できる か を 見 て みよ う 。
これ を 行う コード は 、 以前 に 用い た 順位 を 予測 する 線形回帰 モデル と 基本的 に 同じ もの で ある 。

線形回帰 の もの と 比較 し て 、 この コード 片 で の アルゴリズム 的 な 変更 は 少数 で ある 。
すなわち （ 1 ） glmnet へ の 呼び出し の 際 、 二項分布 の 誤差分布 族 パラメータ を 使っ た こと 、 （ 2 ） 生 の ロジスティック 予測 から 0/1 の 予測 を 生成 する しきい値 ステップ 、 （ 3 ） モデル の 性能 指標 として 、 RMSE で は なく 誤り 率 を 使う こと 、 だけ だ 。
他 にも データ を 50分 割 で は なく 250 分割 し 、 各 lambda の 値 に対して 、 平均 誤り 率 を より しっかり 求め られる よう に し た こと に 気付い た だろ う 。
これ は 結果 として 誤り 率 が 50% 近く に なっ て しまう こと が 多く 、 偶然の確率 以上 で 予測 が 本当に でき て いる か という こと を 確かめ たかっ た ため の 変更 で ある 。
この 増え た 分割 を より 効率 良く 実行 する ため 、 分割 と lambda ループ の 順番 を 入れ替え 、 lambda の 各 値 に対して 毎回 分割 を し なく て も 良い よう に し た 。
これ で 非常 に 多く の 時間 が 節約 でき 、 効率 の 良い 機械学習 の コード を 書く ため に は 、 効率 の 良い コード を 書く こと を 気遣う 良い プログラマ の よう に 振る舞う 必要 が ある こと を 認識 さ せ て くれる 。

ただし ここ で は この データセット に対する 性能 の 方 に 興味 が ある ので 、 lambda の 値 を 変え た とき の 誤り 率 を グラフ に し て みよ う 。

この 結果 から 、 回帰 を 分類 で 置き換え た こと により 本当に 良い 結果 が 得 られ た という こと が わかる 。
lambda の 値 が 低い とき 、 書籍 が 上位 50位 以内 か どう か の 予測 について 偶然 より も 良い 性能 を 上げ て おり 、 胸 を 撫で 下ろす こと が できる 。
この データ は 、 順位 予測 の ため の 高度 な

そして これ を 一般 的 な 教訓 として 、 本章 を 終わり に し たい 。
時に は 、 「 シンプル・イズ・ベター 」 で ある 。
正規化 は 、 テストデータ において より 良い 性能 を 上げる ため により 単純 な モデル を 強制 する 。
そして 二 値 分類 に対する 要件 は 、 順位 を 直接 予測 する ため の 要件 より さらに 弱い ため 、 回帰 モデル から 分類 モデル へ と 切り替える こと により 、 より 高い 性能 を 達成 する こと が できる 。

ここ まで 本書 で は 登場 し た アルゴリズム の ほとんど を ブラックボックス として 扱っ て き た 。
つまり 扱う 可能性 の 高い 入力 と そこ から 得る で あろ う 出力 を 理解 する こと に 焦点 を 当て て き た の で ある 。
そして 基本的 に は 、 機械学習 アルゴリズム を 予測 タスク を 実行 する 関数 の ライブラリ として 扱っ て き た 。

本章 で は 最も 基本 的 な 機械学習 アルゴリズム を 実装 する の に 使う 手法 を いくつか 詳しく 見 て いく こと に する 。
まず その 第一歩 として 、 予測 因子 を 1 個 だけ 持つ 単純 な 線形回帰 モデル を 当てはめる ため の 関数 を 組み立てる 。
この 例 を通じて 、 モデル を データ に 当てはめる という 行為 に 、 最適化問題 として 見る という 考え方 の 裏付け を 与える こと できる 。
最適化問題 という の は 、 ある 機械 が あり 、 その つまみ を いじっ て その 機械 の 設定 を 変える こと が でき 、 現在 の 設定 で その 機械 が どの ぐらい うまく 動い て いる の か を 測定 する 方法 が ある 、 という 状況 で ある 。
その 状況 において その 機械 が どの ぐらい うまく 動い て いる か という 指標 を 最大 化 する よう な 最も 良い 設定 を 見つけ たい 。
この 点 は 最適 値 と 呼ば れ て おり 、 この 点 に 達する こと を 最適化 と 呼ぶ 。

最適化 が どの よう に 動く か を 基本的 に 理解 し たら 、 重要 な タスク に 取り組ん で みよ う 。
暗号 化 さ れ た テキスト の 解読 を 最適化問題 として 扱う 、 非常 に 単純 な 暗号解読 システム を 作り上げる 。

自分 で 線形回帰 関数 を 作る ため に 、 これ まで 例 として 使っ て き た 標準 的 な 身長 と 体重 の データセット を もう一度 見 て みよ う 。
以前 見 た よう に 、 身長 に対して 関数 を 計算 する こと により 、 体重 を 予測 できる と 仮定 する 。
具体的 に は 、 以下 の R の 関数 の よう に 、 線形 関数 を 使っ て うまく 予測 できる と 仮定 する 。

5 章 で は 、 lm 関数 を 用い て この 直線 の 傾き と 切片 を 計算 する 方法 の 詳細 を ひと通り 解説 し た 。
この 例 で は 、 パラメータ a が 直線 の 傾き で あり 、 b が 切片 （ 身長 ゼロ の 人 の 体重 が どの ぐらい に なる か を 表す ） で ある 。

この 関数 が 与え られ た とき 、 a と b の 値 として 何 が 最適 か を どの よう に 決定 し たら 良い だろ う か 。
ここ で 最適化 の 登場 で ある 。
我々 が 作っ た 関数 が 身長 から 体重 を どの ぐらい うまく 予測 できる か を 表す 指標 を 作り 、 そして a と b の 値 を 変化 さ せる こと で 可能 な 限り 良く 予測 できる よう に する 。

これ は どう やっ て 実行 すれ ば 良い だろ う 。
実は 、 lm が これ を すべて 行っ て くれる 。
lm に は 、 最適化 の 対象 と なる 簡単 な 誤差関数 が あり 、 通常 の 線形回帰 で のみ 使う こと が できる 特定 の アルゴリズム を 使い 、 a と b の 最適 な 値 を 見つけ出す 。

ここ で lm を 走ら せ て 、 それ によって 望ましい と 判断 さ れ た a と b の 値 を 見 て みよ う 。

なぜ これら が a と b に対して 正当 な 選択 と なっ て いる の だろ う か 。
これ に 答える ため に は lm が どの よう な 誤差関数 を 使っ て いる か を 知る 必要 が ある 。
5 章 で 簡単 に 述べ た よう に 、 lm は 「 二 乗 誤差 」 と 呼ば れる 誤差 指標 に 基づい て いる 。
これ は 以下 の よう に 求め られる 。

1 . a と b の 値 を 固定 する 。
2 . 身長 の 値 が 与え られ た とき 、 それ に 結び付い た 体重 を 推測 する 。
3 . 体重 の 真 の 値 から 体重 の 推測 値 を 引く 。
これ を 誤差 と 呼ぶ 。
4 . 誤差 を 二乗 する 。
5 . この 二乗 さ れ た 誤差 を 事例 全体 に対して 合計 し 、 二乗 誤差 の 合計 を 得る 。

なお 解釈 の 便宜 を 図る ため に 、 通常 は 和 で は なく 平均 を とっ て から 平方根 を 計算 する 。
ただし 最適化 の ため に は これら の 操作 は 必要 ない ため 、 二乗 誤差 の 合計 を 計算 する こと によって 、 計算 時間 を 少し 短縮 できる 。

最後 の 2つ の ステップ は 密接 に 関連 し て いる 。
誤差 を 各 データ ポイント に対して 合計 し ない の で あれ ば 、 二乗 する 意味 は ない だろ う 。
厳密 に 言う と 二 乗 が 必要 な の は 、 生 の 誤差 を すべて 合計 する と 全体 の 誤差 が ゼロ と なっ て しまう から で ある 。

これ が 常に 正しい こと を 示す の は 難しく は ない が 、 本書 で できるだけ 避け て いる ある 種 の 代数 が 必要 と なる 。

この やり方 を 実装 する コード を 見 て いこ う 。

特定 の a と b の 値 における squared.error を 評価 し 、 これ が どの よう に 動作 する の か の 感覚 を つかも う （ 結果 は 表 7-1 に 示し て ある ） 。

これ を 見 て わかる よう に 、 a や b の 値 を ある 値 に する と 、 squared.error の 値 が 他 の 値 より も かなり 小さく なる 場合 が ある 。
こうして 予測 する 能力 の 良し 悪し を ある程度 教え て くれる 意味 の ある 誤差関数 が ある 以上 、 a と b の 最適 値 を どうしても 見つけ たい と 思う だろ う 。
これ が ここ で の 最適 値 問題 の 最初 の 部分 、 つまり 最小化 もしくは 最大 化 しよ う と する 指標 の 設定 で ある 。
この よう な 指標 は 通常 目的 関数 と 呼ば れ て いる 。
最適化 の 問題 は 、 この 目的 関数 を なるべく 小さく 、 もしくは 大きく する a と b の 最適 な 値 を 探す 問題 と なる 。

明らか な アプローチ の 1つ に 、 グリッド サーチ と 呼ば れる もの が ある 。
これ は 先 ほど 見 た よう に 、 a と b の 値 の 十分 大きな 範囲 に対して 表 を 計算 し て 、 squared.error が 最も 低く なる よう な 行 を 選択 する という やり方 で ある 。
この やり方 で は 、 探索 し た グリッド における 最適 な 値 を 必ず 得る こと は できる ため 、 必ずしも 不適切 な やり方 という わけ で は ない 。
ただし これ に は いくつか 深刻 な 問題 が ある 。

グリッド を 定義 する の に 使う 値 は 、 互いに どの ぐらい 近けれ ば 良い の だろ う か 。
a の 値 を 0 、 1 、 2 、 3 の よう に する べき か 、 それとも 0 、 0.001 、 0.002 、 0.003 の よう に する べき だろ う か 。
言い換えれ ば 、 探索 を 実行 する 正しい 「 解像度 」 は どの ぐらい で あろ う か 。
この 質問 に 答える に は 、 上記 の 幅 の 両方 を 評価 し て 、 どちら か より 有効 か を 確かめ なけれ ば いけ ない が 、 この 評価 自身 が 計算 量的 に コスト が 高く 、 使う グリッド の 大き さ を 最適 化 する という 別 の 最適化問題 を 確実 に 増やし て しまう 。
そして これ を 続け た 先 に は 無限ループ 地獄 が 待っ て いる 。

2つ の パラメータ に対して 、 この グリッド を 各 パラメータ につき 10 個 の 点 で 評価 し たい と する と 、 全体 で 100 個 の エントリ を 持つ テーブル を 構築 する 必要 が ある 。
一方 で 、 100 個 の パラメータ に対して 、 各 パラメータ につき 10 個 の 点 で 評価 する と 、 10100 個 の エントリ を 持つ テーブル を 構築 する 必要 が ある 。
この よう に 指数関数 的 に 大き さ が 増加 し て しまう こと は 機械学習 の 分野 において 広く 蔓延 し て おり 、 「 次元の呪い 」 と 呼ば れ て いる 。

数 百 個 、 さらに は 数 千 個 も の 入力 に対して 線形回帰 を 使える よう に する ため に は 、 グリッド サーチ は 決して 最適 な アルゴリズム で は ない 。
さて 、 どう し たら いい の だろ う 。
我々 にとって 幸い な こと に 、 コンピュータ 科学者 や 数学者 ら は 、 最適化 の 問題 について 長い間 考え抜い て き て おり 、 すぐ に 使える 既製 の 最適化 アルゴリズム を たくさん 構築 し て き た 。
R で は 、 最適化問題 の 最初 の 試行 は 、 optim 関数 を 使っ て 行う べき で あり 、 これ は 、 主要 な 最適化 アルゴリズム を 多く 実装 し て いる ブラックボックス を 提供 し て くれる 。

optim が どの よう に 動作 する か を 見せる ため 、 回帰 モデル の 当てはめ に 使う こと に しよ う 。
これ で 、 lm を 使っ て 求め られ た a と b の 値 と 同様 の 値 が 得 られる と 期待 しよ う 。

例 に 示し た よう に 、 optim は いくつか 異なっ た 引数 を 取る 。
まずは 、 最適化 しよう と し て いる パラメータ に対する 開始 点 の 数値 ベクトル を 渡す 必要 が ある 。
この 場合 、 a と b は デフォルト 値 の ベクトル c ( 0 , 0 ) と しよ う 。
その後 、 最適 化 し たい すべて の パラメータ を 含む ベクトル （ ここ で は x と 呼ぶ ） を 受け取る 関数 を optim に 渡す 必要 が ある 。
複数 の 名前 付き 引数 を 持つ 関数 を 書く ほう が 多く の 場合 好ましい ので 、 ここ で 作成 する 誤差関数 を 、 ただ 1つ の 引数 x を 取る 匿名 関数 で ラップ し 、 これ を 誤差関数 本体 の 方 に 分割 し て 渡す 。
この 例 で は 、 どう やっ て squared.error を ラップ し た か が 見て取れる だろ う 。

この optim へ の 呼び出し を 実行 する と 、 a と b の 値 が それぞれ par の 値 として 得 られる 。
そして これら の 値 は lm によって 得 られ た もの と 非常 に 近く 、 optim が きちんと 動作 し て いる こと が わかる †。
実際 に は 、 lm は optim より も ずっと 線形回帰 に 固有 の アルゴリズム を 使っ て いる ため 、 optim によって 得 られ た値 より 正確 に なる 。
しかし 自分自身 の 問題 に 取り組む 予定 で ある なら 、 線形回帰 以外 の モデル 以外 に対して も 使える ため 、 optim を 扱っ た ほう が ずっと 良い 。

optim から 得 られ た 他 の 出力 は 、 それほど 面白く ない かも しれ ない 。
最初 に 表示 さ れ て いる の は value で あり 、 ここ から optim が 最も 良い と し た パラメータ の 値 を 用い て 評価 さ れ た 二乗 誤差 の 値 が わかる 。
その 次 に は 、 最適 化 し たい メイン 関数 （ ここ で は function と 呼ば れ て いる ） と 勾配 （ ここ で は gradient と 呼ば れ て いる ） が 何回 実行 さ れ た か が 、 counts の 値 から わかる 。
勾配 は 省略 可能 な 引数 で あり 、 メイン 関数 の 勾配 を 計算 できる だけ の 微積分 学 が 十分 が わかっ て いる 場合 に 与える こと が できる 。

もし 「 勾配 」 という 単語 を 聞い て ピン と 来 なく て も 、 心配 は 不要 で ある 。
私たち も みな 、 この 勾配 を 手 で 計算 する の が 嫌 な ので 、 この 省略 可能 な gradient 引数 の 値 を 指定 せ ず に 、 optim に トリック を 任せ て しまう の で ある 。
ここ まで は 事 が うまく 運ん だ が 、 問題 によって は 道のり が 長く かかる こと も ある 。

次 の 値 は convergence （ 収束 ） で あり 、 これ は 、 optim が 自信 を 持っ て 最適 で ある と いえる パラメータ を 見つけ た か どう か を 表し て いる 。
もし すべて が うまく 行っ た の なら 、 0 が 表示 さ れる 。
もし 自身 で 試し た 結果 が 0 で ない とき は 、 optim の ドキュメント を チェック し て 、 他 に 返さ れる 可能 性 の ある エラーコード の 解釈 を 見 て みよ う 。
最後 に 、 message の 値 から ユーザ が 知っ て おく べき こと が 起こっ た か どう か が わかる 。

一般的 に 、 optim は 微積分 学 の 分野 における 多く の 高度 な 考え方 に 基づい て いる 。
数学 的 に かなり 複雑 な ので 、 ここ で は optim の 内部 動作 に は 全く 立ち入ら ない こと に する 。
しかし 、 optim が 実行 し て いる こと の 概観 は 、 図 を 用い て 非常 に 簡単 に 表す こと が できる 。
ここ で は b は 0 に なる と 決め た 後 に 、 a の 最適 な 値 のみ を 見つけ たい と しよ う 。
a のみ を 変化 さ せ た とき の 二 乗 誤差 は 、 以下 の コード を 使っ て 計算 できる 。

a の 最適 値 が どこ に ある か の 感覚 を つかむ ため に 、 R の curve 関数 を 用い て a の 関数 として 二 乗 誤差 の グラフ を 書く こと が できる 。
curve 関数 は 、 関数 や 式 を 、 x の 様々 な 値 を 用い て 評価 し て 、 関数 や 式 の 値 を プロット する もの で ある 。
以下 の 例 で は 、 a.error を x の 様々 な 値 で 評価 し て いる が 、 R の 式 評価 に は クセ が あり 、 sapply を 使っ て うまく 動く よう に し なけれ ば なら ない 。

図 7-1 を 見る と 、 a ある 値 に対して 最適 と なっ て おり 、 その 値 から 離れる と 必ず 悪く なる よう に 見える 。
この 状態 に ある とき 、 その 値 が 大域 最適 値 で ある と 言う 。
この よう な 場合 、 optim は 二 乗 誤差 の 形 を 使っ て 、 ある 単一 の a の 値 において 誤差関数 を 評価 し た のち 、 どの 方向 に 向かう か を 知る 。
この よう に 局所 的 な 情報 を 使っ て 問題 の 大域 的 な 構造 を 理解 する と 、 optim は 最適 値 に 非常 に 早く たどり着く 。

回帰 問題 の 全体 を より よく 理解 する ため に は 、 b を 変え た とき に 誤差関数 が どの よう に 反応 する か を 見る 必要 が ある 。

図 7-2 を 見る と 、 誤差関数 は b について も 大域 的 最適 値 が ある よう に 見える 。
a に対して も 大域 的 最適 値 が ある という こと も 考慮 する と 、 optim は ここ で の 誤差関数 を 最小 化 さ せる 単一 の 最適 値 を a と b の 両方 に対して 見つけ られる はず だ という こと が 示唆 さ れる 。

より 一般的 に は 、 微積分 を 使っ て これら の グラフ の 谷 を すべて の パラメータ に対して 同時に 探索 する ため 、 optim は うまく 動く と 言える 。
optim は 現在 考慮 し て いる 点 に関する 情報 を 使っ て 近隣 の 点 に関する 情報 を 推測 する ため 、 グリッド サーチ より も 早く 探索 が できる 。
この こと から 、 どの 方向 に 動い たら 性能 を 向上 さ せる か が 決定 できる 。
この よう な 適合 的 な 振る舞い によって 、 グリッド サーチ より も 効率的 に なる の で ある 。

これ まで の 中 で optim を どう やっ て 使う か が 少し わかっ た ので 、 最適化 アルゴリズム を 使っ て 、 リッジ 回帰 の 自分 の バージョン を 実装 し 始める こと が できる 。
リッジ 回帰 と は 、 正則化 （ 6 章 で 紹介 し た ） を 取り入れ た 特殊 な 種類 の 回帰 で ある 。
通常 の 最小 二 乗 回帰 と リッジ 回帰 と の 唯一 の 違い は 誤差関数 だ 。
リッジ 回帰 で は 回帰 係数 の 大き さ も 誤差 項 の 一部 として 考慮 する ため 、 これ が 係数 を 小さく する 方向 へ と 向かわ せる 。
この 例 の 場合 で は 傾き と 切片 を ゼロ の 方向 へ と 向かわ せる 。

誤差関数 の 変更 以外 で 、 リッジ 回帰 を 実行 する 上 で 複雑 に なっ て いる 点 は 、 ここ で は パラメータ lambda を 1つ 追加 で 含め ない と いけ ない という こと で ある 。
この パラメータ は 、 二乗 誤差 を 最小 化 する こと の 重要 さ と 、 データ に 過 学習 し ない よう に a と b の 値 を 最小 化 する こと の 重要 さ と の 間 を 調整 する もの で ある 。
この 正則化 アルゴリズム に対して 追加 さ れ た パラメータ は ハイパー パラメータ と 呼ば れ 、 6 章 で 少し 詳しく 触れ た 。
lambda の 値 を 選択 すれ ば 、 リッジ 誤差関数 を 以下 の よう に 書く こと が できる 。

6 章 で 述べ た よう に 、 lambda の 値 は 交差 検定 を 使っ て 選択 する こと が できる 。
本章 の 残り の 部分 で は もう これ が 完了 し て おり 、 lambda の 適切 な 値 が 1 で ある と 仮定 し て いる 。

リッジ 誤差関数 を R で 定義 する と 、 元 の 通常 の 最小 二 乗 問題 を 解く の と 同じ ぐらい 簡単 に 、 新た に optim を 呼び出し て リッジ 回帰 問題 を 解く こと が できる 。

optim の 出力 を 見る と 、 直線 の 切片 と 傾き として lm を 使っ た とき （ 切片 が -3 50 、 傾き が 7.7 ） より も 少し 小さい 値 が 出力 さ れ て いる 。
この 簡単 な 例 で は あまり 有用 で は ない が 、 6 章 で 実行 し た 大規模 な 回帰 で は 、 大きな 係数 の 値 に対して ペナルティ を 与える こと が 、 アルゴリズム を 用い て 意味 の ある 結果 を 得る の に 不可欠 で あっ た 。

当てはめ た 結果 の 係数 を 見る だけ で は なく 、 curve 関数 の 呼び出し を 繰り返す こと により 、 optim が なぜ 通常 の 線形回帰 と 同様 に リッジ 関数 で も うまく いく の か が わかる 。
結果 を 図 7-3 と 図 7-4 に 示し た 。

この 例 から 、 optim など の 関数 を どの よう に 使っ て 予測 誤差 の 指標 を 最小 化 する か を 理解 する だけ で 、 機械学習 で いかに 多く の こと が できる か が わかっ て もらえれ ば と 思う 。
自分自身 で いくつか の 例 を 試し 、 自分 で 作っ た いろいろ な 誤差関数 で 遊ん で みる こと を おすすめ する 。
これ は 、 ここ に 示し た よう な 絶対 誤差関数 の よう な 誤差関数 を 試す 場合 に 特に 有用 で ある 。

微分積分 に 関連 し た 技術 的 な 理由 により 、 この 誤差 項 は optim と 相性 が 悪い 。
なぜ うまく 行か ない か を 微分積分 を 用い ず に 説明 する の は 少し 難しい が 、 視覚 的 に 大まか な 概念 を 伝える の は 可能 で ある 。
これ まで 通り curve の 呼び出し を 再度 繰り返し て みよ う 。

図 7-5 を 見 て わかる よう に 、 絶対 誤差 曲線 は 二 乗 誤差 曲線 や リッジ 誤差 曲線 より も ずっと 鋭い 。
形 が あまりに 鋭い ため optim は ある 単一 の 点 から どの 方向 に 向かえ ば 良い か という 情報 を あまり 得 られ ず 、 単純 な 可視化 から わかる よう に 、 大域 的 最適 値 が 存在 する に も かかわら ず 、 そこ に 到達 する と は 限ら ない 。

強力 な アルゴリズム は 、 ある 誤差 指標 を 用い た 場合 に だけ うまく 行か ない こと が ため 、 機械学習 を うまく 使いこなす 技術 の 一部分 として 、 optim など の 単純 な ツール で うまく いく の は どの よう な 場合 で 、 もっと 強力 な もの が 必要 な の は どの よう な 場合 か を 学ぶ こと が 大切 で ある 。
絶対 誤差 の 最適化 に対して うまく 動く アルゴリズム は 存在 する が 、 それら は この 本 の 範囲 外 で ある 。
もし この 話題 について もっと 学習 し たい なら ば 、 身近 に いる 数学 の 達人 を 見つけ 、 凸最適化 問題 について 話し て もらう よう に する と 良い だろ う 。

回帰 モデル の 範疇 を 越え て 考え た 場合 、 機械学習 の ほぼ あらゆる アルゴリズム は 、 ある 予測 誤差 に関する 指標 を 最小 化 する という 最適化問題 として みなす こと が 可能 で ある 。
しかし パラメータ が 単なる 数字 だ と は 限ら ない ため 、 ある 点 において 誤差関数 を 評価 する だけ で は 、 optim を 使う ため に 必要 な 近く の 点 に関する 十分 な 情報 が 得 られ ない 。
これら の 問題 に対して グリッド サーチ を 使う こと も できる が 、 グリッド サーチ より も 適し た 他の方法 が ある 。
ここ で は 、 かなり 直観 的 で 、 なおかつ 非常 に 強力 な ある 手法 に 注目 する 。
この 背景 に ある の は 確率 的 最適化 と 呼ば れる 考え方 で 、 ある 範囲 の 可能 な パラメータ を 少し だけ ランダム に 移動 する が 、 同時に 誤差関数 が 上がる の で は なく 下がる 方向 に 向かう よう に する もの で ある 。
この 手法 は 、 おそらく 聞い た こと が ある で あろ う 多く の ポピュラー な 最適化 アルゴリズム 、 例えば 、 焼きなまし法 、 遺伝 アルゴリズム 、 マルコフ連鎖モンテカルロ法 （ MarkovchainMonteCarlo ： MCMC ） など に 関連 し て いる 。
ここ で 使う アルゴリズム は メトロポリス 法 と 呼ば れ て おり 、 現代 の 機械学習 アルゴリズム の 多く は この バリエーション を 基 に し て 動い て いる 。

メトロポリス 法 を 実演 する ため に 、 本章 の ケーススタディ で ある 、 秘密 の 暗号 の 解読 に 取り組ん で いこ う 。
ここ で 定義 する アルゴリズム は あまり 効率 的 な 復号 化 システム で は なく 、 実用 システム で は 決して 真面目 に 使わ れ ない で あろ う が 、 メトロポリス 法 の 使い方 の とても わかり やすい 例 と なっ て いる 。
そして 重要 な の は 、 これ は optim の よう な ほとんど の 既存 の 最適化 アルゴリズム で は 決して うまく 行か ない 例 で も ある という こと だ 。

さて 、 まずは ここ で 問題 を 定義 しよ う 。
その 問題 は 、 換字式暗号 で 符号 化 さ れ て いる こと が わかっ て いる 文字 の 列 が 与え られ た とき 、 元 の テキスト を 復元 する 復号 化 ルール を どの よう に 決め たら 良い で あろ う か 、 という もの だ 。
「 換字式暗号 」 という 言葉 に あまり 馴染み が ない かも しれ ない が 、 これ は 暗号化 方式 の 中 で も 最も 単純 な 部類 に 入る もの だ 。
すなわち 原文 の 各 文字 を 、 ある 決まっ た 文字 で 置き換え て 暗号 メッセージ を 作る やり方 で ある 。
ROT 13 † が おそらく 最も 有名 な 例 で ある が 、 シーザー暗号 という もの も 聞い た こと が ある かも しれ ない 。
シーザー暗号 は 非常 に 単純 な 換字式暗号 で あり 、 各 文字 を その 次 の アルファベット で 置き換える という もの で ある 。
よって 、 「 a 」 が 「 b 」 に 、 「 b 」 が 「 c 」 に 、 「 c 」 が 「 d 」 に なる 。
（ 例外 ケース が 気 に なる かも しれ ない 。
「 z 」 は 「 a 」 に なる ） 。

R で 暗号化 を どう やっ て 扱う か を 理解 する ため に 、 ここ で は シーザー暗号 を 作り 、 それ を R で どう やっ て 実装 する か を 見 て みよ う 。

これ で 暗号化 を 実装 し た ので 、 暗号化 を 使っ て 文字列 を 変換 できる よう に いくつか 関数 を 作ろ う 。

暗号化 を 扱う 基本 的 な 道具 が 揃っ た ところ で 、 これから 遭遇 する 暗号 を 解読 する という 問題 について 考え て みよ う 。
線形回帰 と 同様 に 、 換字式暗号 を 解読 する 問題 を 、 いくつか の 部分 に 分け て 解い て いく こと に する 。

1 . 提案 さ れ た 復号 化 ルール の 良さ に対する 指標 を 定義 する 。
2 . 現在 の 最良 の ルール を 無作為 に 変更 する こと によって 、 新しい 復号 化 ルール 候補 を 提案 する ため の アルゴリズム を 定義 する 。
3 . 漸次 的 により 良い 復号 化 ルール へ 近づく ため の アルゴリズム を 定義 する 。

復号 化 ルール の 良さ に関する 指標 について 取り掛かる ため 、 換字式暗号 によって 暗号 化 さ れ た と わかっ て いる ある テキスト の 断片 を 与え られ た と しよ う 。
例えば 、 ユリウス・カエサル † が 暗号化 メッセージ を 送っ て き た と し たら 、 それ は おそらく 「 wfojwjejwjdj 」 の よう な もの で あろ う 。
シーザー暗号 を 逆 適用 する と 、 この テキスト は 「 venividivici 」 という 有名 な フレーズ に なる ††。

ここ で は 暗号 化 さ れ た テキスト の 一部 が 与え られ 、 元 の メッセージ が 標準 的 な 英語 で 書か れ て いる と いう という 保証 が ある と 想像 し て みよ う 。
この 場合 、 どう やっ て 復号 化 に 取り掛かれ ば 良い だろ う か 。

ここ で 問題 を 解く ため に 取る アプローチ は 、 もし ある ルール が 暗号化 メッセージ を 人間 が 見 て わかる 通常 の 言葉 に 変換 する の で あれ ば 、 その ルール は 良い という もの で ある 。
ある 提案 さ れ た 復号 化 ルール が ある とき 、 それ を 暗号 化 さ れ た テキスト に 適用 し 、 出力 が 現実的 に 有り得 そう な 文 か どう か を 見る の で ある 。
例えば A , B という 提案 さ れ た 2つ の 復号 化 ルール が あり 、 それら の 結果 が 以下 の よう に なっ た と する 。

2つ の 復号 化 ルール の 結果 を 見れ ば 、 明らか に ルール A より も ルール B の 方 が 良い という こと が わかる 。
この 直観 的 な 判断 は どの よう に なさ れる の だろ う 。
B が A より も 良い の は 、 ルール B の テキスト の 方 が A の テキスト と 比べ て 実際 の 言語 の よう に 見える こと 、 そして ルール A の テキスト は 全く 意味 が わから ない こと による もの で ある 。
この 人間 の 直観 を コンピュータ に プログラム として 与え られる 自動的 な もの に 変える ため に は 、 現れる あらゆる 単語 に対して 確率 を 与える 語彙 データベース を 使う と 良い 。
そう する こと で 、 実際 の 言語 は 高い 確率 を 持つ 単語 から でき た テキスト と 等価 で ある 一方 、 でたらめ な 言語 は 低い 確率 を 持つ 単語 から でき た テキスト と 等価 と なる 。
この 手法 で 唯一 難しい の は 、 全く 存在 し ない 単語 の 扱い で ある 。
その よう な 単語 の 確率 は ゼロ で あり 、 テキスト の 確率 は 、 各 単語 の 確率 を 掛け合わ せる こと によって 求める ため 、 ゼロ を 何 か 非常 に 小さい もの 、 例えば コンピュータ が 表現 できる 浮動小数点数 の 最小 の 差異 の よう な もの で 置き換える 必要 が あり 、 これ を これ 以降 は イプシロン と 呼び 、 ここ で の アルゴリズム で 用いる 。
この よう な 例外 ケース を うまく 処理 できれ ば 、 語彙 データベース を 使い 、 各 単語 の 確率 を 求め 、 これら の 確率 を 掛け合わ せ て テキスト 全体 の 確率 値 を 推定 する こと によって 2つ の 復号 化 さ れ た テキスト の 品質 を 、 順位 付け できる 。

語彙 データベース を 使っ て 復号 化 し た テキスト の 確率 を 計算 する と 、 提案 さ れ た 復号 化 ルール に対する 誤差 指標 を 得る こと が できる 。
この よう に 誤差関数 を 定義 する と 、 ここ で の 暗号解読 問題 は 完全 に 最適化問題 と なる ため 、 単に 高い 確率 の テキスト を 生成 する 復号 化 ルール を 見つけれ ば 良い という こと に なる の だ 。

残念 な こと に テキスト の 確率 が 最大 と なる ルール を 見つける 問題 は 、 optim で うまく 行く よう な 問題 と は 似 て も 似つか ない もの で ある 。
復号 化 ルール は グラフ に 書け ず 、 optim が より 良い ルール に 向かわ せる 際 に 必要 と なる グラフ の なめらか さ も ない 。
そのため ここ で の 復号 化 問題 を 解く ため に は 、 全く 新しい 最適化 アルゴリズム が 必要 と なる 。
その アルゴリズム と は 、 本節 の 最初 で すで に 述べ た メトロポリス 法 で ある 。
メトロポリス 法 は 、 ここ で の 問題 で は 比較的 うまく 行く こと が わかっ た が 、 実際 ある程度 の 長 さ を 持つ テキスト に対して は とてもとても 遅い †。

メトロポリス 法 の 基本 的 な 考え方 は 、 任意 の 復号 化 ルール から 始め 、 繰り返し 的 に それ を 改善 し 、 現実的 に 正しい ルール に たどり着く という もの で ある 。
これ は 最初 魔法 の よう に 思える かも しれ ない が 、 現実 で は うまく 行く こと が 多い ので 、 実験 で それ を 実感 し て ほしい 。
そして 復号 化 ルール の 候補 が 得 られ たら 、 意味 的 な 妥当 性 と 文法 に関する 人間 の 直観 を 使い 、 テキスト を 正しく 復号 化 でき た か を 判断 できる 。

良い ルール を 作る ため に は 、 完全 に 任意 な ルール から 始め て 、 ルール を 改善 する 単一 の 操作 を 、 例えば 50 , 000 回 など 数多く 繰り返す 。
各 ステップ で は 基本的 に は より 良い ルール の 方向 に 行く ので 、 この 操作 を 何回 も 繰り返す こと により 、 最終的 に は 妥当 な ところ へ 落ち着く 。
もっとも 、 望む ところ へ たどり着く ため に 必要 な ステップ 数 は 、 50 , 000 , 000 ステップ で は なく 50 , 000 ステップ で 済む かも しれ ない が 、 その 保証 は どこ に も ない 。
これ が 、 この アルゴリズム が 実際 の 真面目 な 暗号解読 に対して うまく 使え ない 理由 で ある 。
この アルゴリズム が 現実 的 な 時間 で 解 に たどり着く 保証 は なく 、 しかも 待っ て いる 際 に 、 正しい 方向 に 向かっ て いる か どう か を 知る こと さえ 非常 に 難しい 。
この ケーススタディ は 、 最適化 アルゴリズム を どの よう に 使え ば 、 他の方法 で は 解く の が 非常 に 難しい 複雑 な 問題 を 解く こと が できる か 、 という こと を 見せる 非常 に 単純 な 例 な の だ 。

新しい 復号 化 ルール を どう やっ て 提案 する か について もう少し 詳しく 見 て みよ う 。
これ は 、 現在 の ルール を ランダム に 一 カ所 だけ 変化 さ せる こと により 作る 。
つまり 、 ある 1つ の 入力 文字 に対する 影響 を 変える こと により 、 現在 の ルール を 変化 さ せる という こと で ある 。
例えば 、 もし 「 a 」 が 現在 の ルール に従い 「 b 」 に 変換 さ れる の で あれ ば 、 新しい 変更 ルール で は 、 「 a 」 が 「 q 」 に 変換 さ れる よう に する 。
換字式暗号 の しくみ から する と 、 これ によって 、 ルール 中 の 他 の 文字 が 割り当て られ て い た ところ も 変える 必要性 が あり 、 この 場合 は 「 c 」 を 「 q 」 に 変える 部分 が それ だ 。
暗号 が うまく 動く よう に する に は 、 「 c 」 を 今度 は 「 b 」 に 変え なけれ ば なら ない 。
したがって 新しい ルール を 提案 する アルゴリズム は 、 結局 の ところ 既存 の ルール の 2つ の 場所 を 変更 する という もの で ある 。
1つ は ランダム に 選択 し た ところ 、 もう 1つ は 換字式暗号 の 定義 によって 自動的 に 決まっ て くる ところ で ある 。

単純 に 考えれ ば 、 もし この 新しく 提案 さ れ た ルール が 、 復号 化 さ れ た テキスト の 確率 を 増やす の で あれ ば 、 それ を 採用 すれ ば 良い よう に 思える 。
これ は 貪欲 最適化 と 呼ば れ て いる 。
ところが この 場合 、 貪欲 最適化 で は あまり 良く ない ルール に 行き詰っ て しまう 傾向 が ある ため 、 以下 の 貪欲 で は ない 方法 を 使い 、 元 の ルール A と 新しい ルール B を 決定 する 。

1 . もし 、 ルール B で 復号 化 さ れ た テキスト の 確率 が 、 ルール A で 復号 化 さ れ た テキスト と の 確率 より も 大きけれ ば 、 A を B で 置き換える 。
2 . もし ルール B で 復号 化 さ れ た テキスト の 確率 が 、 ルール A で 復号 化 さ れ た テキスト の 確率 より も 小さけれ ば 、 毎回 で は なく 時々 、 A を B で 置き換える 。
具体的 に は 、 ルール B で 復号 化 さ れ た テキスト の 確率 を 確率 B 、 ルール A で 復号 化 さ れ た テキスト の 確率 を 確率 A と する と 、 確率 B / 確率 A パーセント の 確率 で ルール B に 切り替える 。

もし この 割合 が 唐突 に 出 て き た よう に 思え た として も 心配 する 必要 は ない 。
直観 的 に は 、 本当に 大切 な の は 具体 的 な 比 の 値 で は なく 、 ルール B を 採用 する 確率 は ゼロではない という こと で ある 。
これ が 貪欲 最適化 を 用い た 場合 に 陥っ て しまう 罠 を 避ける 手助け と なる 。

メトロポリス 法 を 使っ て 様々 な 暗号 を より分ける 前 に 、 上 で 述べ た よう な 変更 し た 暗号 ルール を 作る ため に いくつか の ツール が 必要 で ある 。

新た な ルール を 提案 する この ツール と 、 上 で 定義 し た ルール を 入れ替える 手続き を 組み合わせる こと で 、 現在 の ルール より も 低い 確率 を 持つ 明らか に 良く ない ルール で 時間 を 無駄 に する こと なく 、 ここ で の 最適化 アプローチ の 「 貪欲さ 」 を 軽減 する こと が できる 。
アルゴリズム によって どの よう に 軽減 する か と いう と 、 単に 確率 B / 確率 A を 計算 し 、 その 値 を 0 から 1 の 間 の 乱数 と 比較 すれ ば 良い 。
もし 結果 の 乱数 が 確率 B / 確率 A より 大きけれ ば 、 現在 の ルール を 置き換える 。
そう で なけれ ば 置き換え ない 。

これ まで に 何回 も 出 て き た 確率 を 計算 する ため に 、/usr/share/dic/words の 各 単語 が どの ぐらい の 頻度 で ウィキペディア の テキスト に 出現 し た か を 表す 語彙 データベース を 作成 し た 。
この データベース を R に 読み込む に は 、 以下 の よう に する 。

簡単 な 単語 で 検索 し 、 サンプル テキスト 中 で の その 頻度 を 見る こと により 、 データベース の だいたい の 感覚 が つかめる で あろ う （ 表 7-2 ） 。

語彙 データベース の 準備 が でき たら 、 次 は テキスト の 確率 を 計算 する 何らかの 手法 が 必要 で ある 。
まず はじめ に 、 データベース から 確率 を 取っ て くる 処理 を ラップ する 関数 を 書こ う 。
この 関数 を 書く こと により 、 最も 低い 確率 の 値 （ マシン の 浮動 小数点 の イプシロン ） を 未知語 に 割り当てる 処理 が 簡単 に なる 。
R で その 値 を 取得 する に は 、 変数 Machine$double.eps を 使う 。

個別 の 単語 の 確率 を 見つける メソッド が でき たら 、 次 は テキスト の 確率 を 計算 する ため に 、 テキスト を 別々 の 単語 に 分解 し て 別々 に 確率 を 計算 し て から 、 それら を 掛け合わ せる こと によって 1つ に 戻す メソッド を 作る 。
残念 ながら 確率 値 を そのまま 使う と 、 乗算 を 行う 際 の 浮動 小数点 の 演算 精度 は 有限 で ある ので 、 数値 的 に 不安定 に なっ て しまう 。
この ため 実際 に は テキスト の 対数 確率 と よば れる 、 テキスト 中 の 各 単語 の 対数 確率 の 単なる 和 の 値 を 計算 する 。
この 値 は 、 数値 的 に 不安定 で は ない こと が わかる 。

これ で 実際 の 操作 を 行う 構成要素 が すべて 揃っ た ため 、 メトロポリス 法 の 1 サイクル を 以下 の よう に 書く こと が できる 。

これ で 最適化 アルゴリズム の 各 ステップ が すべて 動く よう に なっ た ので 、 それ が どの よう に 動く か を 見る ため に 、 単一 の プログラム 例 に まとめ て みよ う 。
まずは 生 テキスト を R の 文字 ベクトル として 準備 する 。

この テキスト を シーザー暗号 を 用い て 暗号 化 する 。

そして ランダム の 復号 化 暗号 を 作り 、 メトロポリス 法 の サイクル を 50 , 000 回 実行 し て 、 結果 を results という データ フレーム に 格納 し て おく 。
各 ステップ で は 、 復号 化 し た テキスト の 対数 確率 、 サンプル テキスト の 復号 化 結果 、 入力 テキスト を 正しく 復号 し た か どう か を 表す ダミー 変数 を 保持 し て おく 。

もちろん 、 本当に 秘密 の 暗号 を 解読 しよ う と し て いる なら 、 テキスト を いつ 正しく 復号 でき た か どう か は わかる 術 も ない の で ある が 、 デモ の 目的 の ため に は 、 この 記録 を 持っ て おく と 都合 が 良い 。

この コード を 走ら せる に は 少し ばかり 時間 が かかる ため 、 待っ て いる 間 に 表 7-3 に 載せ た 結果 の サンプル を 見 て みよ う 。

見 て わかる よう に 、 45 , 000 ステップ 後 に は 正しい 復号 結果 に 近づい て いる が 、 まだ 到達 し て は い ない こと が わかる 。
そして 結果 を さらに 良く 見 て みる と 、 45 , 609 行 目 で 正しい テキスト に 到達 し て いる が 、 その 正しい ルール を 通り越し て 、 違う ルール に 移っ て しまっ て いる の が 発見 できる だろ う 。
実は これ が 、 ここ で 用い た 目的 関数 の 問題 点 で ある 。
この 目的 関数 は 復号 化 さ れ た もの が 英語 の 文 か どう か では なく 、 各 単語 が すべて 通常 の 英語 の 単語 か どう か を 調べ て いる だけ な の で ある 。
もし ルール を 変える こと によって 、 より 有り得 そう な 単語 が 得 られる と し たら 、 たとえ ルール を 変え た 結果 が 文法 的 に おかしかっ たり 、 意味 的 な 整合 性 が なかっ たり し て も 、 その 方向 に 移っ て しまう 傾向 が ある 。
例えば 2 単語 の 連続 の 確率 など 、 英語 に関する 情報 を もっと 使っ て 、 この 問題 を 回避 する こと も できる だろ う 。
とりあえず この 問題 によって 、 アドホック な 目的 関数 と共に 最適化 アプローチ を 使う 際 の 複雑 さ が 明確 に なっ た と 考え て おこ う 。
自分 が ほしい 解 と 、 ルール が ベスト だ と 判定 し た 解 は 異なる こと が ある の だ 。
最適化 を 用い て 問題 を 解く 際 に は 、 人間 を プロセス の 中 に 組み入れる 必要 が ある 。

実は 、 ここ で 用い た 目的 関数 が 英語 が どの よう な テキスト で ある か という こと に関する 十分 な 知識 を 含ん で い なかっ た という 問題 より も 、 事情 は さらに 複雑 な の で ある 。
まず 第 一 に 、 メトロポリス 法 は 必然的 に ランダム 性 を 伴う 最適化 手法 で ある 。
運 の 良い こと に 、 今回 開始 し た 1 という シード 値 は 良かっ た が 、 悪い シード 値 を 使う と 、 正しい 復号 ルール に 到達 する ため に 何 兆 ステップ も かかっ て しまう こと に なり かね ない 。
これ は 、 シード の 値 を 変え ながら 、 各 シード について 最初 の 1 , 000 ステップ だけ を 実行 し て みる と 納得 が 行く で あろ う 。

第 二 に 、 メトロポリス 法 は 、 常に 良い 復号 化 ルール に 達し て も そこ から 次に 移っ て しまう 傾向 が ある 。
メトロポリス 法 は この おかげ で 貪欲 で は ない アルゴリズム に なる 。
しかし アルゴリズム の 経過 を ずっと 観察 し て いる と 、 そう で ある が ゆえに 見つけ て ほしかっ た 解 を 見捨て て しまう の を しばしば 見る こと が できる 。
図 7-6 に 、 各 ステップ ごと の 対数 確率 の 遷移 を 示し た 。
この 手法 の 動き が いかに 不規則 で ある か が わかる だろ う 。

この ランダム な 動き に 対処 する ため に よく 用い られる 方法 が いくつか ある 。
1つ は 、 時間 が 経つ につれて 貪欲 で は ない ルール を 採用 する 回数 を 減らし 、 手法 の 動き を だんだん と 貪欲 に し て いく という 方法 で ある 。
これ は 焼きなまし法 と 呼ば れる 、 最適化 の ため の 強力 な 方法 で あり 、 ここ で の 例 で は 、 新しい 復号 化 ルール を 採用 する 際 の 方法 を 変える だけ で 実験 する こと が できる †。

この ランダム さ に 対処 する もう 1つ の 方法 は 、 それ を 逆 に 利用 し て 単一 の 正解 で は なく 、 可能 な 解 の 分布 を 求める という 方法 で ある 。
これ は ここ で の 暗号化 問題 で は あまり 役に立た ない 。
しかし 正解 が 数字 で 表さ れる よう な 問題 なら ば 、 いろいろ な 正解 の 候補 を 作り出す こと は とても 役に立つ 。

本章 で 最適化 が 一般的 に どの よう に 動く か 、 機械学習 における 複雑 な 問題 を 解く の に それ を どの よう に 使う か 、 という こと について 一定 の 知見 が 得 られ た と 願っ て いる 。
この 考え は 以降 の 章 、 特に 推薦 システム について 語る 際 に 、 再度 使う こと に なる 。

ここ まで は 、 データ を 使っ た 作業 は すべて 予測 タスク に 基づく もの で あっ た 。
つまり 電子メール や ウェブ の ページビュー など を 分類 する という よう な 、 正しい 答え を 知っ て いる 事例 の 訓練 セット が ある もの を 対象 として きた 。
本書 の 前半 に 述べ た よう に 、 正しい 答え の 与え られ て いる 訓練 サンプル の ある データ から 学習 する こと は 、 教師 あり 学習 と 呼ば れ て いる 。
教師 あり 学習 で は 、 データ における 構造 を 見つける にあたって 、 本当 の パターン を うまく 見つけ られ た か どう か という 信号 を 使っ て いる 。

しかし 、 うまく いっ て いる か どう か という 答え を 使わ ず に 構造 を 見つけ たい こと も ある 。
これ を 教師 なし 学習 と 呼ぶ 。
例えば 、 列 の 数 が 大量 に ある テーブル を 、 列 の 数 が より 少ない テーブル に 収縮 さ せる 次元 縮退 を し たい こと も ある だろ う 。
扱わ なけれ ば なら ない 列 の 数 が あまりに 多 すぎる 場合 、 この 次元 縮退 によって データセット が ずっと 理解 し やすく なる 。
多く の 列 を 単一 の 行 で 置き換え て しまう と 明らか に 情報 は 失わ れる が 、 理解 の し やすさ の 意味 で の メリット は 、 特に 新しい データセット を 調べ て いる とき に 重要 と なる 。

この 種 の 次元 縮退 が 特に 役に立つ の は 、 株式市場 データ を 扱っ て いる とき で ある 。
例 として 表 8-1 に 示し た よう な 、 2002年 1月2日 から 2011年 5月25日 まで の 期間 にわたる 25 銘柄 の 本物 の データ 株価 履歴 を 使う こと に しよ う 。

ここ で は 3 列 しか 示し て い ない が 、 実際 の データ に は 25 列 あり 、 これ は 全体 を 理解 し て 扱う に は あまりに も 多 すぎる 。
ここ で 使える 25 列 の 情報 を 組み合わせ て 一日 ごと に 市場 が どの よう に 動い て いる か が わかる よう な 列 を 1つ だけ 作り たい 。
この 単一 の 列 を 市場 の 指標 と 呼ぶ こと に する 。
さて 、 どの よう に 作っ たら 良い だろ う 。

最も 単純 な 方法 は 、 主成分分析 （ principal componentsanvalysis ： PCA ） と 呼ば れる 手法 を 使う こと で ある 。
PCA の 主 な 考え方 は 、 データ の 生 の 情報 を どの ぐらい たくさん 含ん で いる か という こと に 基づい て 順に 並ん で いる 新た な 25 列 を 作る という もの で ある 。
新しい 最初 の 列 は 、 第 一 主成分 、 もしくは 単に 主成分 と 呼ば れ 、 データセット 全体 の 構造 の 大 部分 を 含ん で いる こと が 多い 。
PCA は データセット の 列 の 間 に すべて 強い 相関 が ある とき に 特に 効果 的 で ある 。
この 場合 、 相関 の ある 列 同士 を 、 両方 の 列 の 相関 を 説明 する 隠れ た パターン に 沿う よう な 単一 の 列 で 置き換える こと が できる 。

さて 、 実際 の データセット で 列 が どの ぐらい 相関 し て いる か を 見 て 、 PCA が うまく 行く か どう か を 確かめ て みよ う 。
これ を する ため に は 、 まず 生データ セット を R に 読み込む 必要 が ある 。

ここ で の 生データ は そのまま 処理 し やすい 形式 に なっ て い ない ため 、 何らかの 前 処理 が 必要 で ある 。
最初 の ステップ は 、 生 の 日付 文字列 を 正しく エンコード さ れ た 日付 変数 に 変換 する こと で ある 。
そのため に CRAN の lubridate パッケージ を 使う 。
この パッケージ で は 、 年月日 形式 の 文字列 を 日付 オブジェクト に 変換 する ymd という 便利 な 関数 が 提供 さ れ て いる 。

日付 の 処理 が 終わっ たら 、 reshape ライブラリ の cast 関数 を 使い って 本章 の 最初 で 見 た 表 の よう な データ 行列 を 作る こと が できる 。
この 表 で は 、 一行 が 一日 に 対応 し 、 一列 が 一 銘柄 に 対応 する 。
これ は 以下 の よう に 行え ば 良い 。

cast 関数 で は 、 行 を 定義 する ため に どの 列 を 使う か を チルダ の 左側に 、 結果 の 列 を 右側に 指定 する 。
結果 内 の 実際 の 項目 は value を 使っ て 指定 する 。

この よう に 巨大 な 日付 ・ 株価 行列 を 作っ た 結果 を 見 て みる と 、 項目 が いくつか 抜け て いる ところ が ある の に 気付く はず だ 。
そこで 株価 データセット を 見直し 、 不完全 な 項目 を 削除 し て から cast を 再度 実行 する 。
不完全 な 項目 を 削除 し た 後 、 再度 cast を 実行 し て 我々 の 求める 行列 を 生成 する 。
そう すれ ば 行列 の すべて の 数値 列 間 の 相関 を cor 関数 を 使っ て 調べ られる 。
そして 相関 行列 を 単一 の 数値 ベクトル に 変換 し て 相関 の 密度 プロット を 作成 する こと により 、 （ a ） 相関 の 平均 と 、 （ b ） 低い 相関 の 起こる 頻度 の 感覚 を つかむ こと が できる 。

結果 の 密度 プロット を 、 図 8-1 に 示し た 。
ここ から 明らか な よう に 相関 の 大 部分 は 正 の 値 に なっ て いる ため 、 この データセット を 使え ば PCA は おそらく うまく 行く はず だ 。
PCA が 使え そう だ と わかっ た が 、 では R で どの よう に すれ ば 良い で あろ う か 。
ここ でも また 、 R の 良さ が 活きる こと に なる 。
PCA 全体 が 1 行 の コード で 実行 できる から だ 。
princomp 関数 を 使え ば PCA を 実行 する こと が できる の で ある 。

これ で 続い て pca と だけ 入力 すれ ば 、 主成分 の 簡単 な 要約 を 見る こと が できる よう に なっ た 。

この 要約 で は 、 データセット の 分散 の うち どの ぐらい が それぞれ の 主成分 によって 占め られ て いる か が 標準偏差 から わかる 。
Comp.1 と 呼ば れ て いる 第 一 成分 は 分散 の 29% の 占め 、 次 の 成分 は 分散 の 20% を 占め て いる 。
最終的 に は 、 最後 の 成分 Comp.24 は 、 分散 の 1% 以下 しか 占め て い ない 。
この こと から 最初 の 主成分 だけ を 見る だけ でも 、 データ について 多く の こと を 学ぶ こと が できる こと が わかる 。
loadings （ 負荷 ） を 見る と 、 第 一 主成分 で ある 、 各 成分 が 各 列 に どの ぐらい 重み を 持つ か を を より 詳しく 調べる こと が できる 。

負荷 は pca に 保存 さ れ た princomp の loadings 要素 を 抽出 する こと で 得 られる 。
loadings を 抽出 する と 、 25 個 の 各 列 が 各 成分 に どの ぐらい 含ま れ て いる か を 示す 巨大 な 行列 が 得 られる 。
実際 に は 第 一 主成分 に しか 関心 が ない ので 、 pca 負荷 の 最初 の 列 を 取り出せ ば 良い 。

その後 負荷 の 密度 プロット を 調べ 、 第 一 主成分 が どの よう に し て でき て いる か という 感覚 を つかも う 。

この 結果 を 図 8-2 に 示し た 。
この プロット を 見る と 、 負荷 の 綺麗 な 分布 が 得 られる が 、 ほとんど が 負 で あり 、 この 結果 は 少し 疑わしい ところ が ある 。
これ が どの よう な 影響 を 持つ か は すぐ 後 に 述べる 。
実は これ は 取る に 足ら ない もの で 、 一行 コード を 書け ば 直る よう な もの で ある 。

これ で 第 一 成分 が 得 られ た ため 、 ここ で の データセット を 1 行 で 要約 し た もの を 生成 し たい 。
そのため に は predict 関数 を 使え ば 良い 。

この 予測 値 が 良い か どう か は どう し たら わかる だろ う か 。
ありがたい こと に 、 今回 は 結果 を 比較 できる 有名 な 市場 指数 が 複数 ある ため 、 結果 が 良い か どう か を 簡単 に 判断 できる 。
今回 は ダウ平均株価 （ DowJonesIndex 、 今後 は DJI と 表記 ） を 使う 。

DJI は 以下 の よう に し て R に 読み込む 。

DJI は 今回 必要 な 分 より も はるか に 長い 期間 の もの が 存在 し て いる ので 、 対象 と する 日付 の 分 だけ を 含む 一部 を 取り出す 必要 が ある 。

その後 DJI に 含ま れる 情報 の 中 から 今回 の 演習 で 利用 する 部分 、 つまり 日 ごと の 終値 と その 日付 を 抽出 する 。
この データ は 現在 扱っ て いる データセット と 逆 の 並び 順 で 記録 さ れ て いる ので 、 rev 関数 を 使っ て 反転 さ せる 。

これ で PCA で 生成 し た 市場 指標 と DJI と を 可視 化 し て 比較 する こと が 可能 に なっ た 。

この 最初 の プロット を 図 8-3 に 示し た 。
見 て わかる よう に 、 以前 に 見 た とき 疑わしかっ た 負 の 負荷 の 値 は 、 ここ で 困っ た 問題 を 引き起こし て いる 。
つまり 指標 が DJI と 負 の 相関 を 持っ て しまっ て いる 。

しかし これ は 簡単 に 修正 できる 。
指標 に -1 を 乗じ 、 DJI と 正しい 方向 に 相関 を 持っ て いる 指標 を 作れ ば 良い 。

もう一度 比較 を 実行 し て みよ う 。

図 8-4 から わかる よう に 、 自作 の 指標 の 方向 を 修正 し た ため 、 今回 は DJI に 非常 に 良く 当てはまっ て いる よう に 見える 。
残っ た の は 、 時間 軸 上 で 見 た とき に 、 自作 の 指標 が DJI に どの ぐらい うまく 沿っ て いる か という 感覚 を つかむ こと で ある 。

この 比較 を する の は 簡単 で ある 。
まずは melt 関数 を 使っ て 、 両方 の 指標 を 同時に 可視 化 する ため に 操作 し やすい data.frame を 作る 。
そして x 軸 が 日付 、 y 軸 が 各 指標 の 価格 で ある よう な 折れ線 プロット を 作る 。

この 1回目 の 実行 時 に は 、 DJI は 非常 に 大きい 値 を 取る に も かかわら ず 自作 の 指標 は 非常 に 小さい 値 に なる ため 、 あまり 見栄え が 良く ない 。
ただし これ は 、 scale を 使っ て 両方 の 指標 を 共通 の スケール に 載せれ ば 直す こと が できる 。

それ に 続い て 折れ線 プロット を 再度 作成 し て 結果 を 再度 確認 する （ 図 8-5 ） 。
この プロット で は 、 完全 に PCA だけ を 用い て 作成 し 、 株式市場 分野 の 知識 を 全く 使わ なかっ た 自作 の 指標 が 、 DJI に 非常 に 良く 沿っ て いる こと が わかる 。
つまり PCA を 使う こと で 、 株式市場 の 全体 的 な パフォーマンス を 表現 できる よう に 注意深く 設計 さ れ て いる 指標 と よく 似 た もの が 作れる 。

PCA が 、 たとえ 何 か を 予測 しよ う と し て い ない 時 でも 、 自前 の データ を 単純 化 し て データ の 構造 を 発見 する のに 大きな 貢献 を し て くれる 強力 な ツール で ある という こと が 、 この 例 から わかっ て いただけれ ば と 思う 。
もし これら の 話題 に 興味 が あれ ば 、 独立成分分析 （ ICA ） について も 調べ て みる こと を おすすめ する 。
これ は 、 PCA が うまく いか ない 環境 で 威力 を 発揮 する もの で 、 PCA の 代わり に 使う こと が できる もの だ 。

ある グループ の メンバー の 互い の 類似 度 を 知り たい という こと は よく ある こと だ 。
例えば 、 あなた が ブランド マーケティング 会社 に い て 、 新ブランド の 潜在 力 の 研究 調査 を 完了 し た ばかり だっ た と しよ う 。
この 調査 で は 、 ある グループ の 人々 に この ブランド の 特徴 を いくつか 示し 、 5 段階 評価 を 使っ て それぞれ の 特徴 に関して ブランド を 順位 付け し て もらっ た 。
同時に それら の 対象者 の 年齢 、 性別 、 人種 、 現住所 の 郵便番号 、 おおよそ の 年収 など の 社会 経済 データ も 収集 し て いる 。

この 調査 から 、 これら すべて の 社会 経済的 変数 における ブランド の 支持 度 を 知り たい 。
最も 重要 な の は 、 ブランド が 広い 顧客層 の 支持 を 得 て いる か どう か を 知る こと で ある 。
この 問題 を 別 の 見方 で 考える と 、 ブランド の 大 部分 の 特徴 を 好 む人 が 広く 多様 な 社会 経済的 特性 を 持っ て いる か どう か を 知り たい という こと に も なる 。
この ため の 手法 として 便利 な もの は 、 調査 回答者 が どの よう に クラスタリング さ れる か を 可視 化 する 方法 だろ う 。
この 方法 を 利用 し て 、 さまざま な 視覚 的 な 手がかり を 用い 、 異なる 社会 経済的 カテゴリ の 構成員 を 示す こと が できる 。
ここ から 、 性別 、 人種 、 経済的 階 層間 の どの 部分 が 大きく 交わっ て いる の か を 知り たい わけ だ 。

この 知識 を 利用 すれ ば 、 ブランド の 支持 度 に 基づい て グループ が どれ くらい 近く に クラスタリング さ れ て いる か を 知る こと も できる 。
さらに は ある グループ と 別 の グループ の 人数 の 比較 や 、 グループ 間 の 遠 さ も わかる 。
ここ から 、 さまざま な 社会 経済的 カテゴリ を ターゲット と する ブランド の 特徴 が わかっ て くる 。
これら の 問題 を 表現 する 際 に 「 近 さ 」 や 「 遠 さ 」 など の 言葉 を 使う が 、 これ は 距離 に 固有 の 概念 で ある 。
つまり グループ 間 の 距離 を 可視 化 する に は 、 個々 の 集合 度 を 表す 空間 概念 が 必要 と なる 。

本章 で は まず 一連 の 観測 値 間 の 距離 の 概念 を 使い 、 類似 度 と 相違 度 を 表す 方法 を 理解 する こと に 重点 を 置く 。
これ に は 、 分析 する データ の 種類 に 関連 し た 距離 の 尺度 を 定義 する 必要 が ある 。
例えば 仮想 の ブランド マーケティング の 場面 で は 、 調査 尺度 の 序 数 的 性質 を 利用 し 、 回答者 間 の 距離 を とても 単純 な 方法 で 求める 。
単純 に 絶対 差 を 求める の で ある 。

しかし 距離 を 求める だけ で は 十分 で は ない 。
本章 で は 観測 値 を クラスタリング する ため の 多次元尺度構成法 （ multidimensionalscaling ： MDS ） と 呼ば れる テクニック を 紹介 する 。
MDS を 適用 する と 、 すべて の 点 の 間 の 距離 の 尺度 を 利用 する だけ で データ を 可視化 できる 。
最初 に 、 模擬 データ を 使っ た 製品 顧客 評価 の 簡単 な 例 を 利用 し 、 MDS の 基本 原理 を 紹介 する 。
次に 、 米国 上院議員 の 点呼 投票 の 実際 の データ を 使い 、 得票 に 基づい て メンバー が どの よう に クラスタリング さ れ て いる か を 示す 。

まずは 、 6つ の 製品 を 評価 し た 4人 の 顧客 の 簡単 な データセット が ある と しよ う 。
それぞれ の 顧客 に は 各 製品 に対して 良い か 悪い か を 尋ね た が 、 彼ら は 意見 が ない 場合 は その 製品 の 評価 を スキップ する こと も できる 。
Pandora † や YouTube など 、 この よう な 評価 システム は いくつ も 存在 する 。
この 評価 データ を 使い 、 顧客 の 互い の 類似 度 を 測定 し たい 。

この 簡単 な 例 で は 、 行 が 顧客 を 表し 、 列 が 製品 を 表す 4 × 6 の 行列 を 用意 する 。
顧客 / 製品 の 各 ペア に対して 「 良い 」 （ 1 ） 、 「 悪い 」 （ −1 ） 、 「 スキップ 」 （ 0 ） を ランダム に 選び 、 この 行列 に 模擬 評価 を 設定 する 。
これ を 行う ため に 、 ベクトル c ( 1 , 0 ,- 1 ) から 値 を ランダム に 6回 復元 抽出 する sample 関数 を 使用 する 。
R の 乱数 ジェネレータ を 使っ て データ を シミュレート する ので 、 ジェネレータ の シード に ここ で 使用 した値 と 同じ 値 を 設定 し 、 出力 が この 例 の 表示 と 同じ に なる よう に する こと が 重要 だ 。
シード を 設定 する に は 、 set.seed () を 呼び出し て ジェネレータ の シード を 数値 851982 に 設定 する 。

この コード は 4 × 6 の 行列 を 作成 し 、 各 エントリ は 製品 （ 列 ） に対する ユーザ （ 列 ） 評価 に 対応 する 。
この 例 で は 、 単に 状況 （ 顧客 A 〜 D 、 製品 1 〜 6 ） を 明確 に する ため に row.names 関数 と colnames 関数 を 使っ て いる 。
この 行列 を 調べれ ば 、 この 簡易 データ の 設定 状況 が 正確 に わかる 。
例えば 顧客 A は 製品 2 と 4 を 「 悪い 」 と 評価 し 、 その他 の 製品 は 評価 し て い ない 。
一方 で 顧客 B は 製品 1 を 「 悪い 」 と 評価 し て いる が 、 製品 3 、 4 、 5 は 「 よい 」 と 評価 し て いる 。
続い て この 違い を 利用 し て すべて の 顧客 間 の 距離 尺度 を 作成 する 。

この データ を 使っ て 距離 尺度 を 作成 する 最初 の ステップ は 、 各 製品 の 顧客 評価 を 、 現在 の 形式 の よう に 製品 に対して だけ で なく 、 他 の すべて の 顧客 と の 関連 で 要約 する こと で ある 。
別 の 考え方 を する と 、 N×M 行列 を N×N 行列 に 変換 し 、 新しい 行列 の 要素 が 製品 評価 に 基づい た ユーザ 間 の 関連 の 要約 を 示す よう に する 必要 が ある 。
これ を 実現 する に は 、 行列 に その 転置行列 を 掛ける 方法 が ある 。
この 乗算 の 結果 は 、 元 の 行列 の 列 の すべて の ペア 間 の 相関 を 計算 する という もの で ある 。

行列 の 転置 と 乗算 は 、 離散数学 や 線形代数 の 授業 の 最初 の 数 週間 で 学習 する 項目 で ある 。
教師 の やり方 によって は 、 この 変換 を 苦労 し て 手書き で 行っ た かも しれ ない 。
嬉しい こと に 、 R は この 変換 を 嫌がら ず に 行っ て くれる 。

本節 で は 行列 演算 と 評価 データ の 距離 尺度 を 作成 する 際 の 行列 演算 の 使い方 の 概要 を 示し て いる 。
すでに 行列 演算 に 馴染み が ある 場合 は 本節 を 読み 飛ばし て も かまわ ない 。

行列 転置 は 、 行 が 列 に なり 、 列 が 行 に なる よう に 行列 を 反転 さ せる 。
見た目 に は 、 転置 は 行列 を 時計回り に 90度 回転 さ せ 、 垂直 方向 に 反転 さ せる 。
例えば 前述 の コード ブロック で は 顧客 × 評価 の 行列 ex.matrix を 示し て いる が 、 以下 の コード ブロック で は 、 t 関数 を 使っ て 行列 を 転置 する 。
すると 結果 として 評価 × 顧客 の 行列 を 得る こと が できる 。

行列 の 乗算 は もう少し 複雑 だ が 、 使う の は 基本 的 な 計算 だけ で ある 。
2つ の 行列 を 掛ける に は 、 最初 の 行列 の 行 と 2番 目 の 行列 の 列 に対して ループ する 。
行 と 列 の 各 ペア に対し 、 エントリ の 各 ペア を 掛け 、 合計 する 。
すぐ に 簡単 な 例 を 見 て いく が 、 行列 の 乗算 を 実行 する とき に 注意 す べき 重要 事項 が いくつか ある 。
まず 、 最初 の 行列 の 行 要素 と 2番 目 の 行列 の 列 要素 を 掛け て いる ので 、 2つ の 行列 の これら の 次元 が 一致 し て い なけれ ば いけ ない 。
この 例 で は 、 単純 に ex.matrix と 2×2 の 行列 を 掛ける こと は でき ない 。
後 に わかる よう に 、 この 算術 は うまく いか ない 。
この よう に 行列 の 乗算 の 結果 は 必ず 、 最初 の 行列 と 同じ 行 数 を 持ち 、 2番 目 の 行列 と 同じ 列 数 を 持つ 。

この こと から 、 行列 の 乗算 で は 順序 が 重要 で ある という 結果 が すぐ に 導か れる 。
この 例 で は 、 顧客 間 の 差 を 要約 する 行列 が ほしい ので 、 顧客 × 評価 の 行列 に その 転置行列 を 掛け 、 積 として 顧客 × 顧客 の 行列 を 取得 する 。
逆 を 行う と （ すなわち 、 評価 × 顧客 の 行列 に その 行列 自体 を 掛ける と ） 、 評価 間 の 差 が 入手 できる 。
この 評価 間 の 差 に関する 情報 は 他 の 状況 で は 興味深い かも しれ ない が 、 現時点 で は 役に立た ない 。

図 9-1 で は 、 行列 の 乗算 の やり方 を 段階的 に 説明 し て いる 。
左上 は ex.matrix で あり 、 右上 は その 転置行列 で ある 。
この 2つ の 行列 の 乗算 を 行い 、 この 順序 で 掛け合わ せる 。
乗算 処理 の 例 として 、 ex.matrix の 行 A と 転置行列 の 列 B を 強調 し て いる 。
行列 の 真下 に は 、 行列 の 乗算 の 計算 方法 を 示し て いる 。
これ は 単純 で あり 、 最初 の 行列 の 行 要素 を 取り出し 、 2番 目 の 行列 の 対応 する 列 要素 を 掛け て いる だけ で ある 。
そして 、 それぞれ の 積 を 合計 する 。
この よう に 、 結果 として 生じる 顧客 × 顧客 の 行列 の A 、 B 要素 は −1 で あり 、 これ が 行 × 列 の 要約 の 結果 で ある 。

また 、 図 9-1 で は R の 表記法 も 紹介 し て おり 、 この 表記法 は 行列 の 乗算 を 行う 以前 の コード ブロック で も 繰り返し 使っ て いる 。
R で は %*% 演算子 を 使っ て 行列 の 乗算 を 実行 する 。
新しい 行列 の 解釈 は 極めて 簡単 で ある 。
1 、 −1 、 0 の コード 体系 を 使っ て いる ので 、 非 対 角 値 は 両方 とも 評価 さ れ た 製品 （ すなわち 、 非 ゼロ の エントリ ） に対する 製品 評価 の 全体 的 な 同意 （ 正 の 値 ） または 非 同意 （ 負 の 値 ） を 要約 し て いる 。
非 対 角 要素 の 正の数 が 多い ほど 同意 が 多く 、 同様 に 負 の 数 が 多い ほど 同意 が 少ない 。
エントリ は ランダム な ので 、 顧客 間 の 相違 は とても 少なく 、 1 より 大きい 値 や −1 より 小さい 値 を 取る 値 は ない 。
対 角 値 は 単に 各 ユーザ が 評価 し た 製品 数 を 表す 。

これ で ユーザ 間 の 相違 に関する 多少 有益 な 要約 を 入手 し た 。
例えば 顧客 A と D は どちら も 製品 4 を 「 悪い 」 と 評価 し て いる 。
顧客 D は 製品 1 と 3 を 好ん で いる が 、 顧客 A は 評価 し て い ない 。
つまり 情報 を 得 た 製品 に関して 、 顧客 A と D は 類似 し て いる ので 、 その 関係 に 1つ の 一致 が ある と 言える 。
残念 ながら 、 これ は 重なる 部分 に関して 言える だけ な ので 、 非常 に 限定 的 で ある 。
この 相違 から もっと 高度 な 表現 を 推測 する 手段 が ある と よい だろ う 。

そのため に 、 多次元空間 で の ユークリッド距離 の 概念 を 使う 。
1次元 、 2次元 、 または 3次元 で は 、 ユークリッド距離 は 距離 に関する 直観 を 形式 化 し た もの で ある 。
空間 で の 2点 間 の ユークリッド距離 を 求める に は 、 その 2点 間 の 最短 直線 経路 を 測定 する 。
この 例 で は 、 行列 の 乗算 で 定め られ た 全体 的 な 類似 性 と 相違性 の 尺度 に 基づい て すべて の 顧客 間 の ユークリッド距離 を 計算 し たい 。

これ を 計算 する ため に 、 各 顧客 の 評価 を ベクトル として 扱う 。
顧客 A と 顧客 B と 比較 する ため に 、 ベクトル の 差 を 取り 、 その 差 を 平方 し て 合計 し て 平方根 を 取る 。
すると 顧客 A の 評価 と 顧客 B の 評価 の 間 の ユークリッド距離 が 求まる 。

これ は 、 R の 基本 関数 sum と sq rt を 使用 し て 「 手動 で 」 実行 できる 。
以下 の コード ブロック で は 、 顧客 A と D で の ユークリッド距離 の 計算 を 示し て おり 、 約 2.236 で ある 。
ありがたい こと に 、 行列 の 行 の すべて の ペア の 距離 の 計算 は とても 一般 的 な 演算 で あり 、 R に は まさに この 計算 を 行っ て 距離 の 行列 （ これ を 距離行列 と 呼ぶ ） を 返す dist という 基本 関数 が ある 。
dist 関数 で は 距離行列 を 作成 する ため の さまざま な 距離 尺度 を 使える が 、 ここ で は デフォルト で ある ユークリッド距離 を 使う 。

この 結果 ex.dist 変数 に は 距離行列 が 含ま れる 。
この コード ブロック から わかる よう に 、 この 行列 は 実は 距離行列 全体 の 下 三角 部分 だけ で ある 。
行 X と 行 Y 間 の 距離 は行 Y と 行 X 間 の 距離 と 等しい ため 、 距離行列 は 対称 と なる はず な ので 、 距離行列 の 下 三角 部分 だけ を 示す の は とても 一般 的 で ある 。
したがって 距離行列 の 上 三 角 部分 を 示す の は 冗長 で あり 、 通常 は 表示 し ない 。
ただし 、 dist 関数 の 呼び出し 時 に upper = TRUE を 設定 する と 、 この デフォルト を 上書き できる 。

ex.dist の 下 三角 部分 の 値 から わかる よう に 、 顧客 A と D が 最も 近く 、 顧客 D と B が 最も 遠い 。
これ で 、 製品 評価 に 基づい た ユーザ 間 の 類似 度 が はっきり と わかる 。
しかし 、 この 非 類似 度 が 視覚 的 に わかれ ば さらに よい だろ う 。
MDS を 使う と 、 ここ で 計算 し た 距離 に 基づい た 顧客 の 空間 レイアウト を 作成 できる 。

MDS は 一連 の 距離 の 類似 度 と 相違 度 を 可視 化 し て 表現 する ため に 使う 統計的 手法 で ある 。
本章 で 使う 標準 的 な MDS で は 、 データセット 内 の 点 の すべて の ペア 間 の 距離 を 示す 距離行列 を 使い 、 その 2点 の 距離 を 近似 する 座標 を 返す 。
近似値 を 作成 する 必要 が ある 理由 は 、 2次元 で は すべて が 特定 の 距離 だけ 離れ て いる 点 を 見つけ られ ない 場合 が ある から で ある 。
例えば 、 2次元 で すべて が 互いに 距離 が 1 離れ て いる 4点 を 見つける こと は 不可能 で ある

標準 的 な MDS は 距離行列 の 特定 の 近似値 を 使う ので 、 機械学習 に 使う 最適化 アルゴリズム の もう 1つ の 例 と なる 。
もちろん 、 MDS の 背景 に ある 近似アルゴリズム は 3次元 や 4次元 で 利用 できる が 、 ここ で の 目的 は 可視化 が 容易 な データ 表現 を 入手 する こと で ある 。

本書 の 例 で は 、 MDS を 使っ て 2次元 で データ を 計る 。
これ は 座標 上 で データ を とても 簡単 に 可視 化 できる ので 、 最も 一般 的 な MDS の 使い方 で ある 。
しかし MDS を 使っ て より 高 次元 の データ を スケール さ せる の も 極めて 有効 で ある 。
例えば 3次元 の 可視化 で は 、 点 が 3次元 に なる ため 、 観測 値 間 の 異なる レベル の クラスタリング が 明らか に なる 。

標準 的 な MDS 手法 は cmdscale として R の 基本 関数 に 含ま れ て おり 、 必要 な 入力 は ex.dist など の 距離行列 だけ で ある 。
デフォルト で は 、 cmdscale は MDS を 2次元 で 計算 する が 、 次元 は k パラメータ で 設定 できる 。
ここ で は 距離 データ を 2次元 で 測る こと だけ に 関心 が ある ので 、 以下 の コード ブロック で は デフォルト 設定 を 使い 、 R の 基本 グラフィックス を 使っ て 結果 を プロット する 。

図 9-2 から 、 顧客 A と D は この 散布 図 の 中央 右 に クラスタリング さ れ て いる こと が わかる 。
しかし 顧客 B と C は 全く クラスタリング さ れ て い ない 。
この データ から 、 顧客 A と D は いくら か 類似性 が ある こと が わかる が 、 顧客 B と C が どの よう に クラスタリング さ れる か を 理解 する に は さらに 多く の データ や 顧客 の 情報 が 必要 で ある こと が わかる 。
また A と D が どの よう に クラスタリング さ れ 、 同様 に B と C が どの よう に クラスタリング さ れ て い ない か は わかる が 、 これら の 距離 の 解釈 方法 について は 実質的 に 何 も 言え ない という こと に 注意 する の が 重要 で ある 。
つまり A と D の 方 が 座標 平面 上 で 近い ため 類似 し て いる こと は わかる が 、 数値 距離 を 使っ て A と D の 類似 の 度合い や B や C と の 相違 の 度合い を 解釈 する こと は でき ない 。
MDS で 算出 する 正確 な 数値 距離 は 、 MDS アルゴリズム が 作り出し た 人工 的 な もの で あり 、 実質 的 な 解釈 は 非常 に 限ら れ て いる 。

本章 で は 以降 ここ で 見 た 簡単 な 例 に 似 た ケーススタディ に 取り組む 。
利用 する の は 米国 上院議員 の 点呼 投票 の 実際 の データ で ある 。
この データ は ためし に 扱う に は 大きな データ で あり 、 この データ を 使っ て 年代 順 の 議会 で 米国 上院議員 の メンバー が どの よう に クラスタリング さ れる か を 示す 。
今回 は そのため に 上院議員 の 点呼 投票 の 記録 を 使っ て 距離 尺度 を 作成 し 、 MDS を 利用 し て 上院議員 を 2次元 で クラスタリング する 。

現在 の 議会 （ 第 111 議会 ） は 、 現代 の 歴史 の 中 で イデオロギー 的 に 最も 分極 化 し て いる 。
下院 、 上院 とも に 、 最も 保守 的 な 民主 党員 の 方 が 最も リベラル な 共和党 員 より も リベラル で ある 。
議会 の 「 中心 」 を この 2 党 が 重なる 部分 と 定義 する と 、 中心 は なくなっ て しまう 。

上記 の ブルッキングス研究所 の 統治 研究 の 上級 研究員 、 ウィリアム A.ガルストン （ William A.Galston ） の 主張 の よう に 、 米国 議会 において 空前 の 分極 化 が 進ん で いる という 主張 を よく 耳 に する ［ WA 10 ］ 。
その 理由 は 簡単 に 理解 できる 。
この よう な 主張 は 大衆紙 で なさ れる こと が 多く 、 米国 の 主流 メディア は この よう な 相違 点 を 誇張 する よう に 働く こと が 少なく ない 。
立法府 の 難局 を この 分極 化 の 副産物 と 考える と 、 立法府 の 成果 は 分極 化 の おおよそ の 尺度 と みなせる 。
第 110 議会 で は 約 14 , 000 件 の 法案 が 提出 さ れ た が 、 実は 449 件 （ 3.3% ） の 法案 しか 可決 さ れ て い ない ［ PS 08 ］ 。
しかも この 449 件 の 法律 の 中 の 144 件 は 単なる 連邦 庁舎 の 名前 の 変更 で ある 。

しかし 現在 の 米国 議会 は 本当に かつて ない ほど 分極 化 し て いる の で あろ う か 。
本当 だ と 信じる こと も できる が （ そして 、 ガルストン 教授 の 引用 の よう な 事例証拠 も ある が ） 、 この 疑問 に 答える もっと 原理 に 基づい た 手段 が あれ ば 望ましい 。
ここ で は MDS を 使っ て 党 路線 における 上院議員 の クラスタリング を 可視 化 し 、 2 党 の メンバー 間 に 交わり が 存在 する か どう か を 調べる という 手法 を 用いる 。
しかし これ を 行う 前 に 、 上院議員 間 の 距離 を 測る 尺度 が 必要 で ある 。

幸い な こと に 、 米国 議会 は 世界 で 最も オープン な 立法機関 の 1つ で ある 。
そのため 国会議員 の 公的 記録 を 使っ て 適切 な 距離 尺度 を 作成 できる 。
ここ で は 国会議員 の 投票 記録 を 使用 する 。
前 の 節 の 例 と 同様 に 、 点呼 投票 の 記録 を 提案 さ れ た 法案 に対する 国会議員 の 承認 または 否認 を 測定 する 手段 として 使える 。
前述 の 例 の 顧客 が 「 よい 」 か 「 悪い 」 の 投票 を 行っ た の と 同様 に 、 国会議員 は 法案 に対して 賛成 （ 承認 ） か 反対 （ 否認 ） を 投票 する 。

米国 の 立法 手続き に 馴染み の ない 人 の ため に 解説 する と 、 点呼 投票 という の は 米国 両 議会 で の 最も 基本 的 な 議会 運営 手続き の こと で ある 。
名前 が 示す よう に 、 下院 と 上院 の メンバー が 提案 さ れ た 法案 に 投票 する 。
それぞれ の 議会 で の 点呼 投票 を 開始 できる 仕組み は 異なる が 、 結果 は 基本的 に 同等 で ある 。
点呼 投票 と は 、 ある 法案 に対する 各国 会議 員 の 対応 の 記録 で ある 。
前述 の とおり 、 点呼 投票 は 一般 に 賛成 か 反対 の 形式 を 取る が 、 後 に 説明 する よう に 結果 は もう少し 複雑 に なる 。

この 点呼 投票 データ は 国会議員 の 類似 度 と 相違 度 を 測る ため の 優れ た 情報源 で あり 、 米国 議会 を 研究 する 政治学者 にとって は 極めて 有益 な 資源 で ある 。
この データ は とても 有益 な ので 、 ダウンロード できる よう に 2人 の 政治学者 が 統一 リソース を 作成 し て いる 。
ケイス ・ プール （ KeithPoole 、 ジョージア 大学 ） と ハワード・ロゼンサール （ HowardRosenthal 、 ニューヨーク大学 ） は http://www.voteview.com/ を 管理 し て おり 、 第 1回 の 議会 から 本書 の 執筆 時点 で の 最新 の 議会 （ 第 111 議会 ） まで の すべて の 米国 点呼 投票 データ を 保存 し て いる 。
この ウェブサイト に は その他 の 多く の データセット も ある が 、 ここ で は 第 101 議会 から 第 111 議会 まで の 米国 上院議員 の 点呼 投票 データ を 調べる 。
これら の データファイル は 、 本章 の data ディレクトリ に 含ま れる 。

以下 の 節 で は この 点呼 投票 データ に MDS を 実行 する の に 使う コード に 取り組む 。
尺度 を 計算 し たら 、 結果 を 可視 化 し 、 「 点呼 投票 データ で クラスタリング し た とき 、 異なる 政党 の 上院議員 が 交わる か ？ 」 という 疑問 に 対処 する 。

前述 し た よう に 、 第 101 議会 から 第 111 議会 まで の 上院議員 の すべて の 点呼 投票 データ を 収集 し 、 本章 の data ディレクトリ に 置い た 。
本章 で の これ まで の ケーススタディ と 同様 に 、 まずは データ の 読み込み と 検査 から 始めよ う 。
この 作業 で は 2つ の R ライブラリ を 使用 する 。
1つ 目 は foreign ライブラリ で 、 これ について は すぐ に 説明 する 。
2つ 目 は ggplot2 で 、 こちら は MDS アルゴリズム の 結果 を 可視 化 する ため に 使う 。
ファイル は data/roll_call/ に ある ので 、 list.files 関数 を 使っ て すべて の データ ファイル名 が 含ま れる data.files という 文字 ベクトル を 作成 する 。

data.files 変数 を 調べる と 、 データファイル の 拡張子 が 前章 の ケーススタディ で 使っ た テキストファイル と は 異なる こと が わかる 。
.dta 拡張子 は Stata データファイル を 意味 し て いる 。
Stata は 学術 界 （ 特に 政治学者 ） に とても 人気 の ある 商用 の 統計的 計算 プログラム で ある 。
プール と ロゼンサール は この 形式 で データ を 配布 する こと に 決め た ため 、 この 形式 の データ を R に 読み込む 手段 が 必要 と なる 。

Stata の 形式 の ファイル の 読み込み に は 、 S 、 SAS 、 SPSS 、 Systat 、 dBase など の 多く の 外部 データファイル を R データ フレーム に 読み込む よう に 設計 さ れ て いる foreign パッケージ を 使用 する 。
ここ で は 、 Stata ファイル を 読み込む read.dta 関数 を 使う 。
この ケーススタディ で は 、 第 101 議会 から 第 111 議会 まで の 10回 の 議会 の データ を 分析 する ので †、 すべて の データ を 1つ の オブジェクト に 格納 し 、 一 度 に 操作 できる よう に する 。
後 に 示す よう に 、 この データセット は 比較的 小さい ので 、 この 場合 は メモリ に関する 心配 は ない 。
データセット を 結合 する ため に は 、 lapply 関数 を read.dta と 一緒に 使用 する 。

これ で 、 点呼 投票 の 10 個 の データ フレーム すべて を rollcall.data 変数 に 格納 でき た 。
最初 の データ フレーム （ 第 101 議会 ） の 大き さ を 調べる と 、 103 行 、 647 列 を 持つ こと が わかる 。
この データファイル の 先頭 を さらに 調べる と 、 行 や 列 の 内容 が わかる 。
データ の 先頭 を 調べる 際 に 注意 す べき 重要 な こと が 2つ ある 。
まず 各行 は 、 米国 上院議員 の 投票者 に 相当 し て いる 。
そして データ フレーム の 最初 の 9 列 に は 投票者 の 識別情報 が 含ま れ て おり 、 残り の 列 は 実際 の 投票 で ある 。
先 に 進む 前 に 、 この 識別情報 の 意味 を 理解 する 必要 が ある 。

lstate （ 州 名 ） や name （ 名前 ） など の 一部 の 列 の 意味 は 非常 に わかり やすい が 、 eh 1 や eh 2 は どう だろ う か 。
ありがたい こと に 、 プール と ロゼンサール は すべて の 点呼 投票 データ の コード ブック を 提供 し て いる 。
第 101 議会 の コード ブック は 例 9-1 に 示す よう に 、 http://www.voteview.com/senate101.htm で 見る こと が できる 。
この コード ブック は 最初 の 9 列 に 含ま れる 内容 だけ で なく 、 これから すぐ に 取り上げる 、 各 投票 の 符号化 方法 も 説明 し て いる ため とても 有益 で ある 。

今回 は 投票者 の 名前 、 所属政党 、 実際 の 投票 だけ を 利用 する 。
そのため 、 まずは 投票 から 適切 な 距離 尺度 を 作成 できる 形式 で 点呼 投票 データ を 取得 する 。
例 9-1 から わかる よう に 、 上院 で の 点呼 投票 は 単なる 賛成 か 反対 だけ で は ない 。
公表 済み や ペア で の 賛成 と 反対 の 投票 に 加え 、 上院議員 が 特定 の 法案 の 投票 を 控え た が 、 投票 時 に 出席 し て い た 場合 を 意味 する 出席 投票 も ある 。
また 上院議員 が 単に 投票 に 出席 し て い なかっ た 場合 や 、 上院議員 に まだ 選出 さ れ て い なかっ た 場合 も ある 。
さまざま な 投票 状況 が ある こと を 考える と 、 この データ を 上院議員 間 の 距離 を 測定 し やすい 形式 に 変換 する に は どう すれ ば よい だろ う か 。

1つ の 方法 は 、 投票 の 種類 など で 集約 し て データ 符号化 を 簡略 化 する こと で ある 。
例えば ペア 投票 は 、 ある 点呼 投票 に 出席 でき ない こと が わかっ て いる 上院議員 が 、 逆 の 投票 を する 予定 の 別 の 議員 と ペア で 投票 できる 手続き で ある 。
ペア 投票 は 、 公表 投票 と 並ん で 、 上院 または 下院 で 投票 を 行う ため の 定足数 を 確保 する ため の 議会 手法 で ある 。
しかし ここ で は 投票 を 行う 仕組み に は あまり 関心 が なく 、 投票 の 結果 （ 賛成 または 反対 ） に 関心 が ある 。
そこで 考え うる 1つ の 集約 方法 として 、 賛成 と 反対 の 全 種類 を まとめる 方法 が ある 。
同じ 考え方 を 用い て 非 投票 の 全 種類 を まとめる こと が できる 。

図 9-3 は プール と ロゼンサール の 符号化 を ここ で の 分析 の ため に 簡略 化 する 方法 を 示し て いる 。
前節 の 模擬 例 と 同様 に 、 すべて の 賛成 を ＋ 1 、 すべて の 反対 を −1 、 そして すべて の 非 投票 観測 値 を 0 に 符号 化 する 。
すると とても 単純 な データ 符号化 を 距離 尺度 に 適用 できる 。
次に データ を 新しい 符号化 に 変換 する 。
さらに データ フレーム から 投票 だけ を 抽出 し 、 必要 な 行列 操作 を 実行 できる よう に する 必要 も ある 。

そのため に 、 rollcall.simplified 関数 を 定義 する 。
rollcall.simplified 関数 は 唯一 の 引数 として 点呼 投票 データ を 取り 、 簡略 化 し た 符号化 を 使っ た 上院議員 × 投票 の 行列 を 返す 。
この 関数 の 最初 の 手順 で は 、 state 列 が 99 に 等しい 観測 値 を 削除 し て いる こと に 気付く はず だ 。
state コード 99 は 米国 副大統領 に 相当 し 、 副大統領 が 投票 する の は 非常 に 稀 な ので 、 副大統領 は 除く 。
そして ifelse コマンド を 使っ て 残り の 行列 の すべて の 列 に ベクトル 化 さ れ た 数値 比較 を 実行 する 。
なお 、 この 比較 を 行う 順序 が 重要 で ある 。
まず すべて の 非 投票 （ 6 より 大きい もの ） を ゼロ に 設定 する 。
次に コード が 0 より 大きく 4 より 小さい 投票 （ 賛成 投票 ） を 探し 、 1 に 変換 する 。
最後 に 、 4 より 大きい もの は 反対 な ので 、 −1 に 符号 化 する 。

これ で 前節 の 模擬 データ と 同様 の 形式 の 点呼 投票 データ が でき 、 模擬 顧客 評価 データ の 場合 と 全く 同じ 方法 で この データ を 処理 できる 。
本章 の 次 の 節 と 最後 の 節 で は 、 この データ の MDS を 作成 し て 視覚 的 に 調査 する 。

これ まで と 同様 に 、 まずは 上院議員 × 投票 の 行列 を 使用 し て 、 MDS を 実行 する 上院議員 × 上院議員 の 距離 尺度 を 作成 しよ う 。
lapply 関数 を 使い 、 議会 ごと に 別々 に この 変換 を 行う 。
まずは 行列 の 乗算 を 行い 、 結果 を rollcall.dist に 格納 する 。
そして 別 の lapply の 呼び出し で cmdscale 関数 を 使用 し て MDS を 実行 する 。
この MDS 演算 に は 注意 点 が 2つ ある 。
まず デフォルト において cmdscale は 2次元 の MDS を 計算 する ので 、 k = 2 の 設定 は 不要 で ある 。
しかし これ は コード の 共有 時 に この 演算 を 行う 場合 に 明確 に なる ため 便利 な ので 、 ここ で は ベストプラクティス として この 設定 を 追加 し て いる 。
次に すべて の 点 に −1 を 掛け て いる こと に 注目 しよ う 。
これ は 可視化 の ため だけ に 行っ て おり 、 すべて の 点 の x 軸 位置 を 反転 さ せ 、 すぐ あと で わかる よう に 民主党 を 左側 、 共和党 を 右側に 配置 する ため の 処理 だ 。
米国 で は 通常 民主党 が イデオロギー 的 に 左派 で 、 共和党 は 右寄り と 考え られ て いる ので 、 これ は 便利 な 視覚 的 手がかり と なる 。

すでに お わかり か と 思う が 、 民主党 が MDS の x 軸 の 右側 、 共和党 が 左側 に ある こと は 可視 化 し て 初めて わかる こと で ある 。
データ 分析 を 適切 に 行う に は 、 分析 の 完了 後 に 結果 の 表現 や 手段 の 改善 方法 を 柔軟 かつ 批判 的 に 検討 する こと が 必要 で ある 。
ここ で は すべて の 作業 を 最初 から 順番 に 示し て いる が 、 実際 の 分析 において 可視化 の 際 に x 軸 を 反転 する という 判断 は 、 この 作業 を 最初 に 一通り 試し て み て 初めて 下せる もの だ 。

次に 、 rollcall.mds の 座標 点 データ フレーム に 適切 な 識別 データ を 追加 し 戻し 、 所属政党 に 照らし て 可視化 できる よう に する 必要 が ある 。
以下 の コード ブロック で は 、 rollcall.mds リスト に対する 単純 な for ループ を 使っ て これ を 実行 し て いる 。
まず 座標 点 列 の 名前 を x と y に 設定 する 。
次に rollcall.data の 元 の 点呼 投票 データ フレーム に アクセス し 、 上院議員 名 列 を 抽出 する 。
その 際 に 先 に 副大統領 を 除い て おく こと を 忘れ て は いけ ない 。
また 一部 の 上院議員 名 に は 姓 と 名 が 含ま れ て いる が 、 ほとんど は 姓 だけ しか 含ま れ て い ない 。
一貫性 を 保つ ため に 、 name 文字 ベクトル を カンマ で 分割 し て 名 を 取り除き 、 その ベクトル を congress.names 変数 に 格納 する 。
最後 に transform 関数 を 使っ て 所属政党 を factor として 追加 し 、 議会 番号 も 追加 する 。

文脈 データ の 追加 後 に rollcall.mds の 最初 の 要素 の 先頭 を 調べる と 、 可視化 に 使う データ フレーム を 見る こと が できる 。
本章 に 含ま れる R コード ファイル で は 、 この データ フレーム の リスト に対して 繰り返す 長い 一連 の コマンド を 使い 、 すべて の 議会 を それぞれ 可視 化 し て いる 。
しかし 簡潔 に する ため に 、 ここ で は その コード の 一部 だけ を 示す 。
以下 に 示す コード は 、 第 110 上院 議会 の データ を プロット する が 、 他 の 議会 に も 簡単 に 変更 できる 。

ggplot2 で 実行 し て いる こと の 多く は 、 すでに お 馴染み の もの だろ う 。
しかし 今回 は 少し 違っ た 方法 で グラフィックス を 作成 し て いる 。
一般 的 な 方法 で は ggplot オブジェクト を 作成 し て から geom や stat レイヤ を 追加 する が 、 この 例 で は case.110 という ベース オブジェクト を 作成 し 、 この オブジェクト が 散布図 の すべて の フォーマット 特性 を 含む よう に し て いる 。
これ に は 、 size 、 alpha 、 shape 、 color 、 opts レイヤ が 含ま れる 。

この よう に し た の は 、 2つ の 散布図 を 作成 し たい から で ある 。
1つ は ポイント そのもの 散布 図 で あり 、 ポイント の 形状 が 所属政党 を 表す 。
2つ 目 は 上院議員 の 名前 を ポイント として 使い 、 テキスト の 色 が 所属政党 を 表す 。
最初 に これら すべて の フォーマット レイヤ を base.110 に 追加 する と 、 ベース に sgeom_point か geom_text レイヤ を 追加 する だけ で 、 希望 の 散布図 が 手 に 入る 。
図 9-4 は その 散布 図 の 結果 を 表し て いる 。

まずは 、 「 点呼 投票 記録 で クラスタリング し た 際 に 、 政党 の 異なる 上院議員 が 交わる か 」 という 最初 の 疑問 に 対処 する 。
図 9-4 から 、 答え は 明らか に いい え で ある 。
民主党 と 共和党 の 間 に は かなり 大きな 隔たり が ある よう に 見える 。
また この データ は 、 最も 極端 と 思わ れる 上院議員 は 実際 に は 多く の 場合 外れ値 で ある こと を 裏付け て いる 。
左端 に ベルモント 州 、 無所属 の サンダース （ Sanders ） 上院議員 、 そして 、 右端 に は コバーン （ Coburn ） 上院議員 と デ ミント （ DeMint ） 上院議員 が 確認 できる 。
同様 に コリンズ （ Collins ） 上院議員 と スノー （ Snowe ） 上院議員 は 第 110 議会 の 中央 に 高度 に クラスタリング さ れ て いる 。
実際 最近 の 米国 上院 議会 で の 大きな 立法 論争 の 中心人物 と なっ た の は 、 これら の 穏健派 の 共和党 議員 で あっ た 。

この 分析 で の もう 1つ の 興味深い 結果 は 、 第 110 上院 議会 で の オバマ （ Obama ） 上院議員 と マケイン （ McCain ） 上院議員 の 位置 で ある 。
オバマ 議員 は 散布図 を 4分 割した 左上 に 位置 する の に対し 、 マケイン 議員 は ウィッカー （ Wicker ） 上院議員 や トーマス （ Thomas ） 上院議員 と 一緒に クラスタリング さ れ 、 中央 寄り で ある 。
データ 符号化 の 特質 を 考える と 、 この こと は この 2人 の 上院議員 の 投票 記録 が とても 相補 的 で ある と 解釈 し たく なる かも しれ ない が 、 2人 が 大統領選挙 活動 の ため に 多く の 同じ 投票 を 欠席 し た 結果 で ある 可能性 が 高い 。
つまり 同じ 法案 に 投票 し た とき に は 、 投票 記録 に 極端 な 違い は ない に し て も 比較的 異なる 投票 傾向 が ある が 、 投票 し なかっ た の は 同じ 法案 で ある こと が 多かっ た の で ある 。
もちろん 、 ここ から 「 ウィッカー 議員 と トーマス 議員 の 位置 を どの よう に 解釈 する の か 」 という 疑問 が 生じる 。

最後 の 可視化 で は 、 年代 順 の 全 議会 の MDS 散布 図 を 調べる 。
これ は 時間 の 経過 に 伴う 政党 ごと の 上院議員 の 全体 的 な 交わり に関して 何らかの 示唆 を 与え て くれる はず で あり 、 現在 の 上院 議会 が かつて ない ほど 分極 化 し て いる という 主張 に対する より 道義 的 な 視点 が 得 られる で あろ う 。
前述 の コード ブロック で は 、 do.call と rbind を 使っ て rollcall.mds を 1つ の データ フレーム に 圧縮 し 、 全 データ から 1つ の 散布図 を 作成 し た 。
今回 は 以前 に 作成 し た の と 全く 同じ 散布 図 を 作成 する が 、 facet_wrap を 追加 し て 、 議会 の 年代 順 の グリッド で MDS 散布図 を 表示 する 。
図 9-5 に この 可視化 の 結果 を 示す 。

点呼 投票 を 上院議員 間 の 相違 の 尺度 として 使う と 、 その 結果 から 実は 米国 上院 議会 の 党派性 は 以前 と 同様 で ある よう に 見える 。
全体的 に 見る と 、 どの 議会 で も 三角 と 丸 の 大きな グループ が でき て いる だけ で 、 例外 は とても 少ない こと が わかる 。
第 101 議会 と 第 102 議会 は グループ が 近づい て いる よう に 見える ので 、 分極 化 が 少ない と 言う 人 も いる かも しれ ない 。
しかし これ は 軸 の 目盛り による 人為 的 な 結果 で ある 。
MDS という 手法 は すべて の 観測 値 間 の 距離 尺度 の 計算 に 基づい て 評価関数 を 最小化 しよう と する だけ で ある 。
第 101 議会 と 第 102 議会 の 目盛り が 他 の 多く の 散布図 より 小さい から と いっ て 、 分極 化 が 少ない という わけ で は ない 。
この 差 は 観測 値 の 数 など の 多く の 理由 から くる もの で ある 。
ところが 1つ の 散布図 に 可視 化 し て いる ので 、 すべて の パネル で 目盛り を 統一 し なけれ ば いけ ない ため 、 狭まっ て 見え たり 広がっ て 見え たり する の で ある 。

この 散布 図 から わかる 重要 な こと は 、 点呼 投票 で クラスタリング する と 政党 の 交わり は 非常 に 少ない という こと で ある 。
政党 内 で の 多少 の 差異 は ある かも しれ ない が 、 丸 と 三角 の 点 の 成層 から わかる よう に 、 政党 間 の 差異 は 非常 に 少ない 。
ほぼ すべて の 場合 に 、 民主党 同士 、 共和党 同士 で クラスタリング さ れ て いる こと が わかる 。
もちろん 所属政党 以外 に も この 散布 図 に 追加 し たら 面白い 情報 は 他 に も たくさん ある 。
例えば 地理 的 に 同じ 地域 の 上院議員 が 一緒に クラスタリング さ れる か どう か 疑問 に 思う で あろ う 。
または 、 同じ 委員会 の 会員 で ある こと が クラスタリング に つながる か という 疑問 も ある で あろ う 。
どれ も 興味深い 疑問 な ので 、 自分 の 手 で ここ で の 分析 を さらに 進め 、 この データ を もっと 深く 掘り下げ て みよ う 。

前章 で は 相関係数 を 使っ て 投票 の 履歴 から 国会議員 の 類似 度 を 測る 方法 を 紹介 し た 。
本章 で は 同じ よう な 類似 度 の 指標 を 使っ て ウェブサイト の ユーザ に アイテム を 推薦 する 方法 について 考え て いく こと に する 。

ここ で 使う アルゴリズム は k 近傍 法 （ kNN ） と 呼ば れ て いる 。
これ は この 本 で 取り扱う 機械学習 の アルゴリズム の うち で 、 最も 直観 的 な アルゴリズム で ある こと は ほぼ 間違い ない 。
もし 誰か に アイテム 同士 の 類似 度 の データ を 使っ て 推薦 システム を 作っ て ください と 頼ま れ たら 、 ほとんど の 人 が そう と 知ら ず に k 近傍 法 の 最も 単純 な 形 を 思いつく こと だろ う 。
例えば ユーザ が 好き な 曲 に 最も よく 似 た もの の うち 、 まだ リスト に 含ま れ て い ない 曲 を 推薦 する といった もの を 作る 場合 が それ に 当たる 。
この よう な 直観 的 な 方法 は 、 本質的 に k ＝ 1 の とき の k 近傍 法 の アルゴリズム と 同一 で ある 。
k 近傍 法 の アルゴリズム は この 直観 を 少し だけ 一般 化 し た もの で 、 推薦 を 行う 前 に 類似 し て いる 複数 の データ ポイント を 集める もの だ 。

k 近傍 法 は 、 人々 が 友達 に おすすめ を お願い する の と 同じ よう な 方法 で 推薦 を 行う 。
まず ある 分野 で 好み が 似 て いる 人々 を 探し出し 、 いくつか の 推薦 を し て くれる よう に 依頼 する 。
もし 彼ら の 多く が 同じ もの を 推薦 し たら 、 自分 も それ を 好き に なる だろ う と 推測 する の だ 。

この 直観 を どう やっ て アルゴリズム に 書き 起こす こと が できる だろ う か 。
実際 の データ で の 推薦 処理 を 書き 始める 前 に 、 データ ポイント を 2つ の カテゴリ に 分類 する という 簡単 な 設定 を 考え て みよ う 。
もし 3 章 で なぜ スパム 分類 の 問題 に 取り組ん だ の か という こと を 覚え て いれ ば 、 図 10-1 の よう な 図 に 見覚え が ある はず だ 。

以前 述べ た よう に 、 R で は glm 関数 で ロジスティック回帰 を 実現 する こと が でき 、 これ により 決定 境界 と 呼ば れる 1つ の 直線 を 引い て これら の データ ポイント を カテゴリ に 分ける こと が できる 。
ロジスティック回帰 の 使い方 を 説明 し た 時 に 、 図 10-2 の よう に 単純 な 線形 の 決定 境界 で は 解決 でき ない 問題点 が ある こと も 指摘 し た 。

図 10-2 の よう な 複雑 な 決定 境界 に ふさわしい 分類 器 を 構築 する に は どう し たら よい だろ う か 。
考え られる 例 として は 12 章 で 議論 する カーネルトリック の よう な 非線形 分類 の 手法 で ある 。

他 の アプローチ として 、 分類 しよ う と し て いる 点 に 近い 点 を 使う という 方法 も 考え られる 。
例えば 分類 しよ う と し て いる 点 の 回り に 円 を 描い て 、 その 円 の 中 に 含ま れる データ ポイント に 基づい て 分類 を 行う という 方法 が ある 。
図 10-3 は その よう な アプローチ を 示し て おり 、 筆者 ら は これ を 「 草の根民主主義 」 アルゴリズム と 呼ん で いる 。

この アルゴリズム は 実際 に かなり 使える もの だ が 、 気 を 付け て おか なけれ ば なら ない 欠点 が ある 。
この アルゴリズム で 使う ため の 円 の 半径 を 選ん で 、 「 局所 的 な 」 データ ポイント を 定義 し なけれ ば なら ない という こと だ 。
もし すべて の データ ポイント が 隣 の 点 と 同じ くらい の 距離 に あれ ば 、 これ は 問題 に は なら ない 。
しかし 、 もし いくつか の 点 は 近く に たくさん の 点 が あり 、 別 の 点 は ほとんど 孤立 し て い た と し たら どう だろ う か 。
すべて の 点 について 近い 点 を 定義 する ため に は 、 大き すぎる 円 を 選ぶ 必要 が あり 、 その 結果 として いくつか の 点 について は 決定 境界 を 過ぎ て 広がっ て しまう だろ う 。
この 問題 について どう 対処 すれ ば よい か 。
そのため に は データ ポイント の 「 近く 」 を 定義 する のに 円 を 使う の を やめ て 、 入力 に 最も 近い k 個 の 点 を 使え ば よい 。
これら の 点 は k 近傍 と 呼ば れる 。
k 近傍 を 求め たら 、 多数決 の 法則 を 使っ て 新しい 点 の クラス を 予測 する こと が できる 。
これ を 行う コード を 書い て みよ う 。

まずは データセット を 読み込む 。
次に データセット 中 の それぞれ の 点 同士 の 距離 を 計算 する 必要 が ある 。
この 情報 は i 番目 の 点 と j 番目 の 点 の 距離 を 配列 中 の distance.matrix [ i , j ] に 格納 する 2次元 の 配列 で ある 、 距離行列 に 格納 さ れる 。
次 の コード は ユークリッド距離 の 公式 を 使っ て 距離行列 を 生成 する 。

距離行列 を 求め たら 、 ある 点 に対する k 近傍 を 返す 関数 が 必要 と なる 。
距離行列 の i 行 目 を 見れ ば 、 他 の すべて の 点 と の 距離 が わかる ため 、 R で は 簡単 に これ を 実装 できる 。
次に この 行 で データ を ソート すれ ば 、 入力 点 に 最も 近い 順 に 近傍 の リスト を 得る こと が できる 。
最後 に 入力 点 自身 （ これ は 常に 最も 近い 点 と なる ） を 除い て k 個 の 項目 を 選択 すれ ば 、 入力 点 に対する k 近傍 を 得る こと が できる 。

k 近傍 を 取得 する 準備 が 整っ た ので 、 次に データ フレーム と k の 値 を 受け取っ て データ フレーム 中 の 各 点 に対して 予測 結果 を 生成 する knn 関数 を 構築 する 。
今回 の 関数 は Label という 名前 の 列 に クラス ラベル を 格納 し て いる と 仮定 し て いる ので あまり 汎用 的 と は 言え ない が 、 この アルゴリズム が どう 動作 する の か の 簡単 な 演習 だ と 思っ て 読み 進め て ほしい 。
R に は すでに k 近傍 法 の 実装 が いくつか 用意 さ れ て いる ので 、 これ について は 後ほど 議論 する こと に しよ う 。

見 て の 通り 、 多数決 の ルール を 使っ て 予測 を 行う ため に 、 ラベル の 平均 を 取って 0.5 という しきい値 による 切り捨て を 行っ た 。
この 関数 を 呼び出す と 予測 結果 の ベクトル を 返す ので 、 それ を データ フレーム に 追加 し て 性能 を 評価 する こと が できる 。

今回 は 予測 を 行っ た 100回 中 7回 に 失敗 し て いる ので 、 精度 は 93% で ある 。
この 性能 は この よう な 単純 な アルゴリズム に し て は そう 悪く は ない 。
ここ まで で k 近傍 法 が どの よう に 動作 する か を 説明 し て き た ので 、 次 は R パッケージ の 使用 について の 実 データ に k 近傍 法 を 適用 し て みよ う 。

ただ それ を 行う 前 に 、 どの よう に k 近傍 法 の 既製 の 実装 を 使う か 簡単 に 説明 し て おき たい 。

ここ で は 、 交差 検定 を 使っ て class パッケージ に 含ま れる knn 関数 の 性能 を 評価 し た 。
面白い こと に 今回 も また 7つ の ラベル について 予測 を 誤っ た の だ が 、 今回 の テストデータ は 50 サンプル しか ない ので 精度 は 86% に とどまっ た こと が わかる 。
それでも かなり 良い 方 だ と 言える 。
比較 の ため ロジスティック回帰 を 使っ た 場合 は どれ くらい うまく いく の か 試し て みよ う 。

この 結果 に よる と ロジスティック回帰 で は 16 個 の データ で 予測 を 誤っ て おり 、 精度 は 68% まで 落ち て しまう 。
問題 設定 が 線形 と は かけ離れ て いる とき 、 kNN は ロジスティック回帰 の よう な 線形 分類 器 と 比べ て うまく 動作 する こと が 知ら れ て いる 。

k 近傍 法 の 使い方 を 理解 し た ところ で 、 推薦 を 行う 方法 を 見 て いこ う 。
推薦 を 行う 方法 の 1つ は 、 ユーザ が 好む アイテム に 似 た アイテム を 探し だし て k 近傍 法 を 適用 する こと で 、 アイテム ベース の 方法 と 呼ば れ て いる 。
別 の アプローチ として 、 推薦 を 行お う と し て いる ユーザ に 似 た ユーザ を 探し出し て その ユーザ ら に 人気 の アイテム を 見つけ て k 近傍 法 を 適用 する という 方法 が あり 、 こちら は ユーザベース の 手法 と 呼ば れ て いる 。

どちら の 方法 も 合理 的 だ が 、 実際 に は 片方 が もう 一方 より も 良い こと が ほとんど だ 。
ちょうど Netflix の よう に もし アイテム より も 多く の ユーザ が いる なら ば 、 アイテム 同士 の 類似 度 を 計算 する だけ で 済む ため 、 アイテム ベース の 方法 によって 計算 と 保存 の コスト を 最小限 に する こと が できる 。
データ を 収集 し 始め た 段階 の よう に 、 もし アイテム の 種類 が ユーザ より も 多けれ ば 、 ユーザベース の 方法 を 試す の が 良い だろ う 。
本章 で は アイテム ベース の 方法 を 採用 する こと に する 。

推薦 を 行う ため の アルゴリズム について 詳細 な 議論 に 入る 前 に 、 今回 取り扱う データ を 眺め て みる こと に しよ う 。
今回 使う データ は Kaggle † 上 で 行わ れ た R パッケージ を 推薦 する コンテスト に 参加 した 者 に 提供 さ れ た もの だ 。
この コンテスト で は 、 50人 の R プログラマ による パッケージ の インストール 記録 が 参加者 に 提供 さ れる 。
これ は 非常 に 小さい データセット だ が 、 R パッケージ の 人気 度 と 類似 度 を 知る に は 良い 題材 と なっ て いる 。

実際 に コンテスト で 勝利 し た アルゴリズム は すべて 推薦 アルゴリズム の 一部 として k 近傍 法 を 使用 し て い た が 、 k 近傍 法 は あくまで 多く の アルゴリズム の うち の 1つ で ある 。
他 に 勝利 し た 解法 に 組み込ま れ た アルゴリズム の うち で 重要 だっ た の は 、 いわゆる 行列 分解 の 手法 で あっ た 。
ここ で は 詳細 に は 立ち入ら ない が 、 製品 水準 の 推薦 システム を 構築 する の で あれ ば 、 k 近傍 法 と 行列 分解 モデル の 組み合わせ を 考慮 す べき だ 。
実際 に 最も 性能 の 良い システム は k 近傍 法 、 行列 分解 、 他 の 分類 器 を より 上位 の モデル に 組み込ん で いる の が 普通 で ある 。
この よう に 多く の 分類 器 を 組み合わせる 手法 は アンサンブル 学習 と 呼ば れ て いる 。
これら について は 12 章 で 簡単 に 触れる こと に しよ う 。

この R パッケージ の コンテスト で は 、 参加者 は ある ユーザ が パッケージ を インストール する か どう か を 、 その ユーザ が インストール し た 他 の パッケージ の 情報 を 用い て 予測 する 。
新しい パッケージ に対して 予測 を 行う ため に は 、 その パッケージ に 似 て いる 他 の パッケージ を 探し て 、 それら が インストール さ れ た か どう か を 確認 すれ ば いい 。
つまり この コンテスト で アイテム ベース の k 近傍 法 を 使う の は 自然 な こと と 言える 。

まずは データ を 読み込ん で 少し 観察 し て みよ う 。
その あと で パッケージ 間 の 類似 度 の 指標 を 構築 する 。
この コンテスト の 元 データ は この 目的 に 合致 し て い ない ため 、 今回 は 扱い やすい よう に 変換 済み の データセット を 用意 し た 。
この ファイル に は 、 それぞれ の 行 に ユーザ と アイテム の 組 、 そして その ユーザ が パッケージ を インストール し た か どう か を 表す 3つ 目 の 列 が 格納 さ れ て いる 。

見 て の 通り 、 ユーザ 1 は abind パッケージ を インストール し て いる が 、 AcceptanceSampling パッケージ は インストール し て い ない 。
異なる 形式 に 変換 する こと で 、 この 行 は パッケージ 間 の 類似 度 について の 情報 を 与え て くれる 。
この データ は ユーザ と パッケージ の ペア が 行 を 表す 縦長 の 形式 な ので 、 それぞれ の 行 が ユーザ に 、 それぞれ の 列 が パッケージ に 対応 する 横長 の 形式 に 変換 する 必要 が ある 。
この 操作 は reshape パッケージ の cast 関数 を 使っ て 行う こと が できる 。

まず ユーザ パッケージ 行列 に対して cast 関数 を 使っ た 。
最初 の 列 を 調べ て みる と ただ の ユーザ 識別子 を 保存 し て いる こと が わかる ので 、 結果 の 行列 の row.names に 情報 を 保存 し て から その 列 を 削除 する 。
これ により 適切 な ユーザ パッケージ 行列 を 手 に する こと が でき た ので 、 類似 度 を 計算 する の は 簡単 で ある 。
簡単 の ため 、 類似 度 の 指標 として 各 列 の 相関係数 を 使う こと に する 。
これ を 計算 する に は R の cor 関数 を 呼び出す だけ で よい 。

これ で すべて の パッケージ の 組 について の 類似 度 を 手 に する こと が でき た 。
見 て の 通り 、 パッケージ 1 は パッケージ 1 と 完全 に 同一 で あり 、 パッケージ 2 と は あまり 似 て い ない 。
しかし k 近傍 法 で 使う の は 類似 度 で は なく 距離 で ある 。
よって 、 類似 度 を 距離 に 変換 する 必要 が ある 。
ここ で は 簡単 な 計算 によって 、 類似 度 1 が 距離 0 に なり 、 類似 度 −1 が 距離 無限大 に なる よう に 変換 を 行う 。
それ を 行う コード を 以下 に 示す 。
なぜ これ が うまく いく の か よく わから なけれ ば 、 この 計算 が 座標軸 上 の 点 を どの よう に 移動 さ せる の か 、 少し 時間 を 使っ て 考え て みよ う 。

この 計算 を 実行 すれ ば 距離 の 情報 が 手 に 入る ので 、 k 近傍 法 の 実装 を 始める こと が できる 。
ここ で は 例 として k 近傍 法 の k を 25 に 設定 する が 、 実際 に 使う とき に は k の 値 を 変え て み て どの 値 が うまく 動作 する の か 試し て みる の が いい 。

パッケージ が どれ だけ インストール さ れ やすい の か を 、 似 た パッケージ が どれ だけ インストール さ れ て いる か を 数える こと で 推定 し て みよ う 。
パッケージ を 頻度 で ソート し 、 高い スコア の パッケージ を 提案 する の だ 。

そのため に 先 ほど の k.nearest.neighbors 関数 を 書き換える こと に する 。

k 近傍 法 を 使う こと で 、 ある パッケージ の インストール 確率 は 似 た パッケージ が どれ だけ インストール さ れ た か によって 予測 する こと が できる 。

これ により 、 ユーザ 1 に は パッケージ 1 が 0.76 の 確率 で インストール さ れる こと が わかる 。
この 情報 を 使っ て 最も インストール さ れる 確率 の 高い パッケージ を 見つけ 、 それら を 推薦 する こと に しよ う 。
ここ で は すべて の パッケージ について インストール 確率 を 計算 し 、 最も 確率 の 高い もの を 表示 する 。
この 方法 で 良い 点 の 1つ は 、 エンド ユーザ に 予測 の 理由 を 説明 し やすい という 点 で ある 。
つまり パッケージ P が 推薦 さ れ た 理由 は 、 すでに その ユーザ が X 、 Y 、 Z の パッケージ を インストール した から だ と 説明 する こと が できる わけ だ 。
この よう な 透明性 は 応用 する ケース によって は 大きな 利点 と なり うる 。

本章 で は アイテム 間 の 類似 度 だけ を 使っ た 推薦 システム を 構築 し た 。
次 章 で は ソーシャルネットワーク 上 の 人間関係 の 情報 を 使っ た 推薦 エンジン に 取り組む こと に しよ う 。

ソーシャルネットワーク は いたる ところ に 存在 する 。
ウィキペディア に よれ ば 、 インターネット上 に は 出会い系 を 除い て 200 を 超える ソーシャルネットワーキング サイト が 運用 さ れ て いる 。
図 11-1 から わかる よう に 、 Googleトレンド に よれ ば 2005年 以来 、 「 ソーシャルネットワーク 」 に対する 世界 的 な 関心 は 確固たる もの で あり 、 常に 高まっ て いる 。
これ は 至極 当然 な こと だ 。
なぜなら 社会的 交流 を 望む 気持ち は 人間 の 基本 的 な 性質 で あり 、 この 持っ て 生まれ た 社会性 が テクノロジ において 現れる の も 意外 な こと で は ない はず だ から だ 。
ソーシャルネットワーク の マッピング や モデリング は 決して 初めて 聞く 話 で は ない 。

数学 コミュニティ で 行わ れ て いる ソーシャル （ 社会 ） ネットワーク 分析 の 例 は 、 エルデシュ数 の 計算 で あり 、 エルデシュ数 は 、 多数 の 論文 を 残し た 数学者 ポール・エルデシュ （ Paul Erd.s ） と の 距離 を 測定 する 。
エルデシュ は 20世紀 で 最も 多く の 論文 を 残し た と 言っ て も 過言 で は ない 数学者 で あり 、 生涯 で 1 , 500 件 以上 の 論文 を 発表 し て いる 。
その 多く の 論文 は 共同 執筆 で あり 、 エルデシュ数 は エルデシュ が 協力 を 求め た 共同執筆者 仲間 と ある 数学者 と の 距離 を 測定 する 。
ある 数学者 が エルデシュ と 論文 を 共同 執筆 し た 場合 、 エルデシュ数 は 1 と なる 。
すなわち 20世紀 の 数学 ネットワーク における エルデシュ と の 距離 が 1 な の で ある 。
別 の 執筆者 が エルデシュ の 共同執筆者 の 1人 と 共同 執筆 し た が 、 エルデシュ と は 直接 共同 執筆 し て ない 場合 、 その 執筆者 は エルデシュ数 2 と なる 。
この 尺度 を 真面目 に 捉える こと は めったに ない が 、 数学 界 における ある 人 の 名誉 の おおよそ の 尺度 として 使わ れ て いる 。
エルデシュ数 を 使う と 、 ポール・エルデシュ を 中心 と し た 巨大 な 数学者 ネットワーク を 簡単 に 要約 する こと が できる 。

20世紀 の 最も 著名 な 知識人 の 1人 で あり 、 圧倒的 な 貢献 の 大き さ によって 社会 学界 の ポール・エルデシュ に 相当 する アーヴィング・ゴッフマン （ ErvingGoffman ） は 、 人的 交流 の 本質 に関する 屈指 の 発言 を 残し て いる 。

人間 が 相互関係 の 中 で 存在 し て いる と 、 単なる 物理的 手段 として だけ で は なく 、 コミュニケーション 手段 として も 機能 できる 。
コミュニケーション 手段 として の 機能 は 、 物理的 手段 に も 劣ら ず 、 関係 し て いる すべて の 人 にとって 重大 で あり 、 あらゆる 社会 において 厳密 な 規範 的 規則 に さらさ れ 、 ある 種 の コミュニケーション の 交通 秩序 が 生まれる 。

ゴッフマン の 言う 「 交通 秩序 」 は 、 まさしく ソーシャルネットワーク で ある 。
互いに やり取り し 交流 し たい という 欲求 の 副産物 が 高度 に 構造 化 さ れ た グラフ で あり 、 各自 の アイデンティティ や 経歴 に関する 一 種 の 「 地図 」 を 示す 。
Facebook 、 ツイッター 、 LinkedIn など の ソーシャルネットワーキングサービス は 、 この 極めて 自然 な 行動 を 取る ため の 高度 に 定型 化 さ れ た テンプレート を 提供 し て いる だけ で ある 。
これら の サービス の 革新 性 は その 機能 で は なく 、 むしろ 人間性 の 大 部分 を 表す 社会的 地図 を 知る 手がかり と なる こと で ある 。
我々 の よう な ハッカー にとって は 、 ソーシャルネットワーキング サイト で 公開 さ れる データ は 、 紛れ も なく 優れ もの の 宝庫 で ある 。

しかし 、 ソーシャルグラフ の 価値 は ソーシャルネットワーキング サイト を しのぐ 。
ネットワーク として モデル 化 できる 関係 に は いくつか の 種類 が ある が 、 その 多く も さまざま な インターネットサービス から 取得 できる 。
例えば 、 Netflix で 見 た 映画 を 基 に 映画鑑賞 者 間 の 関係 を マッピング できる 。
同様 に 、 Last.fm †† や Spotify ‡ など の サービス を 使っ た 聴取者 の パターン に 基づい て 、 さまざま な 音楽ジャンル 間 の 関係 を 示す こと が できる 。
さらに 基本 的 な 方法 で は 、 ローカル コンピュータネットワーク の 構造 を （ または 、 インターネット 全体 の 構造 さえ も ） 大量 の ノード と エッジ として モデル 化 する こと も できる 。

根本的 に は 、 ネットワーク の 研究 は 相互 接続 さ れ た オブジェクト を 表す グラフ理論 の 用語 に 依拠 し て いる 。
1736年 に は 、 レオンハルト・オイラー （ LeonhardEuler ） が ノード と エッジ の 概念 を 使用 し て ケーニヒスベルグ の 橋 問題 を 解決 し て いる 。

ケーニヒスベルグ の 橋 問題 は 、 初期 の 巡回セールスマン問題 の 一 種 で あり 、 プロシア の ケーニヒスベルグ 市 （ 現在 の ロシア の カリーニングラード ） の 7つ の 橋 を 一 度 だけ 渡っ て 巡回 する 経路 を 考える 。
オイラー は 、 都市 の 地図 を 4つ の ノード （ 都市 部分 ） と 7つ の エッジ （ 橋 ） を 使っ た 簡単 な グラフ に 変換 し て この 問題 を 解決 し た 。

1920年代 、 著名 な 精神分析家 の ヤコブ ・ L ・ モレノ （ JacobL.Moreno ） は 、 人間関係 を 研究 する ため の 「 ソシオメトリー 」 という 手法 を 開発 し た 。
モレノ は 人々 の 社会的 交流 が 幸福 に どの よう に 影響 する か に 関心 を 持っ た ため 、 人々 の 友人 が 誰 で ある か を 尋ね 、 その 構造 の マッピング を 始め た 。
1937年 、 人類学 者 の ジョアン・クリスウェル （ JoanCriswell ） は モレノ の ソシオメトリー 手法 を 用い て 、 黒人 と 白人 の 小学生 の 子供 の 間 の 人種 的 な 亀裂 を 研究 し た ［ JC 37 ］ 。

現代 の ソーシャルネットワーク 分析 で 考慮 す べき こと の 大 部分 は 、 幅広い 分野 の 理論 と 手法 の 複合 で ある 。
ほとんど の 部分 は 、 リントン ・ フリーマン （ LintonFreeman ） 、 ハリソン ・ ホワイト （ HarrisonWhite ） 、 マーク・グラノヴェッター （ MarkGranovetter ） など の 著名 な 学者 を 含む 社会学 に 由来 し て いる 。
同様 に 、 物理学 、 経済学 、 コンピュータ 科学 、 政治学 、 心理学 、 そして その他 の 無数 の 分野 や 学者 も 多大 な 貢献 を し て いる 。
ここ で 列挙 す べき 著者 や 引用 は あまりに も 多く 、 この 大きな 研究 分野 で の 手法 を 精査 し た 研究 書 が 書か れ て いる 。
最も 包括 的 な もの として は 、 スタンレー・ワッサーマン （ StanleyWasserman ） と キャサリン ・ ファウスト （ KatherineFaust ） 共著 の 『 SocialNetworkAnalysis 』 ［ WF 94 ］ 、 マシュー ・ O ・ ジャクソン （ MatthewO.Jackson ） 著 の 『 SocialandEconomicNetworks 』 ［ MJ 10 ］ 、 デビッド・イーズリー （ DavidEasley と ジョン ・ クラインバウム （ JonKleinberg ） 共著 の 『 Networks , Crowds , andMarkets 』 ［ EK 10 ］ など が ある 。
ここ で の ソーシャルネットワーク 分析 の 簡単 な 紹介 で は 、 この トピック の ほんの 一部 だけ を 取り上げる 。
さらに 学習 し た い方 に は 、 上記 の 著書 の いずれ か を 強く おすすめ する 。

それでは 本章 で は 何 を 取り上げる の だろ う か 。
本章 で は これ まで と 同様 に 、 ソーシャルネットワーク データ の 取得 、 クリーニング と 構造 化 、 そして 最後 の 分析 まで の データ ハッキング の 全 サイクル を 体験 できる ソーシャルネットワーク の ケーススタディ に 重点 を 置い て いく 。
ここ で は 、 現代 の 傑出 し た 「 オープン 」 ソーシャルネットワーク で ある ツイッター に 焦点 を 当てる 。
「 オープン 」 という 言葉 に 注意喚起 の 括弧 を 付け て いる の は 、 ツイッター は 実は すべて の データ の 自由 に アクセス できる という 意味 で は オープン で は ない ため で ある 。
多く の ソーシャルネットワーキング サイト と 同様 に 、 ツイッター に は アクセス 頻度 に 厳しい 制限 の ある API が ある 。
そのため 、 この アクセス 頻度 を 超過 し たり ツイッター の サービス 条項 を 違反 し たり する こと なく 、 ツイッター から データ を 抽出 する システム を 構築 する 。
実際 、 本章 で は ツイッター の API に 直接 アクセス する こと は ない 。

この プロジェクト で は まず ローカル ネットワーク （ エゴ ネットワーク ） を 構築 し 、 そこ から エルデシュ数 の 計算 と 同じ 方法 で 雪だるま式 に 大きく し て いく 。
最初 の 分析 で は 、 ソーシャルネットワーク を 関連 の ある サブ グループ に 分割 する ため の コミュニティ 検出 方法 を 調べる 。
ツイッター という 環境 内 で は 、 ある ユーザ が 属する さまざま な ソーシャルグループ に関する 情報 が 入手 できる 。
最後 に 、 本書 は 機械学習 に関する 書籍 な ので 、 ツイッター の ソーシャルグラフ の 構造 を 利用 し て 独自 の 「 フォロー す べき 人 」 推奨 エンジン を 構築 する 。

ここ で 行う 処理 を 表す のに 、 専門用語 や 特定 分野 の 学術用語 は 使わ ない よう 努める 。
しかし 、 本章 の 目的 を 果たす ため に 使用 および 学習 する 価値 の ある 用語 も ある 。
先 ほど グラフ の 種類 を 表す エゴ ネットワーク という 用語 を 使っ た 。
今後 も エゴ ネットワーク に 何度 も 触れる ので 、 この 用語 を 定義 し て おく と よい だろ う 。
エゴ ネットワーク と は ネットワーク 内 の 1つ の ノード を 直接 取り囲む ソーシャルグラフ の 構造 を 表す 。
具体的 に 言う と 、 エゴ ネットワーク は シード （ エゴ ） と その 隣接 ノード （ すなわち 、 シード と 直接 接続 し て いる ノード ） で 構成 さ れる 、 ネットワーク の サブ セット で ある 。
言い換える と 、 ある ノード の エゴ ネットワーク に は 、 その ノード の 隣接 ノード 、 シード と 隣接 ノード 間 の 接続 、 そして 、 隣接 ノード 間 の 接続 が 含ま れる 。

ツイッター の ソーシャルグラフ の 作成 に 踏み込む 前 に 、 ネットワーク を 定義 し て おく と よい だろ う 。
数学 的 に は 、 ネットワーク （ グラフ ） は 一連 の ノード と エッジ に すぎ ない 。
これ に は 文脈 は ない 。
エッジ が ノード を 互いに 接続 する 世界 を 表す という 目的 だけ を 持つ 。
最も 抽象 化 し た 表現 で は 、 エッジ に は 2つ の ノード と 接続 し て いる という 事実 以外 の 情報 は ない 。
しかし 、 この 汎用 的 な データ 体系 が すぐ に 複雑 に なる 様子 が わかる 。
図 11-2 の 3つ の グラフ を 考え て みる 。

図 11-2 （ A ） は 、 無向 グラフ の 例 で ある 。
この 例 で は 、 グラフ の エッジ に 方向 は ない 。
また 、 この 例 で の ノード 間 の 接続 は 、 関係 の 相互性 を 示唆 する と も 考え られる 。
例えば 、 ディック と ハリー は 接続 を 共有 し て おり 、 この グラフ は 無向 な ので 、 この 接続 を通じて 情報 や 物品 など を 相互 に 交換 できる という 意味 に 捉える こと が できる 。
また 、 これ は とても 基本 的 な ネットワーク 設定 な ので 、 無向 の 場合 で あっ て も 、 ラベル を 追加 し た こと によって 前述 の 最も 一般 的 な 場合 より も グラフ の 複雑 さ が 増し て いる という 事実 を 見落とし がち で ある 。
図 11-2 の すべて の グラフ で は 、 ノード に ラベル を 追加 し て いる 。
これ は 追加 情報 で あり 、 ここ で は とても 有益 で ある が 、 ネットワーク の 抽象化 から 実際 の データ を 表す ネットワーク へ の 移行 方法 を 考える とき に は 検討 が 必要 で ある 。

図 11-2 （ B ） は 、 有向グラフ で ある 。
この 可視化 法 で は 、 エッジ に その 方向 を 示す 矢印 が ある 。
この グラフ で は 、 エッジ は 相互関係 で は なく 、 一方向 の 関係 を 表す 。
例えば 、 ディック と ドリュー は ジョン に対して 関係 を 持つ が 、 ジョン は ハリー に対して だけ 関係 を 持つ 。
図 11-2 （ C ） は 、 グラフ に エッジ ラベル を 追加 し て いる 。
具体的 に は 、 各 ラベル に プラス または マイナス 記号 を 追加 し て いる 。
これ は 、 この ネットワーク の メンバー 間 や ある レベル の アクセス に対する 「 好き 」 または 「 嫌い 」 の 関係 を 示す こと が できる 。
ノード ラベル が 情報 や 文脈 を ネットワーク に 追加 する の と 同様 に 、 エッジ ラベル も 情報 や 文脈 を 追加 する 。
エッジ ラベル は 、 簡単 な 2 項 関係 より も かなり 複雑 に なる こと も ある 。
エッジ ラベル は 、 関係 の 種類 や 、 強 さ を 表す 重み で ある 場合 も ある 。

オンライン で の ソーシャルグラフ データ は 多種 多様 な 形式 で 現れる ので 、 これら の さまざま な 種類 の グラフ 間 の 違い を 考える こと が 重要 で ある 。
グラフ の 構造 化 方法 の 違い は 、 サービス の 使い方 や 、 結果 として データ の 分析 方法 に も 影響 を 与える 。
使用 する グラフ の 種類 が 異なる 2つ の 有名 な ソーシャルネットワーキング サイト の Facebook と ツイッター を 考え て みる 。
Facebook は 大規模 な 無向 ソーシャルグラフ で ある 。
「 友達 に なる 」 に は 承認 が 必要 な ので 、 すべて の エッジ は 相互関係 を 意味 する 。
そのため 、 Facebook は 、 オープン な サービス の 大規模 な 中央 ハブ と いう より も 、 濃密 な ローカル ネットワーク 構造 を 持つ 比較的 閉じ た ネットワーク として 発達 し た 。
一方 、 ツイッター は 巨大 な 有向グラフ で ある 。
ツイッター で の フォロー の 仕組み に は 相互性 は 必要 ない ため 、 有向グラフ で の 大きな 非対称性 が 許さ れ て おり 、 著名人 、 報道機関 、 その他 の 人目 を 引く ユーザ が つぶやき の 大きな 発信元 の 役割 を 果たす 。

この 2つ の サービス 間 で の 接続 の 作成 方法 の 違い は わずか に 見える かも しれ ない が 、 結果的 に は とても 大きな 違い と なる 。
仕組み を わずか に 変える こと で 、 ツイッター は 全く 異なる 種類 の ソーシャルグラフ を 形成 し て おり 、 Facebook と は 大きく 異なる 方法 で 使わ れ て いる 。
もちろん 、 この 違い の 理由 は グラフ 構造 だけ に とどまら ず 、 ツイッター の 140 文字 制限 や 大 部分 の ツイッターアカウント が 完全 に パブリック で ある こと など も ある が 、 グラフ 構造 は ネットワーク 全体 の 運営 方法 に 強烈 な 影響 を 与える 。
本章 の ケーススタディ で は ツイッター を 取り上げる ため 、 分析 の あらゆる 局面 で 有向グラフ 構造 を 検討 する 必要 が ある 。
まずは 、 API の 速度制限 の 超越 や サービス 条項 を 違反 する こと なく 、 ツイッター の 関係 データ を 収集 する という 課題 から 取り組み 始める 。

本書 の 執筆 時点 で は 、 ツイッター に は 2種類 の 異なる API で アクセス できる 。
1つ 目 の API は 非 認証 で あり 、 1時間 に 150 件 の リクエスト が 可能 で 、 それ を 超える と 打ち切ら れる 。
また 、 OAuth認証 の API 呼び出し は 1時間 に 350 件 に 制限 さ れ て いる 。
1時間 に 150 件 の API 呼び出し で は 、 必要 な データ を 妥当 な 時間 で 収集 する に は 少な すぎる 。
350 件 という 2番 目 の 制限 も 少な すぎ 、 さらに 認証 を 必要 と する ツイッター アプリケーション の 構築 に は 興味 が ない 。
迅速 に データ を 入手 し て ネットワーク を 構築 し 、 データ の 調査 を 始め たい 。

RESTfulAPI に 馴染み が ない 、 または OAuth を 聞い た こと が なく て も 心配 は いら ない 。
この 演習 で は 、 これら の 詳細 は 気 に し ない 。
詳細 を 学習 する こと に 興味 が あれ ば 、 アクセス しよ う と し て いる 特定 の サービス の マニュアル を 読む こと を おすすめ する 。
ツイッター の 場合 、 API の FAQ （ https://dev.twitter.com/docs/api-faq ） を 参照 する の が 最適 で ある 。

残念 ながら 、 ツイッター が 提供 する API を 使う と 必要 な データ を 入手 でき ない 。
必要 な データ を 入手 する に は 、 ツイッター の ソーシャルグラフ データ の 別 の 情報源 で ある Google の SocialGraphAPI （ SGA ）† を 使わ なけれ ば いけ ない 。
Google は 、 すべて の ソーシャルネットワーキング サイト で 使う 単一 の オンライン ID を 作成 する 目的 で 2008年 に SGA を 導入 し た 。
例えば 、 複数 の オンラインサービス の アカウント を 持ち 、 その すべて で 1つ の 電子メール アドレス を 使う 場合 が ある 。
SGA の 目的 は 、 1つ の 情報 を 使っ て 複数 の サービス 間 の ソーシャルグラフ 全体 を 照合 する こと で ある 。
Google で 出力 し た データ の 履歴 を 知り たけれ ば 、 お気に入り の Webブラウザ に 以下 を 入力 する 。

EMAIL_ADDRESS を 正しい アドレス に 置き換えれ ば 、 API は ブラウザウィンドウ に 生 の JSON を 返し 、 Google に すでに どれ ほど 多く の ソーシャルグラフ が 格納 さ れ て いる か が わかる 。
入力 し た 電子メール アドレス を ツイッターアカウント に 登録 し て いる 場合 に は 、 その 電子メール アドレス に 対応 する ソーシャルグラフ サービス の 1つ として ツイッター ページ の URL が 表示 さ れる こと に も 気付く で あろ う 。
ツイッター は 、 SGA が ソーシャルグラフ データ を 格納 する ため に 巡回 する 多数 の ソーシャルネットワーキング サイト の 1つ で ある 。
そのため 、 SGA を 使用 し て 特定 の ユーザ の ソーシャルネットワーク を 問い合わせ 、 ネットワーク を 構築 できる 。

SGA を 利用 する 主 な メリット は 、 ツイッター が 提供 する 1時間 あたり の わずか な クエリ と は 異なり 、 SGA は 1日 に 50 , 000 件 の クエリ を 実行 できる 点 で ある 。
ツイッター の 規模 を 考え て も 、 これ は 大 部分 の ユーザ の ソーシャルグラフ を 構築 する の に 十分 すぎる クエリ 数 で ある 。
もちろん アシュトン・カッチャー †† や ティム・オライリー で あれ ば 、 この ケーススタディ で 示す 方法 で は うまく いか ない 。
と は いえ 、 著名人 で あり ながら も この 演習 に つい て いき たけれ ば 、 我々 の ツイッター ユーザ名 の @ johnmyleswhite や @ drewconway を 自由 に 使っ て もらっ て かまわ ない 。

例 として 、 著者 の ひとり ドリュー の ツイッター ページ を 使っ て SGA の データ構造 を 調べ て みよ う 。
上記 の API クエリ を 好き な Webブラウザ に 入力 する 。
望み と あら ば 、 自分 の ツイッター 名 で SGA クエリ を 行っ て も かまわ ない 。
以前 と 同様 に 、 SGA は ドリュー の ツイッター 関係 を 表す 生 の JSON を 返す 。
この API クエリ に は 、 3つ の 重要 な パラメータ edo 、 edi 、 pretty が ある 。
pretty パラメータ は フォーマット さ れ た JSON を 返す ため 、 この ブラウザビュー で のみ 有効 で ある 。
実際 に この JSON を 解析 し て ネットワーク に 変換 する 際 に は 、 この パラメータ は 取り除く 。
しかし 、 edi と edo は ツイッター 関係 の 方向 に 相当 する 。
edo パラメータ は 「 edgesout 」 （ 出 て いく エッジ 、 つまり 、 ツイッター 友達 ） の 略 で あり 、 edi は 「 edgesin 」 （ 入っ て くる エッジ 、 つまり 、 ツイッターフォロワー ） を 意味 する 。

例 11-1 は 、 @drewconway で 返さ れる フォーマット さ れ た 生 の JSON の 省略 版 を 示す 。
最も 関心 の ある JSON オブジェクト は nodes で ある 。
これ に は 、 ツイッター ユーザ に関する 記述 的 情報 が 含ま れる が 、 さらに 重要 な の は 内 向き と 外 向き の 関係 で ある 。
nodes_referenced に は 、 問い合わせ た ノード の すべて の ツイッター 友達 が 含ま れる 。
これ は 、 この ノード が フォロー し て いる 他 の ユーザ で ある （ 出次数 ） 。
同様 に 、 nodes_referenced_by オブジェクト に は 問い合わせ た ノード を フォロー し て いる ツイッター ユーザ が 含ま れる （ 入次数 ） 。

SGA クローラ は 、 ツイッター の パブリック リンク を 走査 し 、 その 関係 を データベース に 格納 する だけ で ある 。
そのため 、 プライベート ツイッターアカウント は データ に 含ま れ ない 。
自分 の SGA データ を 調べ て いる 場合 に は 、 正確 な 現状 を 反映 し て ない こと に 気付く 場合 が ある 。
具体的 に 言う と 、 nodes_referenced に 現在 は フォロー し て い ない ユーザ が 含ま れる こと が ある 。
これ は 、 SGA は アクティブ な リンク を 定期的 に しか 収集 し ない ため 、 キャッシュ さ れ た データ が 必ずしも 最新 データ を 反映 し て い ない から で ある 。

もちろん 、 ブラウザ から SGA を 扱い たく は ない 。
この API は プログラム で アクセス する ため の もの で あり 、 返さ れる JSON を 解析 し て グラフ オブジェクト に 変換 し 、 ツイッター ネットワーク の 構築 や 分析 を 実行 できる よう に する 必要 が ある 。
グラフ オブジェクト を 構築 する ため の 方策 は 、 1つ の ツイッター ユーザ を シード として 使用 し （ エルデシュ数 を 思い出し て ほしい ） 、 その シード から ネットワーク を 構築 する 。
ここ で は 、 1つ の シード から 始め 、 その シード に対する すべて の 入 出次数 接続 を 見つける 、 スノーボール サンプリング （ 雪だるま式 標本 抽出 ） という 手法 を 利用 する 。
そして 、 その 接続 を 新た な シード として 使い 、 この 処理 を 決まっ た 周期 だけ 繰り返す 。

この ケーススタディ で は 2周 期 だけ サンプリング を 実行 する が 、 これ に は 2つ の 理由 が ある 。
まず 、 シード ユーザ の ローカル ネットワーク 構造 の マッピング と 分析 を 行い 、 シード ユーザ が フォロー す べき 人 を 推奨 する こと に 関心 が ある ため で ある 。
2つ 目 は 、 ツイッター の ソーシャルグラフ の 規模 で は 、 回数 を 増やす と 、 すぐ に SGA 速度制限 と ハード ドライブ の 記憶 容量 を 超え て しまう から で ある 。
この 制約 を 念頭 に 置き 、 次 の 節 で は SGA に 取り組む ため に 基本 関数 の 開発 と データ の 解析 から 始める 。

本書 の 出版 時 に は 、 GoogleSocialGraphAPI が 本章 と コード を 最初 に 記述 し た とき と 同様 の 量 の ツイッター データ を 格納 し なく なっ て いる こと が わかっ た 。
そのため 、 本節 に 示し た とおり の コード を 実行 する と 、 結果 として 本章 の ケーススタディ を 仕上げる の に 必要 な データ と は 大幅 に 異なる データ が 作成 さ れる 。
残念 ながら 、 この データ 問題 を 解決 する 手立て は ない 。
API の 扱い に 触れる こと は 極めて 重要 で ある と 考え 、 読者 から この 説明 部分 を 奪い たく なかっ た ため 、 本節 を そのまま に し て おく こと に し た 。
本書 の 補足 ファイル に は 、 SocialGraphAPI の 変更 前 に この コード で 生成 し た いくつか の サンプル データセット を 含め て ある 。
この データ を 使用 すれ ば 、 この ケーススタディ の 残り の 部分 に 取り組める 。

まず 、 ツイッター グラフ を 作成 する の に 必要 な R パッケージ を 読み込む 。
ここ で は 、 SGA から グラフ を 構築 する ため の 3つ の R パッケージ を 使用 する 。
RCurl パッケージ は 、 SGA へ の HTTP リクエスト を 作成 する libcurl ライブラリ へ の インタフェース を 提供 する 。
次に 、 RJSONIO を 利用 し て SGA が 返す JSON を 解析 し 、 R リスト に 変換 する 。
偶然 に も 、 どちら の パッケージ も ダンカン・テンプル・ラング （ DuncanTempleLang ） が 開発 し て おり 、 彼 は 不可欠 な R パッケージ を 数多く 開発 し て いる （ http://www.omegahat.org/ を 参照 ） 。
最後 に 、 igraph を 使っ て ネットワーク オブジェクト の 構築 と 格納 を 行う 。
igraph パッケージ は グラフ オブジェクト の 作成 や 操作 の ため の 強力 な R パッケージ で あり 、 ネットワーク データ を 扱い 始める ので 、 この パッケージ の 柔軟性 は とても 貴重 で ある 。

最初 に 記述 する 関数 は 、 最も 高い レベル で SGA を 扱う 。
twitter.network 関数 を 呼び出し 、 SGA で 特定 の シード ユーザ を 問い合わせ 、 JSON を 解析 し 、 その ユーザ の エゴ ネットワーク 表現 を 返す 。
この 関数 は 1つ の パラメータ user を 取り 、 これ は シードツイッターユーザ に 相当 する 文字列 で ある 。
そして 、 対応 する SG AGET リクエスト URL を 生成 し 、 RCurl の getURL 関数 を 使っ て HTTP リクエスト を 作成 する 。
スノーボール 検索 に は 一 度 に 多く の HTTP リクエスト が 必要 な ので 、 返さ れる ページ が サービス 停止 を 表し て い ない こと を 確認 する while ループ を 組み込む 。
この while ループ が ない と 、 スクリプト は スノーボール 検索 で うっかり と その ノード を 飛ばし て しまう が 、 この 検査 を 行え ば 、 データ を 収集 する まで 新しい リクエスト を 試みる 。
API リクエスト が JSON を 返し て いる こと を 確認 し たら 、 RJSONIO パッケージ の fromJSON 関数 を 使っ て JSON を 解析 する 。

JSON を 解析 し たら 、 その データ から ネットワーク を 構築 する 。
この データ に は 、 nodes_referenced （ 出次数 ） と nodes_referenced_by （ 入次数 ） の 2種類 の 関係 が 含ま れ て いる こと を 思い出し て ほしい 。
そこで 、 この データ から 2つ の パス を 作成 し 、 両方 の 種類 の エッジ を 含める 必要 が ある 。
そのため に 、 解析 済み の SGAJSON を リスト として 取り 、 ネットワーク を 構築 する build.ego 関数 を 記述 する 。
だ た し 、 始める 前 に 、 SGA が 返す 関係 データ を 整理 し なけれ ば いけ ない 。
API リクエスト が 返す 全 ノード を よく 調べる と 、 一部 の エントリ は 正しい ツイッター ユーザ で は ない こと に 気付く だろ う 。
結果 に は 、 この 演習 に 無縁 の 関係 が 含ま れる 。
例えば 、 「 account 」 リダイレクト を 表す ツイッターリスト や URL が 多数 存在 する 。
これら は すべて ツイッター ソーシャルグラフ の 一部 で ある が 、 グラフ に この よう な ノード は 含め たく ない ので 、 この ノード を 削除 する ヘルパー 関数 を 記述 する 。

find.twitter 関数 は SGA が 返す URL の 構造 を 活用 し 、 ソーシャルグラフ の 他 の 部分 で は なく 実際 の ツイッター ユーザ で ある こと を 確認 する 。
この 関数 は 、 まず grepl 関数 を 使っ て http://twitter.com/ の パターン を 調べ 、 SGA が 返す ノード が 実際 に ツイッター の ノード で ある こと を 確認 する 。
一致 する URL に対して 、 リスト や リダイレクト で は なく 実際 の アカウント に 対応 する URL を 探す 必要 が ある 。
これ を 行う に は 、 スラッシュ で URL を 分割 し 、 非 ツイッター ユーザ の URL を 示す 「 account 」 という 単語 を 調べる 方法 が ある 。
この 非 ツイッター パターン と 一致 する インデックス を 特定 し たら 、 この パターン と 一致 し ない URL を 返せ ば よい 。
この 関数 は 、 ネットワーク に 追加 す べき ノード を build.ego 関数 に 通知 する 。

この リスト で 示さ れ た 正しい ノード を 使う と 、 ネットワーク 構築 を 開始 できる 。
ネットワーク を 構築 する に は 、 build.ego を 使用 し 、 シード ユーザ の 入 出次数 関係 を 表す 「 エッジ リスト 」 を 作成 する 。
エッジ リスト は 、 有向グラフ の 関係 を 表す 単なる 2 列 の 行列 で ある 。
最初 の 列 に は エッジ の 始点 （ ソース ） が 含ま れ て おり 、 2番 目 の 列 に は 終点 （ ターゲット ） が 含ま れる 。
この 場合 、 1列目 の ノード が 2列目 の ノード に つながっ て いる と 考える こと が できる 。
ほとんど の 場合 、 エッジ リスト に は ノード の 整数 ラベル か 文字列 ラベル が 含ま れる 。
ここ で は 、 ツイッター ユーザ名 文字列 を 使う 。

build.ego 関数 は 行 数 的 に は 長い が 、 実際 の 機能 は 極めて 単純 で ある 。
大 部分 の コード は 、 エッジ リスト の 構成 や エラー チェック に 使わ れ て いる 。
ご覧 の よう に 、 まず nodes_referenced と nodes_referenced_by の 両方 の API 呼び出し が 少なくとも 何らかの 関係 を 返し て いる こと を 確認 する 。
そして 、 実際 に ツイッター ユーザ を 表す ノード を 調べる 。
どちら の 検査 で も 何 も 返さ れ ない 場合 に は 、 関数 の 出力 として 特殊 な ベクトル c ( integer ( 0 ), integer ( 0 )) を 返す 。
この 過程 で 、 friends と followers という 適切 な 名前 を 付け た 2つ の エッジ リスト 行列 を 作成 する 。
最後 の ステップ で は 、 rbind を 使っ て この 2つ の 行列 を ego.el という 1つ の エッジ リスト に 結合 する 。
データ が ない 場合 に 特殊 な ベクトル c ( integer ( 0 ), integer ( 0 )) を 使っ た の は 、 rbind は 事実上 この ベクトル を 無視 し 、 結果 に 影響 を 与え ない から で ある 。
これ は R コンソール で 以下 を 入力 すれ ば 確認 できる 。

なぜ igraph で 直接 グラフ を 作成 せ ず に 、 関係 の エッジ リスト だけ を 作成 し た の か 不思議 に 思う かも しれ ない 。
igraph が メモリ に グラフ を 格納 する 方法 が 原因 で 、 スノーボール の サンプル に 必要 な 反復 的 な グラフ 構築 が 困難 な こと も ある 。
そのため 、 まず 関係 データ 全体 を （ この 場合 は エッジ リスト として ） 作成 し 、 その データ を 後で グラフ に 変換 する 方 が はるか に 簡単 で ある 。

これ で グラフ 構築 スクリプト の 中核 が 記述 でき た 。
build.ego 関数 は 、 SGA から 解析 済み の JSON を 取り出し 、 igraph が ネットワーク に 変換 できる 形式 に 変換 する という 難しい 処理 を 行う 。
最後 に 作成 す べき 機能 は 、 スノーボール サンプル を 生成 する ため に すべて を まとめる 機能 で ある 。
スノーボール サンプル を 生成 する twitter.snowball 関数 と 、 訪問 す べき 新しい シード の リスト を 生成 する 1つ の 小さな ヘルパー 関数 get.seeds を 作成 する 。
build.ego の 場合 と 同様 に 、 twitter.snowball の 主 な 目的 は 、 ネットワーク 関係 の エッジ リスト を 作成 する こと で ある 。
しかし 、 ここ で は 多数 の build.ego 呼び出し の 結果 を 結合 し 、 igraph グラフ オブジェクト を 返す 。
簡単 に する ため に 、 get.seeds 関数 から 始める が 、 この 関数 は twitter.snowball が 生成 する もの を 参照 する 。

get.seeds の 目的 は 、 エッジ リスト から シード ノード で は ない ユニーク な ノード を 見つける こと で ある 。
これ は 、 2 列 の 行列 を 1つ の ベクトル に 変換 し 、 その ベクトル の ユニーク な 要素 を 見つけれ ば 簡単 で ある 。
この 整理 さ れ た ベクトル を new.seeds と 呼び 、 この ベクトル で シード で は ない 要素 だけ を 返す 。
これ は 簡単 で 効率 的 な 方法 だ が 、 この 方法 を 使う 際 に 考慮 す べき こと が 1つ ある 。

get.seeds 関数 は 、 新しい シード が 現在 の シード と 同じ では ない こと を 調べる だけ で ある 。
スノーボール サンプル で は 、 すでに 構造 を 再生 し た ネットワーク の ノード を 再 訪問 し ない よう に する 仕組み を 含め たい 。
最終 的 な エッジ リスト で 重複 行 を 簡単 に 削除 できる ので 、 これ は 技術 的 な 観点 で は 必ずしも 重要 で は ない 。
しかし 、 実用 的 観点 から 見る と 重要 で ある 。
新た な 構造 を 構築 する 前 に 新しい シード 候補 の リスト から すでに 訪問 済み の ノード を 取り除く と 、 API の 呼び出し 回数 を 減らす こと が できる 。
これ は 、 SGA の 速度制限 を 超える 可能 性 を 減らし 、 スクリプト の 実行 時間 の 短縮 に つながる 。
この 機能 を get.seeds に 行わ せる の で は なく 、 ネットワークエッジリスト 全体 を すでに メモリ 内 に 格納 し て いる twitter.snowball に 追加 する 。
これ により 、 スノーボール 全体 の 作成 中 に メモリ 内 に エッジ リスト 全体 の コピー が 複数 存在 する こと が なくなる 。
この 程度 の 規模 に なる と 、 特に R の よう な 言語 の 場合 は メモリ を 大いに 意識 する 必要 が ある 。

twitter.snowball 関数 の 機能 は 、 推察 の とおり で ある 。
この 関数 は seed と k の 2つ の パラメータ を 取る 。
seed は ツイッター ユーザ の 文字列 で あり 、 この 例 で は 「 drewconway 」 や 「 johnmyleswhite 」 に なる 。
k は 2 以上 の 整数 で 、 スノーボール 検索 の 繰り返し 数 を 定める 。
ネットワーク 用語 で は 、 一般 に k 値 は グラフ 内 の 度数 や 距離 を 表す 。
ここ で は 、 スノーボール サンプル に 含める 、 ネットワーク 内 の シード から の 距離 に 相当 する 。
最初 に 、 シード から 初期 エゴ ネットワーク を 構築 する 。
そして 、 その エゴ ネットワーク から 次 周期 の シード を 取得 する 。

これ は twitter.net work と get.seeds の 呼び出し で 実行 する 。
これ で スノーボール サンプル の 反復 処理 を 開始 できる 。
サンプリング 全体 は 、 twitter.snowball の while ループ 内 で 行う 。
この ループ の 基本 的 な 論理 構造 は 次 の よう に なる 。
まず 、 サンプル 距離 の 終端 に 到達 し て い ない こと を 確認 する 。
到達 し て い なけれ ば 、 別 の 階層 の スノーボール 作成 に 進む 。
別 の 階層 の スノーボール を 作成 する に は 、 新しい シード ユーザ それぞれ の エゴ ネットワーク を 反復 的 に 構築 する 。
all.nodes オブジェクト は 、 すでに 訪問 し た ノード を 管理 する ため に 使う 。
つまり 、 ノード の エゴ ネットワーク を 構築 する 前 に 、 まず その ノード が すでに all.nodes に 含ま れ て い ない こと を 確認 する の で ある 。
含ま れ て い なけれ ば 、 この ユーザ の 関係 を snowball.el 、 next.seeds 、 all.nodes に 追加 する 。
次 の 周期 の スノーボール に 進む 前 に 、 new.seeds に 重複 が 含ま れ て い ない こと を 確認 する 。
やはり 、 これ も ノード を 再 訪問 し ない ため に 行う 。
最後 に 、 rounds カウンタ を インクリメント する 。

最後 に 、 graph.edgelist 関数 を 使用 し て 、 スノーボール サンプル 全体 の エッジ リスト を 表す snowball.el 行列 を igraph グラフ オブジェクト に 変換 する 。
ただし 、 変換 前 に 最後 の 後処理 を 実行 する 。
SGA 内 の データ は 不完全 で ある ので 、 サンプル エッジ 間 の 関係 が 重複 し て いる 場合 が ある 。
理論 的 に グラフ 化 する なら 、 重複 し た 関係 を そのまま にし 、 ツイッター ネットワーク として 「 マルチ グラフ 」 という 特殊 な 種類 の グラフ を 使う こと が できる 。
マルチ グラフ は 、 単に 同じ ノード 間 に 複数 の エッジ を 持つ グラフ で ある 。
この 枠組み は 状況 によって は 便利 で ある が 、 この モデル に 有効 な ソーシャルネットワーク 分析 尺度 は ほとんど 存在 し ない 。
また 、 ここ で は 余計 な エッジ は エラー の 結果 な ので 、 グラフ オブジェクト に 変換 する 前 に 重複 し た エッジ を 削除 する 。

これ で 、 ツイッター ネットワーク を 構築 する の に 必要 な すべて の 機能 が 手 に 入っ た 。
次 の 節 で は 、 特定 の シード ユーザ から ネットワーク を 素早く 構築 し やすく する 補足 スクリプト を 作成 し 、 グラフ に対して 基本 的 な 構造 分析 を 実行 し て ローカル コミュニティ 構造 を 発見 する 。

いよいよ ツイッター ネットワーク の 構築 を 始める 。
R スクリプト を 作成 し て 実行 する ため の 代替 手段 を 紹介 する ため に 、 ここ で は コード を コマンドライン で 実行 する シェルスクリプト として 作成 する 。
これ まで は R コンソール 内 で 実行 する コード を 記述 し て おり 、 おそらく これ が R言語 の 主 な 使い方 で あろ う 。
しかし 、 時には 異なる 入力 で 何度 も 実行 し たい タスク や プログラム も ある 。
その 場合 、 コマンドライン で 実行 し 、 標準入力 から の 入力 を 取る プログラム を 記述 する 方 が 簡単 で ある 。
これ に は 、 R の インストール に 付属 し て いる Rscript コマンドライン プログラム を 使用 する 。
コード を すぐ に 実行 する の で は なく 、 まず Rscript を 調べ て その 動作 を 理解 し て から プログラム を 起動 しよ う 。

本書 の 執筆 時 に 明らか に なっ た GoogleSocialGraphAPI の 変更 の ため に 、 新しい ツイッターネットワークデータ を 生成 でき なく なっ て いる 。
そのため 、 本章 の これ 以降 で は 、 最初 の 時点 で 収集 し た ジョン （@ johnmyleswhite ） の ツイッターネットワークデータ を 使用 する 。

多く の 異なる ユーザ の ツイッター ネットワーク を 構築 し たい ので 、 プログラム が さまざま な ユーザ 名 と 入力 を 受け取り 、 必要 に 応じ て データ を 生成 できる よう に する 。
メモリ 内 に ネットワーク オブジェクト を 作成 し たら 、 基本 的 な ネットワーク 分析 を 実行 し て 、 根底 に ある コミュニティ 構造 を 特定 し て その 情報 を グラフ オブジェクト に 追加 し 、 ネットワーク を ファイル として ディスク に エクスポート する 。
最初 に 、 igraph ライブラリ と 前節 で 作成 し た 関数 を 読み込む 。
関数 は google_sg.R ファイル に 格納 さ れ て いる 。

再び igraph ライブラリ を 使用 し 、 ツイッターグラフオブジェクト の 構築 と 操作 を 行う 。
source 関数 を 利用 し 、 前節 で 記述 し た 関数 を 読み込む 。
この ケーススタディ で は 新しい データ は 生成 し ない ので 、 johnmyleswhite フォルダ の データ を 読み込む こと で 事前 に 収集 し た ジョン の ツイッター ネットワーク の データ を 読み込む 。

Windows ユーザ へ の 注 ： DOS シェル から は この スクリプト を 実行 でき ない かも しれ ない 。
その 場合 に は 、 user 変数 を ネットワーク を 構築 し たい ツイッター ユーザ に 設定 し 、 以前 と 同様 に この スクリプト を 実行 する 。
これ は twitter_net.R ファイル 内 に も 再度 記載 さ れ て いる 。

前節 で 必要 な サポート 関数 を すべて 作成 し た ので 、 twitter.snowball 関数 に シード ユーザ を 渡す だけ で ある 。
また 、 この 例 で は シード ユーザ の エゴ ネットワーク を 構築 する こと に 関心 が ある ので 、 スノーボール サンプル に は 2周 期 だけ を 使用 する 。
後で データ を 見栄え よく 可視 化 できる グラフ 可視化 ソフトウェア Gephi に ネットワーク ファイル を 読み込む 。
Gephi に は 可視化 に 使う 予約 変数 が ある 。
この 予約 変数 の 1つ が Label 変数 で あり 、 グラフ の ノード に ラベル を 付ける の に 使用 する 。
デフォルト で は 、 igraph は ラベル 情報 を name 頂点 属性 として 格納 する ので 、 この 情報 を 複製 する Label という 新た な 頂点 属性 を 作成 する 必要 が ある 。
これ は set.vertex.attribute 関数 を 使っ て 行う 。
set.vertex.attribute 関数 は 、 前 の 手順 で 作成 し た user.net グラフ オブジェクト 、 新しい 属性 、 その 属性 に 割り当てる データ の ベクトル を 取る 。

Gephi は 、 オープンソース で マルチプラットフォーム の グラフ 可視化 / 操作 プラットフォーム で ある 。
R の 組み込み ネットワーク 可視化 ツール と igraph は 便利 だ が 、 ここ で の ニーズ に は 不十分 で ある 。
Gephi は ネットワーク 可視化 に 特 化 し て 設計 さ れ て おり 、 高品質 な ネットワーク グラフィックス を 作成 する ため の 便利 な 機能 が 多数 含ま れ て いる 。
Gephi を インストール し て い ない 場合 や 旧 バージョン を 使っ て いる 場合 に は 、 http://gephi.org/ から 入手 できる 最新 バージョン を インストール する こと を 強く おすすめ する 。

これ で グラフ オブジェクト が 作成 でき た ので 、 基本 的 な ネットワーク 分析 を 実行 し 、 複雑 さ の 軽減 と ローカル コミュニティ 構造 の 発見 の 両方 を 行う 。

分析 工程 の 最初 の ステップ は 、 グラフ の 中核 要素 の 抽出 で ある 。
user.net オブジェクト に は 、 抽出 し たい 2つ の 便利 な サブ グラフ が ある 。
まず 、 k - コア 分析 を 行い 、 グラフ の 2 コア を 抽出 する 。
定義 に よれ ば 、 k - コア 分析 は グラフ を ノード の 接続 性 で 分解 する 。
グラフ の 「 コア 度 」 を 見つける ため に 、 いくつ の ノード が ある 次数 を 持つ か を 知り たい 。
k - コア の k は 分解 の 次数 を 表す 。
したがって 、 グラフ の 2 コア は 、 2 以上 の 次数 を 持つ ノード から 構成 さ れる サブ グラフ で ある 。
スノーボール 検索 を 行う と ネットワーク の 外側 に 多く の ぶら下がっ た ノード が 含ま れる という 副作用 が 当然 ある ので 、 2 コア を 抽出 し たい 。
この ぶら下がり ノード は 、 ネットワーク 構造 に関する 有益 な 情報 に は ほとんど なら ない ので 削除 し たい 。

しかし 、 ツイッター グラフ は 有向グラフ で ある ので 、 ノード は 入次数 と 出次数 の 両方 を 持つ 。
この 分析 に 関連 の 高い ノード を 見つける ため に 、 graph.coreness 関数 を 使い 、 mode =" in " パラメータ を 設定 し て 入次数 で 各 ノード の 「 コア 度 」 を 計算 する 。
この よう に する の は 、 2つ の エッジ を 与える ノード で は なく 、 少なくとも 2つ の エッジ を 受け取る ノード を 保持 し たい から で ある 。
スノーボール サンプル に 含ま れる ぶら下がり ノード は ネットワーク へ の 接続 は 持つ だろ う が 、 ネットワーク から の 接続 は ない 。
したがって 、 入次数 を 使っ て ぶら下がり ノード を 探す 。

subgraph 関数 は グラフ オブジェクト と 一連 の ノード を 入力 として 取り 、 渡し た グラフ の ノード で 作成 さ れ た サブ グラフ を 返す 。
user.net グラフ の 2 コア を 抽出 する ため に 、 R の 基本 関数 which を 使い 、 コア 度 の 入次数 が 1 より 大きい ノード を 見つける 。

igraph を 扱う 際 に 最も 厄介 な 「 決まり 」 の 1つ は 、 igraph の ノード の インデックス は 0 から 始まる の に対し 、 R の インデックス は 1 から 始まる こと で ある 。
2 コア の 例 で は 、 恐ろしい 「 1つ ずれる 」 エラー に 陥ら ない よう に which が 返す ベクトル から 1 を 引い て いる の に 気付く だろ う 。

抽出 する 2つ 目 の 主要 サブ グラフ は 、 シード の エゴ ネットワーク で ある 。
これ は シード の 隣接 ノード で 作成 さ れる サブ グラフ で ある 。
ありがたい こと に 、 igraph に は 隣接 ノード を 特定 する ため の 便利 な neighbors 関数 が ある 。
ただし 、 やはり ツイッター の 有向グラフ 構造 を 認識 し て い なけれ ば いけ ない 。
ノード の 隣接 ノード は 内 向き と 外 向き が ある ので 、 neighbors 関数 に どちら が 必要 か を 知らせ なけれ ば いけ ない 。
この 例 で は 、 出次数 隣接 ノード （ つまり 、 シード を フォロー する ツイッター ユーザ で は なく シード が フォロー する ツイッター ユーザ ） で 作成 さ れる エゴ ネットワーク を 調べる 。
分析 的 観点 から 見る と 、 特に 自分 の データ を 調べ て いる とき に は 、 誰か が フォロー する ユーザ の 調査 の 方 に 関心 が ある だろ う 。
と は いえ 、 その 逆 を 調査 し て み て も 面白い かも しれ ない ので 、 この コード を 再 実行 し 、 代わり に 入次数 隣接 ノード も 調べ て みる と よい 。

本章 の 残り の 部分 で は 、 エゴ ネットワーク を 重点的 に 扱う が 、 2 コア は 他 の ネットワーク 分析 に 非常 に 役立つ ので 、 データ 操作 の 一部 として 2 コア を 保存 する 。
これ で エゴ ネットワーク を 分析 し 、 ローカル コミュニティ 構造 を 見つける 準備 が 整っ た 。
この 演習 で は 、 どの コミュニティ に 所属 する か を 決める ため の 最も 基本 的 な 手法 の 1つ で ある ノード 距離 の 階層 的 クラスタリング を 使う 。
この 手法 は 名前 こそ 長い が 、 考え方 は 極めて シンプル で ある 。
密接 に 接続 さ れ て いる ノード （ この 場合 は ツイッター ユーザ ） ほど ノード 間 の ホップ が 少なく 、 類似 し て いる と みなす 。
ツイッター で は 関心事 を 共有 し て いる 人々 が 互いに フォロー し て いる と 考え られる ので 、 この 考え方 は 実質的 に うなずける 。
人 は エゴ ネットワーク 内 に 複数 の 異なる コミュニティ を 持つ 可能性 が ある ので 、 特定 の ユーザ の コミュニティ 構造 が どの よう に なっ て いる か に 関心 が ある 。

この よう な 分析 を 行う 際 に は 、 まず グラフ 内 の 全 ノード 間 の 距離 を 測定 する 。
これ に は shortest.paths を 使う 。
shortest.paths は N×N の 行列 を 返し 、 N は グラフ 内 の ノード 数 で あり 、 行列 の 各 要素 は その ノード ペア 間 の 最短 距離 に なる 。
この 距離 を 使い 、 互い の ノード の 近 さ に 基づい て ノード 区分 を 計算 する 。
「 階層 的 」 クラスタリング に は 、 その 名前 が 示す よう に 多く の 階層 が ある という こと で ある 。
「 階層 的 」 クラスタリング で は 、 区分 数 を 増やす 際 に 、 同じ 区分 内 の 距離 が 近い ノード 群 を 保持 する こと で 階層 を 作成 （ 分割 ） する 。
階層 が 下がる たび に 、 区分 数 （ ノード の グループ ） が 1つ 増える 。
この 手法 を 使う と 、 グラフ を さらに 粒度 の 細かい ノード グループ に 反復 的 に 分解 でき 、 全 ノード が 同じ グループ の 状態 から 始め 、 すべて の ノード が それぞれ の グループ に 収まる まで 階層 を 下っ て いく 。

R は 、 クラスタリング を 行う ため の 便利 な 関数 を 数多く 備え て いる 。
この 作業 で は 、 dist 関数 と hclust 関数 を 組み合わせ て 使う 。
dist 関数 は 、 観測 値 の 行列 から 距離行列 を 作成 する 。
ここ で は 、 shortest.path 関数 で 距離 を すでに 計算 し て いる ので 、 dist 関数 は その 行列 を hclust が 扱える 形式 に 変換 する だけ で ある 。
hclust 関数 は クラスタリング を 行い 、 必要 な クラスタリング 情報 を すべて 含む 特殊 な オブジェクト を 返す 。

階層 的 に クラスタリング を 行っ たら 、 区分 の 系統樹 （ デンドログラム ） を 見る と 有益 で ある 。
系統樹 は 、 階層 を 下る に したがっ て どの よう に 分類 さ れ て いる か を 示す 樹 状 図 で ある 。
これ により 、 エゴ ネットワーク の コミュニティ 構造 を 初めて 垣間見る こと が できる 。
例 として 、 ジョン の ツイッターエゴネットワーク の 系統樹 を 調べ て みよ う 。
ジョン の ツイッターエゴネットワーク は 、 本章 の data/ ディレクトリ に 含ま れ て いる 。
ジョン の 系統樹 を 見る ため に 、 彼 の エゴネットワークデータ を 読み込み 、 クラスタリング を 実施 し て から hclust オブジェクト を 、 系統樹 の 描画 を 引き受ける plot 関数 に 渡す 。

図 11-3 を 見る と 、 ジョン の ツイッター ネットワーク から とても 興味深い コミュニティ 構造 が 生じ て いる こと が わかる 。
比較的 はっきり と 高水準 の 2つ の コミュニティ に 分かれ て いる よう に 見え 、 それぞれ の コミュニティ 内 に は 小さい 緊密 な サブ グループ が 数多く 存在 する 。
もちろん 、 人 によって データ は 異なり 、 存在 する コミュニティ 数 は ツイッターエゴネットワーク の 大き さ と 密度 に 大きく 左右 さ れる 。

系統樹 を 使っ た クラスタ の 調査 は 学術的 見地 から は 興味深い が 、 本当は これ を ネットワーク 上 で 見 たい 。
そのため に は 、 ノード に クラスタリング 区分 データ を 追加 する 必要 が ある ため 、 最初 の 10 個 の 重要 な 区分 を ネットワーク に 追加 する 簡単 な ループ を 使う 。
重要 な 区分 という 意味 から 、 最初 の 区分 で は すべて の ノード を 同じ グループ に 割り当てる ため 、 最初 の 区分 は 飛ばす 。
最初 の 区分 は 全体 的 な 階層 という 観点 で は 重要 で ある が 、 ローカル コミュニティ 構造 は わから ない 。

cutree 関数 は 、 特定 の 階層 の 各 要素 へ の 区分 割り当て を 返す 。
つまり 、 「 ツリー （ 木 ） を 切る 」 の で ある 。
クラスタリング アルゴリズム は 1つ の ノード が 中心 と なる エゴ ネットワーク が 与え られ て いる こと を 知ら ない ので 、 クラスタリング の 各 階層 で 他 の ノード と 一緒に シード を グループ 化 する 。
可視化 中 に 後で シード ユーザ を 簡単 に 特定 できる よう に する ため に 、 シード ユーザ に 独自 の クラスタ " 0 " を 割り当てる 。
最後 に 、 set.vertex.attributes 関数 を 再び 使い 、 この 情報 を グラフ オブジェクト に 追加 する 。
これ で 、 ツイッター 名 と 分析 の 最初 の 10 個 の クラスタリング 区分 を 含む グラフ オブジェクト が 手 に 入る 。

Gephi を 起動 し て 結果 を 可視 化 する 前 に 、 グラフ オブジェクト を ファイル に 保存 する 。
write.graph 関数 を 使用 し 、 この データ を GraphML ファイル として エクスポート する 。
GraphML は 数 ある ネットワーク ファイル 形式 の 1つ で あり 、 XML ベース で ある 。
グラフ オブジェクト に は ノード ラベル や クラスタ 区分 など 多く の メタデータ が 含ま れ て いる ので 、 ここ で の 目的 に は GraphML が 便利 で ある 。
XML ベース の ほとんど の 形式 と 同様 に 、 GraphML ファイル は 大規模 な データ を 高速 に 取得 でき 、 関係 データ を 格納 する だけ に は 適し て い ない 。
GraphML に関する 詳細 は 、 http://graphml.graphdrawing.org/ を 参照 し て ほしい 。

処理 中 に 生成 さ れる 3つ の グラフ すべて を 保存 する 。
次 の 節 で は 、 本書 に 付属 する サンプル データ を 使い 、 Gephi で 結果 を 可視 化 する 。

前述 の とおり 、 Gephi プログラム を 使っ て ネットワーク データ を 可視 化 し て 調べる 。
すでに Gephi を ダウンロード し て インストール し て あれ ば 、 まず アプリケーション を 起動 し 、 ツイッター の データ を 読み込む 。
この 例 で は 、 本章 の code/data/drewconway/ に ある 、 ドリュー の ツイッターエゴネットワーク を 利用 する 。
ただし 、 自分 の ツイッター データ を 作成 し て いる なら 、 代わり に その データ を 使っ て かまわ ない 。

これ は 決して Gephi で の ネットワーク の 可視化 を 包括 的 に 説明 する もの で ない 。
本節 で は 、 ツイッターエゴネットワークデータ の ローカル コミュニティ 構造 を 可視 化 し て 調べる 方法 を 説明 する だけ で ある 。
Gephi は 、 データ 分析 の ため の 多数 の オプション を 備え た 、 ネットワーク 可視化 の ため の 強力 な プログラム で ある 。
本節 で は その 機能 の ほんの 一部 を 利用 する が 、 Gephi プログラム を いじり 、 多数 の オプション を 調べる こと を 強く おすすめ する 。
まずは 、 http://gephi.org/2010/quick-start-tutorial/ から オンライン で 利用 できる 、 Gephi の クイック スタート チュートリアル から 始める と よい だろ う 。

Gephi を 起動 し たら 、 ［ File ］ の ［ Open ］ メニュー バー で エゴ ネットワーク を 読み込む 。
図 11-4 の 右側 の 画面 に 示す よう に 、 drewconway ディレクトリ に 移動 し て drewconway_ego.graphml ファイル を 開く 。
グラフ を 読み込ん だら 、 Gephi は 読み込ん だ ネットワーク ファイル に関する 基本情報 を 返す 。
図 11-4 （ A ） の 左側 の 画面 に この 情報 を 示し て おり 、 ノード 数 （ 262 ） や エッジ 数 （ 6 , 945 ） が 含ま れる 。
ウィンドウ 内 の ［ Report ］ タブ を クリック する と 、 この ネットワーク に 追加 し た すべて の 属性 データ も 見る こと が できる 。
特に 興味深い の は ノード 属性 HC * で あり 、 この 属性 は 最初 の 10 個 の 重要 な 区分 の 階層 的 クラスタリング 区分 ラベル で ある 。

Gephi が ネットワーク を ランダム に 配置 さ れ た ノード の 大きな 寄せ 集め （ 恐ろしい 「 ネットワーク 毛玉 」 ） として 読み込ん で いる こと に まず 気付く で あろ う 。
ネットワーク 内 の コミュニティ 構造 情報 の 多く は 、 ノード を もっと よく 考慮 し た 配置 で 表す こと が できる 。
大規模 で 複雑 な ネットワーク で の ノード 配置 手法 や アルゴリズム は 、 ちょっとした 家内工業 で ある 。
そのため 、 ノード の 再 配置 方法 が 無数 に ある 。
ここ で は 、 共有 する 接続 が 多い ノード を 近く に 配置 し たい 。
この クラスタリング 手法 で は 、 互い の 距離 によって ノード を グループ 化 し て いる 。
距離 が 短い ノード が 一緒に グループ 化 さ れる ので 、 可視化 手法 で も これ を 反映 し たい 。

ノード を 配置 する ため の 一般 的 な 手法 に は 、 「 力 指向 」 アルゴリズム を 活用 する 手法 が ある 。
名前 が 示す よう に 、 この アルゴリズム は 、 ネットワーク 上 に 引力 と 反発 力 を 配置 し た 場合 に ノード が どの よう に 配置 さ れる か を シミュレート しよ う と する 。
Gephi が 現在 表示 し て いる ノード 間 の 要領 を 得 ない エッジ の 寄せ 集め が 実は 輪ゴム で あり 、 ノード が 磁荷 を 帯びる こと が できる ボールベアリング で ある と しよ う 。
力 指向 アルゴリズム は 、 ボールベアリング ノード が 磁荷 の 結果 として 互いに どの よう に 反発 し 、 輪ゴム によって どの よう に 引き戻さ れる か を 計算 しよ う と する 。
その 結果 、 ローカル コミュニティ 構造 に したがっ て ノード を 整然と 配置 し て 可視 化 する 。

Gephi に は 力 指向 配置 の 多く の 例 が 含ま れ て いる 。
［ Layout ］ パネル の プルダウン メニュー に は さまざま な オプション が あり 、 その 一部 が 力 指向 で ある 。
ここ で は 、 ［ YifanHuProportional ］ アルゴリズム を 選び 、 デフォルト 設定 を 使う 。
この アルゴリズム を 選ん で ［ Run ］ ボタン を クリック する と 、 Gephi は この 力 指向 方法 で ノード を 再 配置 する 。
ネットワーク の 大き さ や 実行 し て いる 具体 的 な ハードウェア によって は 、 この 処理 は ある程度 時間 が かかる こと も ある 。
ノード の 移動 が 終わっ たら 、 この アルゴリズム は ノード 配置 を 最適 化 し 、 次に 進む 準備 が 整う 。

ネットワーク 内 の ローカル コミュニティ を もっと 簡単 に 見つける ため に 、 ノード の サイズ を 変更 し 、 色 を 付ける 。
ネットワーク は 有向 エゴ ネットワーク な ので 、 ノード の サイズ を ノード の 入次数 の 関数 として 設定 する 。
すると 、 ネットワーク の ほぼ すべて の メンバー が シード を フォロー し て いる ので シード ノード が 最大 に なり 、 エゴ ネットワーク の 他 の 著名 な ユーザ の サイズ も 大きく なる 。
［ Ranking ］ パネル で 、 ［ Nodes ］ タグ を クリック し て プルダウン から ［ InDegree ］ を 選択 する 。
赤い ダイヤモンドアイ コン を クリック し 、 サイズ を 設定 する 。
最大 サイズ と 最小 サイズ を 任意 の 値 に 設定 できる 。
図 11-5 の 下 半分 に 示す よう に 、 ドリュー の ネットワーク で は 最小 を 2 、 最大 を 16 に 設定 し た が 、 状況 に 応じ て 適切 な 設定 が ある だろ う 。
値 を 設定 し たら 、 ［ Apply ］ ボタン を クリック し て ノード の サイズ を 変更 する 。

最後 に 、 コミュニティ 区分 で ノード に 色 を 付ける 。
［ Ranking ］ パネル の 上 の ［ Partition ］ パネル に は 、 反対 向き の 2つ の 矢印 を 持つ アイコン が ある 。
この アイコン を クリック し 、 この グラフ の 区分 の リスト を 更新 する 。
すると 、 プルダウン に は この 区分 に 含ま れる ノード 属性 データ が 表示 さ れる 。
図 11-5 の 上 半分 に 示す よう に 、 ここ で は HC 8 （ 8番 目 の 区分 ） を 選ん で おり 、 ドリュー （ drewconway ） の 区分 と 彼 の エゴ ネットワーク 内 の 他 の 7つ の ノード が 含ま れる 。
再び ［ Apply ］ ボタン を クリック する と 、 ノード は 区分 によって 色付け さ れる 。

すぐさま 根底 に ある 構造 が わかる で あろ う 。
特定 の ネットワーク が どの よう に 小さな サブ コミュニティ に 分かれる か を 知る 優れ た 方法 に は 、 階層 的 クラスタ の 区分 を 調べ て いく 方法 が ある 。
練習 として 、 Gephi で 区分 の 粒度 が 細かく なる ごと に ノード に 繰り返し 色 を 付け 直し て みる こと を おすすめ する 。
HC 2 から 始め て HC 10 まで 進み 、 毎回 ノード の 色 を 付け 直し 、 大きな グループ が どの よう に 分割 さ れ て いく か を 確認 する 。
すると 、 ネットワーク の 根底 に ある 構造 について 多く の こと が わかる 。
図 11-6 は HC 8 で 色付け し た ドリュー の エゴ ネットワーク を 示し て おり 、 彼 の ツイッター ネットワーク の ローカル コミュニティ 構造 を 見事 に 浮かび上がら せ て いる 。

ドリュー は 、 基本的 に 4つ の 主要 サブ コミュニティ を 持っ て いる よう に 見える 。
ドリュー 自身 は 中央 で 青緑 に 色付け さ れ て おり 、 その 左側に 赤 と 紫 に 色付け さ れ た 密接 に 接続 する 2つ の グループ が ある 。
そして 、 右側に は 少し 接続 の 密接 度 が 低い 2つ の サブ グループ が あり 、 青 と 緑 に 色付け さ れ て いる 。
もちろん 、 オレンジ 、 ピンク 、 薄 緑 に 色付け さ れ た グループ も ある が 、 ここ で は この 4つ の 主要 グループ に 着目 する 。

図 11-7 で は 、 ネットワーク の 左側に 注目 し 、 ノード ラベル を 見やすく する ため に エッジ を 取り除く 。
この クラスタ の ツイッター 名 に ざっと 目 を 通す と 、 ドリュー の ネットワーク の 左側に は ドリュー が ツイッター で フォロー し て いる データ マニア が 含ま れる 。
まず 、 ティム・オライリー （ timoreilly ） や ネイサン・ヤウ （ flowingdata ） など の とても 著名 な データ マニア が おり 、 彼ら は いくぶん 「 独自 の グループ 」 を 形成 し て いる ので 、 薄 緑 に 色付け さ れ て いる 。
紫 と 赤 の グループ も 興味深い 。
どちら も データ ハッカー が 含ま れる が 、 1つ の 主要 な 要因 で 分割 さ れ て いる 。
ヒラリー・メイソン （ hmason ） 、 ピート ・ スコモロチ （ peteskomoroch ） 、 ジェイク・ホフマン （ jakehofman ） など 、 紫 に 色付け さ れ て いる ドリュー の 友達 は データ コミュニティ の 著名 な メンバー で ある が 、 誰 も R コミュニティ の 雄弁 な メンバー で は ない 。
一方 、 赤 で 色付け さ れ て いる ノード は R コミュニティ の 雄弁 な メンバー で あり 、 ハドレー・ウィッカム （ hadleywickham ） 、 デビッド ・ スミス （ revodavid ） 、 ゲイリー ・ キング （ kinggary ） が 含ま れる 。

さらに 、 力 指向 アルゴリズム は これら の メンバー を 互いに 近く に 配置 する こと に 成功 し て おり 、 この 2つ の コミュニティ 間 の メンバー を エッジ に 配置 し て いる 。
ジョン （ johnmyleswhite ） は 紫 に 色付け さ れ て いる が 、 他 の 多く の 赤 ノード と 一緒に 配置 さ れ て いる 。
これ は ジョン が 両方 の コミュニティ で 有名 で ある から で あり 、 データ は それ を 反映 し て いる 。
同様 の 例 として は 、 他 にも JD ・ ロング （ cmastication ） や ジョシュ ・ ライヒ （ i 2 pi ） など が いる 。

ドリュー は データ コミュニティ （ R ユーザ と 非 R ユーザ の どちら も 同様 ） の メンバー と の やり取り に 多く の 時間 を 費やし て いる が 、 ドリュー は その他 の 興味 を 満たす コミュニティ と の やり取り に も ツイッター を 利用 し て いる 。
特に 興味 が ある の は 彼 の アカデミック な 経歴 で あり 、 国家安全保障 技術 と 政策 が 中心 と なっ て いる 。
図 11-8 では ドリュー の ネットワーク の 右側に 焦点 を 当て 、 ここ に は 国家安全保障 関係 の コミュニティ の メンバー が 含ま れる 。
データマニアグループ と 同様 に 、 ここ に も 2つ の サブ グループ が 含ま れ 、 一方 は 青 、 他方 は 緑 で 色付け さ れ て いる 。
前述 の 例 と 同様 に 、 区分 の 色 と ノード の 配置 から ネットワーク 内 で の 役割 が かなり わかる 。

青 区分 の ツイッター ユーザ は 散らばっ て いる 。
ドリュー に 近く 、 ネットワーク の 左側に 位置 する ユーザ も いれ ば 、 かなり 右側 に 離れ て おり 、 緑 の グループ に 近い ユーザ も いる 。
左側 に 離れ て いる 人々 は 国家安全保障 技術 の 役割 に 携わっ て おり 、 ショーン ・ ゴーリー （ sgourley ） 、 ルイス ・ シェパード （ lewisshepherd ） 、 ジェフリー ・ カー （ JeffreyCarr ） など が 含ま れる 。
緑 に 近い 人々 は 、 緑 グループ の 他 の メンバー と 同様 に 国家安全保障 政策 の 方 に 着目 し て いる 。
緑 の グループ に は 、 アンドリュー ・ イクサム （ abumuqawama ） 、 ジョシュア ・ ファウスト （ joshuaFoust ） 、 ダヴィド・ガルテンスタイン − ロス （ daveedgr ） など の 国家安全保障 コミュニティ の 有名 な メンバー が 多数 含ま れる 。
興味深い こと に 、 以前 と 同様 に この グループ 間 に 位置 する 人々 は エッジ の 近く に 配置 さ れ て いる クリス ・ アル ボン （ chrisalbon ） など で あり 、 両方 の コミュニティ で 有名 で ある 。

自分 の データ を 調べ て いる 場合 に は 、 どの よう な ローカル コミュニティ 構造 が 出現 し て いる だろ う か ？ おそらく 、 ドリュー の ネットワーク の 場合 と 同様 に 構造 が 極めて 明確 な 場合 も あれ ば 、 コミュニティ が もっと わかり にくい 場合 も ある 。
この 構造 を 詳しく 調べる の は 非常 に 興味深く 参考 に なる ので 、 やっ て みる こと を おすすめ する 。
次 の 最後 の 節 で は 、 この コミュニティ 構造 を 使い 、 ツイッター 用 の 独自 の 「 フォロー す べき 人 」 推奨 エンジン を 作成 する 。

ツイッター 用 の 独自 の 友達 推奨 エンジン の 構築 方法 について は 、 多く の 考え方 が ある 。
ツイッター の データ に は 多く の 次元 が ある ので 、 何 について 「 つぶやい て いる 」 か を 基 に 推奨 する 人 を 考える こと が できる 。
これ は テキストマイニング の 練習 で あり 、 つぶやき 全体 の 中 の 共通 の 単語 や 話題 に 基づい て 人々 を 照合 する 必要 が ある 。
同様 に 、 多く の つぶやき に は 地理 位置情報 データ が 含ま れ て いる ので 、 地理的 に 近い 活発 な ユーザ を 推奨 できる 。
または 、 この 2つ の 手法 を 組み合わせ 、 それぞれ で 推奨 する 上位 100人 の 積 集合 を 取る こと も できる 。
ただし 、 ここ は ネットワーク の 章 な ので 、 人々 の 関係 だけ に 基づい て エンジン を 構築 する 。

まずは 、 大規模 な ソーシャルネットワーク で 有益 な 関係 が どの よう に 築か れる か に関する 簡単 な 理論 から 始める と よい 。
フリッツ・ハイダー （ FritzHeider ） は 、 後世 に 影響 を 与える 1958年 から の 著書 の 中 で 、 「 社会的 バランス 理論 」 という 考え方 を 紹介 し た 。

私 の 友達の友達 は 私 の 友達 で ある 。
私 の 友達 の 敵 は 私 の 敵 で ある 。
私 の 敵 の 友達 は 私 の 敵 で ある 。
私 の 敵 の 敵 は 私 の 友達 で ある 。

この 考え方 は とても シンプル で あり 、 ソーシャルグラフ で は 閉じ た 三角形 と 開い た 三角形 という 形 で 表す こと が できる 。
ハイダー の 理論 で は 、 自分 の 友達 （ 正 ） や 自分 の 敵 （ 負 ） など の 符号 付き 関係 が 必要 で ある 。
ここ で は この よう な 情報 が ない ので 、 ツイッター 関係 の 推奨 エンジン を 構築 する のに ハイダー の 理論 を どの よう に 利用 できる だろ う か 。
まず 、 適切 な 推奨 ツイッター エンジン は 開い た 三角形 を 閉じよ う と する 。
つまり 、 自分 の 友達の友達 を 見つけ 、 自分 の 友達 に する の で ある 。
完全 な 符号 付き 関係 は わから ない が 、 敵同士 は ツイッター で フォロー し ない と みなせ ば 、 正 の 関係 は すべて わかる 。

最初 の データ 操作 で は 、 2周 期 の スノーボール 検索 を 行っ た 。
この データ に は 、 友達 と 友達の友達 が 含ま れる 。
そこで 、 この データ を 使用 し て 閉じる 必要 が ある 三角形 を 特定 できる 。
次 の 問題 は 、 多く の 三角形 候補 から 最初 に どれ を 閉じる べき か で ある 。
ここ でも 社会的 バランス 理論 を 活用 できる 。
最初 の スノーボール 検索 で は シード が フォロー し て い ない が 、 多く の 友達 が フォロー し て いる ノード を 見つける と 、 推奨 に 適し た 候補 と なる で あろ う 。
これ は 、 ハイダー の 理論 を 拡張 し て 「 私 の 多く の 友達の友達 は 私 にとって も よい 友達 と なる 可能性 が 高い 」 と し て いる 。
要するに 、 シード の ツイッター 関係 の 中 の 最も 明らか な 三角形 を 閉じ たい の で ある 。

技術的 観点 から 見る と 、 この 解決 法 も テキストマイニング や 地理 空間 分析 を 試み て 友達 を 推奨 する より も はるか に 簡単 で ある 。
ここ で は 、 友達 の 大 部分 が フォロー し て いる 友達の友達 を 数える だけ で よい 。
そのため に は 、 まず 以前 に 収集 し た すべて の ネットワーク データ を 読み込む 。
以前 と 同様 に 、 この 例 で は ドリュー の データ を 使用 する が 、 自分 の データ が あれ ば 自分 の データ を 使う こと を おすすめ する 。

まずは 、 シード の 友達 の ツイッター 名 を すべて 取得 する 。
neighbors 関数 を 使っ て 隣接 ノード の インデックス を 取得 できる が 、 igraph の デフォルト の インデックス 付け 方法 は R と は 異なる ので 、 すべて の 値 に 1 を 追加 する 必要 が ある 。
そして 、 その 値 を 、 グラフ の ノード 属性 （ この 場合 は name ） を 返す 特殊 な V 関数 に 渡す 。
次に 、 get.edgelist 関数 を 使い 、 グラフ の 全 エッジ リスト を 大きな N× 2 の 行列 として 作成 する 。

これ で 、 現在 シード が フォロー し て い ない ユーザ を フォロー し て いる 友達 の 人数 を 数える の に 必要 な データ が 手 に 入っ た 。
最初 に 、 シード の 友達 から シード が 現在 フォロー し て い ない ユーザ へ の リンク を 含む user.el の 行 を 特定 する 。
前 の 章 の 場合 と 同様 に 、 ベクトル 化 さ れ た sapply 関数 を 使用 し 、 行列 の 行 に かなり 複雑 な 論理 テスト を 含む 関数 を 実行 する 。
各行 に シード が フォロー し て い ない シード の 友達の友達 が 含ま れる か どう か を 判別 する TRUE と FALSE の 値 の ベクトル を 生成 し たい の で ある 。

ifelse を 使っ て この テスト を 行う が 、 これ 自体 が ベクトル 化 さ れ て いる 。
最初 の テスト で は 、 行 の 要素 が この ユーザ で ある か どう か と 、 最初 の 要素 （ ソース ） が シード の 友達 で ない か どう か を 調べる 。
any 関数 を 使っ て この 文 の どちら か が 真 か どう か を 調べる 。
どちら か が 真 なら 、 その 行 を 無視 する 。
もう 一方 の テスト で は 、 行 の 2番 目 の 要素 （ ターゲット ） が シード の 友達 で は ない こと を 調べる 。
友達 を フォロー し て いる 人 で は なく 、 友達の友達 を 対象 と する ので 、 これ も 無視 する 。
この 処理 は 行 数 によって は 1 、 2分 かかる が 、 完了 すれ ば non.friends.el に 適切 な 行 を 抽出 でき 、 table 関数 を 使っ て 名前 の 数 が わかる 。

次に 、 この 結果 を 報告 し たい 。
最も 「 明らか に 」 閉じる べき 三角形 を 見つけ たい ので 、 この データ で 最も 際立っ た ユーザ が 知り たい 。
table 関数 で 作成 し た ベクトル から データ フレーム を 作成 する 。
また 、 各 推奨 候補 を フォロー し て いる シード の 友達 の 割合 を 計算 し 、 フォロー を 勧める の に 最適 な ユーザ の 標準 化 し た 尺度 も 追加 する 。
最後 に 、 各 ユーザ を フォロー する 友達 の 割合 の 高 い方 から 降順 に データ フレーム を ソート する 。

結果 を 報告 する ため に 、 friends.followers [ 1 : 10 ,] を 実行 し 、 最初 の 10 行 （ 上位 10位 の フォロー 推奨 者 ） を 調べる 。
ドリュー の 場合 の 結果 を 表 11-1 に 示す 。

ドリュー を 知っ て いれ ば 、 上記 の 名前 は 大いに 納得 が いく 。
ドリュー に 最適 な フォロー 推奨 者 は 、 社会 における 技術 と インターネット の 役割 に関する 研究 や 執筆 を 行っ て いる ニューヨーク大学 教授 の クレイ ・ シャー キー （ cshirky ） で ある 。
ドリュー の 2つ の 関心 分野 について すで に わかっ て いる こと を 考える と 、 これ は 相性 が いい と 考え られる 。
これ を 念頭 に 置く と 、 残り の 推奨 者 は ドリュー の 一般的 興味 の 1つ または 両方 に 当てはまる 。
DangerRoom （ dangerroom ） 、 Wired の 国家安全保障 ブログ ： BigData （ bigdata ） 、 ネイト・シルバー による ニューヨークタイムズ の 選挙 予測 ブログ 538 （ fivethirtyeight ） など が ある 。
そして 、 もちろん shitmydadsays † も 含ま れる 。

この 推奨 者 は 適切 で あり 、 本書 の 初稿 の 執筆 以来 、 ドリュー は この エンジン で 示さ れ た 名前 の フォロー を 楽しん で いる が 、 おそらく もっと 優れ た 推奨 方法 が ある だろ う 。
特定 の シード ユーザ の ネットワーク に は 多く の 構造 が 出現 する こと が すで に わかっ て いる ので 、 その 構造 を 利用 し て グループ に 適合 する ユーザ を 推奨 する と 便利 で あろ う 。
友達 の 親友 を 推奨 する 代わり に 、 特定 の 次元 で シード に 似 て いる 友達の友達 を 推奨 できる 。
ドリュー の 場合 に は 、 国家安全保障 政策 コミュニティ か 、 データ や R コミュニティ で 閉じる べき 三角形 を 推奨 できる 。

まずは 、 区分 データ を 含む エゴ ネットワーク を 再 読み込み する 必要 が ある 。
すでに HC 8区 分 を 調べ た ので 、 この 推奨 エンジン の 最後 の 調整 で は HC 8区 分 を 利用 する 。
ネットワーク を 読み込ん だら 、 最初 の 列 に 区分 番号 、 2番 目 の 列 に ユーザ名 を 持つ 、 friends.partitions 行列 を 作成 する 。
ドリュー の データ で は 以下 の よう に なる 。

あと は 、 それぞれ の サブ コミュニティ 内 で 最も 明らか に 閉じる べき 三角形 を 計算 する だけ で ある 。
そこで 、 区分 番号 を 取り 、 該当 する ユーザ を 見つける partition.follows 関数 を 作成 する 。
すでに 全 データ を 計算 し て ある ので 、 この 関数 は 各 区分 内 の ユーザ を 調べ 、 シード の 友達 の 中 で 最大 の フォロワー を 持つ ユーザ を 返す だけ で ある 。
この 関数 の 中 で 目 に つく 唯一 の エラー チェック は 、 特定 の サブ セット の 行 数 が 2 より 小さい こと を 調べる if 文 で ある 。
この チェック を 行っ て いる の は 、 1つ の 区分 に 1人 の ユーザ （ シード ） しか いない 区分 が ある こと が わかっ て いる ので 、 その 区分 から は 推奨 し たく ない ため で ある 。

これ で 、 推奨 者 を 区分 ごと に 見る こと が できる 。
前述 し た よう に 、 シード の ため の 「 0 」 区分 に は 推奨 者 は い ない が 、 その他 の 区分 に は 存在 する 。
興味深い の は 、 一部 の 区分 に は 前述 の 方法 の 場合 と 同じ 名前 が ある が 、 多く の 区分 に は 同じ 名前 が 存在 し ない こと で ある 。

もちろん 、 この 推奨 者 を ネットワーク 内 で 見 た 方 が かなり 満足 できる 。
どの サブ コミュニティ で 誰 が 推奨 さ れ て いる か が わかり やすく なる から で ある 。
本章 に 含ま れる コード で は 、 ノード と 区分 番号 を 含む 新しい グラフ ファイル に この 推奨 者 を 追加 する 。
この コード は 主 に 後処理 の 練習 の ため な ので ここ で は 示し て い ない が 、 オライリー の 本書 の サイト から 入手 できる コード に 目 を 通す こと を おすすめ する 。
最後 に 、 ドリュー へ の 推奨 者 の データ を 可視 化 する 。
結果 は 図 11-9 を 参照 し て ほしい 。

この 結果 は かなり 優れ て いる 。
青 の ノード は 、 ドリュー の ネットワーク で 技術 と 国家安全保障 へ の 関心 の 間 に 位置 する ツイッター ユーザ で ある こと を 思い出し て ほしい 。
この エンジン は DangerRoom ブログ を 推奨 し て おり 、 この ブログ は まさに この 両方 を 扱っ て いる 。
また 、 緑 の ノード は 国家 安全 政策 に関して つぶやい て いる 人々 で ある 。
その 中 で 、 この エンジン は ジェレミー・スケイヒル （ jeremyscahill ） を 推奨 し て いる 。
ジェレミー は 雑誌 『 The Nation 』 の 国家安全保障 レポータ で あり 、 この グループ に 完璧 に 適合 し て おり 、 ドリュー の 独自 の 政治的 展望 が かいま見 られる だろ う 。

一方 、 赤 の ノード は R コミュニティ で ある 。
この 推奨 エンジン は 、 カーネギーメロン大学 で 機械学習 を 学ぶ 博士 課程 の 学生 、 ブレンダン ・ オコナー （ brendan 642 ） を 勧め て いる 。
彼 も また 、 R に関する つぶやき や ブログ を 書い て いる 人物 で ある 。
最後 に 、 紫 の グループ に は データ コミュニティ の その他 の 人々 が 含ま れる 。
この グループ から は 、 ペンシルバニア 州立大学 の 数学 と 統計学 の 助教授 、 ジャンソン ・ モートン （ jasonmorton ） を 勧め て いる 。
これら の 推奨 者 は すべて ドリュー の 興味 と 一致 し て いる が 、 ドリュー の 興味 に どの よう に 適合 する か が 正確 に わかる ので 一層 役に立つ で あろ う 。

推奨 エンジン に 手 を 加える 方法 は まだ 数多く ある ため 、 コード に 手 を 加え 、 各自 の データ に 適し た 推奨 者 を 手 に 入れ て ほしい 。

3 章 で は 分類 アルゴリズム における 決定 境界 の 概念 について 紹介 し 、 決定 境界 が 線形 で ない 場合 に は 問題 が 生じる こと を 解説 し た 。
さらに 6 章 で は 、 分類 アルゴリズム で ある ロジスティック回帰 によって 線形 の 決定 境界 を 構築 する 方法 を 示し た 。
どちら の 章 において も 、 非線形 の 決定 境界 に 拡張 する ため の カーネルトリック と 呼ば れる 技術 について 触れ て いる 。
そこで 本章 で は 、 サポートベクターマシン （ SVM ） と 呼ば れる 新しい 分類 アルゴリズム を 紹介 し 、 非線形 の 決定 境界 を 見つける ため に カーネル を 使っ て みよ う 。
ここ で は SVM を 使っ て 非線形 の 決定 境界 を 持つ データセット を 分類 する ため に 使う こと を 考える 。
具体的 に は 図 12-1 で 示さ れる データセット に 取り組ん で みよ う 。

図 12-1 から 、 この データセット 中 の クラス 0 の データ ポイント は 左右 に 散らばっ て おり 、 クラス 1 の データ ポイント は 内側 に ある こと が わかる 。
6 章 で 示し た ロジスティック回帰 の よう な 簡単 な 分類 アルゴリズム で は 、 この よう な 非線形 の 決定 境界 を 見つける こと は でき ない 。
まずは 確認 の ため 、 glm 関数 を 使っ て 試しに ロジスティック回帰 を 適用 し て みよ う 。
その後 、 なぜ ロジスティック回帰 が この データセット の 分類 に 失敗 する の か を 考える こと に する 。

結果 を 見る と 、 ロジスティック回帰 で は この データ の 52% しか 正しく 分類 する こと が でき て い ない 。
これ は すべて の データ ポイント が クラス 0 に 属する と 予測 し た 場合 と 全く 同じ 精度 に なっ て しまっ て いる 。

これ は 簡単 に 言う と 、 ロジスティック回帰 と 線形 の 決定 境界 は 今回 の 場合 は 全く 使いもの に なら ない こと を 意味 する 。
ロジスティック回帰 は 、 クラス 0 が クラス 1 より も 多く 出現 する と いう 以上 の 情報 を 全く 使わ ない モデル と 同じ 予測 を 行っ て しまう 。

どう すれ ば もっと 良い 予測 を 行える だろ う か 。
後ほど 見 て いく よう に 、 SVM を 使え ば ロジスティック回帰 より も 性能 の 良い 分類 器 を 簡単 に 作る こと が できる 。
SVM が どの よう な 原理 で 動作 する の か を 説明 する 前 に 、 まずは 有益 な 答え を 出力 する ブラックボックス な アルゴリズム として の 使い方 を 見 て みよ う 。
e1 071 パッケージ に 含ま れる 関数 で ある svm は 、 glm の よう に 簡単 に 使う こと が でき 、 それ を 行う こと が できる 。

結果 を 見る と 、 SVM の ほう が ロジスティック回帰 より 性能 が 良い こと は 明らか だ 。
SVM は どの よう に し て これ を 実現 し た の だろ う か 。

SVM が なぜ ロジスティック回帰 より 性能 面 で 優れ て いる の か を 直観 的 に 理解 する ため に 、 グラフ 上 で 可視 化 し て みよ う 。

まず は元 の データセット に ロジスティック回帰 と SVM の 予測 結果 を 加え た 。
次に 、 melt 関数 を 使っ て グラフ に し やすい 形式 に データセット を 変換 し 、 predictions という 新しい データ フレーム に 保存 し て いる 。
最後 に 、 正解 ラベル 、 ロジスティック回帰 の ラベル 、 SVM の ラベル を 合わせ て グラフ 表示 する と 、 図 12-2 の よう に なる 。

これ を 実行 し て 結果 を 見れ ば 、 ロジスティック回帰 が データセット の 外側 に 決定 境界 を 置い て い て 無意味 な 予測 を し て いる こと は 明らか だ 。
図 12-2 の 上部 に 示さ れる 実際 の 正解 データ は 、 クラス 1 の データ が 中心部 で 帯状 に 連なっ て いる 。
SVM は データセット の 外側 の 境界 において やや 奇妙 な 挙動 を し て いる が 、 基本的 に は この 帯状 の 構造 を 捉える こと に 成功 し て いる 。

これ で SVM が 期待 通り 非線形 の 決定 境界 を 生成 する こと が わかっ た 。
しかし 、 どう やっ て これ を 実現 し た の だろ う か 。
その 秘密 は カーネルトリック という 手法 に ある 。
カーネルトリック は 、 数学 的 な 変換 によって 元 の データセット を 新しい 空間 に 移動 し て 決定 境界 を 線形 で も 記述 し やすく する 。
この 変換 は 「 カーネル 」 と 呼ば れる 簡単 な 関数 のみ に 依存 する ため 、 この 手法 は カーネルトリック と 呼ば れる 。

カーネルトリック の 数学 的 性質 を 説明 する の は 簡単 で は ない が 、 異なる カーネル を いくつか 試し て み て 直観 的 な 理解 を する こと は 可能 だ 。
svm 関数 に は kernel という 引数 で カーネル を 指定 する こと が できる ため 、 異なる カーネル を 簡単 に 試す こと が できる 。
kernel 引数 は linear （ 線形 カーネル ） 、 polynomial （ 多項式 カーネル ） 、 radial （ ガウスカーネル ） 、 sigmoid （ シグモイド カーネル ） の いずれ か を 取る 。
これら の カーネル が それぞれ どの よう に 動作 する の か という 感触 を 得る ため 、 これら すべて を 使っ て 予測 を 行い 、 結果 を 表示 し て みよ う 。

図 12-3 を 見 て わかる よう に 、 線形 カーネル と 多項式 カーネル は おおよそ ロジスティック回帰 に 似 て いる 。
それ と は 対照 的 に ガウスカーネル は 正解 に 近い 決定 境界 を 生成 し て くれ て いる 。
シグモイド カーネル を 使う と 、 非常 に 複雑 で 奇妙 な 決定 境界 に なる 。

カーネルトリック が どの よう に 動作 する か について さらに 直観 的 に 理解 する ため に 、 これら 4つ の カーネル を 自分 の データ に 適用 し て み て ほしい 。
いろいろ 試し て みる うち に 、 SVM は 初期 設定 の 状態 より も もっと 良い 予測 が できる かも しれ ない と 思う だろ う 。
その 感覚 は 正しい 。
SVM で は ハイパー パラメータ を 設定 する 必要 が あり 、 初期 設定 の まま で は うまく いか ない こと が 多い ので 調節 する 必要 が ある 。
よく ある ハイパー パラメータ と 、 調節 の 仕方 によって どの よう に 性能 が 改善 する か を 見 て みよ う 。

最初 の ハイパー パラメータ は 多項式 カーネル における 多項式 の 次数 で ある 。
svm 関数 を 呼び出す とき に degree 引数 を 設定 する こと で 次数 を 変更 する こと が できる 。
この ハイパーパラメータ が 4つ の 簡単 な 例 で どの よう に 動作 する か を 見 て みよ う 。

ここ で degree を 3 か 5 に 設定 し て も モデル の 予測 の 質 に は 影響 が ない こと が わかる 。
（ 初期 設定 で は degree は 3 に 設定 さ れ て いる 点 に 注意 しよう ） 。
しかし 、 degree を 10 や 12 に 設定 する と 変化 が 起きる 。
何 が 起き て いる か を 見 て みる ため に 、 決定 境界 の グラフ を もう一度 表示 し て みる 。

図 12-4 の 予測 を 観察 する と 、 次数 が 大きい ほど 予測 の 質 が 改善 し て いる こと に が わかる 。
しかし 、 この よう な 方法 で 精度 を 改善 する の は 小手先 の 技術 で あっ て 、 本当 の 意味 で データ の 構造 を 捉え た やり方 で は ない こと に 注意 する 必要 が ある 。
また 、 モデル 構築 の 段階 は 次数 が 大きく なる ほど 遅く なる こと に 気付く はず だ 。
さらに 、 6 章 の 多項 回帰 で 見 た の と 同じ 過学習 の 問題 が 現れ 始め て いる 。
この よう な 理由 から 、 多項式 カーネル の 次数 を 実際 に 決める とき に は 、 交差 検定 による 実験 が 必須 で ある 。
多項式 カーネル と SVM は 重要 な 道具 で ある こと は 疑い よう が ない が 、 この よう に 自分自身 で 考え て 努力 し ない 限り 、 うまく いく と は 限ら ない の で ある 。

先ほど は 多項式 カーネル の 次数 を 表す ハイパー パラメータ を 試し た ので 、 次 は cost （ コスト ） という すべて の SVM の カーネル に 適用 できる ハイパーパラメータ を 試す こと に しよ う 。
コスト を 変更 し た 効果 を 確認 する ため に 、 ガウスカーネル を 使っ て 4つ の 異なる コスト の 設定 を 試し て みる 。
また 今回 から は 、 誤り の 回数 を 数える の で は なく 予測 に 成功 し た データ ポイント の 数 を 数える こと に する 。
興味 が ある の は 最も 悪い モデル が どれ だけ 悪い の か では なく 、 最も 良い モデル が どれ だけ 良い の か だ から だ 。
次 の コード は この よう な コスト の 探索 を 行う 方法 を 示し て いる 。

見 て の 通り 、 コスト を 増加 さ せる と モデル の 当てはまり 方 は だんだん と 悪化 し て いく 。
これ は 6 章 で 説明 し た lambda パラメータ と 同様 に 、 コスト は 正則化 の 強 さ を 表す ハイパー パラメータ で あり 、 コスト を 増やす こと は モデル を 訓練 データ に対して 当てはまら なく さ せる ため で ある 。
もちろん 、 正則化 の 強化 は テストデータ に対する 性能 を 改善 する 可能性 が ある ので 、 常に 交差 検定 を 用い て テスト 性能 を 確認 する 必要 が ある 。

学習 し た モデル に 何 が 起き て いる の か を 理解 する ため に 、 図 12-5 の 予測 結果 を 見 て みよ う 。

コスト による 変化 は 微妙 で ある が 、 図 12-5 では データセット の 外側 に 変化 を 見て取る こと が できる 。
コスト を 増加 さ せる につれて 、 ガウスカーネル が 生成 する 決定 境界 は 線形 に 近く なっ て いく 。

cost パラメータ について 調べ た ところ で 、 最後 に 引数 gamma （ ガンマ ） を 調べ て SVM の ハイパー パラメータ について の 実験 を 終わる こと に しよ う 。
この 目的 の ため に 、 シグモイド カーネル を 使っ て 異なる ガンマ の 値 の 影響 を 調べる こと に する 。

ガンマ を 増加 さ せる ごと に 、 モデル の 性能 は 少し ずつ 良く なっ て いる 。
この 改善 の 意味 を 捉える ため に 、 もう一度 予測 結果 を 可視 化 し て 調べ て みる こと に しよ う 。

図 12-6 を 見る と 、 シグモイド カーネル によって やや 複雑 な 決定 境界 が 選ば れ て 、 ガンマ の 値 を 変える と 決定 境界 が ゆがん で いく こと が わかる 。
何 が 起こっ て いる か を 詳しく 調べ たけれ ば 、 ここ で 示し た 4つ だけ で は なく 、 より 多く の ガンマ の 値 を 試し て みる こと を おすすめ する 。

これ で SVM の 紹介 を 終わる 。
SVM は 道具箱 に 加える 価値 の ある アルゴリズム だ が 、 そろそろ 道具 を 揃える だけ の 作業 を やめ て 、 特定 の 課題 において どの 道具 が 最良 か を 考え 始める こと に しよ う 。
これ を 行う ため に 、 1つ の データセット に対して 複数 の モデル を 同時に 試し て みる こと に する 。

すでに SVM 、 ロジスティック回帰 、 k 近傍 法 の 使い方 は わかっ て いる ので 、 これら の アルゴリズム の 性能 を 3 章 と 4 章 で 使っ た SpamAssassin データセット について 比較 し て みよ う 。
複数 の アルゴリズム を 実験 する の は 、 実 世界 の データセット を 扱っ て いる とき に は 良い 習慣 で ある 。
というのも 、 特定 の データセット に対して どの アルゴリズム が 最も よく 当てはまる か を 事前 に 知る こと は 普通 でき ない から だ 。
しかも 機械学習 の 経験 豊富 な 専門家 は 、 アルゴリズム が うまく 動作 し ない とき に その 原因 を 問題 の 構造 から 読み解く 能力 が あり 、 これ が 初心者 と の 大きな 違い の 1つ と なっ て いる 。
この 直観 を 培う 最も 良い 方法 は 、 出会っ た 問題 すべて に 標準 的 な アルゴリズム を 適用 し て み て 、 どんな とき に どの アルゴリズム が 失敗 する か の 感覚 を 身 に つける こと で ある 。

最初 の 作業 は データ を 読み込ん で 適切 な 前 処理 を 施す こと で ある 。
この 作業 は すでに 以前 に 経験 済み な ので いくつか の 段階 を 飛ばし て 、 R の load 関数 を 使っ て 文書 単語 行列 を ディスク から 読み出す こと に する 。
これ は バイナリ 形式 で ディスク に 書き出さ れ た R の オブジェクト を 読み込む 関数 で ある 。
次に 、 訓練 データ と テストデータ を 切り分け て 元 の データセット を 削除 する 。
ここ で 使う rm 関数 は 、 オブジェクト を メモリ から 解放 する ため に 使う こと が できる 。

データセット を メモリ 中 に 読み込ん だ ので 、 次に 進ん で glmnet 関数 を 使っ て 正則化 つき の ロジスティック回帰 を 適用 する こと が できる 。

もちろん lambda ハイパー パラメータ を 決める に当たって 大きな 自由度 が 残っ て いる ので 、 いろいろ な lambda の 設定 について どれ が 最も 良い 性能 に なる か を 比較 し て みよ う 。
今回 は 簡略 化 の ため に 、 交差 検定 を 行っ て 訓練 データ を 繰り返し 分割 する の で は なく 、 固定 さ れ た 訓練 データ と テストデータ に対して ハイパー パラメータ の 設定 を 検証 する こと に する 。
もし 厳密 に モデル を 検証 し たけれ ば この 手 の 簡略 化 は 行う べき で は ない が 、 その よう な 正統 な lambda の チューニング は 読者 へ の 課題 として 残し て おく 。
今回 は glmnet に 設定 できる 値 を 試し て テスト セット 上 で の 性能 を 確認 する こと に しよ う 。

図 12-7 を 見れ ば 、 明らか に ある 範囲 の lambda の 値 が 最も 低い 誤り 率 に なる こと が わかる 。
その 最良 の 値 を 見つける ため に 、 単純 な 索引 と min 関数 を 使う こと が できる 。

今回 の 場合 に は 、 全く 同じ 性能 の lambda が 2つ 存在 し て いる ので 、 max 関数 を 使っ て 大きい 方 を 取り出し て いる 。
大きい 値 を 選ぶ 理由 は 、 そちら の ほう が 強い 正則化 を 適用 できる ため で ある 。
次に この 最良 の lambda の 値 と ロジスティック回帰 に対する MSE を 計算 する 。

正則化 つき ロジスティック回帰 で は 、 ほんの 少し しか パラメータ の 調整 を 必要 と せ ず 、 今回 の テスト セット の 電子メール の うち たった の 6% しか 誤 分類 し ない こと が わかる 。
しかし ロジスティック回帰 、 SVM 、 k 近傍 法 の うち どれ を 使え ば よい か を 決める ため に 、 他 の 手法 が どれ だけ うまく 当てはまる か を 調べ たい 。

この ため に 、 まずは 線形 カーネル SVM を 当てはめ て み て ロジスティック回帰 と どう 違う か を 調べる こと に しよ う 。

線形 カーネル SVM の 学習 は 今回 の よう な 大きな データセット で は やや 遅く なる 。
この ため 、 いささか 不公平 で ある が 、 SVM の ハイパー パラメータ について は 初期 設定 を 用いる こと に する 。
ロジスティック回帰 の ハイパー パラメータ を 選ぶ の に テスト セット 上 で の 性能 を 評価 し た よう に 、 ハイパー パラメータ の 初期 設定 を 用いる こと は 必ずしも 最適 で は ない が 、 機械学習 の 文献 で は しばしば 行わ れ て いる 。
モデル を 比較 する とき 、 その 結果 は ある意味 で その モデル を データ に 当てはめる ため に 行っ た 努力 の たま もの だ という こと を 心 に 留め て おく 必要 が ある 。
もし ある モデル により 多く の 時間 を 割い て チューニング を 施し たら 、 性能 の 違い の 一部 は 構造 の 違い で は なく 払っ た 努力 の 量 に 依存 し て しまう の だ 。

それ を 踏まえ て 、 線形 カーネル SVM の 性能 を 今回 の テストデータ に対して 評価 し て みよ う 。

この 結果 から 線形 カーネル SVM の 誤り 率 が 12% と なり 、 ロジスティック回帰 の 2倍 に なっ た こと が わかる 。
実際 の 線形 カーネル SVM の 限界 を 知る に は 、 コスト 値 を 変え て 理想 的 な 誤り 率 を 知る 必要 が ある 。

しかし とりあえず は 線形 カーネル SVM について は 今 得 られ た 結果 を 使い 、 ガウスカーネル SVM に 移っ て カーネル の 変更 が 、 本章 の 前半 で 行っ た よう な 可視化 の 難しい 実 応用 例 で どの よう に 影響 する か を 調べ て みる こと に しよ う 。
